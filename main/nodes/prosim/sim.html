<!-- YOUR FIRST DATA TEMPLATE TO DISPLAY THE CONFIG SCREEN WHEN THE CONFIG NODE IS DISPLAYED -->
<script type="text/x-red" data-template-name="probe_config_sidebar">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
        <br/>
        <label for="node-input-name"><i class="icon-tag"></i> Time</label>
        <input type="text" id="node-input-time" placeholder="Time">
    </div>

    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
 
    <div class="form-row">
        <label for="node-input-outs"><i class="fa fa-sign-out"></i> Output</label>
        <select id="node-input-outs" style="width:204px">
            <option value="all">continuously while Simulator</option>
            <option value="end">only on release</option>
        </select>
    </div>

</script>

<script type="text/x-red" data-help-name="probe">
    <p> 시뮬레이션 컴포넌트 : TimeDomain에 의거하여 flow 들의 결과값 확인이 가능한 컴포넌트로 
        텍스트와 그래픽스를 지원하며 컴포넌트의 정보와 데이터 출력값에 대한 파일을 json으로 
        저장 및 입출력 지원 </p>
</script>

<script src="naide/prosim/simulator-utils.js"></script>

<script type="text/javascript">
    (function ($) {
     
        $("#Time_spinner").spinner();
        
        RED.nodes.registerType('probe',{
            category: 'NASimulator',
            color: '#9966FF',
            defaults: {
                name: { value: "probe" },
                outs:{value:'all'},
                topic:{value:''},
                height: {value: 0},
                width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                  }
                }
            },
            inputs: 1,
            outputs: 0, //component connection 
            outputLabels:["stdout", "probe"],
            icon: "probe.png",
            paletteLabel: 'Probe',
            label: function () {
                return this.name || "probe"
            },

            oneditprepare: function () {
                $("#node-input-size").elementSizer({
                width:"#node-input-width",
                height:"#node-input-height",
                group:"#node-input-group"
            });
            if(!$("#node-input-outs").val()){
                $("#node-input-outs").val("all")
              }
            },

            oneditsave: function () {
            },

            onpaletteadd: function() {
                var options = {
                    messageMouseEnter: function(sourceId) {
                        if (sourceId) {
                            var n = RED.nodes.node(sourceId);
                            if (n) {
                                n.highlighted = true;
                                n.dirty = true;
                            }
                            RED.view.redraw();
                        }
                    },
                    messageMouseLeave: function(sourceId) {
                        if (sourceId) {
                            var n = RED.nodes.node(sourceId);
                            if (n) {
                                n.highlighted = false;
                                n.dirty = true;
                            }
                            RED.view.redraw();
                        }
                    },
                    messageSourceClick: function(sourceId) {
                        RED.view.reveal(sourceId);
                    },
                    clear: function() {
                        RED.nodes.eachNode(function(node) {
                            node.highlighted = false;
                            node.dirty = true;
                        });
                        RED.view.redraw();
                    }
                };

                var uiComponents = RED.NAIDE.simulator.init(options);
                RED.sidebar.addTab({
                    id: "sidebar-nasimulator",
                    label: "NA-Simulator_label",
                    name: "NA-Simulator_name",
                    content: uiComponents.content,
                    //toolbar: uiComponents.footer,
                    closeable: true,
                    disableOnEdit: true,
                    // Select here your own FontAwesome icon that needs to be displayed on the tabsheet in the sidepanel
                    iconClass: "fa fa-comment",
                    action: "core:show-debug-tab"
                });
                this.handleSimMessage = function(t,o) {
                    var sourceNode = RED.nodes.node(o.id) || RED.nodes.node(o.z);
                    if (sourceNode) {
                        o._source = {id:sourceNode.id,z:sourceNode.z,name:sourceNode.name,type:sourceNode.type,_alias:o._alias};
                    }
                    RED.NAIDE.simulator.handleSimMessage(o);
                };
                RED.comms.subscribe("sim-message",this.handleSimMessage);
            }

            // onpaletteremove: function () {
            //      RED.sidebar.removeTab("sidebar-nasimulator");
            //      RED.events.off("sidebar:resize", sidebarResizeEventHandler);
            // },
            // onpaletteadd: function () {
            //     // The html content of the sidebar page has been specified a a data-template, from where it can be loaded:
            //     var content = $($('script[type="text/x-red"][data-template-name="probe_config_sidebar"]').i18n().html());

            //     //Add a new "Na-sim" tabsheet to the sidebar in the flow editor
            //     var sidebar_t = null
            //     sidebar_t = RED.sidebar.addTab({
            //         id: "sidebar-nasimulator",
            //         label: "NA-Simulator",
            //         name: "NA-Simulator",
            //         content: content,
            //         closeable: true,
            //         disableOnEdit: true,
            //         // Select here your own FontAwesome icon that needs to be displayed on the tabsheet in the sidepanel
            //         iconClass: "fa fa-comment"
            //     });


            //     $("#node-simulator-tab-settings").append($('script[type="text/x-red"][data-template-name="probe_config_sidebar"]').i18n().html());
            //     var probeTabsheets=null;
            //     if (probeTabsheets === null) {
            //         //console.log("!!!")
            //         probeTabsheets  = RED.tabs.create({
            //             id: "node-simulator-tabs",
            //             onchange: function (tab) {
            //                 $("#node-simulator-tabs-content").children().hide();
            //                 $("#" + tab.id).show();
            //                 //////////////////////////////////
            //             }
            //         });
            //         probeTabsheets.addTab({
            //             id: "node-simulator-tab-simulator",
            //             label: "Simulator"
            //         });
            //         probeTabsheets.addTab({
            //             id: "node-simulator-tab-settings",
            //             label: "Settings"     
            //         });
            //     }
            // }//onpaletted
        });//registerNode
    })(jQuery);
</script>



