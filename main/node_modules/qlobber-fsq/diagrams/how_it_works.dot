digraph {
    subgraph {
        rank = same
        v1 [ shape = point, width = 0 ]
        v2 [ shape = point, width = 0 ]
        v3 [ shape = point, width = 0 ]
        v4 [ shape = point, width = 0 ]
        v1 -> v2 [ dir = none ]
        v2 -> v3 [ dir = none ]
        v3 -> v4 [ dir = none ]
    }
    node [ shape = folder ]
    fsq_dir -> v1 [ dir = none ]
    v1 -> staging [ dir = none ]
    v2 -> topics [ dir = none ]
    v3 -> messages [ dir = none ]
    v4 -> update [ dir = none ]
    subgraph {
        rank = same
        tv1 [ shape = point, width = 0 ]
        tv2 [ shape = point, width = 0 ]
        tv3 [ shape = point, width = 0 ]
        tv1 -> tv2 [ dir = none ]
        tv2 -> tv3 [ dir = none ]
    }
    topics -> tv1 [ dir = none ]
    t00 [ label = "00" ]
    t01 [ label = "01" ]
    t02 [ label = ".." ]
    tv1 -> t00 [ dir = none ]
    tv2 -> t01 [ dir = none ]
    tv3 -> t02 [ dir = none ]
    tf [ shape = note, label = "topic file", color = dimgrey, fontcolor = dimgrey ]
    t01 -> tf [ dir = none ]
    subgraph {
        rank = same
        mv1 [ shape = point, width = 0 ]
        mv2 [ shape = point, width = 0 ]
        mv3 [ shape = point, width = 0 ]
        mv1 -> mv2 [ dir = none ]
        mv2 -> mv3 [ dir = none ]
    }
    messages -> mv1 [ dir = none ]
    m00 [ label = "00" ]
    m01 [ label = "01" ]
    m02 [ label = ".." ]
    mv1 -> m00 [ dir = none ]
    mv2 -> m01 [ dir = none ]
    mv3 -> m02 [ dir = none ]
    mf [ shape = note, label = "message" ]
    m01 -> mf [ dir = none ]
    node [ shape = note ]
    uv1 [ shape = point, width = 0 ]
    uv2 [ shape = point, width = 0 ]
    update -> uv1 [ dir = none ]
    uv1 -> UPDATE [ dir = none ]
    UPDATE -> uv2 [ dir = back ]
    smsg [ label = "staged message", style = dashed ]
    sv1 [ shape = point, width = 0 ]
    sv2 [ shape = point, width = 0 ]
    staging -> sv1 [ dir = none ]
    sv1 -> smsg [ dir = none ]
    smsg -> sv2 [ dir = back, style = dashed ]
    node [ shape = box ]
    subgraph {
        rank = same
        qv1 [ shape = point, width = 0 ]
        qv2 [ shape = point, width = 0 ]
        qv3 [ shape = point, width = 0 ]
        qv4 [ shape = point, width = 0 ]
        qv1 -> qv2 [ dir = none ]
        qv2 -> qv3 [ dir = none ]
        qv3 -> qv4 [ dir = none ]
    }
    sv2 -> qv1 [ dir = none, label = "1. Write to staging area", style = dashed ]
    tf -> qv2 [ dir = back, label = "2. Optional: Write long topic", color = dimgrey, fontcolor = dimgrey ]
    mf -> qv3 [ dir = back, label = "3. Move from staging to bucket" ]
    uv2 -> qv4 [ dir = none, label = "4. Write to UPDATE file" ]
    qv1 -> "qlobber-fsq" [ dir = none ]
}
