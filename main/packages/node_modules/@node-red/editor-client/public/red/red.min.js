/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
jQuery.propHooks.disabled={set:function(e,t){e.disabled!==t&&((e.disabled=t)?$(e).trigger("disabled"):$(e).trigger("enabled"))}};var RED=function(){function r(e,n){n=n||function(){};var a,t=/<!-- --- \[red-module:(\S+)\] --- -->/.exec(e.trim());a=t?t[1]:"unknown";try{var r=!1,s=$("<div>"+e+"</div>"),i=s.find("script"),d=i.length;i.each(function(e,t){var i=$(t).attr("src");if(i&&!/^\s*(https?:|\/|\.)/.test(i)){$(t).remove();var o=document.createElement("script");o.onload=function(){0===--d&&($("#red-ui-editor-node-configs").append(s),n())},"module"===$(t).attr("type")&&(o.type="module"),$("#red-ui-editor-node-configs").append(o),o.src=RED.settings.apiRootUrl+i,r=!0}else(/\/ace.js$/.test(i)||/\/ext-language_tools.js$/.test(i))&&(console.warn("Blocked attempt to load",i,"by",a),$(t).remove()),d--}),r||($("#red-ui-editor-node-configs").append(s),n())}catch(e){RED.notify(RED._("notification.errors.failedToAppendNode",{module:a,error:e.toString()}),{type:"error",timeout:1e4}),console.log("["+a+"] "+e.toString()),n()}}function s(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"icons",success:function(e){RED.nodes.setIconSets(e),t&&t()}})}function t(){var e=localStorage.getItem("editor-language")||i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":e},cache:!1,url:"nodes",success:function(e){var t=e.trim().split(/(?=<!-- --- \[red-module:\S+\] --- -->)/),i=function(){0===t.length?($("#red-ui-editor").i18n(),$("#red-ui-palette > .red-ui-palette-spinner").hide(),$(".red-ui-palette-scroll").removeClass("hide"),$("#red-ui-palette-search").removeClass("hide"),d(function(){RED.settings.theme("projects.enabled",!1)?RED.projects.refresh(function(e){RED.sidebar.info.refresh(),e||(RED.menu.setDisabled("menu-item-projects-open",!0),RED.menu.setDisabled("menu-item-projects-settings",!0),!1===e||RED.projects.showStartup()),o()}):(RED.sidebar.info.refresh(),o())})):r(t.shift(),i)};i()}})}function d(i){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){if(e){var t=window.location.hash;RED.nodes.version(e.rev),RED.nodes.import(e.flows),RED.nodes.dirty(!1),RED.view.redraw(!0),/^#flow\/.+$/.test(t)&&RED.workspaces.show(t.substring(6))}i()}})}function o(){var a={};RED.comms.subscribe("notification/#",function(e,i){var t=e.split("/")[1];if("runtime-deploy"!==t&&"node"!==t){if("project-update"===t)return RED.nodes.clear(),RED.history.clear(),RED.view.redraw(!0),void RED.projects.refresh(function(){d(function(){var e=RED.projects.getActiveProject(),t={"change-branch":RED._("notification.project.change-branch",{project:e.git.branches.local}),"merge-abort":RED._("notification.project.merge-abort"),loaded:RED._("notification.project.loaded",{project:i.project}),updated:RED._("notification.project.updated",{project:i.project}),pull:RED._("notification.project.pull",{project:i.project}),revert:RED._("notification.project.revert",{project:i.project}),"merge-complete":RED._("notification.project.merge-complete")}[i.action];RED.notify("<p>"+t+"</p>"),RED.sidebar.info.refresh()})});if(i.text){i.default=i.text;var o=RED._(i.text,i),n={type:i.type,fixed:void 0===i.timeout,timeout:i.timeout,id:t};"runtime-state"===t&&("safe-mode"===i.error?n.buttons=[{text:RED._("common.label.close"),click:function(){a[t].hideNotification()}}]:"missing-types"===i.error?(o+="<ul><li>"+i.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.projects.getActiveProject()?n.buttons=[{text:RED._("notification.label.manage-project-dep"),click:function(){a[t].hideNotification(),RED.projects.settings.show("deps")}}]:n.buttons=[{text:RED._("common.label.close"),click:function(){a[t].hideNotification()}}]):"credentials_load_failed"===i.error?RED.settings.theme("projects.enabled",!1)?RED.user.hasPermission("projects.write")&&(n.buttons=[{text:RED._("notification.project.setupCredentials"),click:function(){a[t].hideNotification(),RED.projects.showCredentialsPrompt()}}]):n.buttons=[{text:RED._("common.label.close"),click:function(){a[t].hideNotification()}}]:"missing_flow_file"===i.error?RED.user.hasPermission("projects.write")&&(n.buttons=[{text:RED._("notification.project.setupProjectFiles"),click:function(){a[t].hideNotification(),RED.projects.showFilesPrompt()}}]):"missing_package_file"===i.error?RED.user.hasPermission("projects.write")&&(n.buttons=[{text:RED._("notification.project.setupProjectFiles"),click:function(){a[t].hideNotification(),RED.projects.showFilesPrompt()}}]):"project_empty"===i.error?RED.user.hasPermission("projects.write")&&(n.buttons=[{text:RED._("notification.project.no"),click:function(){a[t].hideNotification()}},{text:RED._("notification.project.createDefault"),click:function(){a[t].hideNotification(),RED.projects.createDefaultFileSet()}}]):"git_merge_conflict"===i.error&&(RED.nodes.clear(),RED.sidebar.versionControl.refresh(!0),RED.user.hasPermission("projects.write")&&(n.buttons=[{text:RED._("notification.project.mergeConflict"),click:function(){a[t].hideNotification(),RED.sidebar.versionControl.showLocalChanges()}}]))),a.hasOwnProperty(t)?a[t].update(o,n):a[t]=RED.notify(o,n)}else a.hasOwnProperty(t)&&(a[t].close(),delete a[t])}}),RED.comms.subscribe("status/#",function(e,t){var i=e.split("/"),o=RED.nodes.node(i[1]);o&&(t.hasOwnProperty("text")&&/^[a-zA-Z]/.test(t.text)&&(t.text=o._(t.text.toString(),{defaultValue:t.text.toString()})),o.status=t,o.dirtyStatus=!0,o.dirty=!0,RED.view.redraw())}),RED.comms.subscribe("notification/node/#",function(e,t){var i,o,n;if("notification/node/added"==e){var a=[];t.forEach(function(e){var t=e.id;RED.nodes.addNodeSet(e),a=a.concat(e.types),RED.i18n.loadNodeCatalog(t,function(){$.get("nodes/"+t,function(e){r(e)})})}),a.length&&(n="<ul><li>"+a.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:a.length})+n,"success")),s()}else if("notification/node/removed"==e){for(i=0;i<t.length;i++)o=t[i],RED.nodes.removeNodeSet(o.id).added&&(n="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:o.types.length})+n,"success"));s()}else"notification/node/enabled"==e?t.types&&(RED.nodes.getNodeSet(t.id).added?(RED.nodes.enableNodeSet(t.id),n="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:t.types.length})+n,"success")):$.get("nodes/"+t.id,function(e){r(e),n="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:t.types.length})+n,"success")})):"notification/node/disabled"==e?t.types&&(RED.nodes.disableNodeSet(t.id),n="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:t.types.length})+n,"success")):"notification/node/upgraded"==e&&(RED.notify(RED._("palette.event.nodeUpgraded",{module:t.module,version:t.version}),"success"),RED.nodes.registry.setModulePendingUpdated(t.module,t.version));RED.library.loadFlowLibrary()}),RED.comms.subscribe("event-log/#",function(e,t){var i=e.substring(9);RED.eventLog.log(i,t)})}function e(){$.get("red/about",function(e){RED.sidebar.info.set('<div style="text-align:center;"><img width="50px" src="red/images/node-red-icon.svg" /></div>'+marked(e)),RED.sidebar.info.show()})}function i(){RED.workspaces.init(),RED.statusBar.init(),RED.view.init(),RED.userSettings.init(),RED.user.init(),RED.notifications.init(),RED.library.init(),RED.keyboard.init(),RED.palette.init(),RED.eventLog.init(),!1!==RED.settings.theme("palette.editable")?RED.palette.editor.init():console.log("Palette editor disabled"),RED.sidebar.init(),RED.settings.theme("projects.enabled",!1)?RED.projects.init():console.log("Projects disabled"),RED.subflow.init(),RED.clipboard.init(),RED.search.init(),RED.actionList.init(),RED.editor.init(),RED.diff.init(),RED.deploy.init(RED.settings.theme("deployButton",null)),function(){var e=[];RED.settings.theme("projects.enabled",!1)&&e.push({id:"menu-item-projects-menu",label:RED._("menu.label.projects"),options:[{id:"menu-item-projects-new",label:RED._("menu.label.projects-new"),disabled:!1,onselect:"core:new-project"},{id:"menu-item-projects-open",label:RED._("menu.label.projects-open"),disabled:!1,onselect:"core:open-project"},{id:"menu-item-projects-settings",label:RED._("menu.label.projects-settings"),disabled:!1,onselect:"core:show-project-settings"}]}),e.push({id:"menu-item-view-menu",label:RED._("menu.label.view.view"),options:[{id:"menu-item-palette",label:RED._("menu.label.palette.show"),toggle:!0,onselect:"core:toggle-palette",selected:!0},{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:"core:toggle-sidebar",selected:!0},{id:"menu-item-event-log",label:RED._("eventLog.title"),onselect:"core:show-event-log"},{id:"menu-item-action-list",label:RED._("keyboard.actionList"),onselect:"core:show-action-list"},null]}),e.push(null),RED.settings.theme("menu.menu-item-import-library",!0)&&e.push({id:"menu-item-import",label:RED._("menu.label.import"),onselect:"core:show-import-dialog"}),RED.settings.theme("menu.menu-item-export-library",!0)&&e.push({id:"menu-item-export",label:RED._("menu.label.export"),onselect:"core:show-export-dialog"}),e.push(null),e.push({id:"menu-item-search",label:RED._("menu.label.search"),onselect:"core:search"}),e.push(null),e.push({id:"menu-item-config-nodes",label:RED._("menu.label.displayConfig"),onselect:"core:show-config-tab"}),e.push({id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:"core:add-flow"},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:"core:edit-flow"},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:"core:remove-flow"}]}),e.push({id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:"core:create-subflow"},{id:"menu-item-subflow-convert",label:RED._("menu.label.selectionToSubflow"),disabled:!0,onselect:"core:convert-to-subflow"}]}),e.push(null),!1!==RED.settings.theme("palette.editable")&&(e.push({id:"menu-item-edit-palette",label:RED._("menu.label.editPalette"),onselect:"core:manage-palette"}),e.push(null)),e.push({id:"menu-item-user-settings",label:RED._("menu.label.settings"),onselect:"core:show-user-settings"}),e.push(null),RED.settings.theme("menu.menu-item-keyboard-shortcuts",!0)&&e.push({id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:"core:show-help"}),e.push({id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label",RED._("menu.label.help")),href:RED.settings.theme("menu.menu-item-help.url","http://nodered.org/docs")}),e.push({id:"menu-item-node-red-version",label:"v"+RED.settings.version,onselect:"core:show-about"}),$('<li><a id="red-ui-header-button-sidemenu" class="button" href="#"><i class="fa fa-bars"></i></a></li>').appendTo(".red-ui-header-toolbar"),RED.menu.init({id:"red-ui-header-button-sidemenu",options:e})}(),RED.nodes.init(),RED.comms.connect(),$("#red-ui-main-container").show(),$(".red-ui-header-toolbar").show(),RED.actions.add("core:show-about",e),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(e){RED.nodes.setNodeList(e),RED.i18n.loadNodeCatalogs(function(){s(t)})}})}var n=!1;return{init:function(e){if(n)throw new Error("RED already initialised");n=!0,ace.require("ace/ext/language_tools"),(e=e||{}).apiRootUrl=e.apiRootUrl||"",e.apiRootUrl&&!/\/$/.test(e.apiRootUrl)&&(e.apiRootUrl=e.apiRootUrl+"/"),e.target=$("#red-ui-editor"),e.target.addClass("red-ui-editor"),function(e){var t=$('<div id="red-ui-header"></div>').appendTo(e.target),i=$('<span class="red-ui-header-logo"></span>').appendTo(t);$('<ul class="red-ui-header-toolbar hide"></ul>').appendTo(t),$('<div id="red-ui-header-shade" class="hide"></div>').appendTo(t),$('<div id="red-ui-main-container" class="red-ui-sidebar-closed hide"><div id="red-ui-workspace"></div><div id="red-ui-editor-stack"></div><div id="red-ui-palette"></div><div id="red-ui-sidebar"></div><div id="red-ui-sidebar-separator"></div></div>').appendTo(e.target),$('<div id="red-ui-editor-node-configs"></div>').appendTo(e.target),$('<div id="red-ui-full-shade" class="hide"></div>').appendTo(e.target),$.getJSON(e.apiRootUrl+"theme",function(e){e.header&&(e.header.url&&(i=$("<a>",{href:e.header.url}).appendTo(i)),e.header.image&&$("<img>",{src:e.header.image}).appendTo(i),e.header.title&&$("<span>").html(e.header.title).appendTo(i))})}(e),RED.i18n.init(e,function(){RED.settings.init(e,i)})}}}();RED.events=function(){var n={};return{on:function(e,t){n[e]=n[e]||[],n[e].push(t)},off:function(e,t){var i=n[e];if(i)for(var o=0;o<i.length;o++)if(i[o]===t)return void i.splice(o,1)},emit:function(t,e){if(n[t])for(var i=0;i<n[t].length;i++)try{n[t][i](e)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n=function(){var a;return{init:function(e,t){a=e.apiRootUrl||"";var i=localStorage.getItem("editor-language"),o={resGetPath:a+"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1,returnObjectTrees:!0};i&&(o.lng=i),i18n.init(o,function(){t()}),RED._=function(){var e=i18n.t.apply(null,arguments);return"string"==typeof e?e:arguments[0]}},lang:function(){for(var e=i18n.functions.toLanguages(localStorage.getItem("editor-language")||i18n.detectLanguage()),t=RED.settings.theme("languages")||["en-US"],i=0;i<e.length;i++)if(-1<t.indexOf(e[i]))return e[i];return"end-US"},loadNodeCatalog:function(i,o){var e=i18n.functions.toLanguages(localStorage.getItem("editor-language")||i18n.detectLanguage()),n=e.length;e.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:a+"nodes/"+i+"/messages?lng="+t,success:function(e){i18n.addResourceBundle(t,i,e),0===--n&&o()}})})},loadNodeCatalogs:function(e){var t=i18n.functions.toLanguages(localStorage.getItem("editor-language")||i18n.detectLanguage()),o=t.length;t.forEach(function(i){$.ajax({headers:{Accept:"application/json"},cache:!1,url:a+"nodes/messages?lng="+i,success:function(t){Object.keys(t).forEach(function(e){i18n.addResourceBundle(i,e,t[e])}),0===--o&&e()}})})}}}(),RED.settings=function(){function o(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}var e,i={},n={},a=function(o){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(e){!function(e){for(var t in i)i.hasOwnProperty(t)&&RED.settings.hasOwnProperty(t)&&delete RED.settings[t];for(t in e)e.hasOwnProperty(t)&&(RED.settings[t]=e[t]);i=e}(e),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+e.version),console.groupCollapsed("Versions"),console.log("jQuery",$().jquery),console.log("jQuery UI",$.ui.version),console.log("ACE",ace.version),console.log("D3",d3.version),console.groupEnd(),t(o)},error:function(e,t,i){401===e.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){a(o)})):console.log("Unexpected error loading settings:",e.status,t)}})};function t(t){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(e){!function(e){n=e}(e),t()},error:function(e,t,i){console.log("Unexpected error loading user settings:",e.status,t)}})}function r(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout(function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(n),success:function(e){},error:function(e,t,i){console.log("Unexpected error saving user settings:",e.status,t)}})},300))}return{init:function(o,e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var i=t[1];RED.settings.set("auth-tokens",{access_token:i}),window.location.search=""}RED.settings.apiRootUrl=o.apiRootUrl,$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){o.apiRootUrl&&(t.url=o.apiRootUrl+t.url);var i=RED.settings.get("auth-tokens");i&&e.setRequestHeader("Authorization","Bearer "+i.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),a(e)},load:a,loadUserSettings:t,set:function(e,t){o()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(RED.utils.setMessageProperty(n,e,t),r()))},get:function(e,t){if(o()){if("auth-tokens"===e)return JSON.parse(localStorage.getItem(e));try{var i=RED.utils.getMessageProperty(n,e);void 0===i&&(i=t)}catch(e){i=t}return i}},remove:function(e){o()&&("auth-tokens"===e?localStorage.removeItem(e):(delete n[e],r()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var i=e.split("."),o=RED.settings.editorTheme;try{for(var n=0;n<i.length;n++)o=o[i[n]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function p(){$("#red-ui-header-button-user-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),p(),RED.events.emit("login",RED.settings.user.username)})})}}):(RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var n=/^((.+)\.)?read$/,a=/^((.+)\.)?write$/;return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var e=$('<li><a id="red-ui-header-button-user" class="button hide" href="#"></a></li>').prependTo(".red-ui-header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(e.find("a")):$('<i class="fa fa-user"></i>').appendTo(e.find("a")),RED.menu.init({id:"red-ui-header-button-user",options:[]}),p()}},login:function(d,l){"function"==typeof d&&(l=d,d={});var c=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');c.dialog({autoOpen:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},modal:!0,closeOnEscape:!!d.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(n){var e=0;if("credentials"==n.type){for(;e<n.prompts.length;e++){var t=n.prompts[e],i=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+t.id+'">'+RED._(t.label)+":</label><br/>").appendTo(i);var o=$('<input style="width: 100%" id="node-dialog-login-'+t.id+'" type="'+t.type+'" tabIndex="'+(e+1)+'"/>').appendTo(i);e<n.prompts.length-1&&o.keypress(function(){var t=i;return function(e){13==e.keyCode&&(t.next("div").find("input").trigger("focus"),e.preventDefault())}}()),i.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(d.cancelable?'<a href="#" id="node-dialog-login-cancel" class="red-ui-button" style="margin-right: 20px;" tabIndex="'+(e+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" class="red-ui-button" style="width: auto;" tabIndex="'+(e+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").on("submit",function(e){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var t={client_id:"node-red-editor",grant_type:"password",scope:""},i=0;i<n.prompts.length;i++){var o=n.prompts[i];t[o.id]=$("#node-dialog-login-"+o.id).val()}$.ajax({url:"auth/token",type:"POST",data:t}).done(function(e,t,i){RED.settings.set("auth-tokens",e),$("#node-dialog-login").dialog("destroy").remove(),d.updateMenu&&p(),l()}).fail(function(e,t,i){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),e.preventDefault()})}else if("strategy"==n.type)for(e=0;e<n.prompts.length;e++){t=n.prompts[e],i=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var a=$('<a href="#" class="red-ui-button"></a>',{style:"padding: 10px"}).appendTo(i).on("click",function(){document.location=t.url});if(t.image)$("<img>",{src:t.image}).appendTo(a);else if(t.label){var r=$("<span></span>").text(t.label);t.icon&&($("<i></i>",{class:"fa fa-2x "+t.icon,style:"vertical-align: middle"}).appendTo(a),r.css({verticalAlign:"middle",marginLeft:"8px"})),r.appendTo(a)}a.button()}d.cancelable&&$("#node-dialog-login-cancel").button().on("click",function(e){$("#node-dialog-login").dialog("destroy").remove()});var s=n.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){c.dialog("open")}).attr("src",s)}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done(function(e,t,i){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,i){401===e.status?document.location.reload(!0):console.log(t)})},hasPermission:function(e){return""===e||(!RED.settings.user||function e(t,i){if(""===i)return!0;var o;if(Array.isArray(i)){for(o=0;o<i.length;o++)if(!e(t,i[o]))return!1;return!0}if(Array.isArray(t)){if(0===t.length)return!1;for(o=0;o<t.length;o++)if(e(t[o],i))return!0;return!1}if("*"===t||t===i)return!0;{if("read"===t||"*.read"===t)return n.test(i);if("write"===t||"*.write"===t)return a.test(i)}return!1}(RED.settings.user.permissions||"",e))}}}(),RED.comms=function(){var a,r=null,l=null,c=null,p=10,u={},f=!1,h=0,g=!1;return{connect:function s(){var e;if(g=!0,RED.settings.apiRootUrl){var t=/^(https?):\/\/(.*)$/.exec(RED.settings.apiRootUrl);t&&(console.log(t),e="ws"+("https"===t[1]?"s":"")+"://"+t[2]+"comms")}else{var i=location.hostname,o=location.port;0!==o.length&&(i=i+":"+o),i=(i+=document.location.pathname)+("/"==i.slice(-1)?"":"/")+"comms",e="ws"+("https:"==document.location.protocol?"s":"")+"://"+i}var n=RED.settings.get("auth-tokens");function d(){for(var e in u)u.hasOwnProperty(e)&&a.send(JSON.stringify({subscribe:e}))}f=null!=n,(a=new WebSocket(e)).onopen=function(){h=0,r&&(l=setTimeout(function(){r.close(),r=null},1e3)),f?a.send(JSON.stringify({auth:n.access_token})):d()},a.onmessage=function(e){var t=JSON.parse(e.data);if(t.auth)f&&"ok"===t.auth?(f=!1,d()):"fail"===t.auth&&(g=!1,RED.user.login({updateMenu:!0},function(){s()}));else for(var i=0;i<t.length;i++){var o=t[i];if(o.topic)for(var n in u)if(u.hasOwnProperty(n)&&new RegExp("^"+n.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(o.topic)){var a=u[n];if(a)for(var r=0;r<a.length;r++)a[r](o.topic,o.data)}}},a.onclose=function(){g&&(l&&(clearTimeout(l),l=null),++h<10?(setTimeout(s,1e3),5<h&&null==r&&(r=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):h<20?setTimeout(s,2e3):(p=60,c=setInterval(function(){if(0==--p)r.update(RED._("notification.errors.lostConnection")),clearInterval(c),s();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:p})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";r.update(e,{silent:!0}),$(r).find("a").on("click",function(e){e.preventDefault(),r.update(RED._("notification.errors.lostConnection"),{silent:!0}),clearInterval(c),s()})}},1e3)))}},subscribe:function(e,t){null==u[e]&&(u[e]=[]),u[e].push(t),a&&1==a.readyState&&a.send(JSON.stringify({subscribe:e}))},unsubscribe:function(e,t){if(u[e]){for(var i=0;i<u[e].length;i++)if(u[e][i]===t){u[e].splice(i,1);break}0===u[e].length&&delete u[e]}}}}(),RED.text={},RED.text.bidi=function(){var t="";function i(e){return"auto"==t?function(e){for(var t,i,o=e.length,n=0;n<o;n++){if(1488<=(i=e.charCodeAt(n))&&i<=1535||1536<=i&&i<=1631||1642<=i&&i<=1775||1786<=i&&i<=2047||64285<=i&&i<=65023||65136<=i&&i<=65276)return!0;if(64<(t=e.charCodeAt(n))&&t<91||96<t&&t<123)return!1}return!1}(e)?"rtl":"ltr":t}function o(){$(this).attr("dir",i($(this).val()))}return{setTextDirection:function(e){t=e,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#red-ui-workspace").find("span.red-ui-text-bidi-aware").each(function(){$(this).attr("dir",i($(this).html()))}),$("#red-ui-sidebar").find("span.red-ui-text-bidi-aware").each(function(){$(this).attr("dir",i($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var t=i(e);if("ltr"==t)return"‪"+e+"‬";if("rtl"==t)return"‫"+e+"‬"}return e},resolveBaseTextDir:i,prepareInput:function(e){e.on("keyup",o).on("paste",o).on("cut",o),o.call(e)}}}(),RED.text.format=function(){var p=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},d={handleSubcontents:function(e,t,i,o,n){if(!i.content||"string"!=typeof i.content||0===i.content.length)return e;var a=!0;void 0!==i.loops&&(a=!!i.loops);for(var r=0;!(r>=e.length);r++)if(!(e[r].isParsed||e.keep||e[r].isSeparator)){var s=e[r].content,d=s.indexOf(i.content);if(!(d<0)){var l,c=0;if(i.continued)for(;c++,0===(l=s.indexOf(i.content,d+c*i.content.length)););else c=1;if(l=d+c*i.content.length,e.splice(r,1),0<d&&(e.splice(r,0,new p({content:s.substring(0,d),localGui:t.dir,keep:!0})),r++),e.splice(r,0,new p({content:s.substring(d,l),textDirection:i.subDir,localGui:t.dir})),l<s.length&&e.splice(r+1,0,new p({content:s.substring(l,s.length),localGui:t.dir,keep:!0})),!a)break}}},handleBounds:function(e,t,i,o,n){for(var a=0;a<i.length;a++)if(u(i[a]))for(var r=0;!(r>=e.length);r++)if(!(e[r].isParsed||e[r].inBounds||e.keep||e[r].isSeparator)){var s=f(e[r],i[a]),d=s.bStart,l=s.bEnd;if(!(d<0||l<0)){var c=e[r].content;if(e.splice(r,1),0<d&&(e.splice(r,0,new p({content:c.substring(0,d),localGui:t.dir,keep:!0})),r++),s.start&&(e.splice(r,0,new p({content:s.start,localGui:t.dir,isSeparator:!0})),r++),e.splice(r,0,new p({content:c.substring(d+s.start.length,l-s.end.length),textDirection:s.subDir,localGui:t.dir,inBounds:!0})),s.end&&(r++,e.splice(r,0,new p({content:s.end,localGui:t.dir,isSeparator:!0}))),l+s.end.length<c.length&&e.splice(r+1,0,new p({content:c.substring(l+s.end.length,c.length),localGui:t.dir,keep:!0})),!s.loops)break}}for(a=0;a<e.length;a++)e[a].inBounds=!1;return e},handleCases:function(e,t,i,o,n){if(0===i.length)return e;var a={};for(var r in t)t.hasOwnProperty(r)&&(a[r]=t[r]);for(var s=0;s<i.length;s++)i[s].handler&&"function"==typeof i[s].handler.handle||(i[s].handler=t.commonHandler),i[s].args?(a.cases=i[s].args.cases,a.points=i[s].args.points,a.bounds=i[s].args.bounds,a.subs=i[s].args.subs):(a.cases=[],a.points=[],a.bounds=[],a.subs={}),i[s].handler.handle(o,e,a,n);return e},handlePoints:function(e,t,i,o,n){for(var a=0;a<i.length;a++)for(var r=0;!(r>=e.length);r++)if(!(e[r].isParsed||e[r].keep||e[r].isSeparator)){var s=e[r].content,d=s.indexOf(i[a]);0<=d&&(e.splice(r,1),0<d&&(e.splice(r,0,new p({content:s.substring(0,d),textDirection:t.subDir,localGui:t.dir,inPoints:!0})),r++),e.splice(r,0,new p({content:i[a],localGui:t.dir,isSeparator:!0})),d+i[a].length+1<=s.length&&e.splice(r+1,0,new p({content:s.substring(d+i[a].length),textDirection:t.subDir,localGui:t.dir,inPoints:!0})))}for(a=0;a<e.length;a++)e[a].keep?e[a].keep=!1:e[a].inPoints&&(e[a].isParsed=!0,e[a].inPoints=!1);return e}};function u(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var i=parseInt(e.length,10);return isNaN(i)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function f(e,t){var i={};for(var o in t)t.hasOwnProperty(o)&&(i[o]=t[o]);var n=e.content,a=i.usePos&&i.startPos<n.length;a&&(i.start="",i.loops=!1),i.bStart=a?i.startPos:0<i.start.length?n.indexOf(i.start):0;var r=i.useLength&&0<i.length&&i.bStart+i.length<n.length;return r&&(i.end=""),i.bEnd=r?i.bStart+i.length:0<i.end.length?n.indexOf(i.end,i.bStart+i.start.length)+1:n.length,i.after||(i.start=""),i.before||(i.end=""),i}var e,s={handle:function(e,t,i,o){var n=[];Array.isArray(i.cases)&&(n=i.cases);var a=[];void 0!==i.points&&(Array.isArray(i.points)?a=i.points:"string"==typeof i.points&&(a=i.points.split("")));var r={};"object"==typeof i.subs&&(r=i.subs);var s=[];return Array.isArray(i.bounds)&&(s=i.bounds),d.handleBounds(t,i,s,e,o),d.handleSubcontents(t,i,r,e,o),d.handleCases(t,i,n,e,o),d.handlePoints(t,i,a,e,o),t}},c={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(function(e){var t=e?e.split("-")[0]:"";return!(!t||t.length<2)&&["iw","he","ar","fa","ur"].some(function(e){return e===t})}(e=(e=e||("undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||"")).toLowerCase())){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,i,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;i=/^(rtl|ltr)$/i.test(i)?i:"ltr";var n=o?e.split("").reverse().join(""):e,a=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(n);return a?a[0]<="z"?"ltr":"rtl":i},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var i="",o=0;o<e.length;o++){var n=""+e.charAt(o);switch(n){case"‎":i+="<LRM>";break;case"‏":i+="<RLM>";break;case"‪":i+="<LRE>";break;case"‫":i+="<RLE>";break;case"‭":i+="<LRO>";break;case"‮":i+="<RLO>";break;case"‬":i+="<PDF>";break;default:i+=n}}var a=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return a+i+(a?"‬":"")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},l=((e={}).parseAndDisplayStructure=function(e,t,i,o){return e&&t?a(n(e,t,o),t,i):e},e.parseStructure=n,e.displayStructure=a,e.restore=function(e,t){return e},e);function r(e,t){var i=Array.isArray(e)?e[0]:e;return i.guiDir||(i.guiDir="ltr"),i.dir||(i.dir=i.guiDir),t&&(void 0===i.points&&(i.points=[]),i.cases||(i.cases=[]),i.bounds||(i.bounds=[]),i.commonHandler=s),i}function n(e,t,i){if(!e||!t)return new p({content:""});var o=r(t,!0),n=[new p({content:e,actual:e,localGui:o.dir})],a=s.handle;return o.handler&&"function"==typeof o.handler&&(a=o.handler.handle),a(e,n,o,i),n}function a(e,t,i){var o=r(t,!1);return i?function(e,t){for(var i="",o="",n=0;n<e.length;n++)if(e[n].isVisible){var a=e[n].textDirection,r=e[n].localGui;if(""!==r&&""===o?i+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>":""===o||""!==r&&r===o&&!stop||(i+="</bdi>"+(n==e.length-1&&""!==r?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==r&&(i+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>")),"auto"===a&&(a=c.getDirection(e[n].content,a,t.guiDir)),/^(rtl|ltr)$/i.test(a)?(i+="<bdi dir='"+("rtl"===a?"rtl":"ltr")+"'>"+e[n].content+"</bdi>",a):(i+=e[n].content,c.getDirection(e[n].content,a,t.guiDir,!0)),n<e.length-1){var s=r&&e[n+1].localGui?r:t.dir;i+="<span style='unicode-bidi: embed; direction: "+("rtl"===s?"rtl":"ltr")+";'></span>"}else""!==o&&(i+="</bdi>");o=r,stop=!1}else stop=!0;var d="auto"===t.dir?c.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;d!==t.guiDir&&(i="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>"+i+"</bdi>");return i}(e,o):function(e,t){for(var i="",o="",n=!1,a=0;a<e.length;a++)if(e[a].isVisible){var r=e[a].textDirection,s=e[a].localGui;if(""!==s&&""===o?i+="rtl"===s?c.RLE:c.LRE:""===o||""!==s&&s===o&&!n||(i+=c.PDF+(a==e.length-1&&""!==s?"":"rtl"===t.dir?c.RLM:c.LRM),""!==s&&(i+="rtl"===s?c.RLE:c.LRE)),"auto"===r&&(r=c.getDirection(e[a].content,r,t.guiDir)),/^(rtl|ltr)$/i.test(r)?(i+=("rtl"===r?c.RLE:c.LRE)+e[a].content+c.PDF,r):(i+=e[a].content,c.getDirection(e[a].content,r,t.guiDir,!0)),a<e.length-1){var d=s&&e[a+1].localGui?s:t.dir;i+="rtl"===d?c.RLM:c.LRM}else""!==o&&(i+=c.PDF);o=s,n=!1}else n=!0;var l="auto"===t.dir?c.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;l!==t.guiDir&&(i=("rtl"===l?c.RLE:c.LRE)+i+c.PDF);return i}(e,o)}var t,i,o={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:t.dir?t.dir:i?"rtl":"ltr",subs:{content:">",continued:!0,subDir:i?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:i?"ltr":"rtl"}}}]};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},h={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:"ltr",points:","};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},g={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:function(e,t){if("ar"!==c.getLocaleDetails(t).lang)return"ltr";var i=e.indexOf("@");return 0<i&&i<e.length-1&&c.hasArabicChar(e.substring(i+1))?"rtl":"ltr"}(e,n),points:"<>.:,;@",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},v={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:"ltr",points:"/\\:."};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},b={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},m={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:s,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:s,args:{subs:{content:" ",continued:!0}}},{handler:s,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},y={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:"ltr",points:"_"};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},w={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},D={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:t.dir?t.dir:i?"rtl":"ltr",points:" ,.!?;:"};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},E={format:function(e,t,i,o,n,a){var r={guiDir:i?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}},R={format:function(e,t,i,o,n,a){var r={},s="",d=Array.isArray(t)?t[0]:t;for(s in d)d.hasOwnProperty(s)&&(r[s]=d[s]);return r.guiDir=i?"rtl":"ltr",r.dir=r.dir?r.dir:r.guiDir,a?l.parseStructure(e,r,!!o,n):l.parseAndDisplayStructure(e,r,!!o,n)}};i=!(t={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""});function $(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function x(e){0===e.msgDir.length&&(e.msgDir=$(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:$(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}var k=null;function T(e){switch(e){case"breadcrumb":return o;case"comma":return h;case"email":return g;case"filepath":return v;case"formula":return b;case"sql":return m;case"underscore":return y;case"url":return w;case"word":return D;case"xpath":return E;default:return R}}function _(t,e,i,o,n){if(!t||1!=t.nodeType)return!1;k||(k=document.createEvent("Event")).initEvent("TF",!0,!0),t.setAttribute("data-tf-type",e);var a="undefined"===i?"{}":JSON.stringify(Array.isArray(i)?i[0]:i);t.setAttribute("data-tf-args",a);var r="ltr";if("undefined"===o&&(t.dir?r=t.dir:t.style&&t.style.direction&&(r=t.style.direction),o="rtl"===r.toLowerCase()),t.setAttribute("data-tf-dir",o),t.setAttribute("data-tf-locale",c.getLocaleDetails(n).lang),function(e){var t=window.navigator.userAgent;if(0<=t.indexOf("MSIE")||0<=t.indexOf("Trident")||0<=t.indexOf("Edge"))return!1;var i=document.createElement(e.tagName);i.contentEditable=!0;var o="oninput"in i;return o||(i.setAttribute("oninput","return;"),o="function"==typeof i.oninput),i=null,o}(t)){t.oninput;t.oninput=function(e){j(e.target)}}else t.onkeyup=function(e){j(e.target),t.dispatchEvent(k)},t.onmouseup=function(e){j(e.target),t.dispatchEvent(k)};return j(t),!0}function j(e){var t=e.textContent||"",i=document.getSelection();if(0===t.length||!i||i.rangeCount<=0)e.dispatchEvent(k);else{var o,n,a=i.getRangeAt(0),r=a.cloneRange();o=a.startContainer,n=a.startOffset;var s=0;3===o.nodeType&&(s+=n),r.setStart(e,0),r.setEndBefore(o);var d=document.createElement("div");d.appendChild(r.cloneContents()),s+=d.textContent.length,e.innerHTML=T(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var l=e,c=e,p=0,u=!1;for(i.removeAllRanges(),a.setStart(e,0),a.setEnd(e,0);c;){if(3===c.nodeType){if(p+c.nodeValue.length>=s){a.setStart(c,s-p);break}p+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(l=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(l===e){u=!0;break}c=l.nextSibling,l=l.parentNode}if(u)break}i.addRange(a),e.dispatchEvent(k)}}return{getHtml:function(e,t,i,o,n){return T(t).format(e,i,o,!0,n)},attach:function(e,t,i,o,n){return _(e,t,i,o,n)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9,PANNING:10,SELECTING_NODE:11},RED.nodes=function(){var W,K,p=[],u={},H={},f=[],Y={},r=[],a={},t=null,o=!1;var X=function(){var n={},a=[],r={},s={},i={},t={};i.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}};var o={setModulePendingUpdated:function(e,t){n[e].pending_version=t,RED.events.emit("registry:module-updated",{module:e,version:t})},getModule:function(e){return n[e]},getNodeSetForType:function(e){return o.getNodeSet(s[e])},getModuleList:function(){return n},getNodeList:function(){return a},getNodeTypes:function(){return Object.keys(i)},setNodeList:function(e){a=[];for(var t=0;t<e.length;t++){var i=e[t];o.addNodeSet(i)}},addNodeSet:function(e){e.added=!1,r[e.id]=e;for(var t=0;t<e.types.length;t++)s[e.types[t]]=e.id;a.push(e),n[e.module]=n[e.module]||{name:e.module,version:e.version,local:e.local,sets:{}},e.pending_version&&(n[e.module].pending_version=e.pending_version),n[e.module].sets[e.name]=e,RED.events.emit("registry:node-set-added",e)},removeNodeSet:function(e){for(var t=r[e],i=0;i<t.types.length;i++)delete s[t.types[i]];delete r[e];for(var o=0;o<a.length;o++)if(a[o].id===e){a.splice(o,1);break}return delete n[t.module].sets[t.name],0===Object.keys(n[t.module].sets).length&&delete n[t.module],RED.events.emit("registry:node-set-removed",t),t},getNodeSet:function(e){return r[e]},enableNodeSet:function(e){var t=r[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=r[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var o;"subflow:"!=((i[e]=t).type=e).substring(0,8)&&(t.set=r[s[e]],r[s[e]].added=!0,r[s[e]].enabled=!0,o="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=o+":"+e[0]);var i=RED._.apply(null,e);return i===e[0]&&(i=t),i});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete i[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return i[e]},setIconSets:function(e){(t=e)["font-awesome"]=RED.nodes.fontAwesome.getIconList()},getIconSets:function(){return t}};return o}();function Q(){return(1+4294967295*Math.random()).toString(16)}function Z(e){if(0!==e.type.indexOf("subflow")?e._=e._def._:e._=RED._,"config"==e._def.category)H[e.id]=e;else{if(e.ports=[],e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.outputs)for(var t=0;t<e.outputs;t++)e.ports.push(t);if(e.dirty=!0,c(e),"subflows"==e._def.category&&void 0===e.i){var i=0;RED.nodes.eachNode(function(e){i=Math.max(i,e.i||0)}),e.i=i+1}p.push(e),u[e.z]?u[e.z][e.id]=e:console.warn("Node added to unknown tab/subflow:",e)}RED.events.emit("nodes:add",e)}function ee(e){f.push(e)}function h(e){if(e in H)return H[e];for(var t in p)if(p[t].id==e)return p[t];return null}function g(e){var t,i=[],o=[];if(e in H)t=H[e],delete H[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=h(e)){p.splice(p.indexOf(t),1),u[t.z]&&delete u[t.z][t.id],(i=f.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){f.splice(f.indexOf(e),1)});var a=!1;for(var r in t._def.defaults)if(t._def.defaults.hasOwnProperty(r)){var s=t._def.defaults[r];if(s.type){var d=X.getNodeType(s.type);if(d&&"config"==d.category){var l=H[t[r]];if(l)if(a=!0,l._def.exclusive)g(t[r]),o.push(l);else{var c=l.users;c.splice(c.indexOf(t),1)}}}}a&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:i,nodes:o}}function s(e){var t=f.indexOf(e);-1!=t&&f.splice(t,1)}function te(e,t){Y[e.id]=e,u[e.id]={},e._def=RED.nodes.getType("tab"),void 0===t?r.push(e.id):r.splice(t,0,e.id)}function ie(t,e){if(e){var i=Object.keys(a).map(function(e){return a[e].name});i.sort();var o=1,n=t.name;i.forEach(function(e){n==e&&(o++,n=t.name+" ("+o+")")}),t.name=n}a[t.id]=t,u[t.id]={},RED.nodes.registerType("subflow:"+t.id,{defaults:{name:{value:""},env:{value:[]}},icon:function(){return t.icon||"subflow.svg"},category:t.category||"subflows",inputs:t.in.length,outputs:t.out.length,color:t.color||"#DDAA99",label:function(){return this.name||RED.nodes.subflow(t.id).name},labelStyle:function(){return this.name?"red-ui-flow-node-label-italic":""},paletteLabel:function(){return RED.nodes.subflow(t.id).name},inputLabels:function(e){return t.inputLabels?t.inputLabels[e]:null},outputLabels:function(e){return t.outputLabels?t.outputLabels[e]:null},oneditresize:function(e){var t=e.height;$("ol.red-ui-editor-subflow-env-list").editableList("height",t)},set:{module:"node-red"}}),t._def=RED.nodes.getType("subflow:"+t.id)}function oe(e){return a[e]}function ne(e,t){for(var i=0;i<p.length;i++){var o=p[i];if(o.z===e){var n=/^subflow:(.+)$/.exec(o.type);if(n){if(n[1]===t)return!0;if(ne(n[1],t))return!0}}}return!1}function v(e){var t={};for(var i in t.id=e.id,t.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(i)&&(t[i]=e[i]);return t}function d(t,e){if("tab"===t.type)return v(t);e=e||!1;var i={};if(i.id=t.id,i.type=t.type,i.z=t.z,!0===t.d&&(i.d=!0),"unknown"==i.type)for(var o in t._orig)t._orig.hasOwnProperty(o)&&(i[o]=t._orig[o]);else{for(var n in t._def.defaults)t._def.defaults.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&t.credentials){var a={};for(var r in i.credentials={},t._def.credentials)t._def.credentials.hasOwnProperty(r)&&("password"==t._def.credentials[r].type?(!t.credentials._||t.credentials["has_"+r]!=t.credentials._["has_"+r]||t.credentials["has_"+r]&&t.credentials[r])&&(a[r]=t.credentials[r]):null==t.credentials[r]||t.credentials._&&t.credentials[r]==t.credentials._[r]||(a[r]=t.credentials[r]));0<Object.keys(a).length&&(i.credentials=a)}}if("config"!=t._def.category){i.x=t.x,i.y=t.y,i.wires=[];for(var s=0;s<t.outputs;s++)i.wires.push([]);for(var d=f.filter(function(e){return e.source===t}),l=0;l<d.length;l++){var c=d[l];"subflow"!=c.target.type&&c.sourcePort<i.wires.length&&i.wires[c.sourcePort].push(c.target.id)}if(0<t.inputs&&t.inputLabels&&!/^\s*$/.test(t.inputLabels.join(""))&&(i.inputLabels=t.inputLabels.slice()),0<t.outputs&&t.outputLabels&&!/^\s*$/.test(t.outputLabels.join(""))&&(i.outputLabels=t.outputLabels.slice()),(!t._def.defaults||!t._def.defaults.hasOwnProperty("icon"))&&t.icon){var p=RED.utils.getDefaultNodeIcon(t._def,t);t.icon!==p.module+"/"+p.file&&(i.icon=t.icon)}if((!t._def.defaults||!t._def.defaults.hasOwnProperty("l"))&&t.hasOwnProperty("l"))/^link (in|out)$/.test(i.type)==t.l&&(i.l=t.l)}return t.info&&(i.info=t.info),i}function b(a){var r={};return r.id=a.id,r.type=a.type,r.name=a.name,r.info=a.info,r.category=a.category,r.in=[],r.out=[],r.env=a.env,r.color=a.color,a.in.forEach(function(t){for(var e={x:t.x,y:t.y,wires:[]},i=f.filter(function(e){return e.source===t}),o=0;o<i.length;o++){var n=i[o];"subflow"!=n.target.type&&e.wires.push({id:n.target.id})}r.in.push(e)}),a.out.forEach(function(t,e){var o={x:t.x,y:t.y,wires:[]},n=f.filter(function(e){return e.target===t});for(i=0;i<n.length;i++)"subflow"!=n[i].source.type?o.wires.push({id:n[i].source.id,port:n[i].sourcePort}):o.wires.push({id:a.id,port:0});r.out.push(o)}),0<r.in.length&&a.inputLabels&&!/^\s*$/.test(a.inputLabels.join(""))&&(r.inputLabels=a.inputLabels.slice()),0<r.out.length&&a.outputLabels&&!/^\s*$/.test(a.outputLabels.join(""))&&(r.outputLabels=a.outputLabels.slice()),a.icon&&"node-red/subflow.svg"!==a.icon&&(r.icon=a.icon),a.status&&(r.status={x:a.status.x,y:a.status.y,wires:[]},f.forEach(function(e){e.target===a.status&&("subflow"!=e.source.type?r.status.wires.push({id:e.source.id,port:e.sourcePort}):r.status.wires.push({id:a.id,port:0}))})),r}function m(e,t,i){var o=[];i=i||{},t=t||{};for(var n=0;n<e.length;n++){var a=e[n];if("subflow:"==a.type.substring(0,8)){var r=a.type.substring(8);if(!t[r]){t[r]=!0;var s=[oe(r)];RED.nodes.eachNode(function(e){e.z==r&&s.push(e)}),o=m(s,t,i).concat(o)}}if("subflow"!=a.type){var d=RED.nodes.convertNode(a);for(var l in a._def.defaults)if(a._def.defaults[l].type&&a[l]in H){var c=H[a[l]],p=X.getNodeType(a._def.defaults[l].type).exportable;null==p||p?a[l]in i||(i[a[l]]=!0,e.push(c)):d[l]=""}o.push(d)}else{var u=b(a);o.push(u)}}return o}function ae(r,s){var d;s=s||[];var l=null;return RED.nodes.eachSubflow(function(e){if(e.name==r.name&&e.info==r.info&&e.in.length==r.in.length&&e.out.length==r.out.length){var t=RED.nodes.filterNodes({z:e.id});if(t.length==s.length){var i=[r].concat(s),o=[e].concat(t),n=JSON.stringify(i),a=JSON.stringify(m(o));for(d=0;d<t.length;d++)n=n.replace(new RegExp('"'+s[d].id+'"',"g"),'"'+t[d].id+'"');if((n=n.replace(new RegExp('"'+r.id+'"',"g"),'"'+e.id+'"'))===a)return l=e,!1}}}),l}function re(e,t,i){if(i&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var n in o.defaults)if(o.defaults.hasOwnProperty(n)){var a=e[n],r=t[n];if(typeof a!=typeof r)return!1;if(null===a||"string"==typeof a||"number"==typeof a){if(a!==r)return!1}else if(JSON.stringify(a)!==JSON.stringify(r))return!1}return!0}function l(e,t,i){var o,n,a,r={};if("string"==typeof e){if(""===e)return;try{a=JSON.parse(e)}catch(g){var s=new Error(RED._("clipboard.invalidFlow",{message:g.message}));throw s.code="NODE_RED",s}}else a=e;$.isArray(a)||(a=[a]);var d={};a=a.filter(function(e){return!d[e.id]&&(d[e.id]=!0)});var l=!1;K||(l=!0,K=JSON.parse(JSON.stringify(a)));var c=[];for(o=0;o<a.length;o++)"workspace"==(n=a[o]).type||"tab"==n.type||"subflow"==n.type||X.getNodeType(n.type)||"subflow:"==n.type.substring(0,8)||-1!=c.indexOf(n.type)||c.push(n.type),n.z&&(r[n.z]=r[n.z]||[],r[n.z].push(n));if(!l&&0<c.length){var p="<ul><li>"+c.join("</li><li>")+"</li></ul>";RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:c.length})+"</p>"+p,"error",!1,1e4)}var u=RED.workspaces.active(),f=oe(u);for(o=0;o<a.length;o++){var h=/^subflow:(.+)$/.exec(a[o].type);if(h){var g,v=h[1],b=oe(u);if(b)if(v===b.id&&(g=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),ne(v,b.id)&&(g=new Error(RED._("notification.errors.cannotAddCircularReference"))),g)throw g.code="NODE_RED",g}}var m,y,w,D,E=[],R={},x=[],k={},T={},_={},j=[],C=[],L=null;for(o=0;o<a.length;o++)if("workspace"===(n=a[o]).type||"tab"===n.type)"workspace"===n.type&&(n.type="tab"),null==W&&(W=n),t&&(m=Q(),R[n.id]=m,n.id=m),te(n),RED.workspaces.add(n),E.push(n);else if("subflow"===n.type){var S=ae(n,r[n.id]);S?T[n.id]=S:(k[n.id]=n,t&&(m=Q(),n.id=m),n.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=n.id,e.i=t,e.id=Q()}),n.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=n.id,e.i=t,e.id=Q()}),n.status&&(n.status.type="subflow",n.status.direction="status",n.status.z=n.id,n.status.id=Q()),x.push(n),ie(n,t))}for(null==W&&(te(W={type:"tab",id:Q(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(W),E.push(W),u=RED.workspaces.active()),o=0;o<a.length;o++)if(n=a[o],(y=X.getNodeType(n.type))&&"config"==y.category){var O=null;if(t){if(n.z){if(T[n.z])continue;k[n.z]?n.z=k[n.z].id:(n.z=R[n.z],Y[n.z]||(i?(null===L&&(L=RED.workspaces.add(null,!0),E.push(L)),n.z=L.id):n.z=u))}if((O=RED.nodes.node(n.id))&&n.z&&O.z!==n.z)for(var I in O=null,H)if(H.hasOwnProperty(I)&&H[I].z===n.z&&re(H[I],n,!1)){O=H[I],_[n.id]=H[I];break}}if(!O||O._def.exclusive){for(D in w={id:n.id,z:n.z,type:n.type,info:n.info,users:[],_config:{}},n.hasOwnProperty("d")&&(w.d=n.d),y.defaults)y.defaults.hasOwnProperty(D)&&(w[D]=n[D],w._config[D]=JSON.stringify(n[D]));if(y.hasOwnProperty("credentials")&&n.hasOwnProperty("credentials"))for(D in w.credentials={},y.credentials)y.credentials.hasOwnProperty(D)&&n.credentials.hasOwnProperty(D)&&(w.credentials[D]=n.credentials[D]);w.label=y.label,w._def=y,t&&(w.id=Q()),_[n.id]=w,j.push(w),RED.nodes.add(w)}}for(o=0;o<a.length;o++)if("workspace"!==(n=a[o]).type&&"tab"!==n.type&&"subflow"!==n.type&&(!(y=X.getNodeType(n.type))||"config"!=y.category)){var P={x:parseFloat(n.x||0),y:parseFloat(n.y||0),z:n.z,type:0,wires:n.wires||[],inputLabels:n.inputLabels,outputLabels:n.outputLabels,icon:n.icon,info:n.info,changed:!1,_config:{}};if(n.hasOwnProperty("l")&&(P.l=n.l),n.hasOwnProperty("d")&&(P.d=n.d),t){if(T[n.z])continue;k[P.z]?P.z=k[P.z].id:(P.z=R[P.z],Y[P.z]||(i?(null===L&&(L=RED.workspaces.add(null,!0),E.push(L)),P.z=L.id):P.z=u)),P.id=Q()}else P.id=n.id,null!=P.z&&(Y[P.z]||k[P.z])||(i?(null===L&&(L=RED.workspaces.add(null,!0),E.push(L)),P.z=L.id):P.z=u);if(P.type=n.type,P._def=y,"subflow"===n.type.substring(0,7)){var N=n.type.split(":")[1],A=T[N]||k[N]||oe(N);t&&(N=A.id,P.type="subflow:"+N,P._def=X.getNodeType(P.type),delete P.i),P.name=n.name,P.outputs=A.out.length,P.inputs=A.in.length,P.env=n.env}else{if(!P._def){P.x&&P.y?P._def={color:"#fee",defaults:{},label:"unknown: "+n.type,labelStyle:"red-ui-flow-node-label-italic",outputs:n.outputs||n.wires.length,set:X.getNodeSet("node-red/unknown")}:(P._def={category:"config",set:X.getNodeSet("node-red/unknown")},P.users=[],delete P.x,delete P.y,delete P.wires,delete P.inputLabels,delete P.outputLabels);var z={};for(var M in n)n.hasOwnProperty(M)&&"x"!=M&&"y"!=M&&"z"!=M&&"id"!=M&&"wires"!=M&&(z[M]=n[M]);P._orig=z,P.name=n.type,P.type="unknown"}if("config"!=P._def.category){for(D in n.hasOwnProperty("inputs")?(P.inputs=n.inputs,P._config.inputs=JSON.stringify(n.inputs)):P.inputs=P._def.inputs,n.hasOwnProperty("outputs")?(P.outputs=n.outputs,P._config.outputs=JSON.stringify(n.outputs)):P.outputs=P._def.outputs,P.hasOwnProperty("wires")&&P.wires.length>P.outputs&&(P._def.defaults.hasOwnProperty("outputs")&&isNaN(parseInt(n.outputs))?P.outputs=P.wires.length:(console.log("Warning: node.wires longer than node.outputs - trimming wires:",P.id," wires:",P.wires.length," outputs:",P.outputs),P.wires=P.wires.slice(0,P.outputs))),P._def.defaults)P._def.defaults.hasOwnProperty(D)&&"inputs"!==D&&"outputs"!==D&&(P[D]=n[D],P._config[D]=JSON.stringify(n[D]));if(P._config.x=P.x,P._config.y=P.y,P._def.hasOwnProperty("credentials")&&n.hasOwnProperty("credentials"))for(D in P.credentials={},P._def.credentials)P._def.credentials.hasOwnProperty(D)&&n.credentials.hasOwnProperty(D)&&(P.credentials[D]=n.credentials[D])}}Z(P),RED.editor.validateNode(P),"unknown"!==(_[n.id]=P).type&&"config"===P._def.category||j.push(P)}var B={catch:"scope",status:"scope",complete:"scope","link in":"links","link out":"links"};for(o=0;o<j.length;o++){if((n=j[o]).wires){for(var U=0;U<n.wires.length;U++)for(var q=n.wires[U]instanceof Array?n.wires[U]:[n.wires[U]],F=0;F<q.length;F++)if(_.hasOwnProperty(q[F]))if(n.z===_[q[F]].z){var J={source:n,sourcePort:U,target:_[q[F]]};ee(J),C.push(J)}else console.log("Warning: dropping link that crosses tabs:",n.id,"->",_[q[F]].id);delete n.wires}for(var G in n._def.defaults)if(n._def.defaults.hasOwnProperty(G))if(n._def.defaults[G].type&&_[n[G]])n[G]=_[n[G]].id,(w=RED.nodes.node(n[G]))&&-1===w.users.indexOf(n)&&w.users.push(n);else if(B.hasOwnProperty(n.type)&&B[n.type]===G&&void 0!==n[G]&&null!==n[G])for(var V=0;V<n[G].length;V++)_[n[G][V]]&&(n[G][V]=_[n[G][V]].id);f&&/^link /.test(n.type)&&n.links&&(n.links=n.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===u})),RED.editor.validateNode(n)}for(o=0;o<x.length;o++)(n=x[o]).in.forEach(function(i){i.wires.forEach(function(e){var t={source:i,sourcePort:0,target:_[e.id]};ee(t),C.push(t)}),delete i.wires}),n.out.forEach(function(i){i.wires.forEach(function(e){var t;ee(t=k[e.id]&&k[e.id].id==n.id?{source:n.in[e.port],sourcePort:e.port,target:i}:{source:_[e.id]||k[e.id],sourcePort:e.port,target:i}),C.push(t)}),delete i.wires}),n.status&&(n.status.wires.forEach(function(e){var t;ee(t=k[e.id]&&k[e.id].id==n.id?{source:n.in[e.port],sourcePort:e.port,target:n.status}:{source:_[e.id]||k[e.id],sourcePort:e.port,target:n.status}),C.push(t)}),delete n.status.wires);return RED.workspaces.refresh(),[j,C,E,x,L]}function c(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var i=e._def.defaults[t];if(i.type){var o=X.getNodeType(i.type);if(o&&"config"==o.category){var n=H[e[t]];n&&-1===n.users.indexOf(e)&&n.users.push(e)}}}}return{init:function(){RED.events.on("registry:node-type-added",function(t){X.getNodeType(t);var i={};RED.nodes.eachNode(function(e){"unknown"===e.type&&e.name===t&&(i[e.id]=e)}),RED.nodes.eachConfig(function(e){"unknown"===e.type&&e.name===t&&(i[e.id]=e)});var e=Object.keys(i);if(0<e.length){var o=[];e.forEach(function(e){var t=i[e];H.hasOwnProperty(t.id)?delete H[t.id]:p.splice(p.indexOf(t),1),o.push(d(t))});var n=[];RED.nodes.eachLink(function(e){i.hasOwnProperty(e.source.id)&&i.hasOwnProperty(e.target.id)&&n.push(e)}),n.forEach(s),RED.view.redraw(!0);var a=l(o,!1),r={};a[0].forEach(function(e){r[e.id]=e}),RED.nodes.eachLink(function(e){r.hasOwnProperty(e.source.id)&&(e.source=r[e.source.id]),r.hasOwnProperty(e.target.id)&&(e.target=r[e.target.id])}),RED.view.redraw(!0)}})},registry:X,setNodeList:X.setNodeList,getNodeSet:X.getNodeSet,addNodeSet:X.addNodeSet,removeNodeSet:X.removeNodeSet,enableNodeSet:X.enableNodeSet,disableNodeSet:X.disableNodeSet,setIconSets:X.setIconSets,getIconSets:X.getIconSets,registerType:X.registerNodeType,getType:X.getNodeType,convertNode:d,add:Z,remove:g,clear:function(){p=[],f=[],u={},H={},r=[],Object.keys(a).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(Y).forEach(function(e){RED.workspaces.remove(Y[e])}),K=W=null,RED.nodes.dirty(!1),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh()},moveNodeToTab:function(e,t){u[e.z]&&delete u[e.z][e.id],u[t]||(u[t]={}),(u[t][e.id]=e).z=t},addLink:ee,removeLink:s,addWorkspace:te,removeWorkspace:function(e){delete Y[e],delete u[e],r.splice(r.indexOf(e),1);var t,i,o=[],n=[];for(t=0;t<p.length;t++)(i=p[t]).z==e&&o.push(i);for(t in H)H.hasOwnProperty(t)&&(i=H[t]).z==e&&o.push(i);for(t=0;t<o.length;t++){var a=g(o[t].id);n=n.concat(a.links)}return{nodes:o,links:n}},getWorkspaceOrder:function(){return r},setWorkspaceOrder:function(e){r=e},workspace:function(e){return Y[e]},addSubflow:ie,removeSubflow:function(e){delete a[e.id],delete u[e.id],X.removeNodeType("subflow:"+e.id)},subflow:oe,subflowContains:ne,eachNode:function(e){for(var t=0;t<p.length&&!1!==e(p[t]);t++);},eachLink:function(e){for(var t=0;t<f.length&&!1!==e(f[t]);t++);},eachConfig:function(e){for(var t in H)if(H.hasOwnProperty(t)&&!1===e(H[t]))break},eachSubflow:function(e){for(var t in a)if(a.hasOwnProperty(t)&&!1===e(a[t]))break},eachWorkspace:function(e){for(var t=0;t<r.length&&!1!==e(Y[r[t]]);t++);},node:h,version:function(e){if(void 0===e)return t;t=e},originalFlow:function(e){if(void 0===e)return K;K=e},filterNodes:function(e){var t=[],i=p,o=!1;e.hasOwnProperty("z")&&(Object.hasOwnProperty("values")&&u.hasOwnProperty(e.z)?i=Object.values(u[e.z]):o=!0);for(var n=0;n<i.length;n++){var a=i[n];e.hasOwnProperty("type")&&a.type!==e.type||o&&a.z!==e.z||t.push(a)}return t},filterLinks:function(e){for(var t=[],i=0;i<f.length;i++){var o=f[i];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||t.push(o)}return t},import:l,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var i=[e],o=[e];0!==o.length;)for(var n=o.shift(),a=f.filter(function(e){return e.source===n||e.target===n}),r=0;r<a.length;r++){var s=a[r].source===n?a[r].target:a[r].source,d=s.id;t[d=d||s.direction+":"+s.i]||(t[d]=!0,i.push(s),o.push(s))}return i},createExportableNodeSet:m,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,i=[];for(t=0;t<r.length;t++)"tab"==Y[r[t]].type&&i.push(v(Y[r[t]]));for(t in a)a.hasOwnProperty(t)&&i.push(b(a[t]));for(t in H)H.hasOwnProperty(t)&&i.push(d(H[t],e));for(t=0;t<p.length;t++){var o=p[t];i.push(d(o,e))}return i},updateConfigNodeUsers:c,id:Q,dirty:function(e){if(null==e)return o;!function(e){o=e,RED.events.emit("nodes:change",{dirty:o})}(e)}}}(),RED.nodes.fontAwesome=function(){var i={"fa-address-book-o":"","fa-address-book":"","fa-address-card-o":"","fa-address-card":"","fa-adjust":"","fa-align-center":"","fa-align-justify":"","fa-align-left":"","fa-align-right":"","fa-ambulance":"","fa-american-sign-language-interpreting":"","fa-anchor":"","fa-angle-double-down":"","fa-angle-double-left":"","fa-angle-double-right":"","fa-angle-double-up":"","fa-angle-down":"","fa-angle-left":"","fa-angle-right":"","fa-angle-up":"","fa-archive":"","fa-area-chart":"","fa-arrow-circle-down":"","fa-arrow-circle-left":"","fa-arrow-circle-o-down":"","fa-arrow-circle-o-left":"","fa-arrow-circle-o-right":"","fa-arrow-circle-o-up":"","fa-arrow-circle-right":"","fa-arrow-circle-up":"","fa-arrow-down":"","fa-arrow-left":"","fa-arrow-right":"","fa-arrow-up":"","fa-arrows-alt":"","fa-arrows-h":"","fa-arrows-v":"","fa-arrows":"","fa-asl-interpreting":"","fa-assistive-listening-systems":"","fa-asterisk":"","fa-at":"","fa-audio-description":"","fa-automobile":"","fa-backward":"","fa-balance-scale":"","fa-ban":"","fa-bank":"","fa-bar-chart-o":"","fa-bar-chart":"","fa-barcode":"","fa-bars":"","fa-bath":"","fa-bathtub":"","fa-battery-0":"","fa-battery-1":"","fa-battery-2":"","fa-battery-3":"","fa-battery-4":"","fa-battery-empty":"","fa-battery-full":"","fa-battery-half":"","fa-battery-quarter":"","fa-battery-three-quarters":"","fa-battery":"","fa-bed":"","fa-beer":"","fa-bell-o":"","fa-bell-slash-o":"","fa-bell-slash":"","fa-bell":"","fa-bicycle":"","fa-binoculars":"","fa-birthday-cake":"","fa-blind":"","fa-bold":"","fa-bolt":"","fa-bomb":"","fa-book":"","fa-bookmark-o":"","fa-bookmark":"","fa-braille":"","fa-briefcase":"","fa-bug":"","fa-building-o":"","fa-building":"","fa-bullhorn":"","fa-bullseye":"","fa-bus":"","fa-cab":"","fa-calculator":"","fa-calendar-check-o":"","fa-calendar-minus-o":"","fa-calendar-o":"","fa-calendar-plus-o":"","fa-calendar-times-o":"","fa-calendar":"","fa-camera-retro":"","fa-camera":"","fa-car":"","fa-caret-down":"","fa-caret-left":"","fa-caret-right":"","fa-caret-square-o-down":"","fa-caret-square-o-left":"","fa-caret-square-o-right":"","fa-caret-square-o-up":"","fa-caret-up":"","fa-cart-arrow-down":"","fa-cart-plus":"","fa-cc":"","fa-certificate":"","fa-chain-broken":"","fa-chain":"","fa-check-circle-o":"","fa-check-circle":"","fa-check-square-o":"","fa-check-square":"","fa-check":"","fa-chevron-circle-down":"","fa-chevron-circle-left":"","fa-chevron-circle-right":"","fa-chevron-circle-up":"","fa-chevron-down":"","fa-chevron-left":"","fa-chevron-right":"","fa-chevron-up":"","fa-child":"","fa-circle-o-notch":"","fa-circle-o":"","fa-circle-thin":"","fa-circle":"","fa-clipboard":"","fa-clock-o":"","fa-clone":"","fa-close":"","fa-cloud-download":"","fa-cloud-upload":"","fa-cloud":"","fa-cny":"","fa-code-fork":"","fa-code":"","fa-coffee":"","fa-cog":"","fa-cogs":"","fa-columns":"","fa-comment-o":"","fa-comment":"","fa-commenting-o":"","fa-commenting":"","fa-comments-o":"","fa-comments":"","fa-compass":"","fa-compress":"","fa-copy":"","fa-copyright":"","fa-creative-commons":"","fa-credit-card-alt":"","fa-credit-card":"","fa-crop":"","fa-crosshairs":"","fa-cube":"","fa-cubes":"","fa-cut":"","fa-cutlery":"","fa-dashboard":"","fa-database":"","fa-deaf":"","fa-deafness":"","fa-dedent":"","fa-desktop":"","fa-diamond":"","fa-dollar":"","fa-dot-circle-o":"","fa-download":"","fa-drivers-license-o":"","fa-drivers-license":"","fa-edit":"","fa-eject":"","fa-ellipsis-h":"","fa-ellipsis-v":"","fa-envelope-o":"","fa-envelope-open-o":"","fa-envelope-open":"","fa-envelope-square":"","fa-envelope":"","fa-eraser":"","fa-eur":"","fa-euro":"","fa-exchange":"","fa-exclamation-circle":"","fa-exclamation-triangle":"","fa-exclamation":"","fa-expand":"","fa-external-link-square":"","fa-external-link":"","fa-eye-slash":"","fa-eye":"","fa-eyedropper":"","fa-fast-backward":"","fa-fast-forward":"","fa-fax":"","fa-feed":"","fa-female":"","fa-fighter-jet":"","fa-file-archive-o":"","fa-file-audio-o":"","fa-file-code-o":"","fa-file-excel-o":"","fa-file-image-o":"","fa-file-movie-o":"","fa-file-o":"","fa-file-pdf-o":"","fa-file-photo-o":"","fa-file-picture-o":"","fa-file-powerpoint-o":"","fa-file-sound-o":"","fa-file-text-o":"","fa-file-text":"","fa-file-video-o":"","fa-file-word-o":"","fa-file-zip-o":"","fa-file":"","fa-files-o":"","fa-film":"","fa-filter":"","fa-fire-extinguisher":"","fa-fire":"","fa-flag-checkered":"","fa-flag-o":"","fa-flag":"","fa-flash":"","fa-flask":"","fa-floppy-o":"","fa-folder-o":"","fa-folder-open-o":"","fa-folder-open":"","fa-folder":"","fa-font":"","fa-forward":"","fa-frown-o":"","fa-futbol-o":"","fa-gamepad":"","fa-gavel":"","fa-gbp":"","fa-gear":"","fa-gears":"","fa-genderless":"","fa-gift":"","fa-glass":"","fa-globe":"","fa-graduation-cap":"","fa-group":"","fa-h-square":"","fa-hand-grab-o":"","fa-hand-lizard-o":"","fa-hand-o-down":"","fa-hand-o-left":"","fa-hand-o-right":"","fa-hand-o-up":"","fa-hand-paper-o":"","fa-hand-peace-o":"","fa-hand-pointer-o":"","fa-hand-rock-o":"","fa-hand-scissors-o":"","fa-hand-spock-o":"","fa-hand-stop-o":"","fa-handshake-o":"","fa-hard-of-hearing":"","fa-hashtag":"","fa-hdd-o":"","fa-header":"","fa-headphones":"","fa-heart-o":"","fa-heart":"","fa-heartbeat":"","fa-history":"","fa-home":"","fa-hospital-o":"","fa-hotel":"","fa-hourglass-1":"","fa-hourglass-2":"","fa-hourglass-3":"","fa-hourglass-end":"","fa-hourglass-half":"","fa-hourglass-o":"","fa-hourglass-start":"","fa-hourglass":"","fa-i-cursor":"","fa-id-badge":"","fa-id-card-o":"","fa-id-card":"","fa-ils":"","fa-image":"","fa-inbox":"","fa-indent":"","fa-industry":"","fa-info-circle":"","fa-info":"","fa-inr":"","fa-institution":"","fa-intersex":"","fa-italic":"","fa-jpy":"","fa-key":"","fa-keyboard-o":"","fa-krw":"","fa-language":"","fa-laptop":"","fa-leaf":"","fa-legal":"","fa-lemon-o":"","fa-level-down":"","fa-level-up":"","fa-life-bouy":"","fa-life-buoy":"","fa-life-ring":"","fa-life-saver":"","fa-lightbulb-o":"","fa-line-chart":"","fa-link":"","fa-list-alt":"","fa-list-ol":"","fa-list-ul":"","fa-list":"","fa-location-arrow":"","fa-lock":"","fa-long-arrow-down":"","fa-long-arrow-left":"","fa-long-arrow-right":"","fa-long-arrow-up":"","fa-low-vision":"","fa-magic":"","fa-magnet":"","fa-mail-forward":"","fa-mail-reply-all":"","fa-mail-reply":"","fa-male":"","fa-map-marker":"","fa-map-o":"","fa-map-pin":"","fa-map-signs":"","fa-map":"","fa-mars-double":"","fa-mars-stroke-h":"","fa-mars-stroke-v":"","fa-mars-stroke":"","fa-mars":"","fa-medkit":"","fa-meh-o":"","fa-mercury":"","fa-microchip":"","fa-microphone-slash":"","fa-microphone":"","fa-minus-circle":"","fa-minus-square-o":"","fa-minus-square":"","fa-minus":"","fa-mobile-phone":"","fa-mobile":"","fa-money":"","fa-moon-o":"","fa-mortar-board":"","fa-motorcycle":"","fa-mouse-pointer":"","fa-music":"","fa-navicon":"","fa-neuter":"","fa-newspaper-o":"","fa-object-group":"","fa-object-ungroup":"","fa-outdent":"","fa-paint-brush":"","fa-paper-plane-o":"","fa-paper-plane":"","fa-paperclip":"","fa-paragraph":"","fa-paste":"","fa-pause-circle-o":"","fa-pause-circle":"","fa-pause":"","fa-paw":"","fa-pencil-square-o":"","fa-pencil-square":"","fa-pencil":"","fa-percent":"","fa-phone-square":"","fa-phone":"","fa-photo":"","fa-picture-o":"","fa-pie-chart":"","fa-plane":"","fa-play-circle-o":"","fa-play-circle":"","fa-play":"","fa-plug":"","fa-plus-circle":"","fa-plus-square-o":"","fa-plus-square":"","fa-plus":"","fa-podcast":"","fa-power-off":"","fa-print":"","fa-puzzle-piece":"","fa-qrcode":"","fa-question-circle-o":"","fa-question-circle":"","fa-question":"","fa-quote-left":"","fa-quote-right":"","fa-random":"","fa-recycle":"","fa-refresh":"","fa-registered":"","fa-remove":"","fa-reorder":"","fa-repeat":"","fa-reply-all":"","fa-reply":"","fa-retweet":"","fa-rmb":"","fa-road":"","fa-rocket":"","fa-rotate-left":"","fa-rotate-right":"","fa-rouble":"","fa-rss-square":"","fa-rss":"","fa-rub":"","fa-ruble":"","fa-rupee":"","fa-s15":"","fa-save":"","fa-scissors":"","fa-search-minus":"","fa-search-plus":"","fa-search":"","fa-send-o":"","fa-send":"","fa-server":"","fa-share-square-o":"","fa-share-square":"","fa-share":"","fa-shekel":"","fa-sheqel":"","fa-shield":"","fa-ship":"","fa-shopping-bag":"","fa-shopping-basket":"","fa-shopping-cart":"","fa-shower":"","fa-sign-in":"","fa-sign-language":"","fa-sign-out":"","fa-signal":"","fa-signing":"","fa-sitemap":"","fa-sliders":"","fa-smile-o":"","fa-snowflake-o":"","fa-soccer-ball-o":"","fa-sort-alpha-asc":"","fa-sort-alpha-desc":"","fa-sort-amount-asc":"","fa-sort-amount-desc":"","fa-sort-asc":"","fa-sort-desc":"","fa-sort-down":"","fa-sort-numeric-asc":"","fa-sort-numeric-desc":"","fa-sort-up":"","fa-sort":"","fa-space-shuttle":"","fa-spinner":"","fa-spoon":"","fa-square-o":"","fa-square":"","fa-star-half-empty":"","fa-star-half-full":"","fa-star-half-o":"","fa-star-half":"","fa-star-o":"","fa-star":"","fa-step-backward":"","fa-step-forward":"","fa-stethoscope":"","fa-sticky-note-o":"","fa-sticky-note":"","fa-stop-circle-o":"","fa-stop-circle":"","fa-stop":"","fa-street-view":"","fa-strikethrough":"","fa-subscript":"","fa-subway":"","fa-suitcase":"","fa-sun-o":"","fa-superscript":"","fa-support":"","fa-table":"","fa-tablet":"","fa-tachometer":"","fa-tag":"","fa-tags":"","fa-tasks":"","fa-taxi":"","fa-television":"","fa-terminal":"","fa-text-height":"","fa-text-width":"","fa-th-large":"","fa-th-list":"","fa-th":"","fa-thermometer-0":"","fa-thermometer-1":"","fa-thermometer-2":"","fa-thermometer-3":"","fa-thermometer-4":"","fa-thermometer-empty":"","fa-thermometer-full":"","fa-thermometer-half":"","fa-thermometer-quarter":"","fa-thermometer-three-quarters":"","fa-thermometer":"","fa-thumb-tack":"","fa-thumbs-down":"","fa-thumbs-o-down":"","fa-thumbs-o-up":"","fa-thumbs-up":"","fa-ticket":"","fa-times-circle-o":"","fa-times-circle":"","fa-times-rectangle-o":"","fa-times-rectangle":"","fa-times":"","fa-tint":"","fa-toggle-down":"","fa-toggle-left":"","fa-toggle-off":"","fa-toggle-on":"","fa-toggle-right":"","fa-toggle-up":"","fa-trademark":"","fa-train":"","fa-transgender-alt":"","fa-transgender":"","fa-trash-o":"","fa-trash":"","fa-tree":"","fa-trophy":"","fa-truck":"","fa-try":"","fa-tty":"","fa-turkish-lira":"","fa-tv":"","fa-umbrella":"","fa-underline":"","fa-undo":"","fa-universal-access":"","fa-university":"","fa-unlink":"","fa-unlock-alt":"","fa-unlock":"","fa-unsorted":"","fa-upload":"","fa-usd":"","fa-user-circle-o":"","fa-user-circle":"","fa-user-md":"","fa-user-o":"","fa-user-plus":"","fa-user-secret":"","fa-user-times":"","fa-user":"","fa-users":"","fa-vcard-o":"","fa-vcard":"","fa-venus-double":"","fa-venus-mars":"","fa-venus":"","fa-video-camera":"","fa-volume-control-phone":"","fa-volume-down":"","fa-volume-off":"","fa-volume-up":"","fa-warning":"","fa-wheelchair-alt":"","fa-wheelchair":"","fa-wifi":"","fa-window-close-o":"","fa-window-close":"","fa-window-maximize":"","fa-window-minimize":"","fa-window-restore":"","fa-won":"","fa-wrench":"","fa-yen":""},t={"fa-500px":"","fa-adn":"","fa-amazon":"","fa-android":"","fa-angellist":"","fa-apple":"","fa-bandcamp":"","fa-behance-square":"","fa-behance":"","fa-bitbucket-square":"","fa-bitbucket":"","fa-bitcoin":"","fa-black-tie":"","fa-bluetooth-b":"","fa-bluetooth":"","fa-btc":"","fa-buysellads":"","fa-cc-amex":"","fa-cc-diners-club":"","fa-cc-discover":"","fa-cc-jcb":"","fa-cc-mastercard":"","fa-cc-paypal":"","fa-cc-stripe":"","fa-cc-visa":"","fa-chrome":"","fa-codepen":"","fa-codiepie":"","fa-connectdevelop":"","fa-contao":"","fa-css3":"","fa-dashcube":"","fa-delicious":"","fa-deviantart":"","fa-digg":"","fa-dribbble":"","fa-dropbox":"","fa-drupal":"","fa-edge":"","fa-eercast":"","fa-empire":"","fa-envira":"","fa-etsy":"","fa-expeditedssl":"","fa-fa":"","fa-facebook-f":"","fa-facebook-official":"","fa-facebook-square":"","fa-facebook":"","fa-firefox":"","fa-first-order":"","fa-flickr":"","fa-font-awesome":"","fa-fonticons":"","fa-fort-awesome":"","fa-forumbee":"","fa-foursquare":"","fa-free-code-camp":"","fa-ge":"","fa-get-pocket":"","fa-gg-circle":"","fa-gg":"","fa-git-square":"","fa-git":"","fa-github-alt":"","fa-github-square":"","fa-github":"","fa-gitlab":"","fa-gittip":"","fa-glide-g":"","fa-glide":"","fa-google-plus-circle":"","fa-google-plus-official":"","fa-google-plus-square":"","fa-google-plus":"","fa-google-wallet":"","fa-google":"","fa-gratipay":"","fa-grav":"","fa-hacker-news":"","fa-houzz":"","fa-html5":"","fa-imdb":"","fa-instagram":"","fa-internet-explorer":"","fa-ioxhost":"","fa-joomla":"","fa-jsfiddle":"","fa-lastfm-square":"","fa-lastfm":"","fa-leanpub":"","fa-linkedin-square":"","fa-linkedin":"","fa-linode":"","fa-linux":"","fa-maxcdn":"","fa-meanpath":"","fa-medium":"","fa-meetup":"","fa-mixcloud":"","fa-modx":"","fa-odnoklassniki-square":"","fa-odnoklassniki":"","fa-opencart":"","fa-openid":"","fa-opera":"","fa-optin-monster":"","fa-pagelines":"","fa-paypal":"","fa-pied-piper-alt":"","fa-pied-piper-pp":"","fa-pied-piper":"","fa-pinterest-p":"","fa-pinterest-square":"","fa-pinterest":"","fa-product-hunt":"","fa-qq":"","fa-quora":"","fa-ra":"","fa-ravelry":"","fa-rebel":"","fa-reddit-alien":"","fa-reddit-square":"","fa-reddit":"","fa-renren":"","fa-resistance":"","fa-safari":"","fa-scribd":"","fa-sellsy":"","fa-share-alt-square":"","fa-share-alt":"","fa-shirtsinbulk":"","fa-simplybuilt":"","fa-skyatlas":"","fa-skype":"","fa-slack":"","fa-slideshare":"","fa-snapchat-ghost":"","fa-snapchat-square":"","fa-snapchat":"","fa-soundcloud":"","fa-spotify":"","fa-stack-exchange":"","fa-stack-overflow":"","fa-steam-square":"","fa-steam":"","fa-stumbleupon-circle":"","fa-stumbleupon":"","fa-superpowers":"","fa-telegram":"","fa-tencent-weibo":"","fa-themeisle":"","fa-trello":"","fa-tripadvisor":"","fa-tumblr-square":"","fa-tumblr":"","fa-twitch":"","fa-twitter-square":"","fa-twitter":"","fa-usb":"","fa-viacoin":"","fa-viadeo-square":"","fa-viadeo":"","fa-vimeo-square":"","fa-vimeo":"","fa-vine":"","fa-vk":"","fa-wechat":"","fa-weibo":"","fa-weixin":"","fa-whatsapp":"","fa-wikipedia-w":"","fa-windows":"","fa-wordpress":"","fa-wpbeginner":"","fa-wpexplorer":"","fa-wpforms":"","fa-xing-square":"","fa-xing":"","fa-y-combinator-square":"","fa-y-combinator":"","fa-yahoo":"","fa-yc-square":"","fa-yc":"","fa-yelp":"","fa-yoast":"","fa-youtube-play":"","fa-youtube-square":"","fa-youtube":""},o=[],n={};return Object.keys(i).forEach(function(e){var t=i[e];!0!==n[t]&&(o.push(e),n[t]=!0)}),n=void 0,{getIconUnicode:function(e){return i[e]||t[e]},getIconList:function(){return o}}}(),RED.history=function(){var i=[],o=[];function m(t){var e,i,o,n,a={};if(t){if("multi"==t.t)for(n={t:"multi",events:[]},e=t.events.length-1;0<=e;e--){var r=m(t.events[e]);n.events.push(r)}else if("replace"==t.t){n={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:[],rev:RED.nodes.version()},RED.nodes.clear(),RED.nodes.import(t.config)[0].forEach(function(e){t.changed[e.id]&&(e.changed=!0,n.changed[e.id]=!0)}),RED.nodes.version(t.rev)}else if("add"==t.t){if(n={t:"delete"},t.nodes)for(n.nodes=[],e=0;e<t.nodes.length;e++)(i=RED.nodes.node(t.nodes[e])).z&&(a[i.z]=!0),n.nodes.push(i),RED.nodes.remove(t.nodes[e]);if(t.links)for(n.links=[],e=0;e<t.links.length;e++)n.links.push(t.links[e]),RED.nodes.removeLink(t.links[e]);if(t.workspaces)for(n.workspaces=[],e=0;e<t.workspaces.length;e++){var s=RED.nodes.getWorkspaceOrder();t.workspaces[e]._index=s.indexOf(t.workspaces[e].id),n.workspaces.push(t.workspaces[e]),RED.nodes.removeWorkspace(t.workspaces[e].id),RED.workspaces.remove(t.workspaces[e])}if(t.subflows)for(n.subflows=[],e=0;e<t.subflows.length;e++)n.subflows.push(t.subflows[e]),RED.nodes.removeSubflow(t.subflows[e]),RED.workspaces.remove(t.subflows[e]);if(t.subflow&&(n.subflow={},t.subflow.instances&&(n.subflow.instances=[],t.subflow.instances.forEach(function(e){n.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)})),t.subflow.hasOwnProperty("changed")&&(o=RED.nodes.subflow(t.subflow.id))&&(o.changed=t.subflow.changed)),t.removedLinks)for(n.createdLinks=[],e=0;e<t.removedLinks.length;e++)n.createdLinks.push(t.removedLinks[e]),RED.nodes.addLink(t.removedLinks[e])}else if("delete"==t.t){if(n={t:"add"},t.workspaces)for(n.workspaces=[],e=0;e<t.workspaces.length;e++)n.workspaces.push(t.workspaces[e]),RED.nodes.addWorkspace(t.workspaces[e],t.workspaces[e]._index),RED.workspaces.add(t.workspaces[e],void 0,t.workspaces[e]._index),delete t.workspaces[e]._index;if(t.subflows)for(n.subflows=[],e=0;e<t.subflows.length;e++)n.subflows.push(t.subflows[e]),RED.nodes.addSubflow(t.subflows[e]);if(t.subflowInputs&&0<t.subflowInputs.length&&((o=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),o.in[0].dirty=!0),t.subflowOutputs&&0<t.subflowOutputs.length)for(o=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),e=0;e<t.subflowOutputs.length;e++){var d=t.subflowOutputs[e];o.out.splice(d.i,0,d);for(var l=d.i+1;l<o.out.length;l++)o.out[l].i++,o.out[l].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+o.id&&e.sourcePort>=d.i&&e.sourcePort++})}if(t.subflow&&(n.subflow={},t.subflow.hasOwnProperty("instances")&&(n.subflow.instances=[],t.subflow.instances.forEach(function(e){n.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)})),t.subflow.hasOwnProperty("status")&&((o=RED.nodes.subflow(t.subflow.id)).status=t.subflow.status)),o&&RED.nodes.filterNodes({type:"subflow:"+o.id}).forEach(function(e){for(e.inputs=o.in.length,e.outputs=o.out.length;e.outputs>e.ports.length;)e.ports.push(e.ports.length);e.resize=!0,e.dirty=!0}),t.nodes)for(n.nodes=[],e=0;e<t.nodes.length;e++)RED.nodes.add(t.nodes[e]),a[t.nodes[e].z]=!0,n.nodes.push(t.nodes[e].id);if(t.links)for(n.links=[],e=0;e<t.links.length;e++)RED.nodes.addLink(t.links[e]),n.links.push(t.links[e]);if(t.createdLinks)for(n.removedLinks=[],e=0;e<t.createdLinks.length;e++)n.removedLinks.push(t.createdLinks[e]),RED.nodes.removeLink(t.createdLinks[e]);if(t.changes)for(e in t.changes)if(t.changes.hasOwnProperty(e)&&(i=RED.nodes.node(e))){for(var c in t.changes[e])t.changes[e].hasOwnProperty(c)&&(i[c]=t.changes[e][c]);i.dirty=!0}}else if("move"==t.t){for(n={t:"move",nodes:[]},e=0;e<t.nodes.length;e++){var p=t.nodes[e],u={n:p.n,ox:p.n.x,oy:p.n.y,dirty:!0,moved:p.moved};n.nodes.push(u),p.n.x=p.ox,p.n.y=p.oy,p.n.dirty=!0,p.n.moved=p.moved}if(t.links)for(n.removedLinks=[],e=0;e<t.links.length;e++)n.removedLinks.push(t.links[e]),RED.nodes.removeLink(t.links[e]);if(t.removedLinks)for(n.links=[],e=0;e<t.removedLinks.length;e++)n.links.push(t.removedLinks[e]),RED.nodes.addLink(t.removedLinks[e])}else if("edit"==t.t){for(e in(n={t:"edit",changes:{}}).node=t.node,t.changes)if(t.changes.hasOwnProperty(e)){if(n.changes[e]=t.node[e],t.node._def.defaults&&t.node._def.defaults[e]&&t.node._def.defaults[e].type){var f=RED.nodes.node(t.node[e]);f&&f.users.splice(f.users.indexOf(t.node),1);var h=RED.nodes.node(t.changes[e]);h&&h.users.push(t.node)}t.node[e]=t.changes[e]}if("tab"===t.node.type&&t.changes.hasOwnProperty("disabled")&&($("#red-ui-tab-"+t.node.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!t.node.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!t.node.disabled)),t.subflow)n.subflow={},t.subflow.hasOwnProperty("inputCount")&&(n.subflow.inputCount=t.node.in.length,t.node.in.length>t.subflow.inputCount?(n.subflow.inputs=t.node.in.slice(t.subflow.inputCount),t.node.in.splice(t.subflow.inputCount)):0<t.subflow.inputs.length&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(n.subflow.outputCount=t.node.out.length,t.node.out.length>t.subflow.outputCount?(n.subflow.outputs=t.node.out.slice(t.subflow.outputCount),t.node.out.splice(t.subflow.outputCount)):0<t.subflow.outputs.length&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&(n.subflow.instances=[],t.subflow.instances.forEach(function(e){n.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)})),t.subflow.hasOwnProperty("status")&&t.subflow.status&&delete t.node.status,RED.editor.validateNode(t.node),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e),RED.editor.validateNode(e)});else{var g;if(t.outputMap)for(var v in g={},n.outputMap={},t.outputMap)t.outputMap.hasOwnProperty(v)&&"-1"!==t.outputMap[v]&&(g[t.outputMap[v]]=v,n.outputMap[t.outputMap[v]]=v);RED.editor.updateNodeProperties(t.node,g),RED.editor.validateNode(t.node)}if(t.links)for(n.createdLinks=[],e=0;e<t.links.length;e++)RED.nodes.addLink(t.links[e]),n.createdLinks.push(t.links[e]);if(t.createdLinks)for(n.links=[],e=0;e<t.createdLinks.length;e++)RED.nodes.removeLink(t.createdLinks[e]),n.links.push(t.createdLinks[e]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(n={t:"deleteSubflow",activeWorkspace:t.activeWorkspace,dirty:RED.nodes.dirty()},t.nodes){n.movedNodes=[];var b=t.activeWorkspace;for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).forEach(function(e){e.x+=t.subflow.offsetX,e.y+=t.subflow.offsetY,e.dirty=!0,n.movedNodes.push(e.id),RED.nodes.moveNodeToTab(e,b)}),n.subflows=[],e=0;e<t.nodes.length;e++)n.subflows.push(RED.nodes.node(t.nodes[e])),RED.nodes.remove(t.nodes[e])}if(t.links)for(n.links=[],e=0;e<t.links.length;e++)n.links.push(t.links[e]),RED.nodes.removeLink(t.links[e]);if(n.subflow=t.subflow,RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(n.createdLinks=[],e=0;e<t.removedLinks.length;e++)n.createdLinks.push(t.removedLinks[e]),RED.nodes.addLink(t.removedLinks[e])}else if("deleteSubflow"==t.t){if(n={t:"createSubflow",activeWorkspace:t.activeWorkspace,dirty:RED.nodes.dirty()},t.subflow&&(RED.nodes.addSubflow(t.subflow.subflow),n.subflow=t.subflow),t.subflows)for(n.nodes=[],e=0;e<t.subflows.length;e++)RED.nodes.add(t.subflows[e]),n.nodes.push(t.subflows[e].id);if(t.movedNodes&&t.movedNodes.forEach(function(e){nn=RED.nodes.node(e),nn.x-=t.subflow.offsetX,nn.y-=t.subflow.offsetY,nn.dirty=!0,RED.nodes.moveNodeToTab(nn,t.subflow.subflow.id)}),t.links)for(n.links=[],e=0;e<t.links.length;e++)n.links.push(t.links[e]),RED.nodes.addLink(t.links[e]);if(t.createdLinks)for(n.removedLinks=[],e=0;e<t.createdLinks.length;e++)n.removedLinks.push(t.createdLinks[e]),RED.nodes.removeLink(t.createdLinks[e])}else"reorder"==t.t&&(n={t:"reorder",order:RED.nodes.getWorkspaceOrder()},t.order&&RED.workspaces.order(t.order));return Object.keys(a).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(t.dirty),RED.view.select(null),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.subflow.refresh(),n}}return{markAllDirty:function(){for(var e=0;e<i.length;e++)i[e].dirty=!0},list:function(){return i},depth:function(){return i.length},push:function(e){i.push(e),o=[]},pop:function(){var e=m(i.pop());e&&o.push(e)},peek:function(){return i[i.length-1]},clear:function(){i=[],o=[]},redo:function(){var e=o.pop();if(e){var t=m(e);t&&i.push(t)}}}}(),RED.validators={number:function(t){return function(e){return t&&(""===e||void 0===e)||""!==e&&!isNaN(e)}},regex:function(t){return function(e){return t.test(e)}},typedInput:function(i,o){return function(e){var t=$("#node-"+(o?"config-":"")+"input-"+i).val()||this[i];if("json"===t)try{return JSON.parse(e),!0}catch(e){return!1}else{if("msg"===t||"flow"===t||"global"===t)return RED.utils.validatePropertyExpression(e);if("num"===t)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(e)}return!0}}},RED.utils=function(){function P(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function N(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function A(e){var t;if(Array.isArray(e))t=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]");else if(null===e)t=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-null">null</span>');else if("object"==typeof e)t=e.hasOwnProperty("type")&&"Buffer"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("buffer["+e.length+"]"):e.hasOwnProperty("type")&&"array"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]"):e.hasOwnProperty("type")&&"function"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("function"):e.hasOwnProperty("type")&&"number"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>').text(e.data):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta">object</span>');else if("string"==typeof e){var i;i=30<e.length?N(e.substring(0,30))+"&hellip;":N(e),t=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-string"></span>').html('"'+P(i)+'"')}else t="number"==typeof e?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>').text(""+e):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-other"></span>').text(""+e);return t}function z(i,o,n,e){i.addClass("red-ui-debug-msg-expandable"),i.prop("toggle",function(){return function(e){var t=i.parent();if(t.hasClass("collapsed")){if(e)return o&&!t.hasClass("built")&&(o(),t.addClass("built")),t.removeClass("collapsed"),!0}else if(!e)return t.addClass("collapsed"),!0;return!1}}),i.on("click",function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&n&&n(!t),e.preventDefault()}),e&&i.trigger("click")}var M={},l={};function B(e,t,i,o){if(t&&0<t.length){if(""===e&&void 0===i)return!0;for(var n=0;n<t.length;n++){var a=t[n];if(0===a.indexOf(e)&&("."===a[e.length]||"["===a[e.length])){if(void 0===i||"["!==a[e.length])return!0;var r=a.substring(e.length),s=/\[(\d+)\]/.exec(r);if(s){var d=parseInt(s[1]);return i<=d&&d<=o}}}}return!1}function U(e,t,i,o,n,a){var r=l[i]&&l[i][o]&&l[i][o].number||a||"dec";if(n?(r="dec"===r?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===r||"dateS"==r?13===t.toString().length&&t<=2147483647e3?"dateML":10===t.toString().length&&t<=2147483647?"dateL":"hex":"dateML"===r||"dateL"==r?"hex":"dec",l[i]=l[i]||{},l[i][o]=l[i][o]||{},l[i][o].number=r):void 0!==a&&(l[i]=l[i]||{},l[i][o]=l[i][o]||{},l[i][o].number=r),"dec"===r)e.text(""+t);else if("dateMS"===r)e.text(new Date(t).toISOString());else if("dateS"===r)e.text(new Date(1e3*t).toISOString());else if("dateML"===r){var s=new Date(t);e.text(s.toLocaleString()+"  [UTC"+(s.getTimezoneOffset()/-60<=0?"":"+")+s.getTimezoneOffset()/-60+"]")}else if("dateL"===r){var d=new Date(1e3*t);e.text(d.toLocaleString()+"  [UTC"+(d.getTimezoneOffset()/-60<=0?"":"+")+d.getTimezoneOffset()/-60+"]")}else"hex"===r&&e.text("0x"+t.toString(16))}function q(e,t,i,o,n){var a=l[i]&&l[i][o]&&l[i][o].buffer||"raw";n&&(a="raw"===a?"string":"raw",l[i]=l[i]||{},l[i][o]=l[i][o]||{},l[i][o].buffer=a),"raw"===a?(t.text("raw"),e.removeClass("red-ui-debug-msg-buffer-string").addClass("red-ui-debug-msg-buffer-raw")):"string"===a&&(t.text("string"),e.addClass("red-ui-debug-msg-buffer-string").removeClass("red-ui-debug-msg-buffer-raw"))}function F(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var i,o,n=[],a=0,r=!1,s=!1,d=0;d<t;d++){var l=e[d];if(r){if(l===i){if(d-a==0)throw new Error("Invalid property expression: zero-length string at position "+a);if(n.push(e.substring(a,d)),s&&!/\]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected array expression at position "+a);if(!s&&d+1!==t&&!/[\[\.]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" expression at position "+(d+1));a=d+1,r=!1}}else if("'"===l||'"'===l){if(d!=a)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);r=!0,i=l,a=d+1}else if("."===l){if(0===d)throw new Error("Invalid property expression: unexpected . at position 0");if(a!=d&&(o=e.substring(a,d),/^\d+$/.test(o)?n.push(parseInt(o)):n.push(o)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1}else if("["===l){if(0===d)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d&&n.push(e.substring(a,d)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1,s=!0}else if("]"===l){if(!s)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d){if(o=e.substring(a,d),!/^\d+$/.test(o))throw new Error("Invalid property expression: unexpected array expression at position "+a);n.push(parseInt(o))}a=d+1,s=!1}else if(" "===l)throw new Error("Invalid property expression: unexpected ' ' at position "+d)}if(s||r)throw new Error("Invalid property expression: unterminated expression");return a<t&&n.push(e.substring(a)),n}function J(e,t){var i=null;return("string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),F(t)):t).reduce(function(e,t){return void 0===(i=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(i=void 0!==e.data[t]?e.data[t]:void 0),i},e),i}function s(e){var t={module:"",file:""};if(e){var i=e.indexOf("icons/");-1!==i&&(e=e.substring(i+6)),-1!==(i=e.indexOf("/"))?(t.module=e.slice(0,i),t.file=e.slice(i+1)):t.file=e}return t}function n(t,e){var i;if(e&&"subflow"===e.type)i="node-red/subflow.svg";else if("function"==typeof t.icon)try{i=t.icon.call(e)}catch(e){console.log("Definition error: "+t.type+".icon",e),i="arrow-in.svg"}else i=t.icon;var o=s(i);return o.module||(t.set?o.module=t.set.module:o.module="node-red"),o}function a(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}var d={};return{createObjectElement:function s(i,e){var d,t,o,l,c,p,u=(e=e||{}).key,f=e.typeHint,n=e.hideKey,h=e.path,g=e.sourceId,v=e.rootPath,b=e.expandPaths,m=e.ontoggle,y=e.exposeApi,a=e.tools,w={};void 0!==h&&void 0!==v&&(p=h.substring(v.length+("."===h[v.length]?1:0)));var D=$('<span class="red-ui-debug-msg-element"></span>');if(D.collapse=function(){D.find(".red-ui-debug-msg-expandable").parent().addClass("collapsed")},l=$('<span class="red-ui-debug-msg-row"></span>').appendTo(D),g&&function(i,o,t,n,e,a,r){M.hasOwnProperty(o)||(M[o]={});var s=$('<span class="red-ui-debug-msg-tools"></span>').appendTo(i),d=$('<span class="red-ui-debug-msg-tools-copy button-group"></span>').appendTo(s);if(t){var l=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-terminal"></i></button>').appendTo(d).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(t,l,"clipboard.copyMessagePath")});RED.popover.tooltip(l,RED._("node-red:debug.sidebar.copyPath"))}var c=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(d).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(n,c,"clipboard.copyMessageValue")});if(RED.popover.tooltip(c,RED._("node-red:debug.sidebar.copyPayload")),void 0!==a&&""!==a){var p=M[o].hasOwnProperty(a),u=$('<button class="red-ui-button red-ui-button-small red-ui-debug-msg-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(s).on("click",function(e){if(e.preventDefault(),e.stopPropagation(),M[o].hasOwnProperty(a))delete M[o][a],$(this).removeClass("selected"),i.removeClass("red-ui-debug-msg-row-pinned");else{var t="$"+("["===a[0]?"":".")+a;M[o][a]=F(t),$(this).addClass("selected"),i.addClass("red-ui-debug-msg-row-pinned")}}).toggleClass("selected",p);i.toggleClass("red-ui-debug-msg-row-pinned",p),RED.popover.tooltip(u,RED._("node-red:debug.sidebar.pinPath"))}r&&(r.addClass("red-ui-debug-msg-tools-other"),r.appendTo(s))}(l,g,h,i,0,p,a),u)n||($('<span class="red-ui-debug-msg-object-key"></span>').text(u).appendTo(l),$("<span>: </span>").appendTo(l));else if(D.addClass("red-ui-debug-msg-top-level"),g){var r=M[g];if(b=[],r){for(var E in r)if(r.hasOwnProperty(E))try{void 0!==J({$:i},r[E])&&b.push(E)}catch(e){}b.sort()}D.clearPinned=function(){D.find(".red-ui-debug-msg-row-pinned").removeClass("red-ui-debug-msg-row-pinned"),M[g]={}}}o=$('<span class="red-ui-debug-msg-object-value"></span>').appendTo(l);var R=Array.isArray(i),x=!1;if(i&&"object"==typeof i&&i.hasOwnProperty("type")&&i.hasOwnProperty("data")&&(i.__enc__&&"array"===i.type||"Buffer"===i.type)&&(x=R=!0),null==i)$('<span class="red-ui-debug-msg-type-null">'+i+"</span>").appendTo(o);else if(i.__enc__&&"number"===i.type)t=$('<span class="red-ui-debug-msg-type-number red-ui-debug-msg-object-header"></span>').text(i.data).appendTo(o);else if("function"===f||i.__enc__&&"function"===i.type)t=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("function").appendTo(o);else if("internal"===f||i.__enc__&&"internal"===i.type)t=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("[internal]").appendTo(o);else if("string"==typeof i)/[\t\n\r]/.test(i)&&(D.addClass("collapsed"),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(l),z(l,function(){$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(f||"string").appendTo(l);var e=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(D);$('<pre class="red-ui-debug-msg-type-string"></pre>').text(i).appendTo(e)},function(e){m&&m(h,e)},B(p,b))),t=$('<span class="red-ui-debug-msg-type-string red-ui-debug-msg-object-header"></span>').html('"'+P(N(i))+'"').appendTo(o),/^#[0-9a-f]{6}$/i.test(i)&&$('<span class="red-ui-debug-msg-type-string-swatch"></span>').css("backgroundColor",i).appendTo(t);else if("number"==typeof i)t=$('<span class="red-ui-debug-msg-type-number"></span>').appendTo(o),Number.isInteger(i)&&0<=i&&(t.addClass("red-ui-debug-msg-type-number-toggle"),t.on("click",function(e){e.preventDefault(),U($(this),i,g,h,!0)})),U(t,i,g,h,!1,"hex"===f?"hex":void 0);else if(R){D.addClass("collapsed");var k=i.length;if(f){var T=/\[(\d+)\]/.exec(f);T&&(k=parseInt(T[1]))}var _=i,j="array";x?(_=i.data,void 0===k&&(k=_.length),_.__enc__&&(_=_.data),j=i.type.toLowerCase()):/buffer/.test(f)&&(j="buffer");var C=_.length;if(0<k){$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(l);var L=$('<div class="red-ui-debug-msg-array-rows"></div>').appendTo(D);D.addClass("red-ui-debug-msg-buffer-raw")}if(u)c=$('<span class="red-ui-debug-msg-type-meta"></span>').text(f||j+"["+k+"]").appendTo(o);else{c=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(o),$("<span>[ </span>").appendTo(c);var S=Math.min(k,10);for(d=0;d<S;d++)A(_[d]).appendTo(c),d<S-1&&$("<span>, </span>").appendTo(c);S<k&&$("<span> &hellip;</span>").appendTo(c),0===S&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(c),$("<span> ]</span>").appendTo(c)}0<k&&z(l,function(){if(u||(c=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(f||j+"["+k+"]").appendTo(l)),"buffer"===j){var e=$('<div class="red-ui-debug-msg-string-rows"></div>').appendTo(D),t=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(e),i="";try{i=String.fromCharCode.apply(null,new Uint16Array(_))}catch(e){console.log(e)}$('<pre class="red-ui-debug-msg-type-string"></pre>').text(i).appendTo(t);var o=$('<span class="red-ui-debug-msg-buffer-opts"></span>').appendTo(c),n=$('<a class="red-ui-button red-ui-button-small" href="#"></a>').text("raw").appendTo(o).on("click",function(e){e.preventDefault(),e.stopPropagation(),q(D,$(this),g,h,!0)});q(D,n,g,h,!1)}var a;if(C<=10)for(d=0;d<C;d++)a=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(L),w[h+"["+d+"]"]=s(_[d],{key:""+d,typeHint:"buffer"===j&&"hex",hideKey:!1,path:h+"["+d+"]",sourceId:g,rootPath:v,expandPaths:b,ontoggle:m,exposeApi:y}).appendTo(a);else{for(d=0;d<C;d+=10){var r=d;a=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(L),l=$("<span></span>").appendTo(a),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').appendTo(l),z(l,function(){var i=r,o=Math.min(C-1,r+9),n=a;return function(){for(var e=i;e<=o;e++){var t=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(n);w[h+"["+e+"]"]=s(_[e],{key:""+e,typeHint:"buffer"===j&&"hex",hideKey:!1,path:h+"["+e+"]",sourceId:g,rootPath:v,expandPaths:b,ontoggle:m,exposeApi:y}).appendTo(t)}}}(),function(){var t=t+"["+d+"]";return function(e){m&&m(t,e)}}(),B(p,b,r,Math.min(C-1,r+9))),$('<span class="red-ui-debug-msg-object-key"></span>').html("["+r+" &hellip; "+Math.min(C-1,r+9)+"]").appendTo(l)}C<k&&$('<div class="red-ui-debug-msg-object-entry collapsed"><span class="red-ui-debug-msg-object-key">['+C+" &hellip; "+k+"]</span></div>").appendTo(L)}},function(e){m&&m(h,e)},B(p,b))}else if("object"==typeof i){D.addClass("collapsed");var O=Object.keys(i);if((u||0<O.length)&&($('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(l),z(l,function(){for(u||$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text("object").appendTo(l),d=0;d<O.length;d++){var e=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(D),t=h;void 0!==t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(O[d])?t+=(0<t.length?".":"")+O[d]:t+='["'+O[d].replace(/"/,'\\"')+'"]'),w[t]=s(i[O[d]],{key:O[d],typeHint:!1,hideKey:!1,path:t,sourceId:g,rootPath:v,expandPaths:b,ontoggle:m,exposeApi:y}).appendTo(e)}0===O.length&&$('<div class="red-ui-debug-msg-object-entry red-ui-debug-msg-type-meta collapsed"></div>').text("empty").appendTo(D)},function(e){m&&m(h,e)},B(p,b))),u)$('<span class="red-ui-debug-msg-type-meta"></span>').text("object").appendTo(o);else{c=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(o),$("<span>{ </span>").appendTo(c);var I=Math.min(O.length,5);for(d=0;d<I;d++)$('<span class="red-ui-debug-msg-object-key"></span>').text(O[d]).appendTo(c),$("<span>: </span>").appendTo(c),A(i[O[d]]).appendTo(c),d<I-1&&$("<span>, </span>").appendTo(c);O.length>I&&$("<span> &hellip;</span>").appendTo(c),0===I&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(c),$("<span> }</span>").appendTo(c)}}else $('<span class="red-ui-debug-msg-type-other"></span>').text(""+i).appendTo(o);return y&&D.prop("expand",function(){return function(e,t){if(h===e)l.prop("toggle")&&l.prop("toggle")(t);else if(w[e]&&w[e].prop("expand"))w[e].prop("expand")(e,t);else for(var i in w)if(w.hasOwnProperty(i)&&0===e.indexOf(i)){w[i].prop("expand")&&w[i].prop("expand")(e,t);break}}}),D},getMessageProperty:J,setMessageProperty:function(e,t,i,o){void 0===o&&(o=void 0!==i),0===t.indexOf("msg.")&&(t=t.substring(4));for(var n,a=F(t),r=a.length,s=e,d=0;d<r-1;d++)if("string"==typeof(n=a[d])||"number"==typeof n&&!Array.isArray(s))if(s.hasOwnProperty(n))s=s[n];else{if(!o)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else if("number"==typeof n)if(void 0===s[n]){if(!o)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else s=s[n];n=a[r-1],void 0===i?"number"==typeof n&&Array.isArray(s)?s.splice(n,1):delete s[n]:s[n]=i},normalisePropertyExpression:F,validatePropertyExpression:function(e){try{F(e);return!0}catch(e){return!1}},separateIconPath:s,getDefaultNodeIcon:n,getNodeIcon:function(e,t){if("config"===e.category)return RED.settings.apiRootUrl+"icons/node-red/cog.svg";if(t&&"tab"===t.type)return RED.settings.apiRootUrl+"icons/node-red/subflow.svg";if(t&&"unknown"===t.type)return RED.settings.apiRootUrl+"icons/node-red/alert.svg";if(t&&t.icon){if(a(i=s(t.icon)))return"font-awesome"===i.module?t.icon:RED.settings.apiRootUrl+"icons/"+t.icon;if("font-awesome"!==i.module&&/.png$/i.test(i.file)&&(i.file=i.file.replace(/.png$/,".svg"),a(i)))return RED.settings.apiRootUrl+"icons/"+t.icon.replace(/.png$/,".svg")}var i;if(a(i=n(e,t)))return"font-awesome"===i.module?i.module+"/"+i.file:RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file;if(/.png$/i.test(i.file)){var o=i.file;if(i.file=i.file.replace(/.png$/,".svg"),a(i))return RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file;i.file=o}return i.module="node-red",a(i)?RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file:/.png$/i.test(i.file)&&(i.file=i.file.replace(/.png$/,".svg"),a(i))?RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file:"subflows"===e.category?RED.settings.apiRootUrl+"icons/node-red/subflow.svg":RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"},getNodeLabel:function(t,i){var o;if(i=i||"","tab"===t.type)o=t.label||i;else{o=t._def.label;try{o=("function"==typeof o?o.call(t):o)||i}catch(e){console.log("Definition error: "+t.type+".label",e),o=i}}return RED.text.bidi.enforceTextDirectionWithUCC(o)},getNodeColor:function(e,t){var i=t.color,o=RED.settings.theme("palette.theme")||[];if(0<o.length){if(!d.hasOwnProperty(e)){d[e]=t.color;for(var n=o.length,a=0;a<n;a++){var r=o[a];if((!r.hasOwnProperty("category")||(r.hasOwnProperty("_category")||(r._category=new RegExp(r.category)),r._category.test(t.category)))&&(!r.hasOwnProperty("type")||(r.hasOwnProperty("_type")||(r._type=new RegExp(r.type)),r._type.test(e)))){d[e]=r.color||t.color;break}}}i=d[e]}return i||"#ddd"},clearNodeColorCache:function(){d={}},addSpinnerOverlay:function(e,t){var i=$('<div class="red-ui-component-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&i.addClass("red-ui-component-spinner-contain"),i},decodeObject:function(e,t){if("number"===t&&"NaN"===e)e=Number.NaN;else if("number"===t&&"Infinity"===e)e=1/0;else if("number"===t&&"-Infinity"===e)e=-1/0;else if("Object"===t||/^array/.test(t)||"boolean"===t||"number"===t)e=JSON.parse(e);else if(/error/i.test(t))e=((e=JSON.parse(e)).name?e.name+": ":"")+e.message;else if("null"===t)e=null;else if("undefined"===t)e=void 0;else if(/^buffer/.test(t)){var i=e;e=[];for(var o=0;o<i.length;o+=2)e.push(parseInt(i.substr(o,2),16))}return e},parseContextKey:function(e){var t={},i=/^#:\((\S+?)\)::(.*)$/.exec(e);return i?(t.store=i[1],t.key=i[2]):(t.key=e,RED.settings.context&&(t.store=RED.settings.context.default)),t},createIconElement:function(e,t,i){var o=t.find(".red-ui-palette-icon");0!==o.length&&o.remove(),0!==(a=t.find("i")).length&&a.remove();var n=s(e);if("font-awesome"===n.module){if(RED.nodes.fontAwesome.getIconUnicode(n.file)){var a,r=i?"fa-lg ":"";return void(a=$("<i/>").appendTo(t)).addClass("red-ui-palette-icon-fa fa fa-fw "+r+n.file)}e=RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"}$("<div/>",{class:"red-ui-palette-icon"}).appendTo(t).css("backgroundImage","url("+e+")")},sanitize:N}}(),function(s){s.widget("nodered.editableList",{_create:function(){var e,i=this;this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton&&(e="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",s('<a href="#" class="red-ui-button red-ui-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+e+"</a>").appendTo(this.topContainer).on("click",function(e){e.preventDefault(),i.addItem({})}));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=i.element.css(e);"auto"!==t&&""!==t&&(i.topContainer.css(e,t),i.uiContainer.css(e,"0"),i.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var t=this.element.css("minHeight");"0px"!==t&&(this.uiContainer.css("minHeight",t),this.element.css("minHeight",0));var o=this.element.css("maxHeight");"0px"!==o&&(this.uiContainer.css("maxHeight",o),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var n,a=this.element.attr("style");if(null!==(n=/width\s*:\s*(\d+%)/i.exec(a))&&(this.element.width("100%"),this.uiContainer.width(n[1])),this.options.sortable){var r={axis:"y",update:function(e,t){i.options.sortItems&&i.options.sortItems(i.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(r.connectWith=this.options.connectWith),this.element.sortable(r)}this._resize()},_resize:function(){var e=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-e),this.options.resize&&this.options.resize(),this.options.resizeItem){var t=this;this.element.children().each(function(e){t.options.resizeItem(s(this).find(".red-ui-editableList-item-content"),e)})}},_destroy:function(){if(this.topContainer){var e=this.topContainer;delete this.topContainer,e.remove()}},_refreshFilter:function(){var o=this,n=0;return this.activeFilter?(this.items().each(function(e,t){var i=t.data("data");try{o.activeFilter(i)?(t.parent().show(),n++):t.parent().hide()}catch(e){console.log(e),t.parent().show(),n++}}),n):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var e=this.element.children(),i=this;e.sort(function(e,t){return i.activeSort(s(e).find(".red-ui-editableList-item-content").data("data"),s(t).find(".red-ui-editableList-item-content").data("data"))}),s.each(e,function(e,t){i.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},getItemAt:function(e){var t=this.items();return 0<=e&&e<t.length?s(t[e]).data("data"):void 0},indexOf:function(e){for(var t=this.items(),i=0;i<t.length;i++)if(s(t[i]).data("data")===e)return i;return-1},insertItemAt:function(o,e){var n=this;o=o||{};var a=s("<li>"),r=!1;if(this.activeSort){this.items().each(function(e,t){if(!r){var i=t.data("data");n.activeSort(o,i)<0&&(a.insertBefore(t.closest("li")),r=!0)}})}r||(e<=0?a.prependTo(this.element):e>n.element.children().length-1?a.appendTo(this.element):a.insertBefore(this.element.children().eq(e)));var i=s("<div/>").addClass("red-ui-editableList-item-content").appendTo(a);if(i.data("data",o),!0===this.options.sortable&&(s('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(a),a.addClass("red-ui-editableList-item-sortable")),this.options.removable){var t=s("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(a);s("<i/>",{class:"fa fa-remove"}).appendTo(t),a.addClass("red-ui-editableList-item-removable"),t.on("click",function(e){e.preventDefault();var t=i.data("data");a.addClass("red-ui-editableList-item-deleting"),a.fadeOut(300,function(){s(this).remove(),n.options.removeItem&&n.options.removeItem(t)})})}if(this.options.addItem){e=n.element.children().length-1;setTimeout(function(){if(n.options.addItem(i,e,o),n.activeFilter)try{n.activeFilter(o)||a.hide()}catch(e){}!n.activeSort&&n.scrollOnAdd&&setTimeout(function(){n.uiContainer.scrollTop(n.element.height())},0)},0)}},addItem:function(e){this.insertItemAt(e,this.element.children().length)},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t){this.element.children().filter(function(e){return t===s(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(e){return s(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty(),this.uiContainer.scrollTop(0)},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length},show:function(t){var e=this.element.children().filter(function(e){return t===s(this).find(".red-ui-editableList-item-content").data("data")});0<e.length&&this.uiContainer.scrollTop(this.uiContainer.scrollTop()+e.position().top)},getItem:function(e){var t=e.find(".red-ui-editableList-item-content");return t.length?t.data("data"):null}})}(jQuery),function(c){c.widget("nodered.treeList",{_create:function(){var o=this;this.element.addClass("red-ui-treeList"),this.element.attr("tabIndex",0);var e=c("<div>",{class:"red-ui-treeList-container"}).appendTo(this.element);this.element.on("keydown",function(e){var t=o._topList.find(".selected").parent().data("data");if(t||40!==e.keyCode&&38!==e.keyCode){var i;switch(e.keyCode){case 13:t.children?t.treeList.container.hasClass("expanded")?t.treeList.collapse():t.treeList.expand():o._trigger("confirm",null,t);break;case 37:t.children&&t.treeList.container.hasClass("expanded")?t.treeList.collapse():t.parent&&(i=t.parent);break;case 38:!(i=(i=o._getPreviousSibling(t))&&o._getLastDescendant(i))&&t.parent&&(i=t.parent);break;case 39:t.children&&(t.treeList.container.hasClass("expanded")||t.treeList.expand());break;case 40:if(t.children&&Array.isArray(t.children)&&0<t.children.length&&t.treeList.container.hasClass("expanded"))i=t.children[0];else for(i=o._getNextSibling(t);!i&&t.parent;)t=t.parent,i=o._getNextSibling(t)}i&&o.select(i)}else o.select(o._data[0])}),this._data=[],this._topList=c('<ol class="red-ui-treeList-list">').css({position:"absolute",top:0,left:0,right:0,bottom:0}).appendTo(e);var t={addButton:!1,scrollOnAdd:!1,height:"100%",addItem:function(e,t,i){o._addSubtree(o._topList,e,i,0)}};!1!==this.options.rootSortable&&this.options.sortable&&(t.sortable=this.options.sortable,t.connectWith=".red-ui-treeList-sortable",this._topList.addClass("red-ui-treeList-sortable")),this._topList.editableList(t),this.options.data&&this.data(this.options.data)},_getLastDescendant:function(e){return e.children&&e.treeList.container.hasClass("expanded")&&0!==e.children.length?this._getLastDescendant(e.children[e.children.length-1]):e},_getPreviousSibling:function(e){var t,i=(t=e.parent?e.parent.children:this._data).indexOf(e);return 0===i?null:t[i-1]},_getNextSibling:function(e){var t,i=(t=e.parent?e.parent.children:this._data).indexOf(e);return i===t.length-1?null:t[i+1]},_addChildren:function(e,n,t,o){var a=this,r=c('<ol class="red-ui-treeList-list">').appendTo(e).editableList({connectWith:".red-ui-treeList-sortable",sortable:a.options.sortable,addButton:!1,scrollOnAdd:!1,height:"auto",addItem:function(e,t,i){a._addSubtree(r,e,i,o+1)},sortItems:function(e){var i=[],o=[];e.each(function(){var e=c(this).data("data");i.push(e);var t=a._fixDepths(n,e);t&&o.push(t)}),Array.isArray(n.children)&&(n.children=i),o.forEach(function(e){a._trigger("changeparent",null,e)}),a._trigger("sort",null,n)}});a.options.sortable&&r.addClass("red-ui-treeList-sortable");for(var i=0;i<t.length;i++)t[i].parent=n,r.editableList("addItem",t[i]);return r},_fixDepths:function(e,t){var i=this,o=null;if(t.parent!==e){reparented=!0;var n=t.parent;t.parent=e,o={item:t,old:n}}if(t.depth!==e.depth+1){t.depth=e.depth+1;var a=(t.gutter?t.gutter.width()+2:0)+20*t.depth;t.treeList.labelPadding.width(a+"px"),t.element&&c(t.element).css({width:"calc(100% - "+(a+20+(t.icon?20:0))+"px)"}),t.children&&Array.isArray(t.children)&&t.children.forEach(function(e){i._fixDepths(t,e)})}return o},_addSubtree:function(t,r,s,d){var l=this;s.treeList={},s.treeList.depth=d,s.treeList.container=r,s.treeList.parentList=t,s.treeList.remove=function(){if(t.editableList("removeItem",s),s.parent){var e=s.parent.children.indexOf(s);s.parent.children.splice(e,1),l._trigger("sort",null,s.parent)}};var i=c("<div>",{class:"red-ui-treeList-label"}).appendTo(r);s.treeList.label=i,s.class&&i.addClass(s.class),s.gutter&&s.gutter.css({position:"absolute"}).appendTo(i);var e=(s.gutter?s.gutter.width()+2:0)+20*d;s.treeList.labelPadding=c("<span>").css({display:"inline-block",width:e+"px"}).appendTo(i),i.on("mouseover",function(e){l._trigger("itemmouseover",e,s)}),i.on("mouseout",function(e){l._trigger("itemmouseout",e,s)}),i.on("mouseenter",function(e){l._trigger("itemmouseenter",e,s)}),i.on("mouseleave",function(e){l._trigger("itemmouseleave",e,s)}),s.treeList.makeLeaf=function(e){if(o.children().length){if(e&&s.children){var t=function(e){e.children&&e.children.forEach(function(e){e.element&&e.element.detach(),e.gutter&&e.gutter.detach(),t(e)})};t(s)}o.empty(),s.deferBuild||(s.treeList.childList.remove(),delete s.treeList.childList),i.off("click.red-ui-treeList-expand"),o.off("click.red-ui-treeList-expand"),delete s.children,r.removeClass("expanded")}},s.treeList.makeParent=function(e){o.children().length||(c('<i class="fa fa-angle-right" />').appendTo(o),o.on("click.red-ui-treeList-expand",function(e){e.stopPropagation(),e.preventDefault(),r.hasClass("expanded")?s.treeList.collapse():s.treeList.expand()}),i.on("click.red-ui-treeList-expand",function(e){r.hasClass("expanded")?(s.hasOwnProperty("selected")||i.hasClass("selected"))&&s.treeList.collapse():s.treeList.expand()}),s.children||(s.children=e||[],s.treeList.childList=l._addChildren(r,s,s.children,d).hide()))},s.treeList.insertChildAt=function(e,t,i){(e.parent=s).children.splice(t,0,e),s.deferBuild||(s.treeList.childList.editableList("insertItemAt",e,t),i&&setTimeout(function(){l.select(e)},100),l._trigger("sort",null,s))},s.treeList.addChild=function(e,t){s.treeList.insertChildAt(e,s.children.length,t)},s.treeList.expand=function(i){if(s.children)if(r.hasClass("expanded"))i&&i();else{if(r.hasClass("built")||!s.deferBuild&&"function"!=typeof s.children)l._loadingData?s.treeList.childList.show():s.treeList.childList.slideDown("fast"),i&&i();else{r.addClass("built");function e(e){n=!0,s.treeList.childList=l._addChildren(r,s,e,d).hide();var t=Date.now()-a;t<400?setTimeout(function(){s.treeList.childList.slideDown("fast"),o&&o.remove()},400-t):(s.treeList.childList.slideDown("fast"),o&&o.remove()),i&&i(),l._trigger("childrenloaded",null,s)}var o,n=!1,a=0;"function"==typeof s.children?s.children(e,s):(delete s.deferBuild,e(s.children)),n||(a=Date.now(),o=c('<div class="red-ui-treeList-spinner">').css({"background-position":35+20*d+"px 50%"}).appendTo(r))}r.addClass("expanded")}},s.treeList.collapse=function(){s.children&&(s.treeList.childList.slideUp("fast"),r.removeClass("expanded"))};var o=c('<span class="red-ui-treeList-icon"></span>').appendTo(i);if(s.children&&s.treeList.makeParent(),s.hasOwnProperty("selected")){var n=c('<span class="red-ui-treeList-icon"></span>').appendTo(i),a=c('<input class="red-ui-treeList-checkbox" type="checkbox">').prop("checked",s.selected).appendTo(n);i.toggleClass("selected",s.selected),a.on("click",function(e){e.stopPropagation()}),a.on("change",function(e){s.selected=this.checked,i.toggleClass("selected",this.checked),l._trigger("select",e,s)}),s.children||i.on("click",function(e){e.stopPropagation(),a.trigger("click")}),s.treeList.select=function(e){e!==s.selected&&a.trigger("click")}}else i.on("click",function(e){l._topList.find(".selected").removeClass("selected"),i.addClass("selected"),l._trigger("select",e,s)}),i.on("dblclick",function(e){s.children||l._trigger("confirm",e,s)});s.icon&&c('<span class="red-ui-treeList-icon"><i class="'+s.icon+'" /></span>').appendTo(i),s.hasOwnProperty("label")||s.hasOwnProperty("sublabel")?(s.hasOwnProperty("label")&&c('<span class="red-ui-treeList-label-text"></span>').text(s.label).appendTo(i),s.hasOwnProperty("sublabel")&&c('<span class="red-ui-treeList-sublabel-text"></span>').text(s.sublabel).appendTo(i)):s.element&&(c(s.element).appendTo(i),c(s.element).css({width:"calc(100% - "+(e+20+(s.icon?20:0))+"px)"})),s.children&&(Array.isArray(s.children)&&!s.deferBuild&&(s.treeList.childList=l._addChildren(r,s,s.children,d).hide()),s.expanded&&s.treeList.expand())},empty:function(){this._topList.editableList("empty")},data:function(e){var t=this;if(void 0===e)return this._data;this._data=e,this._topList.editableList("empty"),this._loadingData=!0;for(var i=0;i<e.length;i++)this._topList.editableList("addItem",e[i]);setTimeout(function(){delete t._loadingData},200),this._trigger("select")},show:function(e){for(var t=0;t<this._data.length;t++)this._data[t].id===e&&this._topList.editableList("show",this._data[t])},select:function(e){this._topList.find(".selected").removeClass("selected"),e.treeList.label.addClass("selected"),this._trigger("select",null,e)},selected:function(){var e=this._topList.find(".selected");if(this.options.multi){var t=[];return e.each(function(){t.push(c(this).parent().data("data"))}),t}return e.length?e.parent().data("data"):void 0}})}(jQuery),function(t){t.widget("nodered.checkboxSet",{_create:function(){var i=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var e=this.element.prop("checked");this.options=[t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],e?this.options[1].show():this.options[0].show(),this.element.on("change",function(){this.checked?(i.options[0].hide(),i.options[1].show()):(i.options[1].hide(),i.options[0].show()),i.options[2].hide();var t=this.checked;i.children.forEach(function(e){e.checkboxSet("state",t,!1,!0)})}),this.uiElement.on("click",function(e){e.stopPropagation(),i.state(!1===i.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);-1<t&&this.children.splice(t,1)},updateChild:function(e){var i=0;this.children.forEach(function(e,t){!0===e.checkboxSet("state")&&i++}),0===i?this.state(!1,!0):i===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,i){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var o=this.partialFlag||e;this.element.prop("checked",o),!0===e?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):!1===e?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===e&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),t||this.element.trigger("change",null),!i&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var d={};function l(t){var e,i;if(null!==t&&t.id&&!1===RED.settings.theme("menu."+t.id))return null;if(null===t)e=$('<li class="red-ui-menu-divider"></li>');else{e=$("<li></li>"),t.group&&e.addClass("red-ui-menu-group-"+t.group);var o="<a "+(t.id?'id="'+t.id+'" ':"")+'tabindex="-1" href="#">';t.toggle&&(o+='<i class="fa fa-square pull-left"></i>',o+='<i class="fa fa-check-square pull-left"></i>'),void 0!==t.icon&&(/\.(png|svg)/.test(t.icon)?o+='<img src="'+t.icon+'"/> ':o+='<i class="'+(t.icon?t.icon:'" style="display: inline-block;"')+'"></i> '),t.sublabel?o+='<span class="red-ui-menu-label-container"><span class="red-ui-menu-label">'+t.label+'</span><span class="red-ui-menu-sublabel">'+t.sublabel+"</span></span>":o+='<span class="red-ui-menu-label">'+t.label+"</span>",o+="</a>";var n=$(o).appendTo(e);if((d[t.id]=t).onselect?(n.on("click",function(e){e.preventDefault(),$(this).parent().hasClass("disabled")||(t.toggle?!0===t.toggle?u(t.id,!p(t.id)):u(t.id,!0):c(t.id))}),t.toggle&&(i=RED.settings.get("menu-"+t.id),t.setting&&(null!==i?(RED.settings.set(t.setting,i),RED.settings.remove("menu-"+t.id)):i=RED.settings.get(t.setting)),i?(n.addClass("active"),c(t.id,!0)):!1===i?(n.removeClass("active"),c(t.id,!1)):t.hasOwnProperty("selected")&&(t.selected?n.addClass("active"):n.removeClass("active"),c(t.id,t.selected)))):t.href?n.attr("target","_blank").attr("href",t.href):t.options||(e.addClass("disabled"),n.on("click",function(e){e.preventDefault()})),t.options){e.addClass("red-ui-menu-dropdown-submenu pull-left");for(var a=$('<ul id="'+t.id+'-submenu" class="red-ui-menu-dropdown"></ul>').appendTo(e),r=0;r<t.options.length;r++){var s=l(t.options[r]);s&&s.appendTo(a)}}t.disabled&&e.addClass("disabled")}return e}function c(e,t){var i=d[e],o=i.onselect;"string"==typeof i.onselect&&(o=RED.actions.get(i.onselect)),o?o.call(i,t):console.log("No callback for",e,i.onselect)}function p(e){return $("#"+e).hasClass("active")}function u(e,t){var i=!1;p(e)==t&&(i=!0);var o=d[e];if(t?$("#"+e).addClass("active"):$("#"+e).removeClass("active"),o){if(o.toggle&&"string"==typeof o.toggle&&t)for(var n in d)if(d.hasOwnProperty(n)){var a=d[n];a.id!=o.id&&o.toggle==a.toggle&&u(a.id,!1)}!i&&o.onselect&&c(o.id,t),o.local||i||RED.settings.set(o.setting||"menu-"+o.id,t)}}return{init:function(e){var t=$("<ul/>",{class:"red-ui-menu red-ui-menu-dropdown pull-right"});if(e.id){t.attr({id:e.id+"-submenu"});var i=$("#"+e.id);1===i.length&&(t.insertAfter(i),i.on("click",function(e){e.stopPropagation(),e.preventDefault(),t.is(":visible")?($(document).off("click.red-ui-menu"),t.hide()):($(document).on("click.red-ui-menu",function(e){$(document).off("click.red-ui-menu"),activeMenu=null,t.hide()}),$(".red-ui-menu").hide(),t.show())}))}for(var o=!1,n=0;n<e.options.length;n++){var a=e.options[n];if(null!==a||!o){var r=l(a);r&&(r.appendTo(t),o=null===a)}}return t},setSelected:u,isSelected:p,toggleSelected:function(e){u(e,!p(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,t){var i=l(t);if(null!==t&&t.group){var o=$("#"+e+"-submenu").children(".red-ui-menu-group-"+t.group);if(0===o.length)i.appendTo("#"+e+"-submenu");else{for(var n=0;n<o.length;n++){var a=o[n],r=$(a).find(".red-ui-menu-label").html();if(t.label<r){$(a).before(i);break}}n===o.length&&i.appendTo("#"+e+"-submenu")}}else i.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(e,t){var i=d[e];i&&(i.onselect=t)}}}(),RED.panels={create:function(a){var r=a.container||$("#"+a.id),s=r.children();if(2!==s.length)throw console.log(a.id),new Error("Container must have exactly two children");var d=!a.dir||"vertical"===a.dir;r.addClass("red-ui-panels"),d||r.addClass("red-ui-panels-horizontal");var l,t=$('<div class="red-ui-panels-separator"></div>').insertAfter(s[0]),c=[],o=!1,p=.5;t.draggable({axis:d?"y":"x",containment:r,scroll:!1,start:function(e,t){l=d?t.position.top:t.position.left,c=[d?$(s[0]).height():$(s[0]).width(),d?$(s[1]).height():$(s[1]).width()]},drag:function(e,t){var i=d?r.height():r.width(),o=(d?t.position.top:t.position.left)-l,n=[c[0]+o,c[1]-o];d?($(s[0]).height(n[0]),$(s[1]).height(n[1]),t.position.top-=o):($(s[0]).width(n[0]),$(s[1]).width(n[1]),t.position.left-=o),a.resize&&a.resize(n[0],n[1]),p=n[0]/(i-8)},stop:function(e,t){o=!0}});var i={ratio:function(e){o=!0,0===(p=e)||1===e?t.hide():t.show(),d?i.resize(r.height()):i.resize(r.width())},resize:function(e){var t;if(d?(t=[$(s[0]).outerHeight(),$(s[1]).outerHeight()],r.height(e)):(t=[$(s[0]).outerWidth(),$(s[1]).outerWidth()],r.width(e)),o){var i=p*(e-8);t=[i,e-i-8],d?($(s[0]).outerHeight(t[0]),$(s[1]).outerHeight(t[1])):($(s[0]).outerWidth(t[0]),$(s[1]).outerWidth(t[1]))}a.resize&&(t=d?[$(s[0]).height(),$(s[1]).height()]:[$(s[0]).width(),$(s[1]).width()],a.resize(t[0],t[1]))}};return i}},RED.popover=function(){var k={default:{top:10,topTop:30,leftRight:17,leftLeft:25,leftBottom:8,leftTop:11},small:{top:6,topTop:20,leftRight:8,leftLeft:26,leftBottom:8,leftTop:9}};return{create:function(g){var v=g.target,b=g.direction||"right",e=g.trigger,m=g.content,t=g.delay||{show:750,hide:50},i=g.autoClose,y=g.width||"auto",w=g.size||"default";if(!k[w])throw new Error("Invalid RED.popover size value:",w);function o(e){if(D){var t=v.data("red-ui-popover");if(g.tooltip&&t)return void(D=!1);if(E=$('<div class="red-ui-popover"></div>'),"default"!==w&&E.addClass("red-ui-popover-size-"+w),"function"==typeof m){var i=m.call(x);if(null===i)return;"string"==typeof i?E.text(i):E.append(i)}else E.html(m);"auto"!==y&&E.width(y),E.appendTo("body");var o=v.offset(),n=v.outerWidth(),a=v.outerHeight(),r=E.height(),s=E.width(),d=$(window).scrollTop(),l=$(window).scrollLeft(),c=d+$(window).height(),p=l+$(window).width(),u=0,f=0,h=b;"right"===h?(u=o.top+a/2-r/2-k[w].top,f=o.left+n+k[w].leftRight):"left"===h?(u=o.top+a/2-r/2-k[w].top,f=o.left-k[w].leftLeft-s):"bottom"===h?(u=o.top+a+k[w].top,(f=o.left+n/2-s/2-k[w].leftBottom)<0?(h="right",u=o.top+a/2-r/2-k[w].top,f=o.left+n+k[w].leftRight):p<f+s?(h="left",u=o.top+a/2-r/2-k[w].top,f=o.left-k[w].leftLeft-s,c<u+r+a/2+5&&(u-=u+r+a/2-c+5)):c<u+r&&(h="top",u=o.top-k[w].topTop-r,f=o.left+n/2-s/2-k[w].leftTop)):"top"===h&&(u=o.top-k[w].topTop-r,f=o.left+n/2-s/2-k[w].leftTop,u<0&&(h="bottom",u=o.top+a+k[w].top,f=o.left+n/2-s/2-k[w].leftBottom)),E.addClass("red-ui-popover-"+h).css({top:u,left:f}),t&&t.close(!0),v.data("red-ui-popover",x),g.tooltip&&E.on("mousedown",function(e){R(!0)}),e?E.show():E.fadeIn("fast")}}var D,E,n=null,R=function(e){$(document).off("mousedown.red-ui-popover"),D||E&&(e?E.remove():E.fadeOut("fast",function(){$(this).remove()}),E=null,v.removeData("red-ui-popover",x))};"hover"===e?(v.on("mouseenter",function(e){clearTimeout(n),D=!0,n=setTimeout(o,t.show)}),v.on("mouseleave disabled",function(e){n&&clearTimeout(n),D&&(D=!1,setTimeout(R,t.hide))})):"click"===e?(v.on("click",function(e){e.preventDefault(),e.stopPropagation(),(D=!D)?o():R()}),i&&v.on("mouseleave disabled",function(e){n&&clearTimeout(n),D&&(D=!1,setTimeout(R,i))})):"modal"===e?$(document).on("mousedown.red-ui-popover",function(e){for(var t=e.target;"BODY"!==t.nodeName&&t!==E[0];)t=t.parentElement;"BODY"===t.nodeName&&(D=!1,R())}):i&&setTimeout(function(){D=!1,R()},i);var x={setContent:function(e){return m=e,x},open:function(e){return D=!0,o(e),x},close:function(e){return D=!1,R(e),x}};return x},tooltip:function(e,i,o){var t=i;return o&&(t=function(){var e=i,t=RED.keyboard.getShortcut(o);return t&&t.key&&(e=$("<span>"+i+' <span class="red-ui-popover-key">'+RED.keyboard.formatKey(t.key,!0)+"</span></span>")),e}),RED.popover.create({tooltip:!0,target:e,trigger:"hover",size:"small",direction:"bottom",content:t,delay:{show:750,hide:50}})},panel:function(e){var l=$('<div class="red-ui-editor-dialog red-ui-popover-panel"></div>');function c(){$(document).off("mousedown.red-ui-popover-panel-close"),l.hide(),l.css({height:"auto"}),l.remove()}return l.css({display:"none"}),l.appendTo(document.body),e.appendTo(l),{container:l,show:function(e){var t=e.onclose,i=e.target,o=e.align||"left",n=i.offset(),a=(i.width(),i.height()),r=l.height(),s=l.width(),d=a+n.top;d+r>$(window).height()&&(d-=d+r-$(window).height()+5),d<0&&(r.height(r+d),d=0),"left"===o?l.css({top:d+"px",left:n.left+"px"}):"right"===o&&l.css({top:d+"px",left:n.left-s+"px"}),l.slideDown(100),$(document).on("mousedown.red-ui-popover-panel-close",function(e){$(e.target).closest(l).length||$(e.target).closest(".red-ui-editor-dialog").length||(t&&t(),c())})},hide:c}}}}(),function(i){i.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.element.addClass("red-ui-searchBox-input"),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),i('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=i('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.trigger("focus")}),this.resultCount=i("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(e){t._change(i(this).val())}),this.element.on("focus",function(){i(document).one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var i=!1;i=""===e?(this.clearButton.hide(),!0):(this.clearButton.show(),e.length>=(this.options.minimumLength||0));var o=this.element.val();if(i=i&&o!==this.lastSent)if(!t&&0<this.options.delay){clearTimeout(this.currentTimeout);var n=this;this.currentTimeout=setTimeout(function(){n.lastSent=n.element.val(),n._trigger("change")},this.options.delay)}else this.lastSent=this.element.val(),this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){var x,k="fa fa-lemon-o",T=!1,_=!1;return{create:function(u){var r,f,o,n,h={},g=0,s=0,v=u.element||$("#"+u.id),d=v.wrap("<div>").parent(),b=v.wrap("<div>").parent();if(d.addClass("red-ui-tabs"),u.vertical&&d.addClass("red-ui-tabs-vertical"),u.addButton){d.addClass("red-ui-tabs-add");var e=$('<div class="red-ui-tab-button red-ui-tabs-add"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(d);if(e.find("a").on("click",function(e){e.preventDefault(),"function"==typeof u.addButton?u.addButton():"string"==typeof u.addButton&&RED.actions.invoke(u.addButton)}),"string"==typeof u.addButton){var t=u.addButton;u.addButtonCaption&&(t=u.addButtonCaption),RED.popover.tooltip(e,t,u.addButton)}v.on("dblclick",function(e){var t=v.children(),i=e.clientX,o=0;t.each(function(e){if($(this).offset().left>i)return!1;o=e+1}),"function"==typeof u.addButton?u.addButton({index:o}):"string"==typeof u.addButton&&RED.actions.invoke(u.addButton,{index:o})})}if(u.searchButton){d.addClass("red-ui-tabs-search");var i=$('<div class="red-ui-tab-button red-ui-tabs-search"><a href="#"><i class="fa fa-list-ul"></i></a></div>').appendTo(d);if(i.find("a").on("click",function(e){e.preventDefault(),"function"==typeof u.searchButton?u.searchButton():"string"==typeof u.searchButton&&RED.actions.invoke(u.searchButton)}),"string"==typeof u.searchButton){t=u.searchButton;u.searchButtonCaption&&(t=u.searchButtonCaption),RED.popover.tooltip(i,t,u.searchButton)}}if(u.scrollable&&(d.addClass("red-ui-tabs-scrollable"),b.addClass("red-ui-tabs-scroll-container"),b.on("scroll",p),(o=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(d).find("a")).on("mousedown",function(e){a(e,"-=150")}).on("click",function(e){e.preventDefault()}),(n=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(d).find("a")).on("mousedown",function(e){a(e,"+=150")}).on("click",function(e){e.preventDefault()})),u.collapsible){d.addClass("red-ui-tabs-collapsible");var m=$('<div class="red-ui-tab-link-buttons"></div>').appendTo(d);if(!1!==u.menu){var l=$('<a href="#"><i class="fa fa-caret-down"></i></a>').appendTo(m);l.addClass("red-ui-tab-link-button-menu"),l.on("click",function(e){if(e.stopPropagation(),e.preventDefault(),!f){var n=[],a=[];v.children().each(function(e,t){var i=$(t).data("tabId"),o={id:"red-ui-tabs-menu-option-"+i,icon:h[i].iconClass||k,label:h[i].name,onselect:function(){D(i)}};h[i].pinned?n.push(o):a.push(o)}),a=n.concat(a),(f=RED.menu.init({options:a})).css({position:"absolute"}),f.appendTo("body")}var t=l.offset();f.css({top:t.top+l.height()-2+"px",left:t.left-f.width()+l.width()+"px"}),f.is(":visible")?$(document).off("click.red-ui-tabmenu"):($(".red-ui-menu").hide(),$(document).on("click.red-ui-tabmenu",function(e){$(document).off("click.red-ui-tabmenu"),f.hide()})),f.toggle()})}}function a(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var i=b.scrollLeft();b.animate({scrollLeft:t},100);var o=setInterval(function(){var e=b.scrollLeft();e!==i?(i=e,b.animate({scrollLeft:t},100)):clearInterval(o)},100);$(this).one("mouseup",function(){clearInterval(o)})}}function c(){var e=v.find("li.red-ui-tab.selected"),t=[];return e.each(function(){t.push(h[$(this).find("a").attr("href").slice(1)])}),t}function y(){u.onselect(c())}function w(e){if(!T){if(x&&Date.now()-x<400)return _=!(x=0),function(e){if(e.preventDefault(),e.metaKey||e.shiftKey)return;u.ondblclick&&u.ondblclick(h[$(this).attr("href").slice(1)]);return!1}.call(this,e);x=Date.now();var t=v.find("li.red-ui-tab.active"),i=$(this).parent(),o=!1;if(u.onselect)if(e.metaKey||e.ctrlKey){if(i.hasClass("selected")){if(i.removeClass("selected"),i[0]!==t[0])return void y();if(0===(r=v.find("li.red-ui-tab.selected")).length)return void y();i=r.first()}else{if(!t.hasClass("selected")){h[t.find("a").attr("href").slice(1)];t.addClass("selected")}i.addClass("selected")}o=!0}else if(e.shiftKey){var n,a;if(t[0]!==i[0])a=t.index()<i.index()?(n=t,i):(n=i,t),v.find("li.red-ui-tab").removeClass("selected"),n.addClass("selected"),a.addClass("selected"),n.nextUntil(a).addClass("selected");o=!0}else{var r;0<(r=v.find("li.red-ui-tab.selected")).length&&(r.removeClass("selected"),o=!0)}var s=i.find("a");u.onclick&&u.onclick(h[s.attr("href").slice(1)]),D(s),o&&y()}}function p(){if(0!==v.children().length){var e=b.scrollLeft(),t=b.width(),i=v.width();0===e?o.hide():o.show(),e===i-t?n.hide():n.show()}}function D(e){if("string"==typeof e&&(e=v.find("a[href='#"+e+"']")),0!==e.length&&!e.parent().hasClass("active")){v.children().removeClass("active"),v.children().css({transition:"width 100ms"}),e.parent().addClass("active");var t=e.parent().attr("id");if(d.find(".red-ui-tab-link-button").removeClass("active selected"),$("#"+t+"-link-button").addClass("active selected"),u.scrollable){var i=e.parent().position().left;i-21<0?b.animate({scrollLeft:"+="+(i-50)},300):i+120>b.width()&&b.animate({scrollLeft:"+="+(i+140-b.width())},300)}u.onchange&&u.onchange(h[e.attr("href").slice(1)]),E(),setTimeout(function(){v.children().css({transition:""})},100)}}function E(){if(!u.vertical){var e=v.find("li.red-ui-tab"),t=d.width(),i=e.length;if(u.collapsible){if((n=t-m.width()-10)<198){for(var o=m.find("a:last").prev();o.is(":not(:visible)");)o=o.prev();o.hasClass("red-ui-tab-link-button-pinned")||o.hide(),n=t-m.width()-10}else{40<t-198-m.width()&&(m.find("a:not(:visible):first").show(),n=t-m.width()-10)}e.css({width:n})}else{var n;if(s=(r=100*(n=(t-12-6*i)/i)/t+"%")+"%",u.scrollable){n=Math.max(n,140),r=n+"px",s=0;var a=Math.max(d.width(),12+(n+6)*i);v.width(a),p()}else u.hasOwnProperty("minimumActiveTabWidth")&&(s=n<u.minimumActiveTabWidth?(i-=1,n=(t-12-u.minimumActiveTabWidth-6*i)/i,r=100*n/t+"%",u.minimumActiveTabWidth+"px"):0);e.css({width:r}),n<50?(v.find(".red-ui-tab-icon").hide(),v.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,n-38))+"px"})):(v.find(".red-ui-tab-icon").show(),v.find(".red-ui-tab-label").css({paddingLeft:""})),0!==s&&(v.find("li.red-ui-tab.active").css({width:u.minimumActiveTabWidth}),v.find("li.red-ui-tab.active .red-ui-tab-icon").show(),v.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}}function R(e){if(u.onselect){var t=v.find("li.red-ui-tab.selected");0<t.length&&(t.removeClass("selected"),y())}var i=v.find("a[href='#"+e+"']").parent();if(i.hasClass("active")){var o=i.prev();0===o.length&&(o=i.next()),D(o.find("a"))}i.remove(),h[e].pinned&&g--,u.onremove&&u.onremove(h[e]),delete h[e],E(),f&&(f.remove(),f=null)}return v.children().first().addClass("active"),v.children().addClass("red-ui-tab"),v.find("li.red-ui-tab a").on("mouseup",w).on("click",function(e){e.preventDefault()}).on("dblclick",function(e){e.stopPropagation(),e.preventDefault()}),setTimeout(function(){E()},0),{addTab:function(t,e){if(u.onselect){var i=v.find("li.red-ui-tab.selected");0<i.length&&(i.removeClass("selected"),y())}h[t.id]=t;var o=$("<li/>",{class:"red-ui-tab"});0===v.children().length&&(e=void 0),0===e?o.prependTo(v):0<e?o.insertAfter(v.find("li:nth-child("+e+")")):o.appendTo(v),o.attr("id","red-ui-tab-"+t.id.replace(".","-")),o.data("tabId",t.id),u.maximumTabWidth&&o.css("maxWidth",u.maximumTabWidth+"px");var n=$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(o);if(t.icon?$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(n):t.iconClass&&$("<i>",{class:"red-ui-tab-icon "+t.iconClass}).appendTo(n),$("<span/>",{class:"red-ui-text-bidi-aware"}).text(t.label).appendTo(n).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),u.collapsible){o.addClass("red-ui-tab-pinned");var a=$('<a href="#'+t.id+'" class="red-ui-tab-link-button"></a>');t.pinned?0===g?a.prependTo(m):a.insertAfter(m.find("a.red-ui-tab-link-button-pinned:last")):!1!==u.menu?a.insertBefore(m.find("a:last")):a.appendTo(m),a.attr("id",o.attr("id")+"-link-button"),t.iconClass?$("<i>",{class:t.iconClass}).appendTo(a):$("<i>",{class:k}).appendTo(a),a.on("click",function(e){e.preventDefault(),D(t.id)}),t.pinned&&(a.addClass("red-ui-tab-link-button-pinned"),g++),RED.popover.tooltip($(a),t.name,t.action)}if(n.on("mouseup",w),n.on("click",function(e){e.preventDefault()}),n.on("dblclick",function(e){e.stopPropagation(),e.preventDefault()}),t.closeable){o.addClass("red-ui-tabs-closeable");var r=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(o);r.append('<i class="fa fa-times" />'),r.on("click",function(e){e.preventDefault(),R(t.id)})}var s=$('<span class="red-ui-tabs-badges"></span>').appendTo(o);if(u.onselect&&($('<i class="red-ui-tabs-badge-changed fa fa-circle"></i>').appendTo(s),$('<i class="red-ui-tabs-badge-selected fa fa-check-circle"></i>').appendTo(s)),u.onadd&&u.onadd(t),n.attr("title",t.label),1==v.find("li.red-ui-tab").length&&D(n),u.onreorder){var d,l,c,p=[];o.draggable({axis:"x",distance:20,start:function(e,t){if(_)return _=!1;T=!0,d=[],p=[],v.children().each(function(e){p[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(o)&&(c=l=e),d.push($(this).data("tabId"))}),v.children().each(function(e){e!==l&&$(this).css({position:"absolute",left:p[e].left+"px",width:p[e].width+2,transition:"left 0.3s"})}),o.hasClass("active")||o.css({zIndex:1})},drag:function(e,t){t.position.left+=p[l].left+b.scrollLeft();for(var i=t.position.left+p[l].width/2-b.scrollLeft(),o=0;o<p.length;o++)if(o!==l&&i>p[o].left&&i<p[o].left+p[o].width){o<l?(p[o].left+=p[l].width+8,p[l].el.detach().insertBefore(p[o].el)):(p[o].left-=p[l].width+8,p[l].el.detach().insertAfter(p[o].el)),p[o].el.css({left:p[o].left+"px"}),p.splice(o,0,p.splice(l,1)[0]),l=o;break}},stop:function(e,t){T=!1,v.children().css({position:"relative",left:"",transition:""}),o.hasClass("active")||o.css({zIndex:""}),E(),c!==l&&u.onreorder(d,$.makeArray(v.children().map(function(){return $(this).data("tabId")}))),D(p[l].el.data("tabId"))}})}setTimeout(function(){E()},10),f&&(f.remove(),f=null)},removeTab:R,activateTab:D,nextTab:function(){var e=v.find("li.active").next();0<e.length&&D(e.find("a"))},previousTab:function(){var e=v.find("li.active").prev();0<e.length&&D(e.find("a"))},resize:E,count:function(){return v.find("li.red-ui-tab").length},contains:function(e){return 0<v.find("a[href='#"+e+"']").length},renameTab:function(e,t){h[e].label=t;var i=v.find("a[href='#"+e+"']");i.attr("title",t),i.find("span.red-ui-text-bidi-aware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),E()},selection:c,order:function(e){var t=$.makeArray(v.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var i,o=!0;for(i=0;i<e.length;i++)if(e[i]!==t[i]){o=!1;break}if(!o){var n={};v.children().detach().each(function(){n[$(this).data("tabId")]=$(this)});for(i=0;i<e.length;i++)n[e[i]].appendTo(v)}}}}}}}(),RED.stack={create:function(o){var n=o.container;function a(){if(0<s.length){var t=0;s.forEach(function(e){t+=e.header.outerHeight()});var e=n.innerHeight();r=e-t-(s.length-1),s.forEach(function(e){e.contentWrap.height(r)})}}n.addClass("red-ui-stack");var r=0,s=[],d=!0;return o.fill&&o.singleExpanded&&($(window).on("resize",a),$(window).on("focus",a)),{add:function(t){s.push(t),t.container=$('<div class="red-ui-palette-category">').appendTo(n),d||t.container.hide();var e=$('<div class="red-ui-palette-header"></div>').appendTo(t.container);if(t.header=e,t.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(t.container),o.fill&&t.contentWrap.css("height",r),t.content=$("<div></div>").appendTo(t.contentWrap),!1!==t.collapsible){e.on("click",function(){if(o.singleExpanded)if(t.isExpanded())2===s.length&&(s[0]===t?(s[0].collapse(),s[1].expand()):(s[1].collapse(),s[0].expand()));else{for(var e=0;e<s.length;e++)s[e].isExpanded()&&s[e].collapse();t.expand()}else t.toggle()});var i=$('<i class="fa fa-angle-down"></i>').appendTo(e);t.expanded?(t.container.addClass("expanded"),i.addClass("expanded")):t.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(e),e.css("cursor","default");return t.title=$("<span></span>").html(t.title).appendTo(e),t.toggle=function(){return t.isExpanded()?(t.collapse(),!1):(t.expand(),!0)},t.expand=function(){if(!t.isExpanded())return t.onexpand&&t.onexpand.call(t),o.singleExpanded&&s.forEach(function(e){e!==t&&e.collapse()}),i.addClass("expanded"),t.container.addClass("expanded"),t.contentWrap.slideDown(200),!0},t.collapse=function(){if(t.isExpanded())return i.removeClass("expanded"),t.container.removeClass("expanded"),t.contentWrap.slideUp(200),!0},t.isExpanded=function(){return t.container.hasClass("expanded")},o.fill&&o.singleExpanded&&a(),t},hide:function(){return d=!1,s.forEach(function(e){e.container.hide()}),this},show:function(){return d=!0,s.forEach(function(e){e.container.show()}),this},resize:function(){a()}}}},function(p){function e(e){var t=RED.utils.parseContextKey(e);return{option:t.store,value:t.key}}function t(e,t){if(!t)return e;var i="string"==typeof t?t:t.value;return i!==RED.settings.context.default?"#:("+i+")::"+e:e}function u(e){return/^red\/images\/typedInput\/.+\.png$/.test(e)&&(e=e.replace(/.png$/,".svg")),e}var r={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:e,export:t},global:{value:"global",label:"global.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:e,export:t},str:{value:"str",label:"string",icon:"red/images/typedInput/az.svg"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.svg",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.svg",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.svg",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var i=this,e=this.value();try{e=JSON.stringify(JSON.parse(e),null,4)}catch(e){}RED.editor.editJSON({value:e,complete:function(e){var t=e;try{t=JSON.stringify(JSON.parse(e))}catch(e){}i.value(t)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.svg"},date:{value:"date",label:"timestamp",icon:"fa fa-clock-o",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.svg",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var t=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(e){t.value(e.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.svg",expand:function(){var t=this;RED.editor.editBuffer({value:this.value(),complete:function(e){t.value(e)}})}},env:{value:"env",label:"env variable",icon:"red/images/typedInput/env.svg"},node:{value:"node",label:"node",icon:"red/images/typedInput/target.svg",valueLabel:function(e,t){var i=RED.nodes.node(t),o=p("<div>",{class:"red-ui-search-result-node"}).css({"margin-top":"2px","margin-left":"3px"}).appendTo(e),n=p("<span>").css({"line-height":"32px","margin-left":"6px"}).appendTo(e);if(i){var a=RED.utils.getNodeColor(i.type,i._def),r=RED.utils.getNodeIcon(i._def,i);"tab"===i.type&&(a="#C0DEED"),o.css("backgroundColor",a);var s=p("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(o);RED.utils.createIconElement(r,s,!0);var d=RED.utils.getNodeLabel(i,i.id);n.text(d)}else o.css({backgroundColor:"#eee","border-style":"dashed"})},expand:function(){var t=this;RED.tray.hide(),RED.view.selectNodes({single:!0,selected:[t.value()],onselect:function(e){t.value(e.id),RED.tray.show()},oncancel:function(){RED.tray.show()}})}}},s=!1;p.widget("nodered.typedInput",{_create:function(){try{if(!s&&RED&&RED._){for(var e in r)r.hasOwnProperty(e)&&(r[e].label=RED._("typedInput.type."+e,{defaultValue:r[e].label}));var t=RED.settings.context.stores.map(function(e){return{value:e,label:e,icon:'<i class="red-ui-typedInput-icon fa fa-database"></i>'}});t.length<2?(r.flow.options=[],r.global.options=[]):(r.flow.options=t,r.global.options=t)}s=!0;var i=this;this.disarmClick=!1,this.input=p('<input class="red-ui-typedInput-input" type="text"></input>'),this.input.insertAfter(this.element),this.input.val(this.element.val()),this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.input.wrap("<div>").parent().addClass("red-ui-typedInput-input-wrap"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var o,n=this.element.attr("style");if(null!==(o=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(n))?(this.input.css("width","100%"),this.uiSelect.width(o[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=i.element.css("margin"+e);i.uiSelect.css("margin"+e,t),i.input.css("margin"+e,0)}),["type","placeholder","autocomplete","data-i18n"].forEach(function(e){var t=i.element.attr(e);i.input.attr(e,t)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.element.attr("type","hidden"),this.options.types=this.options.types||Object.keys(r),this.selectTrigger=p('<button class="red-ui-typedInput-type-select" tabindex="0"></button>').prependTo(this.uiSelect),p('<i class="red-ui-typedInput-icon fa fa-caret-down"></i>').toggle(1<this.options.types.length).appendTo(this.selectTrigger),this.selectLabel=p('<span class="red-ui-typedInput-type-label"></span>').appendTo(this.selectTrigger),this.valueLabelContainer=p('<div class="red-ui-typedInput-value-label">').appendTo(this.uiSelect),this.types(this.options.types),this.options.typeField){this.typeField=p(this.options.typeField).hide();var a=this.typeField.val();a&&this.typeMap[a]&&(this.options.default=a)}else this.typeField=p("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.input.on("focus",function(){i.uiSelect.addClass("red-ui-typedInput-focus")}),this.input.on("blur",function(){i.uiSelect.removeClass("red-ui-typedInput-focus")}),this.input.on("change",function(){i.validate(),i.element.val(i.value()),i.element.trigger("change",i.propertyType,i.value())}),this.input.on("keydown",function(e){37<=e.keyCode&&e.keyCode<=40&&e.stopPropagation()}),this.selectTrigger.on("click",function(e){e.preventDefault(),e.stopPropagation(),i._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&i._showTypeMenu(),e.stopPropagation()}).on("focus",function(){i.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=p('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-caret-down"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=p('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),RED.popover.tooltip(this.optionSelectLabel,function(){return i.optionValue}),this.optionSelectTrigger.on("click",function(e){e.preventDefault(),e.stopPropagation(),i._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&i._showOptionSelectMenu(),e.stopPropagation()}).on("blur",function(){i.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){i.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=p('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"></button>').appendTo(this.uiSelect),this.optionExpandButtonIcon=p('<i class="red-ui-typedInput-icon fa fa-ellipsis-h"></i>').appendTo(this.optionExpandButton),this.type(this.options.default||this.typeList[0].value)}catch(e){console.log(e.stack)}},_showTypeMenu:function(){if(1<this.typeList.length){this._showMenu(this.menu,this.selectTrigger);var e=this.menu.find("[value='"+this.propertyType+"']");setTimeout(function(){e.trigger("focus")},120)}else this.input.trigger("focus")},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectTrigger);var e=this.optionMenu.find("[value='"+this.optionValue+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.trigger("focus")}},_hideMenu:function(e){if(p(document).off("mousedown.red-ui-typedInput-close-property-select"),e.hide(),e.css({height:"auto"}),e.opts.multiple){var t=[];e.find('input[type="checkbox"]').each(function(){p(this).prop("checked")&&t.push(p(this).data("value"))}),e.callback(t)}this.elementDiv.is(":visible")?this.input.trigger("focus"):this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.trigger("focus"):this.selectTrigger.trigger("focus")},_createMenu:function(e,o,n){var a=this,r=p("<div>").addClass("red-ui-typedInput-options red-ui-editor-dialog");return r.opts=o,r.callback=n,e.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var i,e=p('<a href="#"></a>').attr("value",t.value).appendTo(r);t.label&&e.text(t.label),t.icon?0===t.icon.indexOf("<")?p(t.icon).prependTo(e):-1!==t.icon.indexOf("/")?p("<img>",{src:u(t.icon),style:"margin-right: 4px; height: 18px;"}).prependTo(e):p("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(e):e.css({paddingLeft:"18px"}),t.icon||t.label||e.text(t.value),o.multiple&&(i=p('<input type="checkbox">').css("pointer-events","none").data("value",t.value).prependTo(e).on("mousedown",function(e){e.preventDefault()})),e.on("click",function(e){e.preventDefault(),e.stopPropagation(),o.multiple?i.prop("checked",!i.prop("checked")):(n(t.value),a._hideMenu(r))})}),r.css({display:"none"}),r.appendTo(document.body),r.on("keydown",function(e){40===e.keyCode?(e.preventDefault(),p(this).children(":focus").next().trigger("focus")):38===e.keyCode?(e.preventDefault(),p(this).children(":focus").prev().trigger("focus")):27===e.keyCode&&(e.preventDefault(),a._hideMenu(r)),e.stopPropagation()}),r},_showMenu:function(t,i){if(this.disarmClick)this.disarmClick=!1;else{if(t.opts.multiple){var o={};this.value().split(",").forEach(function(e){o[e]=!0}),t.find('input[type="checkbox"]').each(function(){p(this).prop("checked",o[p(this).data("value")])})}var n=this,e=i.offset(),a=i.height(),r=t.height(),s=a+e.top;s+r>p(window).height()&&(s-=s+r-p(window).height()+5),s<0&&(t.height(r+s),s=0),t.css({top:s+"px",left:e.left+"px"}),t.slideDown(100),this._delay(function(){n.uiSelect.addClass("red-ui-typedInput-focus"),p(document).on("mousedown.red-ui-typedInput-close-property-select",function(e){p(e.target).closest(t).length||n._hideMenu(t),p(e.target).closest(i).length&&(n.disarmClick=!0,e.preventDefault())})})}},_getLabelWidth:function(e,t){var i=e.outerWidth();if(0===i){var o=p('<div class="red-ui-editor"></div>').css({position:"absolute","white-space":"nowrap",top:-2e3}).appendTo(document.body),n=p('<div class="red-ui-typedInput-container"></div>').appendTo(o),a=e.clone().appendTo(n);setTimeout(function(){i=a.outerWidth(),o.remove(),t(i)},50)}else t(i)},_resize:function(){var t=this;null!==this.uiWidth&&this.uiSelect.width(this.uiWidth);var i=this.typeMap[this.propertyType];i&&!1===i.hasValue?this.selectTrigger.addClass("red-ui-typedInput-full-width"):(this.selectTrigger.removeClass("red-ui-typedInput-full-width"),this._getLabelWidth(this.selectTrigger,function(e){t.elementDiv.css("left",e+"px"),t.valueLabelContainer.css("left",e+"px"),t.optionExpandButton.shown?(t.elementDiv.css("right","22px"),t.valueLabelContainer.css("right","22px")):(t.elementDiv.css("right","0"),t.valueLabelContainer.css("right","0"),t.input.css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"})),t.optionSelectTrigger&&(i&&i.options&&!0===i.hasValue?(t.optionSelectLabel.css({left:"auto"}),t._getLabelWidth(t.optionSelectLabel,function(e){t.optionSelectTrigger.css({width:23+e+"px"}),t.elementDiv.css("right",23+e+"px"),t.input.css({"border-top-right-radius":0,"border-bottom-right-radius":0})})):(t.optionSelectLabel.css({left:"0"}),t.optionSelectTrigger.css({width:"calc( 100% - "+e+"px )"}),t.optionExpandButton.shown||(t.elementDiv.css({right:0}),t.input.css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"}))))}))},_updateOptionSelectLabel:function(e){var t=this.typeMap[this.propertyType];this.optionSelectLabel.empty(),this.typeMap[this.propertyType].valueLabel?t.multiple?this.typeMap[this.propertyType].valueLabel.call(this,this.optionSelectLabel,e):this.typeMap[this.propertyType].valueLabel.call(this,this.optionSelectLabel,e.value):t.multiple?this.optionSelectLabel.text(e.length+" selected"):(e.icon?0===e.icon.indexOf("<")?p(e.icon).prependTo(this.optionSelectLabel):-1!==e.icon.indexOf("/")?p("<img>",{src:u(e.icon),style:"height: 18px;"}).prependTo(this.optionSelectLabel):p("<i>",{class:"red-ui-typedInput-icon "+e.icon}).prependTo(this.optionSelectLabel):e.label?this.optionSelectLabel.text(e.label):this.optionSelectLabel.text(e.value),t.hasValue&&(this.optionValue=e.value,this._resize(),this.input.trigger("change",this.propertyType,this.value())))},_destroy:function(){this.optionMenu&&this.optionMenu.remove(),this.menu.remove(),this.uiSelect.remove()},types:function(e){var i=this,t=this.type();this.typeMap={},this.typeList=e.map(function(e){var t;return t="string"==typeof e?r[e]:e,i.typeMap[t.value]=t}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.selectTrigger.find(".fa-caret-down").toggle(1<this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,{},function(e){i.type(e)}),t&&!this.typeMap.hasOwnProperty(t)?this.type(this.typeList[0].value):(this.propertyType=null,this.type(t)),setTimeout(function(){i._resize()},0)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){var o=this,n=this.typeMap[this.propertyType];if(!arguments.length){var t=this.input.val();return n.export&&(t=n.export(t,this.optionValue)),t}var a=[];if(n.options){var i=[e];n.multiple&&(a=[],i=e.split(",")),i.forEach(function(e){for(var t=0;t<n.options.length;t++){var i=n.options[t];if("string"==typeof i){if(i===e||i===""+e){a.push(o.activeOptions[i]);break}}else if(i.value===e){a.push(i);break}}}),this.input.val(e),n.multiple?this._updateOptionSelectLabel(a):(0===a.length&&(a=[{value:""}]),this._updateOptionSelectLabel(a[0]))}else this.input.val(e),n.valueLabel&&(this.valueLabelContainer.empty(),n.valueLabel.call(this,this.valueLabelContainer,e));this.input.trigger("change",this.type(),e)},type:function(e){if(!arguments.length)return this.propertyType;var n=this,a=this.typeMap[e];if(a&&this.propertyType!==e){var t;if(this.propertyType=e,this.typeField&&this.typeField.val(e),this.selectLabel.empty(),a.icon&&!1!==a.showLabel&&(0===a.icon.indexOf("<")?p(a.icon).prependTo(this.selectLabel):-1!==a.icon.indexOf("/")?((t=new Image).onload=function(){n._resize()},t.onerror=function(){n._resize()},t.name=a.icon,t.src=u(a.icon),p("<img>",{src:u(a.icon),style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):p("<i>",{class:"red-ui-typedInput-icon "+a.icon}).prependTo(this.selectLabel)),!1!==a.hasValue&&(!1===a.showLabel||a.icon)||this.selectLabel.text(a.label),this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),a.options){if(this.optionExpandButton&&(this.optionExpandButton.hide(),this.optionExpandButton.shown=!1),this.optionSelectTrigger){var i;if(this.optionSelectTrigger.show(),a.hasValue?this.elementDiv.show():this.elementDiv.hide(),this.valueLabelContainer.hide(),this.activeOptions={},a.options.forEach(function(e){"string"==typeof e?n.activeOptions[e]={label:e,value:e}:n.activeOptions[e.value]=e}),n.activeOptions.hasOwnProperty(n.optionValue)||(n.optionValue=null),a.hasValue){var o=this.optionValue||a.options[0];if(a.parse){var r=a.parse(this.input.val());r.option&&(o=r.option,this.activeOptions.hasOwnProperty(o)||(r.option=Object.keys(this.activeOptions)[0],o=r.option)),this.input.val(r.value),a.export&&this.element.val(a.export(r.value,r.option||o))}"string"==typeof o?(this.optionValue=o,this.activeOptions.hasOwnProperty(o)||(o=Object.keys(this.activeOptions)[0]),o?this._updateOptionSelectLabel(this.activeOptions[o]):this.optionSelectTrigger.hide()):o?(this.optionValue=o.value,this._updateOptionSelectLabel(o)):this.optionSelectTrigger.hide()}else{var s=!1,d=this.input.val();if(a.multiple){var l={};d.split(",").forEach(function(e){e&&(l[e]=!0)});for(c=0;c<a.options.length;c++)i=a.options[c],delete l[i.value||i];p.isEmptyObject(l)||this.value((a.default||[]).join(","))}else{for(var c=0;c<a.options.length;c++){if("string"==typeof(i=a.options[c])&&i===d){n._updateOptionSelectLabel({value:d}),s=!0;break}if(i.value===d){n._updateOptionSelectLabel(i),s=!0;break}}s||("string"==typeof(i=a.options[0])?(this.value(i),n._updateOptionSelectLabel({value:i})):(this.value(i.value),n._updateOptionSelectLabel(i)))}}this.optionMenu=this._createMenu(a.options,a,function(e){a.multiple?(n._updateOptionSelectLabel(e),a.hasValue||n.value(e.join(","))):(n._updateOptionSelectLabel(n.activeOptions[e]),a.hasValue||n.value(n.activeOptions[e].value))})}this._trigger("typechange",null,this.propertyType),this.input.trigger("change",this.propertyType,this.value())}else this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===a.hasValue?(this.oldValue=this.input.val(),this.input.val(""),this.elementDiv.hide(),this.valueLabelContainer.hide()):a.valueLabel?(this.valueLabelContainer.show(),this.valueLabelContainer.empty(),a.valueLabel.call(this,this.valueLabelContainer,this.input.val()),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.input.val(this.oldValue),delete this.oldValue),this.valueLabelContainer.hide(),this.elementDiv.show()),this.optionExpandButton&&(a.expand?(a.expand.icon?this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa "+a.expand.icon):this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa fa-ellipsis-h"),this.optionExpandButton.shown=!0,this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){if(e.preventDefault(),"function"==typeof a.expand)a.expand.call(n);else{var t=p("<div>"),i=a.expand.content.call(n,t),o=RED.popover.panel(t);o.container.css({width:n.valueLabelContainer.width()}),a.expand.minWidth&&o.container.css({minWidth:a.expand.minWidth+"px"}),o.show({target:n.optionExpandButton,onclose:i.onclose,align:"right"})}})):(this.optionExpandButton.shown=!1,this.optionExpandButton.hide())),this._trigger("typechange",null,this.propertyType),this.input.trigger("change",this.propertyType,this.value());t||this._resize()}},validate:function(){var e,t=this.value(),i=this.type();if(this.typeMap[i]&&this.typeMap[i].validate){var o=this.typeMap[i].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),function(d){d.widget("nodered.toggleButton",{_create:function(){var t=this,i=!1;this.options.hasOwnProperty("invertState")&&(i=this.options.invertState);var e=this.options.baseClass||"red-ui-button",o=this.options.enabledIcon||"fa-check-square-o",n=this.options.disabledIcon||"fa-square-o",a=this.options.hasOwnProperty("enabledLabel")?this.options.enabledLabel:RED._("editor:workspace.enabled"),r=this.options.hasOwnProperty("disabledLabel")?this.options.disabledLabel:RED._("editor:workspace.disabled");this.element.css("display","none"),this.element.on("focus",function(){t.button.focus()}),this.button=d('<button type="button" class="red-ui-toggleButton '+e+' toggle single"><i class="fa"></i> <span></span></button>'),this.options.class&&this.button.addClass(this.options.class),this.element.after(this.button),this.buttonIcon=this.button.find("i"),this.buttonLabel=this.button.find("span"),this.button.addClass("selected"),this.buttonIcon.addClass(o),this.buttonLabel.text(a);var s=this.button.width();this.button.removeClass("selected"),this.buttonIcon.removeClass(o),t.buttonIcon.addClass(n),t.buttonLabel.text(r),s=Math.max(s,this.button.width()),this.buttonIcon.removeClass(n),0<s&&this.button.width(Math.ceil(s)),this.button.on("click",function(e){e.stopPropagation(),t.buttonIcon.hasClass(n)?t.element.prop("checked",!i):t.element.prop("checked",i),t.element.trigger("change")}),this.element.on("change",function(e){d(this).prop("checked")!==i?(t.button.addClass("selected"),t.buttonIcon.addClass(o),t.buttonIcon.removeClass(n),t.buttonLabel.text(a)):(t.button.removeClass("selected"),t.buttonIcon.addClass(n),t.buttonIcon.removeClass(o),t.buttonLabel.text(r))}),this.element.trigger("change")}})}(jQuery),RED.actions=function(){var o={};return{add:function(e,t){o[e]=t},remove:function(e){delete o[e]},get:function(e){return o[e]},invoke:function(e,t){o.hasOwnProperty(e)&&o[e](t)},list:function(){var i=[];return Object.keys(o).forEach(function(e){var t=RED.keyboard.getShortcut(e);i.push({id:e,scope:t?t.scope:void 0,key:t?t.key:void 0,user:t?t.user:void 0})}),i}}}(),RED.deploy=function(){var t={full:{img:"red/images/deploy-full-o.svg"},nodes:{img:"red/images/deploy-nodes-o.svg"},flows:{img:"red/images/deploy-flows-o.svg"}},g={unknown:!1,unusedConfig:!1,invalid:!1},v="full",b=!1,l=null;function a(e){v=e,$("#red-ui-header-button-deploy-icon").attr("src",t[e].img)}function m(e){var t="";if(e.z){var i=RED.nodes.workspace(e.z);t=i?i.label:(i=RED.nodes.subflow(e.z)).name}var o=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:o}}function y(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function w(e,t){var i=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(i);var o=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(i),n=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(i),a=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(i);i.i18n(),l=null;var r=[{text:RED._("common.label.cancel"),click:function(){s.close()}},{id:"red-ui-deploy-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),s.close())}},{id:"red-ui-deploy-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(l),s.close())}}];t&&r.push({id:"red-ui-deploy-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){R(!0,t),s.close()}});var s=RED.notify(i,{modal:!0,fixed:!0,width:600,buttons:r}),d=Date.now();RED.diff.getRemoteDiff(function(e){var t=Math.max(1e3-(Date.now()-d),0);l=e,setTimeout(function(){o.hide(),0===Object.keys(e.conflicts).length?(n.show(),$("#red-ui-deploy-dialog-confirm-deploy-merge").removeClass("disabled")):a.show(),$("#red-ui-deploy-dialog-confirm-deploy-review").removeClass("disabled")},t)})}function D(e){if(5<e.length){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function E(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function r(){var t=Date.now();$(".red-ui-deploy-button-content").css("opacity",0),$(".red-ui-deploy-button-spinner").show();var o=!$("#red-ui-header-button-deploy").hasClass("disabled");$("#red-ui-header-button-deploy").addClass("disabled"),b=!0,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$.ajax({url:"flows",type:"POST",headers:{"Node-RED-Deployment-Type":"reload"}}).done(function(e,t,i){o&&$("#red-ui-header-button-deploy").removeClass("disabled"),RED.notify("<p>"+RED._("deploy.successfulRestart")+"</p>","success")}).fail(function(e,t,i){o&&$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?w(nns,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){b=!1;var e=Math.max(0,300-(Date.now()-t));setTimeout(function(){$(".red-ui-deploy-button-content").css("opacity",1),$(".red-ui-deploy-button-spinner").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide()},e)})}function R(e,t){if(!$("#red-ui-header-button-deploy").hasClass("disabled")){if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");if(!e){var i,o=!1,n=!1,a=[],r=[];RED.nodes.eachNode(function(e){o=o||!e.valid,e.valid||r.push(m(e)),"unknown"===e.type&&-1==a.indexOf(e.name)&&a.push(e.name)}),i=0<a.length;var s=[];RED.nodes.eachConfig(function(e){!1!==e._def.hasUsers&&0===e.users.length&&(s.push(m(e)),n=!0)});var d,l,c=!1,p=[];if(i&&!g.unknown?(c=!0,d="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+D(a).map(function(e){return E(e)}).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",p=[{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){R(!0),l.close()}}]):o&&!g.invalid&&(c=!0,r.sort(y),d="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+D(r.map(function(e){return E((e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")")})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",p=[{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){R(!0),l.close()}}]),c)return p.unshift({text:RED._("common.label.cancel"),click:function(){l.close()}}),void(l=RED.notify(d,{modal:!0,fixed:!0,buttons:p}))}var u=RED.nodes.createCompleteNodeSet(),f=Date.now();$(".red-ui-deploy-button-content").css("opacity",0),$(".red-ui-deploy-button-spinner").show(),$("#red-ui-header-button-deploy").addClass("disabled");var h={flows:u};t||(h.rev=RED.nodes.version()),b=!0,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":v}}).done(function(e,t,i){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(u),n?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachSubflow(function(e){e.changed=!1}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,i){RED.nodes.dirty(!0),$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?w(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){b=!1;var e=Math.max(0,300-(Date.now()-f));setTimeout(function(){$(".red-ui-deploy-button-content").css("opacity",1),$(".red-ui-deploy-button-spinner").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide()},e)})}}return{init:function(e){var n,t=(e=e||{}).type||"default";if("default"==t)$('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content"><img id="red-ui-header-button-deploy-icon" src="red/images/deploy-full-o.svg"> <span>'+RED._("deploy.deploy")+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="red-ui-header-button-deploy-options" class="red-ui-deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".red-ui-header-toolbar"),RED.menu.init({id:"red-ui-header-button-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.svg",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&a("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.svg",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&a("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.svg",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&a("nodes")}},null,{id:"deploymenu-item-reload",icon:"red/images/deploy-reload.svg",label:RED._("deploy.restartFlows"),sublabel:RED._("deploy.restartFlowsDesc"),onselect:"core:restart-flows"}]});else if("simple"==t){var i=e.label||RED._("deploy.deploy"),o="red/images/deploy-full-o.svg";e.hasOwnProperty("icon")&&(o=e.icon),$('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content">'+(o?'<img id="red-ui-header-button-deploy-icon" src="'+o+'"> ':"")+"<span>"+i+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".red-ui-header-toolbar")}$("#red-ui-header-button-deploy").on("click",function(e){e.preventDefault(),R()}),RED.actions.add("core:deploy-flows",R),"default"===t&&(RED.actions.add("core:restart-flows",r),RED.actions.add("core:set-deploy-type-to-full",function(){RED.menu.setSelected("deploymenu-item-full",!0)}),RED.actions.add("core:set-deploy-type-to-modified-flows",function(){RED.menu.setSelected("deploymenu-item-flow",!0)}),RED.actions.add("core:set-deploy-type-to-modified-nodes",function(){RED.menu.setSelected("deploymenu-item-node",!0)})),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#red-ui-header-button-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#red-ui-header-button-deploy").addClass("disabled"))}),RED.comms.subscribe("notification/runtime-deploy",function(e,t){if(!n){var i=RED.nodes.version();if(null===i||b||i===t.revision)return;var o=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));n=RED.notify(o,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){n.close(),n=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){n.close(),w(RED.nodes.createCompleteNodeSet(),!1),n=null}}]})}})},setDeployInflight:function(e){b=e}}}(),RED.diff=function(){var s=!1;function R(e,t,i){var o=$('<div class="red-ui-diff-panel"></div>').appendTo(e),n=$('<div class="red-ui-diff-panel-headers"></div>').appendTo(o);"merge"===i.mode&&o.addClass("red-ui-diff-panel-merge");var a=function(e,S){var t=$('<ol class="red-ui-diff-list"></ol>').appendTo(e);return t.editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,t,i){var o=i.diff,n=i.remoteDiff,a=i.tab.n,r=i.def,s=S.conflicts,d=$("<div>",{class:"red-ui-diff-list-flow"}).appendTo(e);d.addClass("collapsed");var l,c,p=$("<div>",{class:"red-ui-diff-list-flow-title"}).appendTo(d),u=$("<div>").appendTo(d),f=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(p),h=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(p);n&&(l=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(p)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(f),O(a,r).appendTo(f);var g=(i.newTab||i.tab).n,v=$("<span>",{class:"red-ui-diff-list-flow-title-meta"}).appendTo(f);"tab"===g.type?v.text(g.label||g.id):"subflow"===a.type?v.text(g.name||g.id):v.text(RED._("diff.globalNodes"));var b={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(i.newTab||i.remoteTab){var m,y={node:o.newConfig.all[a.id],all:o.newConfig.all,diff:o};if(n&&(m={node:n.newConfig.all[a.id]||null,all:n.newConfig.all,diff:n}),void 0!==a.type){var w,D=$("<div>",{class:"red-ui-diff-list-node red-ui-diff-list-node-props collapsed"}).appendTo(u),E=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(D),R=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(E),x=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(E);o.newConfig.all[a.id]?o.added[a.id]?(x.addClass("red-ui-diff-status-added"),!0,$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(x)):o.changed[a.id]?(x.addClass("red-ui-diff-status-changed"),!0,$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(x)):(x.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(x)):x.addClass("red-ui-diff-empty"),n&&(w=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(E),n.newConfig.all[a.id]?n.added[a.id]?(w.addClass("red-ui-diff-status-added"),!0,$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(w)):n.changed[a.id]?(w.addClass("red-ui-diff-status-changed"),!0,$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(w)):(w.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(w)):(w.addClass("red-ui-diff-empty"),n.deleted[a.id]&&!0)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(R),$("<span>").text(RED._("diff.flowProperties")).appendTo(R),E.on("click",function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),P(r,a,y,m).appendTo(D),c="",s[a.id]?(b.conflicts++,x.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(x),w.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(w),D.addClass("red-ui-diff-list-node-conflict")):c=S.resolutions[a.id],N(a,D,x,w,!0,!s[a.id],c,S)}}var k=0,T=0,_={};if(i.tab.nodes.forEach(function(e){_[e.id]=!0,I(e,b,S).appendTo(u)}),i.newTab&&(k=i.newTab.nodes.length,i.newTab.nodes.forEach(function(e){_[e.id]||(_[e.id]=!0,I(e,b,S).appendTo(u))})),i.remoteTab&&(T=i.remoteTab.nodes.length,i.remoteTab.nodes.forEach(function(e){_[e.id]||I(e,b,S).appendTo(u)})),p.on("click",function(e){p.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".red-ui-diff-list-node").addClass("collapsed"),$(this).parent().find(".red-ui-debug-msg-element").addClass("collapsed"))}),o.deleted[a.id])$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(i.newTab)if(o.added[a.id])$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{a.id&&(o.changed[a.id]?b.local.changedCount++:b.local.unchangedCount++);var j=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(h);$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:k})).appendTo(j),0<b.conflicts+b.local.addedCount+b.local.changedCount+b.local.deletedCount&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(j),0<b.conflicts&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+b.conflicts+"</span></span>").appendTo(j),0<b.local.addedCount&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+b.local.addedCount+"</span></span>").appendTo(j),0<b.local.changedCount&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+b.local.changedCount+"</span></span>").appendTo(j),0<b.local.deletedCount&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+b.local.deletedCount+"</span></span>").appendTo(j),$('<span class="red-ui-diff-status"> ] </span>').appendTo(j))}else h.addClass("red-ui-diff-empty");if(n){if(n.deleted[a.id])$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(l);else if(i.remoteTab)if(n.added[a.id])$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(l);else{a.id&&(n.changed[a.id]?b.remote.changedCount++:b.remote.unchangedCount++);var C=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(l);$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:T})).appendTo(C),0<b.conflicts+b.remote.addedCount+b.remote.changedCount+b.remote.deletedCount&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(C),0<b.conflicts&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+b.conflicts+"</span></span>").appendTo(C),0<b.remote.addedCount&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+b.remote.addedCount+"</span></span>").appendTo(C),0<b.remote.changedCount&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+b.remote.changedCount+"</span></span>").appendTo(C),0<b.remote.deletedCount&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+b.remote.deletedCount+"</span></span>").appendTo(C),$('<span class="red-ui-diff-status"> ] </span>').appendTo(C))}else l.addClass("red-ui-diff-empty");if(c="",0<b.conflicts?p.addClass("red-ui-diff-list-node-conflict"):c=S.resolutions[a.id],a.id){var L=!(0<b.conflicts&&(o.deleted[a.id]||n.deleted[a.id]));N(a,p,h,l,!1,L,c,S)}}0===d.find(".red-ui-diff-list-node").length&&d.addClass("red-ui-diff-list-flow-empty"),e.i18n()}}),t}(o,t),r=t.localDiff,s=t.remoteDiff,d=(t.conflicts,r.currentConfig),l=r.newConfig;if(void 0!==s){o.addClass("red-ui-diff-three-way");var c=i.oldRevTitle||RED._("diff.local"),p=i.newRevTitle||RED._("diff.remote");$("<div></div>").text(c).appendTo(n),$("<div></div>").text(p).appendTo(n)}else o.removeClass("red-ui-diff-three-way");return{list:a,finish:function(){var e={diff:r,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:d.globals},newTab:{n:{},nodes:l.globals}};void 0!==s&&(e.remoteTab={n:{},nodes:s.newConfig.globals},e.remoteDiff=s),a.editableList("addItem",e);var t,o={};for(t in d.tabOrder.forEach(function(e){var t=d.tabs[e],i={diff:r,def:RED.nodes.getType("tab"),tab:t};l.tabs.hasOwnProperty(e)&&(i.newTab=l.tabs[e]),void 0!==s&&(i.remoteTab=s.newConfig.tabs[e],i.remoteDiff=s),o[e]=!0,a.editableList("addItem",i)}),l.tabOrder.forEach(function(e){if(!o[e]){o[e]=!0;var t=l.tabs[e],i={diff:r,def:RED.nodes.getType("tab"),tab:t,newTab:t};void 0!==s&&(i.remoteDiff=s),a.editableList("addItem",i)}}),void 0!==s&&s.newConfig.tabOrder.forEach(function(e){if(!o[e]){var t=s.newConfig.tabs[e],i={diff:r,remoteDiff:s,def:RED.nodes.getType("tab"),tab:t,remoteTab:t};a.editableList("addItem",i)}}),d.subflows)d.subflows.hasOwnProperty(t)&&(o[t]=!0,e={diff:r,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:d.subflows[t]},l.subflows.hasOwnProperty(t)&&(e.newTab=l.subflows[t]),void 0!==s&&(e.remoteTab=s.newConfig.subflows[t],e.remoteDiff=s),a.editableList("addItem",e));for(t in l.subflows)l.subflows.hasOwnProperty(t)&&!o[t]&&(o[t]=!0,e={diff:r,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:l.subflows[t],newTab:l.subflows[t]},void 0!==s&&(e.remoteDiff=s),a.editableList("addItem",e));if(void 0!==s)for(t in s.newConfig.subflows)s.newConfig.subflows.hasOwnProperty(t)&&!o[t]&&(e={diff:r,remoteDiff:s,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:s.newConfig.subflows[t],remoteTab:s.newConfig.subflows[t]},a.editableList("addItem",e))}}}function E(e,n){var t=$("<div>",{class:"red-ui-diff-list-wires"}),a=$("<ol></ol>"),r=0;return e.forEach(function(e,t){var i=$("<li>").appendTo(a);if(e&&0<e.length){$("<span>").text(t+1).appendTo(i);var o=$("<ul>").appendTo(i);e.forEach(function(e){r++;var t=$("<li>").appendTo(o),i=n[e];i?w(i,RED.nodes.getType(i.type)||{}).appendTo(t):t.text(e)})}else i.text("none")}),0===r?t.text("none"):a.appendTo(t),t}function O(e,t){var i=$("<div>",{class:"red-ui-diff-list-node-icon"}),o=RED.utils.getNodeColor(e.type,t),n=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(o="#C0DEED"),i.css("backgroundColor",o);var a=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(i);return RED.utils.createIconElement(n,a,!1),i}function w(e,t){var i=$("<div>",{class:"red-ui-diff-list-node-title"});O(e,t).appendTo(i);var o=e.label||e.name||e.id;return $("<div>",{class:"red-ui-diff-list-node-description"}).text(o).appendTo(i),i}function I(t,e,i){var o=i.localDiff,n=i.remoteDiff,a=i.conflicts[t.id],r=!0;o.added[t.id]&&(e.local.addedCount++,r=!1),n&&n.added[t.id]&&(e.remote.addedCount++,r=!1),o.deleted[t.id]&&(e.local.deletedCount++,r=!1),n&&n.deleted[t.id]&&(e.remote.deletedCount++,r=!1),o.changed[t.id]&&(e.local.changedCount++,r=!!0),n&&n.changed[t.id]&&(e.remote.changedCount++,r=!!0);var s=RED.nodes.getType(t.type);void 0===s&&(s=/^subflow:/.test(t.type)?{icon:"subflow.svg",category:"subflows",color:"#DDAA99",defaults:{name:{value:""}}}:{});var d,l=$("<div>",{class:"red-ui-diff-list-node collapsed"}),c=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(l),p=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(c),u=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(c);if(n&&(d=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(c)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(p),r)e.local.unchangedCount++,w(t,s).appendTo(p),u.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u),n&&(e.remote.unchangedCount++,d.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(d)),l.addClass("red-ui-diff-status-unchanged");else if(o.added[t.id])u.addClass("red-ui-diff-status-added"),d&&d.addClass("red-ui-diff-empty"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(u),w(t,s).appendTo(p);else if(n&&n.added[t.id])u.addClass("red-ui-diff-empty"),d.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(d),w(t,s).appendTo(p);else{if(w(t,s).appendTo(p),o.moved[t.id]){var f=o.newConfig.all[t.id];if(o.deleted[t.z]||t.z===f.z||""===t.z||o.newConfig.all[t.z]){u.addClass("red-ui-diff-status-moved");var h="";h=t.z===f.z?RED._("diff.type.movedFrom",{id:o.currentConfig.all[t.id].z||"global"}):RED._("diff.type.movedTo",{id:f.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+h+"</span>").appendTo(u)}else u.addClass("red-ui-diff-empty");!0}else o.deleted[t.z]?(u.addClass("red-ui-diff-empty"),!0):o.deleted[t.id]?(u.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(u),!0):o.changed[t.id]?o.newConfig.all[t.id].z!==t.z?u.addClass("red-ui-diff-empty"):(u.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(u),!0):o.newConfig.all[t.id].z!==t.z?u.addClass("red-ui-diff-empty"):(e.local.unchangedCount++,u.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u));if(n)if(n.moved[t.id]){var g=n.newConfig.all[t.id];if(n.deleted[t.z]||t.z===g.z||""===t.z||n.newConfig.all[t.z]){d.addClass("red-ui-diff-status-moved");var v="";v=t.z===g.z?RED._("diff.type.movedFrom",{id:n.currentConfig.all[t.id].z||"global"}):RED._("diff.type.movedTo",{id:g.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+v+"</span>").appendTo(d)}else d.addClass("red-ui-diff-empty")}else n.deleted[t.z]?d.addClass("red-ui-diff-empty"):n.deleted[t.id]?(d.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(d)):n.changed[t.id]?n.newConfig.all[t.id].z!==t.z?d.addClass("red-ui-diff-empty"):(d.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(d)):n.newConfig.all[t.id].z!==t.z?d.addClass("red-ui-diff-empty"):(e.remote.unchangedCount++,d.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(d))}var b,m={node:o.newConfig.all[t.id],all:o.newConfig.all,diff:o};n&&(b={node:n.newConfig.all[t.id]||null,all:n.newConfig.all,diff:n});var y="";return a?(e.conflicts++,u.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(u),d.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(d),l.addClass("red-ui-diff-list-node-conflict")):y=i.resolutions[t.id],N(t,l,u,d,!1,!a,y,i),c.on("click",function(e){$(this).parent().toggleClass("collapsed"),0===$(this).siblings(".red-ui-diff-list-node-properties").length&&P(s,t,m,b).appendTo(l)}),l}function P(t,o,n,a){var r,s={},d=n.node;a&&(r=a.node);var e=$("<div>",{class:"red-ui-diff-list-node-properties"}),i=$("<table>").appendTo(e),l=$("<colgroup><col/><col/></colgroup>").appendTo(i);void 0!==r&&$("<col/>").appendTo(l);var c,p,u,f,h,g,v,b=$("<tbody>").appendTo(i),m=!1,y=!1,w=!1;c=$("<tr>").appendTo(b),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("id").appendTo(c),p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(c),d?(p.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"></span>').appendTo(p),f=$('<span class="red-ui-diff-list-element"></span>').appendTo(p),s["local.id"]=RED.utils.createObjectElement(d.id).appendTo(f)):p.addClass("red-ui-diff-empty"),void 0!==r&&((u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(c)).addClass("red-ui-diff-status-unchanged"),r?($('<span class="red-ui-diff-status"></span>').appendTo(u),f=$('<span class="red-ui-diff-list-element"></span>').appendTo(u),s["remote.id"]=RED.utils.createObjectElement(r.id).appendTo(f)):u.addClass("red-ui-diff-empty")),o.hasOwnProperty("x")&&(d&&(d.x===o.x&&d.y===o.y||(m=!0)),r&&(r.x===o.x&&r.y===o.y||(y=!0)),(y&&m&&(d.x!==r.x||d.y!==r.y)||!m&&y&&n.diff.deleted[o.id]||m&&!y&&a.diff.deleted[o.id])&&(w=!0),c=$("<tr>").appendTo(b),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("position").appendTo(c),p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(c),d?(p.addClass("red-ui-diff-status-"+(m?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(m?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p),f=$('<span class="red-ui-diff-list-element"></span>').appendTo(p),s["local.position"]=RED.utils.createObjectElement({x:d.x,y:d.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["remote."+e]&&s["remote."+e].prop("expand")(e,t)}}).appendTo(f)):p.addClass("red-ui-diff-empty"),void 0!==r&&((u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(c)).addClass("red-ui-diff-status-"+(y?"changed":"unchanged")),r?($('<span class="red-ui-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),f=$('<span class="red-ui-diff-list-element"></span>').appendTo(u),s["remote.position"]=RED.utils.createObjectElement({x:r.x,y:r.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["local."+e]&&s["local."+e].prop("expand")(e,t)}}).appendTo(f)):u.addClass("red-ui-diff-empty"))),m=y=w=!1,o.hasOwnProperty("wires")&&(h=JSON.stringify(o.wires),d&&(g=JSON.stringify(d.wires),h!==g&&(m=!0)),r&&(v=JSON.stringify(r.wires),h!==v&&(y=!0)),(y&&m&&g!==v||!m&&y&&n.diff.deleted[o.id]||m&&!y&&a.diff.deleted[o.id])&&(w=!0),c=$("<tr>").appendTo(b),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("wires").appendTo(c),p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(c),d?(w?(p.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("red-ui-diff-status-"+(m?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(m?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),E(d.wires,n.all).appendTo(p)):p.addClass("red-ui-diff-empty"),void 0!==r&&(u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(c),r?(w?(u.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("red-ui-diff-status-"+(y?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),E(r.wires,a.all).appendTo(u)):u.addClass("red-ui-diff-empty")));var D=Object.keys(o).filter(function(e){return!("inputLabels"==e||"outputLabels"==e||"z"==e||"wires"==e||"x"===e||"y"===e||"id"===e||"type"===e||t.defaults&&t.defaults.hasOwnProperty(e))});return t.defaults&&(D=D.concat(Object.keys(t.defaults))),"tab"!==o.type&&(D=D.concat(["inputLabels","outputLabels"])),(d&&d.hasOwnProperty("icon")||r&&r.hasOwnProperty("icon"))&&-1===D.indexOf("icon")&&D.unshift("icon"),D.forEach(function(i){w=y=m=!1,h=JSON.stringify(o[i]),d&&(g=JSON.stringify(d[i]),h!==g&&(m=!0,0)),r&&(v=JSON.stringify(r[i]),h!==v&&(y=!0,0)),(y&&m&&g!==v||!m&&y&&n.diff.deleted[o.id]||m&&!y&&a.diff.deleted[o.id])&&(w=!0),c=$("<tr>").appendTo(b);var e=$("<td>",{class:"red-ui-diff-list-cell-label"}).text(i).appendTo(c);p=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(c),d?(w?(p.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("red-ui-diff-status-"+(m?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(m?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),f=$('<span class="red-ui-diff-list-element"></span>').appendTo(p),s["local."+i]=RED.utils.createObjectElement(d[i],{path:i,exposeApi:!0,ontoggle:function(e,t){s["remote."+i]&&s["remote."+i].prop("expand")(e,t)}}).appendTo(f)):p.addClass("red-ui-diff-empty"),void 0!==r&&(u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(c),r?(w?(u.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("red-ui-diff-status-"+(y?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),f=$('<span class="red-ui-diff-list-element"></span>').appendTo(u),s["remote."+i]=RED.utils.createObjectElement(r[i],{path:i,exposeApi:!0,ontoggle:function(e,t){s["local."+i]&&s["local."+i].prop("expand")(e,t)}}).appendTo(f)):u.addClass("red-ui-diff-empty")),d&&r&&"string"==typeof d[i]&&(/\n/.test(d[i])||/\n/.test(r[i]))&&$('<button class="red-ui-button red-ui-button-small red-ui-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').on("click",function(){_(d[i],r[i])}).appendTo(e)}),e}function N(n,a,e,t,r,i,o,s){var d="red-ui-diff-selectbox-"+n.id.replace(/\./g,"-")+(r?"-props":""),l="";(n.z||r)&&(l="red-ui-diff-selectbox-tab-"+(r?n.id:n.z).replace(/\./g,"-"));function c(e){var t;if(void 0===n.type);else if(p)t="red-ui-diff-selectbox-tab-"+n.id.replace(/\./g,"-"),$("."+t+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+t+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-local"),$("."+t+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-remote")):($("."+t+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-local"),$("."+t+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-remote"));else{var i="red-ui-diff-selectbox-"+(r?n.id:n.z).replace(/\./g,"-");$("#"+i+"-local").prop("checked",!1),$("#"+i+"-remote").prop("checked",!1);var o=$("#"+i+"-local").closest(".red-ui-diff-list-flow").find(".red-ui-diff-list-flow-title");o.removeClass("red-ui-diff-select-local"),o.removeClass("red-ui-diff-select-remote")}"local"===this.value?(a.removeClass("red-ui-diff-select-remote"),a.addClass("red-ui-diff-select-local")):"remote"===this.value&&(a.addClass("red-ui-diff-select-remote"),a.removeClass("red-ui-diff-select-local")),x(s)}var p=!r&&("tab"===n.type||"subflow"===n.type),u=$("<label>",{class:"red-ui-diff-selectbox",for:d+"-local"}).on("click",function(e){e.stopPropagation()}).appendTo(e),f=$("<input>",{class:"red-ui-diff-selectbox-input",id:d+"-local",type:"radio",value:"local",name:d,class:l+"-local"}).data("node-id",n.id).on("change",c).appendTo(u),h=$("<label>",{class:"red-ui-diff-selectbox",for:d+"-remote"}).on("click",function(e){e.stopPropagation()}).appendTo(t),g=$("<input>",{class:"red-ui-diff-selectbox-input",id:d+"-remote",type:"radio",value:"remote",name:d,class:l+"-remote"}).data("node-id",n.id).on("change",c).appendTo(h);"local"===o?f.prop("checked",!0):"remote"===o&&g.prop("checked",!0),(i||e.hasClass("red-ui-diff-empty")||t.hasClass("red-ui-diff-empty"))&&(u.hide(),h.hide())}function x(e){var t=0;$(".red-ui-diff-selectbox>input:checked").each(function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()});var i=Object.keys(e.conflicts).length;i-t==0?$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:i-t})):$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:i-t})),i===t&&($("#red-ui-diff-view-diff-merge").removeClass("disabled"),$("#red-ui-diff-view-resolve-diff").removeClass("disabled"))}function t(r){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){var t=RED.nodes.createCompleteNodeSet(),i=RED.nodes.originalFlow(),o=e.flows,n=k(i,t),a=k(i,o);a.rev=e.rev,r(T(n,a))}})}function i(e){void 0===e?t(i):function(o,n){if(s)return;n=n||{},o.localDiff;var a=o.remoteDiff,r=o.conflicts,e={title:n.title||RED._("diff.reviewChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("merge"===n.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".red-ui-tray-body"),i=($('<div class="red-ui-diff-dialog-toolbar"><span><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span> </div>').prependTo(t),R($('<div class="red-ui-diff-container"></div>').appendTo(t),o,n));i.list.hide(),a?($("#red-ui-diff-view-diff-merge").show(),0===Object.keys(r).length?$("#red-ui-diff-view-diff-merge").removeClass("disabled"):$("#red-ui-diff-view-diff-merge").addClass("disabled")):$("#red-ui-diff-view-diff-merge").hide(),x(o),setTimeout(function(){i.finish(),i.list.show()},300),$("#red-ui-sidebar-shade").show()},close:function(){s=!1,$("#red-ui-sidebar-shade").hide()},show:function(){}};"merge"===n.mode&&e.buttons.push({id:"red-ui-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-diff-view-diff-merge").hasClass("disabled")||(x(o),l(o),RED.tray.close())}});RED.tray.show(e)}(e,{mode:"merge"})}function d(e){var t=[],i={},o={},n=[],a={};return e.forEach(function(e){"tab"===(a[e.id]=e).type?(t.push(e.id),i[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(o[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(i[e.z]?i[e.z].nodes.push(e):o[e.z]?o[e.z].nodes.push(e):n.push(e))}),{all:a,tabOrder:t,tabs:i,subflows:o,globals:n}}function k(e,t){var i=d(e),o=d(t),n={},a={},r={},s={};return Object.keys(i.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);o.all.hasOwnProperty(e)?JSON.stringify(i.all[e])!==JSON.stringify(o.all[e])&&(r[e]=!0,i.all[e].z!==o.all[e].z&&(s[e]=!0)):a[e]=!0}),Object.keys(o.all).forEach(function(e){i.all.hasOwnProperty(e)||(n[e]=!0)}),{currentConfig:i,newConfig:o,added:n,deleted:a,changed:r,moved:s}}function T(e,t){var i,o,n={},a={},r={localDiff:e,remoteDiff:t,conflicts:n,resolutions:a},s={};for(i in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(i)){s[i]=!0;var d=e.newConfig.all[i];if(e.changed[i]&&t.deleted[i])n[i]=!0;else if(e.deleted[i]&&t.changed[i])n[i]=!0;else if(e.changed[i]&&t.changed[i]){var l=t.newConfig.all[i];JSON.stringify(d)!==JSON.stringify(l)&&(n[i]=!0)}n[i]||(t.added[i]||t.changed[i]||t.deleted[i]?a[i]="remote":a[i]="local")}for(i in e.added)e.added.hasOwnProperty(i)&&(o=e.newConfig.all[i],t.deleted[o.z]?n[i]=!0:a[i]="local");for(i in t.added)t.added.hasOwnProperty(i)&&(o=t.newConfig.all[i],e.deleted[o.z]?n[i]=!0:a[i]="remote");return r}function c(e){e.localDiff.currentConfig;var t,i=e.localDiff,o=e.remoteDiff,n=e.conflicts,a=e.resolutions;for(t in n)if(n.hasOwnProperty(t)&&!a.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var r,s=[],d={},l={};for(t in i.newConfig.all)i.newConfig.all.hasOwnProperty(t)&&(r=RED.nodes.node(t),"local"===a[t]?(r&&(d[t]=r.changed),s.push(i.newConfig.all[t])):"remote"===a[t]?!o.deleted[t]&&o.newConfig.all.hasOwnProperty(t)&&(r&&(d[t]=r.changed),l[t]=1,s.push(o.newConfig.all[t])):console.log("Unresolved",t));for(t in o.added)o.added.hasOwnProperty(t)&&((r=RED.nodes.node(t))&&(d[t]=r.changed),i.added.hasOwnProperty(t)||(l[t]=2,s.push(o.newConfig.all[t])));return{config:s,nodeChangedStates:d,localChangedStates:l}}function l(e){var t=c(e),i=t.config,o=t.nodeChangedStates,n=t.localChangedStates,a=RED.nodes.dirty(),r={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:o,dirty:a,rev:RED.nodes.version()};RED.history.push(r);var s=RED.nodes.originalFlow();for(var d in e.remoteDiff.added)e.remoteDiff.added.hasOwnProperty(d)&&e.remoteDiff.newConfig.all.hasOwnProperty(d)&&s.push(JSON.parse(JSON.stringify(e.remoteDiff.newConfig.all[d])));RED.nodes.clear();var l=RED.nodes.import(i);RED.nodes.originalFlow(s),l[0].forEach(function(e){(o[e.id]||n[e.id])&&(e.changed=!0)}),RED.nodes.version(e.remoteDiff.rev),a&&RED.nodes.dirty(!0),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}function _(y,w){var e={title:RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".red-ui-tray-body"),i=$('<div class="red-ui-diff-text"></div>').appendTo(t),o=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(i);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(o);for(var n,a=$("<tbody>").appendTo(o),r=function(e,t,i){var o,n,a=e.split(/\r?\n/),r=t.split(/\r?\n/),s=a.length,d=r.length,l={a:[],b:[]},c=[];for(o=0;o<s+1;o++)for(c[o]=[],n=0;n<d+1;n++)c[o][n]=0;for(o=s-1;0<=o;o--)for(n=d-1;0<=n;n--)0,1!==C(a[o],r[n],i)?c[o][n]=c[o+1][n+1]+1:c[o][n]=Math.max(c[o+1][n],c[o][n+1]);n=o=0;for(;o<s&&n<d;){var p=C(a[o],r[n],i);if(1!==p){var u=0;0===p?u=0:2==p&&(u=3),l.a.push({i:o+1,j:n+1,line:a[o],type:u}),l.b.push({i:n+1,j:o+1,line:r[n],type:u}),o++,n++}else c[o+1][n]>=c[o][n+1]?(l.a.push({i:o+1,line:a[o],type:1}),o++):(l.b.push({i:n+1,line:r[n],type:4}),n++)}for(;o<s||n<d;)o==s?(l.b.push({i:n+1,line:r[n],type:4}),n++):n==d&&(l.a.push({i:o+1,line:a[o],type:1}),o++);return l}(y||"",w||""),s=0,d=0,l=Math.max(r.a.length,r.b.length),c=[],p=[],u=0,f=0,h=0;h<l;h++){r[h];var g=s<r.a.length?r.a[s]:{type:2,line:""},v=d<r.b.length?r.b[d]:{type:2,line:""};0===g.type&&0!==v.type?(g={type:2,line:""},d++):0===v.type&&0!==g.type?(v={type:2,line:""},s++):(s++,d++),c.push({a:g,b:v}),void 0===n?(n={start:h,end:h},f=(u=0)===g.type&&0===v.type?0:1):0===g.type&&0===v.type?0===f?(n.end=h,u++):1===f?(n.end=h,f=2,u=0):2===f&&(n.end=h,8===++u&&(n.end-=5,p.push(n),n={start:h-5,end:h-5},u=f=0)):(n.end=h,u++,0===f?(3<n.end&&(n.end-=3,n.empty=!0,p.push(n),n={start:h-3,end:h-3}),f=1):2===f&&(f=1))}0===f&&(n.empty=!0),n.end=l,p.push(n),console.table(p);for(var b=0;b<p.length;b++)if((n=p[b]).empty)D(n.start,n.end,c).appendTo(a);else for(h=n.start;h<n.end;h++){var m=j(c[h]).appendTo(a);h===n.start?m.addClass("start-block"):h===n.end-1&&m.addClass("end-block")}},close:function(){s=!1},show:function(){}};RED.tray.show(e)}function D(n,a,r){diffRow=$('<tr class="red-ui-diff-text-header red-ui-diff-text-expand">');var e=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),s=$("<span></span>").appendTo(e);return a<r.length-1&&s.text("@@ -"+(r[a-1].a.i+1)+" +"+(r[a-1].b.i+1)),diffRow.on("click",function(e){if(20<a-n){var t=$(this).offset();if(0<n){for(var i=n;i<n+10;i++)j(r[i]).addClass("unchanged").insertBefore($(this));n+=10}if(a<r.length-1){for(i=a-1;a-11<i;i--)j(r[i]).addClass("unchanged").insertAfter($(this));a-=10}a<r.length-1&&s.text("@@ -"+(r[a-1].a.i+1)+" +"+(r[a-1].b.i+1));var o=$(this).offset().top-t.top;$(".red-ui-diff-text").scrollTop($(".red-ui-diff-text").scrollTop()+o)}else{for(i=n;i<a;i++)j(r[i]).addClass("unchanged").insertBefore($(this));$(this).remove()}}),diffRow}function j(e){var t=$("<tr>"),i=e.a,o=e.b,n=$('<td class="lineno">').text(2===i.type?"":i.i).appendTo(t),a=$('<td class="linetext">').text(i.line).appendTo(t);return 2===i.type?(n.addClass("blank"),a.addClass("blank")):4===i.type?(n.addClass("added"),a.addClass("added")):1===i.type&&(n.addClass("removed"),a.addClass("removed")),n=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),a=$('<td class="linetext">').text(o.line).appendTo(t),2===o.type?(n.addClass("blank"),a.addClass("blank")):4===o.type?(n.addClass("added"),a.addClass("added")):1===o.type&&(n.addClass("removed"),a.addClass("removed")),t}function C(e,t,i){return i?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function p(e,E){var g=$("<div></div>");return e.forEach(function(v){var e=v.hunks,t=v.binary,i=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(g);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(i);var b=$("<tbody>").appendTo(i),o=$('<tr class="red-ui-diff-text-file-header">').appendTo(b),n=$('<td colspan="3"></td>').appendTo(o);$('<i class="red-ui-diff-list-chevron fa fa-angle-down"></i>').appendTo(n);o.on("click",function(e){o.toggleClass("collapsed");var t=o.hasClass("collapsed");o.nextUntil(".red-ui-diff-text-file-header").toggle(!t)});$('<span class="filename"></span>').text(v.file).appendTo(n);var m,y=0,w=0,D={};if(E.project.files&&E.project.files.flow===v.file){E.unmerged&&$('<span style="float: right;"><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span>').appendTo(n);var a=$('<tr class="red-ui-diff-text-header">').appendTo(b),l=$('<td class="red-ui-diff-flow-diff" colspan="3"></td>').appendTo(a),r=E.project.name,c=E.project.files.flow,p="projects/"+r+"/files/"+E.commonRev+"/"+c,u="projects/"+r+"/files/"+E.oldRev+"/"+c,s="projects/"+r+"/files/"+E.newRev+"/"+c,d=[$.Deferred(),$.Deferred(),$.Deferred()];if(E.commonRev){p="projects/"+r+"/files/"+E.commonRev+"/"+c;$.ajax({dataType:"json",url:p}).then(function(e){d[0].resolve(e)}).fail(function(){d[0].resolve(null)})}else d[0].resolve(null);$.ajax({dataType:"json",url:u}).then(function(e){d[1].resolve(e)}).fail(function(){d[1].resolve({content:"[]"})}),$.ajax({dataType:"json",url:s}).then(function(e){d[2].resolve(e)}).fail(function(){d[2].resolve({content:"[]"})}),$.when.apply($,d).always(function(e,t,i){var o,n,a;if(e)try{o=JSON.parse(e.content||"[]")}catch(e){return console.log(RED._("diff.commonVersionError"),p),void console.log(e)}try{n=JSON.parse(t.content||"[]")}catch(e){return console.log(RED._("diff.oldVersionError"),u),void console.log(e)}o=o||n;try{a=JSON.parse(i.content||"[]")}catch(e){return console.log(RED._("diff.newVersionError"),a),void console.log(e)}var r=k(o,n),s=k(o,a);E.currentDiff=T(r,s);var d=R(l,E.currentDiff,{title:c,mode:E.commonRev?"merge":"view",oldRevTitle:E.oldRevTitle,newRevTitle:E.newRevTitle});d.list.hide(),x(E.currentDiff),setTimeout(function(){d.finish(),d.list.show()},300)})}else if(t){var f=$('<tr class="red-ui-diff-text-header">').appendTo(b),h=$('<td colspan="3"></td>').appendTo(f);$("<span></span>").text(RED._("diff.noBinaryFileShowed")).appendTo(h)}else E.unmerged&&(m=$('<span style="float: right;">'+RED._("diff.conflictHeader",{resolved:w,unresolved:y})+"</span>").appendTo(n)),e.forEach(function(u){var e=$('<tr class="red-ui-diff-text-header">').appendTo(b),t=$('<td colspan="3"></td>').appendTo(e),f=($("<span></span>").text(u.header).appendTo(t),u.conflict),h=u.localStartLine,g=u.remoteStartLine;f&&y++,u.lines.forEach(function(e,t){var i,o=u.diffStart+t,n=f&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(e),a=$("<tr>").appendTo(b),r=$('<td class="lineno">').appendTo(a);n?r.attr("colspan",2):i=$('<td class="lineno">').appendTo(a);var s=$('<td class="linetext">').appendTo(a),d=1;if(f&&(d=2),n){if(a.addClass("mergeHeader"),/^\+\+=======$/.test(e))u.changeSeparator=o,a.addClass("mergeHeader-separator");else{var l=/^..<<<<<<</.test(e);l?($("<span>").text("<<<<<<< Local Changes").appendTo(s),u.localChangeStart=o):(u.remoteChangeEnd=o,$("<span>").text(">>>>>>> Remote Changes").appendTo(s)),a.addClass("mergeHeader-"+(l?"ours":"theirs")),$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(l?"down":"up")+'"></i> use '+(l?"local":"remote")+" changes</button>").appendTo(s).on("click",function(e){var t,i;e.preventDefault(),w++,l?((i=(t=a.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),i.next().remove()):((i=(t=a.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),i.prev().remove()),i.remove(),a.remove(),t.find(".linetext").addClass("added"),m.empty(),$("<span>"+RED._("diff.conflictHeader",{resolved:w,unresolved:y})+"</span>").appendTo(m),D[v.file]=D[v.file]||{},D[v.file][u.localChangeStart]={changeStart:u.localChangeStart,separator:u.changeSeparator,changeEnd:u.remoteChangeEnd,selection:l?"A":"B"},E.resolveConflict&&E.resolveConflict({conflicts:y,resolved:w,resolutions:D})})}}else{var c=e[0];f&&!E.unmerged&&" "===c&&(c=e[1]),$('<span class="prefix">').text(c).appendTo(s);var p=!1;f&&E.unmerged?($('<span class="prefix">').text(e[1]).appendTo(s),"+"===e[0]&&(r.text(h++),p=!0),"+"===e[1]&&(i.text(g++),p=!0)):"+"===e[0]||f&&"+"===e[1]?(r.addClass("added"),i.addClass("added"),s.addClass("added"),i.text(g++),p=!0):("-"===e[0]||f&&"-"===e[1])&&(r.addClass("removed"),i.addClass("removed"),s.addClass("removed"),r.text(h++),p=!0),p||(s.addClass("unchanged"),0<h&&"\\"!==e[0]&&""!==e&&r.text(h++),0<g&&"\\"!==e[0]&&""!==e&&i.text(g++)),$("<span>").text(e.substring(d)).appendTo(s)}})})}),g}function r(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var i,o,n=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,a=/^\+\+\+ b\/(.*)\t?/,r=/^Binary files /,s=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,d=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,l=[],c=0;c<t.length;c++){var p=t[c],u=n.exec(p);if(u)o&&(i.hunks.push(o),l.push(i)),o=null,i={file:u[1]||u[3],hunks:[]};else if(r.test(p))i&&(i.binary=!0);else{var f=a.exec(p);if(f)i.file=f[1];else{var h=s.exec(p);if(h){o&&i.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=d.exec(p)){o&&i.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}o&&o.lines.push(p)}}}return o&&i.hunks.push(o),l.push(i),l}return{init:function(){RED.actions.add("core:show-remote-diff",i)},getRemoteDiff:t,showRemoteDiff:i,showUnifiedDiff:function(o){var t,e=o.diff,i=o.title,n=r(e);o.unmerged&&(o.resolveConflict=function(e){(t=e).conflicts===e.resolved&&$("#red-ui-diff-view-resolve-diff").removeClass("disabled")});var a={title:i||RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._(o.unmerged?"common.label.cancel":"common.label.close"),click:function(){o.oncancel&&o.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".red-ui-tray-body"),i=$('<div class="red-ui-diff-text"></div>').appendTo(t);p(n,o).appendTo(i)},close:function(){s=!1},show:function(){}};o.unmerged&&a.buttons.push({id:"red-ui-diff-view-resolve-diff",text:RED._("diff.saveConflict"),class:"primary disabled",click:function(){if(!$("#red-ui-diff-view-resolve-diff").hasClass("disabled")){if(o.currentDiff){var e=c(o.currentDiff);(t={resolutions:{}}).resolutions[o.project.files.flow]=JSON.stringify(e.config,"",4)}o.onresolve&&o.onresolve(t),RED.tray.close()}}}),RED.tray.show(a)},showCommitDiff:function(d){var l=function(e){for(var t={},i=e.split("\n"),o=[],n=0;n<i.length;n++)if(/^commit /.test(i[n]))t.sha=i[n].substring(7);else if(/^Author: /.test(i[n])){t.author=i[n].substring(8);var a=/^(.*) <(.*)>$/.exec(t.author);a&&(t.authorName=a[1],t.authorEmail=a[2])}else if(/^Date: /.test(i[n]))t.date=i[n].substring(8);else if(/^    /.test(i[n]))t.title?(4!==i[n].length||0<o.length)&&o.push(i[n].substring(4)):t.title=i[n].substring(4);else if(/^diff /.test(i[n])){t.files=r(i.slice(n));break}return t.comment=o.join("\n"),t}(d.commit),e={title:RED._("diff.viewCommitDiff"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".red-ui-tray-body"),i=$('<div class="red-ui-diff-text"></div>').appendTo(t),o=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(i);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(o);var n=$("<tbody>").appendTo(o),a=$('<tr class="red-ui-diff-text-commit-header">').appendTo(n),r=$('<td colspan="3"></td>').appendTo(a);$("<h3>").text(l.title).appendTo(r),$('<div class="commit-body"></div>').text(l.comment).appendTo(r);var s=$('<div class="commit-summary"></div>').appendTo(r);$('<div style="float: right">').text("Commit "+l.sha).appendTo(s),$("<div>").text((l.authorName||l.author)+" - "+d.date).appendTo(s),l.files&&p(l.files,d).appendTo(i)},close:function(){s=!1},show:function(){}};RED.tray.show(e)},mergeDiff:l}}(),RED.keyboard=function(){var c,o=/Mac/i.test(window.navigator.platform),p={},a={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},t={16:!0,17:!0,18:!0,91:!0,93:!0},u={},s={},f={59:186,61:187,173:189};function h(e){for(var t,i=e.toLowerCase().split("-"),o={},n=0;n<i.length;n++)switch(i[n]){case"ctrl":case"cmd":o.ctrl=!0,o.meta=!0;break;case"alt":o.alt=!0;break;case"shift":o.shift=!0;break;case"":0,t=a["-"];break;default:if(a.hasOwnProperty(i[n]))t=a[i[n]];else{if(1<i[n].length)return null;t=i[n].toUpperCase().charCodeAt(0)}}return[t,o]}function g(e,t){for(var i=e.target,o=0;"BODY"!==i.nodeName&&i.id!==t.scope;)i=i.parentElement,o++;return"BODY"===i.nodeName&&"*"!==t.scope&&(o=-1),o}function d(e,t,i,o){var n=i,a=o;"function"!=typeof i&&"string"!=typeof i||(n={},a=i);var r=[],s=0;if("string"==typeof t){"string"==typeof a&&(u[a]={scope:e,key:t},"boolean"==typeof o&&(u[a].user=o));var d=t.split(" ");for(s=0;s<d.length;s++){var l=h(d[s]);if(!l)return;r.push(l)}}else r.push([t,n]);var c=p;for(s=0;s<r.length;s++)t=r[s][0],(n=r[s][1]).ctrl&&(c.ctrl=c.ctrl||{},c=c.ctrl),n.shift&&(c.shift=c.shift||{},c=c.shift),n.alt&&(c.alt=c.alt||{},c=c.alt),c[t]=c[t]||{},c=c[t];c.handlers=c.handlers||[],c.handlers.push({scope:e,ondown:a}),c.scope=e,c.ondown=a}function n(e,t){var i=t||{},o=[],n=0;if("string"==typeof e){var a=e.split(" ");for(n=0;n<a.length;n++){var r=h(a[n]);if(!r)return void console.log("Unrecognised key specifier:",e);o.push(r)}}else o.push([e,i]);var s=p;for(n=0;n<o.length;n++){if(e=o[n][0],(i=o[n][1]).ctrl&&(s=s.ctrl),s&&i.shift&&(s=s.shift),s&&i.alt&&(s=s.alt),!s[e])return;s=s[e]}"string"==typeof s.ondown&&("boolean"==typeof t&&t?u[s.ondown]={user:t}:delete u[s.ondown]),delete s.scope,delete s.ondown,delete s.handlers}d3.select(window).on("keydown",function(){if(!t[d3.event.keyCode]){var e=function e(t){var i=c||p;(t.ctrlKey||t.metaKey)&&(i=i.ctrl),i&&t.shiftKey&&(i=i.shift),i&&t.altKey&&(i=i.alt);var o=f[t.keyCode]||t.keyCode;if(i&&i[o]){var n=i[o];if(!n.handlers)return c?(c=null,e(t)):(0<Object.keys(n).length&&(c=n,t.preventDefault()),null);var a,r=1/0,s=0,d=n.handlers.length;for(s=0;s<d;s++){var l=g(t,n.handlers[s]);-1<l&&l<r&&(r=l,a=n.handlers[s])}return c=null,n=a}if(c)return c=null,e(t)}(d3.event);e&&e.ondown&&("string"==typeof e.ondown?RED.actions.invoke(e.ondown):e.ondown(),d3.event.preventDefault())}});function l(e){e.preventDefault();var a=$(this),r=a.data("data");if(!a.hasClass("keyboard-shortcut-entry-expanded")){v();var t=a.find(".keyboard-shortcut-entry-key"),i=a.find(".keyboard-shortcut-entry-scope");a.addClass("keyboard-shortcut-entry-expanded");var o=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(r.key||"").appendTo(t);o.on("keyup",function(e){if(13===e.keyCode)return v();var t=$(this).val(),i=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!i)});var n=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="red-ui-workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(i);n.i18n(),"workspace"===r.scope&&(r.scope="red-ui-workspace"),n.val(r.scope||"*");var s=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(i),d=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-check"></i></button>').appendTo(s),l=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(s);d.on("click",function(e){e.stopPropagation(),v()}),l.on("click",function(e){e.stopPropagation(),RED.keyboard.revertToDefault(r.id),a.empty(),a.removeClass("keyboard-shortcut-entry-expanded");var t=RED.keyboard.getShortcut(r.id),i=RED.settings.get("keymap")||{},o=RED.settings.get("editor")||{};(i=o.keymap||{})[r.id]=null,o.keymap=i,RED.settings.set("editor",o);var n={id:r.id,scope:t?t.scope:void 0,key:t?t.key:void 0,user:t?t.user:void 0};b(a,n)}),o.trigger("focus")}}function v(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var i=t.data("data"),o=t.find(".keyboard-shortcut-entry-key input"),n=t.find(".keyboard-shortcut-entry-scope select");if(!e){var a=o.val().trim(),r=n.val();if(""===a||RED.keyboard.validateKey(a)){var s=RED.keyboard.getShortcut(i.id);if(!s&&a||s&&(s.scope!==r||s.key!==a)){var d=t.find(".keyboard-shortcut-entry-key"),l=t.find(".keyboard-shortcut-entry-scope");d.empty(),l.empty(),i.key&&RED.keyboard.remove(i.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===a?(d.parent().addClass("keyboard-shortcut-entry-unassigned"),d.append($("<span>").text(RED._("keyboard.unassigned"))),delete i.key,delete i.scope):(d.parent().removeClass("keyboard-shortcut-entry-unassigned"),d.append(RED.keyboard.formatKey(a)),$("<span>").text(r).appendTo(l),i.key=a,i.scope=r,RED.keyboard.add(i.scope,i.key,i.id,!0));var c=RED.settings.get("editor")||{},p=c.keymap||{};p[i.id]=RED.keyboard.getShortcut(i.id),c.keymap=p,RED.settings.set("editor",c)}}}o.remove(),n.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function b(e,t){var i=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var o=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),n=$("<div>").addClass("keyboard-shortcut-entry-text").text(o).appendTo(i),a=$('<i class="fa fa-user"></i>').prependTo(n);t.user||a.css("opacity",0);var r=$('<div class="keyboard-shortcut-entry-key">').appendTo(i);t.key?r.append(RED.keyboard.formatKey(t.key)):(i.addClass("keyboard-shortcut-entry-unassigned"),r.append($("<span>").text(RED._("keyboard.unassigned"))));var s=$('<div class="keyboard-shortcut-entry-scope">').appendTo(i);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(s),e.on("click",l)}function e(){var e=$('<div id="red-ui-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="red-ui-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("input").searchBox({delay:100,change:function(){var t=$(this).val().trim();""===t?i.editableList("filter",null):(t=t.replace(/\s/g,""),i.editableList("filter",function(e){return-1<e.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(t)}))}});var i=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){b(e,i)}}),t=RED.actions.list();return t.sort(function(e,t){var i=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),o=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return i.localeCompare(o)}),t.forEach(function(e){i.editableList("addItem",e)}),e}return{init:function(){!function(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");if(null!==e){localStorage.removeItem("keymap");var t=RED.settings.get("editor")||{};t.keymap=JSON.parse(e),RED.settings.set("editor",t)}}}();var r=(RED.settings.get("editor")||{}).keymap||{};$.getJSON("red/keymap.json",function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];for(var o in i)i.hasOwnProperty(o)&&(r.hasOwnProperty(i[o])||d(t,o,i[o],!1),s[i[o]]={scope:t,key:o,user:!1})}for(var n in r)if(r.hasOwnProperty(n)&&r[n]){var a=r[n];if(a.hasOwnProperty("key"))"workspace"===(t=a.scope)&&(t="red-ui-workspace"),d(t,a.key,n,!0)}}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:e,focus:function(){setTimeout(function(){$("#red-ui-settings-tab-keyboard-filter").trigger("focus")},200)}})},add:d,remove:n,getShortcut:function(e){return u[e]},revertToDefault:function(e){var t=u[e];if(t&&n(t.key),s.hasOwnProperty(e)){var i=s[e];d(i.scope,i.key,e,!1)}},formatKey:function(e,t){var i=o?e.replace(/ctrl-?/,"&#8984;"):e;return i=(i=(i=(i=(i=(i=o?i.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;"),t?i:'<span class="help-key-block"><span class="help-key">'+i.split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++){if(!h(t[i]))return!1}return!0}}}(),RED.workspaces=function(){var l,r=0,n=0;function i(e,t,i){if(e)l.addTab(e,i),l.resize();else{for(var o=RED.nodes.id();n+=1,0!==$("#red-ui-workspace-tabs a[title='"+RED._("workspace.defaultName",{number:n})+"']").size(););e={type:"tab",id:o,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:n})},RED.nodes.addWorkspace(e,i),l.addTab(e,i),l.activateTab(o),t||(RED.history.push({t:"add",workspaces:[e],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),e}function o(e){if(1!==a){var t=RED.nodes.getWorkspaceOrder();e._index=t.indexOf(e.id),f(e);var i=RED.nodes.removeWorkspace(e.id);i.t="delete",i.dirty=RED.nodes.dirty(),i.workspaces=[e],RED.history.push(i),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function t(e){var s=RED.nodes.workspace(e);if(s){var d;RED.view.state(RED.state.EDITING);var t={title:RED._("workspace.editFlow",{name:RED.utils.sanitize(s.label)}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===a?" disabled":""),text:RED._("common.label.delete"),click:function(){o(s),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e=$("#node-input-name").val(),t=!1,i={};s.label!=e&&(i.label=s.label,t=!0,s.label=e,l.renameTab(s.id,e));var o=$("#node-input-disabled").prop("checked");s.disabled!==o&&(i.disabled=s.disabled,t=!0,s.disabled=o);var n=d.getValue();if(s.info!==n&&(i.info=s.info,t=!0,s.info=n),$("#red-ui-tab-"+s.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!s.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!s.disabled),t){var a={t:"edit",changes:i,node:s,dirty:RED.nodes.dirty()};s.changed=!0,RED.history.push(a),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var r=RED.view.selection();r.nodes||r.links||RED.sidebar.info.refresh(s),i.hasOwnProperty("disabled")&&(RED.nodes.eachNode(function(e){e.z===s.id&&(e.dirty=!0)}),RED.view.redraw())}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),i=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)i-=$(t[o]).outerHeight(!0);i-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",i+"px"),d.resize()},open:function(e){var t=e.find(".red-ui-tray-footer"),i=e.find(".red-ui-tray-body"),o=$('<div class="red-ui-tray-footer-left"></div>').appendTo(t),n=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(i);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>').appendTo(n),s.hasOwnProperty("disabled")||(s.disabled=!1),$('<input id="node-input-disabled" type="checkbox">').prop("checked",s.disabled).appendTo(o).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0});$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="min-height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(n);d=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$("#node-info-input-info-expand").on("click",function(e){e.preventDefault();var t=d.getValue();RED.editor.editMarkdown({value:t,width:"Infinity",cursor:d.getCursorPosition(),complete:function(e,t){d.setValue(e,-1),d.gotoLine(t.row+1,t.column,!1),setTimeout(function(){d.focus()},300)}})}),$('<input type="text" style="display: none;" />').prependTo(n),n.on("submit",function(e){e.preventDefault()}),$("#node-input-name").val(s.label),RED.text.bidi.prepareInput($("#node-input-name")),d.getSession().setValue(s.info||"",-1),n.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(s),d.destroy()}};RED.tray.show(t)}else{var i=RED.nodes.subflow(e);i&&RED.editor.editSubflow(i)}}var a=0;function e(){l=RED.tabs.create({id:"red-ui-workspace-tabs",onchange:function(e){var t={old:r};r=e.id,t.workspace=r,RED.events.emit("workspace:change",t),window.location.hash="flow/"+e.id,$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!e.disabled),RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?t(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&a++,$('<span class="red-ui-workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("red-ui-workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",a<=1),1===a&&($("#red-ui-workspace .red-ui-tabs").show(),$("#red-ui-workspace-chart").show(),$("#red-ui-workspace-footer").children().show())},onremove:function(e){"tab"===e.type&&a--,RED.menu.setDisabled("menu-item-workspace-delete",a<=1),0===a&&s()},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),h(t)},onselect:function(e){RED.view.select(!1),0===e.length?($("#red-ui-workspace-chart svg").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-palette-container").css({"pointer-events":"auto",filter:"none"}),$(".red-ui-sidebar-shade").hide()):(RED.view.select(!1),$("#red-ui-workspace-chart svg").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-palette-container").css({"pointer-events":"none",filter:"opacity(60%)"}),$(".red-ui-sidebar-shade").show())},minimumActiveTabWidth:150,scrollable:!0,addButton:"core:add-flow",addButtonCaption:RED._("workspace.addFlow"),searchButton:"core:list-flows",searchButtonCaption:RED._("workspace.listFlows")}),a=0}function s(){$("#red-ui-workspace .red-ui-tabs").hide(),$("#red-ui-workspace-chart").hide(),$("#red-ui-workspace-footer").children().hide()}function d(e){t(e||r)}function c(e){u(e,!1)}function p(e){u(e,!0)}function u(e,t){var i=RED.nodes.workspace(e||r);if(i&&i.disabled!==t){var o={disabled:i.disabled};i.disabled=t,$("#red-ui-tab-"+i.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!i.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!i.disabled);var n={t:"edit",changes:o,node:i,dirty:RED.nodes.dirty()};i.changed=!0,RED.history.push(n),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var a=RED.view.selection();a.nodes||a.links||RED.sidebar.info.refresh(i),o.hasOwnProperty("disabled")&&(RED.nodes.eachNode(function(e){e.z===i.id&&(e.dirty=!0)}),RED.view.redraw())}}function f(e){e?(l.contains(e.id)&&l.removeTab(e.id),e.id===r&&(r=0)):o(RED.nodes.workspace(r))}function h(e){RED.nodes.setWorkspaceOrder(e.filter(function(e){return void 0!==RED.nodes.workspace(e)})),l.order(e)}return{init:function(){$('<ul id="red-ui-workspace-tabs"></ul>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-tabs-shade" class="hide"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-chart" tabindex="1"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-toolbar"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-editor-shade" class="hide"></div>').appendTo("#red-ui-workspace"),e(),RED.events.on("sidebar:resize",l.resize),RED.actions.add("core:show-next-tab",l.nextTab),RED.actions.add("core:show-previous-tab",l.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){o(RED.nodes.workspace(r))}),$(window).on("resize",function(){l.resize()}),RED.actions.add("core:add-flow",function(e){i(void 0,void 0,e?e.index:void 0)}),RED.actions.add("core:edit-flow",d),RED.actions.add("core:remove-flow",f),RED.actions.add("core:enable-flow",c),RED.actions.add("core:disable-flow",p),RED.actions.add("core:list-flows",function(){RED.actions.invoke("core:search","type:tab ")}),s()},add:i,remove:f,order:h,edit:d,contains:function(e){return l.contains(e)},count:function(){return a},active:function(){return r},selection:function(){return l.selection()},show:function(e){if(!l.contains(e)){var t=RED.nodes.subflow(e);if(!t)return;i({type:"subflow",id:e,icon:"red/images/subflow_tab.svg",label:t.name,closeable:!0})}l.activateTab(e)},refresh:function(){RED.nodes.eachWorkspace(function(e){l.renameTab(e.id,e.label)}),RED.nodes.eachSubflow(function(e){l.contains(e.id)&&l.renameTab(e.id,e.name)}),RED.sidebar.config.refresh()},resize:function(){l.resize()},enable:c,disable:p}}(),RED.statusBar=function(){var i,o,n={};return{init:function(){i=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-left">').appendTo("#red-ui-workspace-footer"),o=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-right">').appendTo("#red-ui-workspace-footer")},add:function(e){n[e.id]=e;var t=$('<span class="red-ui-statusbar-widget"></span>');e.element.appendTo(t),"left"===e.align?i.append(t):"right"===e.align&&o.prepend(t)}}}(),RED.view=function(){var x,k,f,T,_,E,i,l,n,c,j,C=5e3,L=5e3,w=.75,p=1,S=100,O=30,h=1e3,g=0,v=[],b=0,a={},I=20,P=!1,N=!1,A=null,u=[],m=[],y=[],z={},M=null,D=null,B=null,U=null,q=0,R=null,F=[0,0],J=null,G=0,V=[],W=null,K=null,H=!1,Y=null,X=null,Q=0,Z=0,ee=[],te=null,ie=-1,s="",oe={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},ne=1,ae=0;function t(){for(var e=[],t=0;t<C;t+=+I)e.push(t);i.selectAll("line.red-ui-workspace-chart-grid-h").remove(),i.selectAll("line.red-ui-workspace-chart-grid-h").data(e).enter().append("line").attr({class:"red-ui-workspace-chart-grid-h",x1:0,x2:C,y1:function(e){return e},y2:function(e){return e}}),i.selectAll("line.red-ui-workspace-chart-grid-v").remove(),i.selectAll("line.red-ui-workspace-chart-grid-v").data(e).enter().append("line").attr({class:"red-ui-workspace-chart-grid-v",y1:0,y2:C,x1:function(e){return e},x2:function(e){return e}})}function re(e){ie=-1;for(var t=0;t<e.length;t++){var i=e[t];i.el=n.append("svg:path").attr("class","red-ui-flow-drag-line"),("link out"===i.node.type&&i.portType===ae||"link in"===i.node.type&&i.portType===ne)&&(i.el.attr("class","red-ui-flow-link-link red-ui-flow-drag-line"),i.virtualLink=!0,ie=i.portType===ae?ne:ae),j.push(i)}-1!==ie&&u.forEach(function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)})}function se(){for(-1!==ie&&u.forEach(function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)}),ie=-1;j.length;){var e=j.pop();e.el&&e.el.remove()}}function de(){var e=RED.workspaces.active();u=RED.nodes.filterNodes({z:e}),m=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function le(e,t,i,o,n){var a=o-t,r=i-e,s=Math.sqrt(a*a+r*r),d=w;if(0<r*n?s<S&&(d=.75-(S-s)/S*.75):d=.4-.2*Math.max(0,(S-Math.min(Math.abs(r),Math.abs(a)))/S),0<r*n)return"M "+e+" "+t+" C "+(e+n*(S*d))+" "+(t+0*O)+" "+(i-n*d*S)+" "+(o-0*O)+" "+i+" "+o;var l=Math.floor(i-r/2),c=Math.floor(o-a/2);0==a&&(c=o+O);var p=O/2,u=(o+c)/2,f=e+n*S*d,h=0<a?Math.min(u-a/2,t+p):Math.max(u-a/2,t-p),g=i-n*S*d,v=0<a?Math.max(u,o-p):Math.min(u,o+p),b=(e+f)/2,m=0<a?1:-1,y=[[b,t],[f,0<a?Math.max(t,h-p):Math.min(t,h+p)],[b,0<a?Math.min(c,h+p):Math.max(c,h-p)],[g,0<a?Math.max(c,v-p):Math.min(c,v+p)],[(i+g)/2,o]];return y[2][1]===h+m*p&&(Math.abs(a)<10*p&&(y[1][1]=h-m*p/2,y[3][1]=v-m*p/2),y[2][0]=f),"M "+e+" "+t+" C "+y[0][0]+" "+y[0][1]+" "+y[1][0]+" "+y[1][1]+" "+f+" "+h+" S "+y[2][0]+" "+y[2][1]+" "+l+" "+c+" S "+y[3][0]+" "+y[3][1]+" "+g+" "+v+" S "+y[4][0]+" "+y[4][1]+" "+i+" "+o}function ce(e){var t=/^subflow:(.+)$/.exec(e);if(A&&t){if(t[1]===A.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(t[1],A.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var i={id:RED.nodes.id(),z:RED.workspaces.active()};if(i.type=e,i._def=RED.nodes.getType(i.type),t){var o=RED.nodes.subflow(t[1]);i.name="",i.inputs=o.in.length,i.outputs=o.out.length}else{for(var n in i.inputs=i._def.inputs||0,i.outputs=i._def.outputs,i._def.defaults)i._def.defaults.hasOwnProperty(n)&&void 0!==i._def.defaults[n].value&&(i[n]=JSON.parse(JSON.stringify(i._def.defaults[n].value)));if(i._def.onadd)try{i._def.onadd.call(i)}catch(e){console.log("Definition error: "+i.type+".onadd:",e)}}i.changed=!0,i.moved=!0,i.w=S,i.h=Math.max(O,15*(i.outputs||0)),i.resize=!0;var a={t:"add",nodes:[i.id],dirty:RED.nodes.dirty()};if(A){var r=RED.subflow.refresh(!0);r&&(a.subflow={id:A.id,changed:A.changed,instances:r.instances})}return{node:i,historyEvent:a}}function e(){var e;if(G!==RED.state.SELECTING_NODE){if(1===d3.event.button)return G=RED.state.PANNING,J=[d3.event.pageX,d3.event.pageY],void(ee=[T.scrollLeft(),T.scrollTop()]);B||D||(M=null,me()),0===G&&W&&(W.remove(),W=null),0!==G&&G!==RED.state.QUICK_JOINING||(d3.event.metaKey||d3.event.ctrlKey)&&(d3.event.stopPropagation(),pe(d3.mouse(this))),0!==G||d3.event.metaKey||d3.event.ctrlKey||b||(e=d3.mouse(this),W=E.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","nr-ui-view-lasso"),d3.event.preventDefault())}else d3.event.stopPropagation()}function pe(b,m){var e=b[0],t=b[1];RED.settings.get("editor").view["view-snap-grid"]&&(b[0]=Math.round(b[0]/I)*I,b[1]=Math.round(b[1]/I)*I);var i=$("#red-ui-main-container").position();G!==RED.state.QUICK_JOINING&&(G=RED.state.QUICK_JOINING,$(window).on("keyup",ke)),!0,K&&K.remove(),(K=E.append("g").attr("transform","translate("+(b[0]-S/2)+","+(b[1]-O/2)+")")).append("rect").attr("class","red-ui-flow-node-placeholder").attr("rx",5).attr("ry",5).attr("width",S).attr("height",O).attr("fill","none");var o=void 0;0<j.length&&(o=j[0].virtualLink?{type:"link in"===j[0].node.type?"link out":"link in"}:j[0].portType===ae?{input:!0}:{output:!0},te={node:j[0].node,port:j[0].port,portType:j[0].portType},j[0].virtualLink&&(te.virtualLink=!0),se()),m&&(o={input:!0,output:!0});function y(){if(te){te.el||(te.el=n.append("svg:path").attr("class","red-ui-flow-drag-line"));var e=-((te.portType===ae&&te.node.outputs||1)-1)/2*13+13*te.port,t=te.portType===ae?1:-1;te.el.attr("d",le(te.node.x+t*te.node.w/2,te.node.y+e,b[0]-t*S/2,b[1],t))}}var w,D;te&&y(),RED.typeSearch.show({x:d3.event.clientX-i.left-S/2-(e-b[0]),y:d3.event.clientY-i.top+O/2+5-(t-b[1]),filter:o,move:function(e,t){if(K){var i=d3.transform(K.attr("transform")).translate;K.attr("transform","translate("+(i[0]+e)+","+(i[1]+t)+")"),b[0]+=e,b[1]+=t,y()}},cancel:function(){te&&(te.el&&te.el.remove(),te=null),!1,K&&K.remove(),xe(),me(),se(),Ue()},add:function(e,t){var i=ce(e);if(i){t&&(G=RED.state.QUICK_JOINING);var o=i.node,n=i.historyEvent;o.x=b[0],o.y=b[1];var a=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");if(void 0===a||/^link (in|out)$/.test(o._def.type)||o._def.defaults.hasOwnProperty("l")||(o.l=a),te){var r,s,d=te,l=null;if(d.portType===ae&&(0<o.inputs||d.virtualLink)?(l=d.node,s=d.port,r=o):d.portType===ne&&(0<o.outputs||d.virtualLink)&&(l=o,r=d.node,s=0),null!==l){if(d.virtualLink){n={t:"multi",events:[n]};var c=$.extend(!0,{},{v:l.links}).v,p=$.extend(!0,{},{v:r.links}).v;l.links.push(r.id),r.links.push(l.id),l.dirty=!0,r.dirty=!0,n.events.push({t:"edit",node:l,dirty:RED.nodes.dirty(),changed:l.changed,changes:{links:c}}),n.events.push({t:"edit",node:r,dirty:RED.nodes.dirty(),changed:r.changed,changes:{links:p}}),l.changed=!0,r.changed=!0}else{var u={source:l,sourcePort:s,target:r};RED.nodes.addLink(u),n.links=[u]}t?(te.node=o,te.port=0):(te.el.remove(),te=null,G===RED.state.QUICK_JOINING&&(d.portType===ae&&0<o.outputs?re([{node:o,port:0,portType:ae}]):!te&&d.portType===ne&&0<o.inputs?re([{node:o,port:0,portType:ne}]):xe()))}else se(),xe()}else t?0<o.outputs?te={node:o,port:0,portType:ae}:0<o.inputs?te={node:o,port:0,portType:ne}:xe():G===RED.state.QUICK_JOINING&&(0<o.outputs?re([{node:o,port:0,portType:ae}]):0<o.inputs?re([{node:o,port:0,portType:ne}]):xe());if(m){xe(),RED.nodes.removeLink(m);var f={source:m.source,sourcePort:m.sourcePort,target:o},h={source:o,sourcePort:0,target:m.target};RED.nodes.addLink(f),RED.nodes.addLink(h),n.links=(n.links||[]).concat([f,h]),n.removedLinks=[m]}if(RED.history.push(n),RED.nodes.add(o),RED.editor.validateNode(o),RED.nodes.dirty(!0),ve(),o.selected=!0,V.push({n:o}),de(),me(),Ue(),void 0!==w){var g=w+D/2,v=o.x-o.w/2-g;v!=2*I&&(o.x=o.x+2*I-v,o.dirty=!0,o.x=Math.ceil(o.x/I)*I,Ue())}t?(void 0===w&&setTimeout(function(){RED.typeSearch.refresh({filter:{input:!0}})},100),w=o.x,D=o.w,b[0]=o.x+o.w/2+S/2+2*I,K.attr("transform","translate("+(b[0]-S/2)+","+(b[1]-O/2)+")"),y()):(!1,K.remove())}}}),de(),me(),Ue()}function ue(){var e,p;if(G===RED.state.PANNING){var t=[d3.event.pageX,d3.event.pageY],i=[J[0]-t[0],J[1]-t[1]];return T.scrollLeft(ee[0]+i[0]),void T.scrollTop(ee[1]+i[1])}if(J=d3.touches(this)[0]||d3.mouse(this),W){var o,n,a=parseInt(W.attr("ox")),r=parseInt(W.attr("oy")),s=parseInt(W.attr("x")),d=parseInt(W.attr("y"));return o=J[0]<a?a-(s=J[0]):J[0]-s,n=J[1]<r?r-(d=J[1]):J[1]-d,void W.attr("x",s).attr("y",d).attr("width",o).attr("height",n)}if(G!==RED.state.SELECTING_NODE){if(G==RED.state.QUICK_JOINING||G==RED.state.IMPORT_DRAGGING||B||null!=M){var l;if(G==RED.state.JOINING||G===RED.state.QUICK_JOINING){if(0===j.length&&null!==U){if(d3.event.shiftKey){var c,u=[],f=[];if(M&&(U===ae&&M.source===B&&M.sourcePort===q||U===ne&&M.target===B))f=[M];else c=U===ae?{source:B,sourcePort:q}:{target:B},f=RED.nodes.filterLinks(c);for(e=0;e<f.length;e++){var h=f[e];RED.nodes.removeLink(h),u.push({link:h,node:U===ae?h.target:h.source,port:U===ae?0:h.sourcePort,portType:U===ae?ne:ae})}0===u.length?(xe(),Ue()):(re(u),G=0,de(),Ue(),G=RED.state.JOINING)}else B&&!te&&re([{node:B,port:q,portType:U}]);M=null}for(l=J,e=0;e<j.length;e++){var g=j[e],v=-((g.portType===ae&&g.node.outputs||1)-1)/2*13+13*g.port,b=g.portType===ae?1:-1;g.el.attr("d",le(g.node.x+b*g.node.w/2,g.node.y+v,l[0],l[1],b))}d3.event.preventDefault()}else if(G==RED.state.MOVING){l=d3.mouse(document.body),isNaN(l[0])&&(l=d3.touches(document.body)[0]),3<(F[0]-l[0])*(F[0]-l[0])+(F[1]-l[1])*(F[1]-l[1])&&(G=RED.state.MOVING_ACTIVE,Z=0,N=!1,1===V.length&&(p=V[0],N=p.n.hasOwnProperty("_def")&&(p.n.hasOwnProperty("inputs")&&0<p.n.inputs||!p.n.hasOwnProperty("inputs")&&0<p.n._def.inputs)&&(p.n.hasOwnProperty("outputs")&&0<p.n.outputs||!p.n.hasOwnProperty("outputs")&&0<p.n._def.outputs)&&0===RED.nodes.filterLinks({source:p.n}).length&&0===RED.nodes.filterLinks({target:p.n}).length))}else if(G==RED.state.MOVING_ACTIVE||G==RED.state.IMPORT_DRAGGING){l=J;for(var m=0,y=0,w=C,D=L,E=0;E<V.length;E++)p=V[E],d3.event.shiftKey&&(p.n.ox=p.n.x,p.n.oy=p.n.y),p.n.x=l[0]+p.dx,p.n.y=l[1]+p.dy,p.n.dirty=!0,m=Math.min(p.n.x-p.n.w/2-5,m),y=Math.min(p.n.y-p.n.h/2-5,y),w=Math.max(p.n.x+p.n.w/2+5,w),D=Math.max(p.n.y+p.n.h/2+5,D);if(0!==m||0!==y)for(e=0;e<V.length;e++)(p=V[e]).n.x-=m,p.n.y-=y;if(w!==C||D!==L)for(e=0;e<V.length;e++)(p=V[e]).n.x-=w-C,p.n.y-=D-L;if(P!=d3.event.shiftKey&&0<V.length){var R=[0,0];if(p=V[0],R[0]=p.n.x-(I*Math.floor((p.n.x-p.n.w/2)/I)+p.n.w/2),R[1]=p.n.y-I*Math.floor(p.n.y/I),0!==R[0]||0!==R[1])for(e=0;e<V.length;e++)(p=V[e]).n.x-=R[0],p.n.y-=R[1],p.n.x==p.n.ox&&p.n.y==p.n.oy&&(p.dirty=!1)}G!=RED.state.MOVING_ACTIVE&&G!=RED.state.IMPORT_DRAGGING||1!==V.length||(p=V[0],N&&(k=k||setTimeout(function(){var e=[],t=1/0,i=null,o=p.n.x,n=p.n.y;if(_[0][0].getIntersectionList){var a=_[0][0].createSVGRect();a.x=o,a.y=n,a.width=1,a.height=1,e=_[0][0].getIntersectionList(a,_[0][0])}else e=RED.view.getLinksAtPoint(o,n);for(var r=0;r<e.length;r++)if(d3.select(e[r]).classed("red-ui-flow-link-background"))for(var s=e[r].getTotalLength(),d=0;d<s;d+=10){var l=e[r].getPointAtLength(d),c=(l.x-o)*(l.x-o)+(l.y-n)*(l.y-n);c<200&&c<t&&(t=c,i=e[r])}x&&x!==i&&d3.select(x.parentNode).classed("red-ui-flow-link-splice",!1),i?d3.select(i.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),x=i,k=null},100)))}0!==G&&Ue()}}else d3.event.stopPropagation()}function o(){var e,t;if(G!==RED.state.PANNING)if(G!==RED.state.SELECTING_NODE){if(G!==RED.state.QUICK_JOINING){if(B&&G==RED.state.JOINING){var i=[];for(e=0;e<j.length;e++)j[e].link&&i.push(j[e].link);0<i.length&&(t={t:"delete",links:i,dirty:RED.nodes.dirty()},RED.history.push(t),RED.nodes.dirty(!0)),se()}if(W){var o=parseInt(W.attr("x")),n=parseInt(W.attr("y")),a=o+parseInt(W.attr("width")),r=n+parseInt(W.attr("height"));d3.event.ctrlKey||ve(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>o&&e.x<a&&e.y>n&&e.y<r,e.selected&&(e.dirty=!0,V.push({n:e})))}),A&&(A.in.forEach(function(e){e.selected=e.x>o&&e.x<a&&e.y>n&&e.y<r,e.selected&&(e.dirty=!0,V.push({n:e}))}),A.out.forEach(function(e){e.selected=e.x>o&&e.x<a&&e.y>n&&e.y<r,e.selected&&(e.dirty=!0,V.push({n:e}))}),A.status&&(A.status.selected=A.status.x>o&&A.status.x<a&&A.status.y>n&&A.status.y<r,A.status.selected&&(A.status.dirty=!0,V.push({n:A.status})))),me(),W.remove(),W=null}else G!=RED.state.DEFAULT||null!=D||d3.event.ctrlKey||d3.event.metaKey||(ve(),me());if(G==RED.state.MOVING_ACTIVE&&0<V.length){for(var s=[],d=0;d<V.length;d++){var l=V[d];l.ox===l.n.x&&l.oy===l.n.y||(s.push({n:l.n,ox:l.ox,oy:l.oy,moved:l.n.moved}),l.n.dirty=!0,l.n.moved=!0)}if(0<s.length){if(t={t:"move",nodes:s,dirty:RED.nodes.dirty()},x){var c=d3.select(x).data()[0];RED.nodes.removeLink(c);var p={source:c.source,sourcePort:c.sourcePort,target:V[0].n},u={source:V[0].n,sourcePort:0,target:c.target};RED.nodes.addLink(p),RED.nodes.addLink(u),t.links=[p,u],t.removedLinks=[c],de()}RED.nodes.dirty(!0),RED.history.push(t)}}if(G==RED.state.MOVING||G==RED.state.MOVING_ACTIVE)for(e=0;e<V.length;e++)delete V[e].ox,delete V[e].oy;G==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),de(),RED.nodes.dirty(!0)),xe(),Ue()}}else d3.event.stopPropagation();else xe()}function r(){p<2&&he(p+.1)}function d(){.3<p&&he(p-.1)}function fe(){he(1)}function he(e){var t=[T.width(),T.height()],i=[T.scrollLeft(),T.scrollTop()],o=[(i[0]+t[0]/2)/p,(i[1]+t[1]/2)/p],n=[(i[0]+t[0]/2)/(p=e),(i[1]+t[1]/2)/p],a=[(n[0]-o[0])*p,(n[1]-o[1])*p];T.scrollLeft(i[0]-a[0]),T.scrollTop(i[1]-a[1]),RED.view.navigator.resize(),Ue()}function ge(){G===RED.state.SELECTING_NODE&&f.single||(RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){if(G===RED.state.SELECTING_NODE&&f.filter&&!f.filter(e))return;e.selected||(e.selected=!0,e.dirty=!0,V.push({n:e}))}}),G!==RED.state.SELECTING_NODE&&A&&(A.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,V.push({n:e}))}),A.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,V.push({n:e}))}),A.status&&(A.status.selected||(A.status.selected=!0,A.status.dirty=!0,V.push({n:A.status})))),M=null,G!==RED.state.SELECTING_NODE&&me(),Ue())}function ve(){for(var e=0;e<V.length;e++){var t=V[e];t.n.dirty=!0,t.n.selected=!1}V=[],M=null}var be=null;function me(){var e={},t=RED.workspaces.selection();if(0===t.length){0<V.length&&(e.nodes=V.map(function(e){return e.n})),null!=M&&(e.link=M);var i=RED.workspaces.active();m=RED.nodes.filterLinks({source:{z:i},target:{z:i}});RED.nodes.getWorkspaceOrder();var o={};y=[],Object.keys(z).forEach(function(e){z[e].dirty=!0}),z={};for(var n=0;n<V.length;n++)if("link out"===V[n].n.type||"link in"===V[n].n.type){var a=V[n].n;z[a.id]=a;var r={};a.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link out"===a.type?t.z===a.z?o[a.id+":"+t.id]||(m.push({source:a,sourcePort:0,target:t,link:!0}),o[a.id+":"+t.id]=!0,(z[t.id]=t).dirty=!0):(r[t.z]=r[t.z]||[],r[t.z].push(t)):t.z===a.z?o[t.id+":"+a.id]||(m.push({source:t,sourcePort:0,target:a,link:!0}),o[t.id+":"+a.id]=!0,(z[t.id]=t).dirty=!0):(r[t.z]=r[t.z]||[],r[t.z].push(t)))}),0<Object.keys(r).length&&y.push({refresh:Math.floor(1e4*Math.random()),node:a,links:r})}0===y.length&&null!==M&&M.link&&(m.push(M),z[M.source.id]=M.source,M.source.dirty=!0,z[M.target.id]=M.target,M.target.dirty=!0)}else e.flows=t;var s=i+":"+JSON.stringify(e,function(e,t){return"nodes"===e||"flows"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t});s!==be&&(be=s,RED.events.emit("view:selection-changed",e))}function ye(){if(0<V.length){var e=V[0].n;"subflow"===e.type?RED.editor.editSubflow(A):RED.editor.edit(e)}}function we(){if(G!==RED.state.SELECTING_NODE){Ce&&(Ce.remove(),Ce=null);var e=RED.workspaces.selection();if(0<e.length){var t=0;if(e.forEach(function(e){"tab"===e.type&&t++}),t===RED.workspaces.count())return;for(var i={t:"delete",dirty:RED.nodes.dirty(),nodes:[],links:[],workspaces:[],subflows:[]},o=RED.nodes.getWorkspaceOrder().slice(0),n=0;n<e.length;n++){var a,r=e[n];r._index=o.indexOf(r.id),RED.workspaces.remove(r),"tab"===r.type?(i.workspaces.push(r),a=RED.nodes.removeWorkspace(r.id)):(a=RED.subflow.removeSubflow(r.id),i.subflows=i.subflows.concat(a.subflows)),i.nodes=i.nodes.concat(a.nodes),i.links=i.links.concat(a.links)}RED.history.push(i),RED.nodes.dirty(!0),de(),me(),Ue()}else if(0<V.length||null!=M){var s,d=[],l=[],c=[],p=[],u=void 0,f=[],h=RED.nodes.dirty();if(0<V.length){for(n=0;n<V.length;n++){var g=V[n].n;if(g.selected=!1,"subflow"!=g.type){g.x<0&&(g.x=25);var v=RED.nodes.remove(g.id);d.push(g),d=d.concat(v.nodes),l=l.concat(v.links)}else"out"===g.direction?c.push(g):"in"===g.direction?p.push(g):"status"===g.direction&&(u=g),g.dirty=!0}0<c.length&&(s=RED.subflow.removeOutput(c))&&(l=l.concat(s.links)),1==p.length&&(s=RED.subflow.removeInput())&&(l=l.concat(s.links)),u&&(s=RED.subflow.removeStatus())&&(l=l.concat(s.links));var b=RED.subflow.refresh(!0);b&&(f=b.instances),V=[],(0<d.length||0<c.length||0<p.length||u)&&RED.nodes.dirty(!0)}if(M&&M.link){var m=M.source.id,y=M.target.id,w=M.target.links.indexOf(m),D=M.source.links.indexOf(y);i={t:"multi",events:[{t:"edit",node:M.source,changed:M.source.changed,changes:{links:$.extend(!0,{},{v:M.source.links}).v}},{t:"edit",node:M.target,changed:M.target.changed,changes:{links:$.extend(!0,{},{v:M.target.links}).v}}],dirty:RED.nodes.dirty()},RED.nodes.dirty(!0),M.source.changed=!0,M.target.changed=!0,M.target.links.splice(w,1),M.source.links.splice(D,1),M.source.dirty=!0,M.target.dirty=!0}else M&&(RED.nodes.removeLink(M),l.push(M)),RED.nodes.dirty(!0),i={t:"delete",nodes:d,links:l,subflowOutputs:c,subflowInputs:p,subflow:{id:A?A.id:void 0,instances:f},dirty:h},u&&(i.subflow.status=u);RED.history.push(i),M=null,de(),me(),Ue()}}}function De(){if(G!==RED.state.SELECTING_NODE){var t=[],e=RED.workspaces.selection();if(0<e.length?(t=[],e.forEach(function(e){"tab"===e.type&&(t.push(e),t=t.concat(RED.nodes.filterNodes({z:e.id})))})):0<V.length&&(t=V.map(function(e){return e.n})),0<t.length){for(var i=[],o=0;o<t.length;o++){var n=t[o];if("subflow"!=n.type){for(var a in n._def.defaults)if(n._def.defaults.hasOwnProperty(a)&&n._def.defaults[a].type){var r=RED.nodes.node(n[a]);r&&r._def.exclusive&&i.push(RED.nodes.convertNode(r))}i.push(RED.nodes.convertNode(n))}}s=JSON.stringify(i),RED.notify(RED._("clipboard.nodeCopied",{count:i.length}),{id:"clipboard"})}}}function Ee(e,t,i){return $e(e,t,i,0)[0]}var Re={};function $e(e,t,i,o){return Re[t]||(Re[t]=document.createElement("span"),Re[t].className=t,Re[t].style.position="absolute",Re[t].style.top="-1000px",document.getElementById("red-ui-editor").appendChild(Re[t])),Re[t].textContent=e||"",[i+Re[t].offsetWidth,o+Re[t].offsetHeight]}function xe(){G=0,x=U=D=R=B=null,N=!1,d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),k&&(clearTimeout(k),k=null)}function ke(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(xe(),se(),Ue(),$(window).off("keyup",ke))}function Te(e,t,i){1!==d3.event.button&&(G!==RED.state.SELECTING_NODE?(B=e,U=t,q=i||0,G!==RED.state.QUICK_JOINING&&(G=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(G=RED.state.QUICK_JOINING,re([{node:B,port:q,portType:U}]),$(window).on("keyup",ke))),d3.event.stopPropagation(),d3.event.preventDefault()):d3.event.stopPropagation())}function _e(e,o,n){if(G!==RED.state.SELECTING_NODE){var t;if(G===RED.state.QUICK_JOINING&&0<j.length){if(j[0].node===e)return;if(j[0].virtualLink&&("link in"===j[0].node.type&&"link out"!==e.type||"link out"===j[0].node.type&&"link in"!==e.type))return}if(document.body.style.cursor="",G==RED.state.JOINING||G==RED.state.QUICK_JOINING){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var t=e.w/2,i=e.h/2;e.x-t<J[0]&&e.x+t>J[0]&&e.y-i<J[1]&&e.y+i>J[1]&&(o=0<(R=e).inputs?ne:ae,n=0)}}):R=e;var i=[],a=[],r=[],s=null;for(t=0;t<j.length;t++)j[t].link&&a.push(j[t].link);var d=[];for(t=0;t<j.length;t++)if(o!=j[t].portType&&R!==j[t].node){var l,c,p,u=j[t];u.portType===ae?(l=u.node,p=u.port,c=R):u.portType===ne&&(l=R,c=u.node,p=n);var f={source:l,sourcePort:p,target:c};if(u.virtualLink){if(/^link (in|out)$/.test(l.type)&&/^link (in|out)$/.test(c.type)&&l.type!==c.type&&-1===l.links.indexOf(c.id)&&-1===c.links.indexOf(l.id)){var h=$.extend(!0,{},{v:l.links}).v,g=$.extend(!0,{},{v:c.links}).v;l.links.push(c.id),c.links.push(l.id),l.dirty=!0,c.dirty=!0,r.push(l),r.push(c),f.link=!0,m.push(f),z[l.id]=l,z[c.id]=c,s=f,d.push({t:"edit",node:l,dirty:RED.nodes.dirty(),changed:l.changed,changes:{links:h}}),d.push({t:"edit",node:c,dirty:RED.nodes.dirty(),changed:c.changed,changes:{links:g}}),l.changed=!0,c.changed=!0}}else if(!("link out"===e.type&&o===ae||"link in"===e.type&&o===ne))0!==RED.nodes.filterLinks({source:l,target:c,sourcePort:p}).length||(RED.nodes.addLink(f),i.push(f))}if(0<i.length||0<a.length||0<r.length){var v;if(v=0<r.length?{t:"multi",events:d,dirty:RED.nodes.dirty()}:{t:"add",links:i,removedLinks:a,dirty:RED.nodes.dirty()},A){var b=RED.subflow.refresh(!0);b&&(v.subflow={id:A.id,changed:A.changed,instances:b.instances})}RED.history.push(v),de(),RED.nodes.dirty(!0)}if(G===RED.state.QUICK_JOINING)return(0<i.length||0<r.length)&&(se(),o===ne&&0<e.outputs?re([{node:e,port:0,portType:ae}]):o===ae&&0<e.inputs?re([{node:e,port:0,portType:ne}]):xe(),(D=M=s)&&me()),void Ue();xe(),se(),(D=M=s)&&me(),Ue()}}else d3.event.stopPropagation()}var je=null,Ce=null;function Le(e){var t=d3.select(e);if("red-ui-workspace-chart-event-layer"===t.attr("class"))return[0,0];var i=[0,0];if("g"===e.nodeName.toLowerCase()){var o=t.attr("transform");o&&(i=d3.transform(o).translate)}else i=[t.attr("x")||0,t.attr("y")||0];var n=Le(e.parentNode);return[i[0]+n[0],i[1]+n[1]]}function Se(e,t,i,o){var n=E.append("g").attr("transform","translate("+e+","+t+")").attr("class","red-ui-flow-port-tooltip"),a=i.split("\n"),r=6,s=12,d=[],l=0;a.forEach(function(e,t){var i=$e(e||"&nbsp;","red-ui-flow-port-tooltip-label",8,0);r=Math.max(r,i[0]+6),d.push(i[1]),0===t&&(l=i[1]),s+=i[1]});var c,p,u,f=r/2-5-2,h=s/2-5-2,g=s-4,v=-s/2;return"left"===o?(c="M0 0 l -5 -5 v -"+h+" q 0 -2 -2 -2 h -"+r+" q -2 0 -2 2 v "+g+" q 0 2 2 2 h "+r+" q 2 0 2 -2 v -"+h+" l 5 -5",p=-14,u="end"):"right"===o?(c="M0 0 l 5 -5 v -"+h+" q 0 -2 2 -2 h "+r+" q 2 0 2 2 v "+g+" q 0 2 -2 2 h -"+r+" q -2 0 -2 -2 v -"+h+" l -5 -5",p=14,u="start"):"top"===o&&(c="M0 0 l 5 -5 h "+f+" q 2 0 2 -2 v -"+s+" q 0 -2 -2 -2 h -"+(r-4)+" q -2 0 -2 2 v "+s+" q 0 2 2 2 h "+f+" l 5 5",p=-r/2+6,v=-s-l+12,u="start"),n.append("path").attr("d",c),a.forEach(function(e,t){v+=d[t],n.append("svg:text").attr("class","red-ui-flow-port-tooltip-label").attr("x",p).attr("y",v).attr("text-anchor",u).text(e||" ")}),n}function Oe(i,o,n,a){if(G!==RED.state.SELECTING_NODE){clearTimeout(je);var e=G!=RED.state.JOINING&&G!=RED.state.QUICK_JOINING||0<j.length&&j[0].portType!==n&&(!j[0].virtualLink||"link in"===j[0].node.type&&"link out"===o.type||"link out"===j[0].node.type&&"link in"===o.type);e&&(n===ne&&(o._def&&o._def.inputLabels||o.inputLabels)||n===ae&&(o._def&&o._def.outputLabels||o.outputLabels))&&(je=setTimeout(function(){var e=function(t,i,e){var o,n=i===ne?t.inputLabels:t.outputLabels;if(n&&n[e])return n[e];var a=i===ne?t._def.inputLabels:t._def.outputLabels;if("string"==typeof a)o=a;else if("function"==typeof a)try{o=a.call(t,e)}catch(e){console.log("Definition error: "+t.type+"."+(i===ne?"inputLabels":"outputLabels"),e),o=null}else $.isArray(a)&&(o=a[e]);return o}(o,n,a);if(e){var t=Le(i.node());je=null,Ce=Se(t[0]+(n===ne?-2:12),t[1]+5,e,n===ne?"left":"right")}},500)),i.classed("red-ui-flow-port-hovered",e)}else d3.event.stopPropagation()}function Ie(e){G!==RED.state.SELECTING_NODE?(clearTimeout(je),Ce&&(Ce.remove(),Ce=null),e.classed("red-ui-flow-port-hovered",!1)):d3.event.stopPropagation()}function Pe(e){if(G!==RED.state.SELECTING_NODE){if(X&&B==e&&0<Z&&Z<750)return G=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(A),Z=0,void d3.event.stopPropagation();var t=e._def?0<e.inputs?1:0:"in"==e.direction?0:1,i=!1;G!==RED.state.JOINING&&G!==RED.state.QUICK_JOINING||(i=!0,0<j.length&&j[0].virtualLink&&("link in"===e.type?t=1:"link out"===e.type&&(t=0))),_e(e,t,0),i&&d3.selectAll(".red-ui-flow-port-hovered").classed("red-ui-flow-port-hovered",!1)}else d3.event.stopPropagation()}function Ne(e){if(qe(),1!==d3.event.button){if(G==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),x){var t=d3.select(x).data()[0];RED.nodes.removeLink(t);var i={source:t.source,sourcePort:t.sourcePort,target:V[0].n},o={source:V[0].n,sourcePort:0,target:t.target};RED.nodes.addLink(i),RED.nodes.addLink(o);var n=RED.history.peek();n.links=[i,o],n.removedLinks=[t],de()}return me(),RED.nodes.dirty(!0),Ue(),xe(),void d3.event.stopPropagation()}if(G!=RED.state.QUICK_JOINING){if(G===RED.state.SELECTING_NODE){if(d3.event.stopPropagation(),f.single)return void f.done(e);if(e.selected){for(e.selected=!1,a=0;a<V.length;a+=1)if(V[a].n===e){V.splice(a,1);break}}else f.filter&&!f.filter(e)||(e.selected=!0,V.push({n:e}));return e.dirty=!0,void Ue()}B=e;var a,r=Date.now();if(Z=r-Q,Q=r,X=!(Y!=B||0!==d3.event.button||d3.event.shiftKey||d3.event.metaKey||d3.event.altKey||d3.event.ctrlKey),Y=B,e.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(B.selected=!1,a=0;a<V.length;a+=1)if(V[a].n===B){V.splice(a,1);break}}else{if(d3.event.shiftKey){ve();for(var s=RED.nodes.getAllFlowNodes(B),d=0;d<s.length;d++)s[d].selected=!0,s[d].dirty=!0,V.push({n:s[d]})}else e.selected||(d3.event.ctrlKey||d3.event.metaKey||ve(),B.selected=!0,V.push({n:B}));if(M=null,2!=d3.event.button){G=RED.state.MOVING;var l=d3.touches(this)[0]||d3.mouse(this);for(l[0]+=e.x-e.w/2,l[1]+=e.y-e.h/2,a=0;a<V.length;a++)V[a].ox=V[a].n.x,V[a].oy=V[a].n.y,V[a].dx=V[a].n.x-l[0],V[a].dy=V[a].n.y-l[1];F=d3.mouse(document.body),isNaN(F[0])&&(F=d3.touches(document.body)[0])}}e.dirty=!0,me(),Ue(),d3.event.stopPropagation()}else d3.event.stopPropagation()}}function Ae(e){var t=!0,i=RED.nodes.workspace(RED.workspaces.active());return!i||i.disabled||e.d?t=!1:e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function ze(t){if(G!==RED.state.SELECTING_NODE){var e=RED.workspaces.active(),i=RED.nodes.workspace(e);if(!i||i.disabled||t.d)A?RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabledSubflow")}),"warning"):RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(t._def.button.toggle&&(t[t._def.button.toggle]=!t[t._def.button.toggle],t.dirty=!0),t._def.button.onclick)try{t._def.button.onclick.call(t)}catch(e){console.log("Definition error: "+t.type+".onclick",e)}t.dirty&&Ue()}d3.event.preventDefault()}else d3.event.stopPropagation()}function Me(e,t){var i=B,o=[];o.push({name:"delete",disabled:0===V.length&&null===M,onselect:function(){we()}}),o.push({name:"cut",disabled:0===V.length,onselect:function(){De(),we()}}),o.push({name:"copy",disabled:0===V.length,onselect:function(){De()}}),o.push({name:"paste",disabled:0===s.length,onselect:function(){Fe(s,!1,!0)}}),o.push({name:"edit",disabled:1!=V.length,onselect:function(){RED.editor.edit(i)}}),o.push({name:"select",onselect:function(){ge()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,o),xe()}function Be(n,e,t){var i=null;if(0===n.indexOf("font-awesome/")){var o=n.substr(13);if(!(i=RED.nodes.fontAwesome.getIconUnicode(o))){var a=RED.utils.getDefaultNodeIcon(t._def,t);n=RED.settings.apiRootUrl+"icons/"+a.module+"/"+a.file}}if(i)e.append("text").attr("xlink:href",n).attr("class","fa-lg").attr("x",15).text(i);else{var r=e.append("image").attr("xlink:href",n).attr("class","red-ui-flow-node-icon").attr("x",0).attr("width","30").attr("height","30").style("display","none"),s=new Image;s.src=n,s.onload=function(){if(!n.match(/\.svg$/)){var e=Math.max(s.width,s.height),t=1;30<e&&(t=30/e);var i=s.width*t,o=s.height*t;r.attr("width",i),r.attr("height",o),r.attr("x",15-i/2)}r.attr("xlink:href",n),r.style("display",null)}}}function Ue(){if(E.attr("transform","scale("+p+")"),_.attr("width",C*p).attr("height",L*p),-1!==ie||G!=RED.state.JOINING){var $={};if(A){var e=c.selectAll(".red-ui-flow-subflow-port-output").data(A.out,function(e,t){return e.id});e.exit().remove();var t=e.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-output").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});t.each(function(e,t){e.w=40,e.h=40}),t.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Pe).on("mousedown",Ne).on("touchstart",function(e){var t=d3.select(this),i=d3.event.touches.item(0),o=[i.pageX,i.pageY];v=[i.pageX,i.pageY],g=0,b=setTimeout(function(){Me(t,o)},h),Ne.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Pe.call(this,e)}),t.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Te(e,ne,0)}).on("touchstart",function(e,t){Te(e,ne,0)}).on("mouseup",function(e,t){_e(e,ne,0)}).on("touchend",function(e,t){_e(e,ne,0)}).on("mouseover",function(e){Oe(d3.select(this),e,ne,0)}).on("mouseout",function(e){Ie(d3.select(this))}),t.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",20).attr("y",12).style("font-size","10px").text("output"),t.append("svg:text").attr("class","red-ui-flow-port-label red-ui-flow-port-index").attr("x",20).attr("y",28).text(function(e,t){return t+1});var i=c.selectAll(".red-ui-flow-subflow-port-input").data(A.in,function(e,t){return e.id});i.exit().remove();var o=i.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-input").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});o.each(function(e,t){e.w=40,e.h=40}),o.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Pe).on("mousedown",Ne).on("touchstart",function(e){var t=d3.select(this),i=d3.event.touches.item(0),o=[i.pageX,i.pageY];v=[i.pageX,i.pageY],g=0,b=setTimeout(function(){Me(t,o)},h),Ne.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Pe.call(this,e)}),o.append("g").attr("transform","translate(35,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Te(e,ae,t)}).on("touchstart",function(e,t){Te(e,ae,t)}).on("mouseup",function(e,t){_e(e,ae,t)}).on("touchend",function(e,t){_e(e,ae,t)}).on("mouseover",function(e){Oe(d3.select(this),e,ae,0)}).on("mouseout",function(e){Ie(d3.select(this))}),o.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",18).attr("y",20).style("font-size","10px").text("input");var n=c.selectAll(".red-ui-flow-subflow-port-status").data(A.status?[A.status]:[],function(e,t){return e.id});n.exit().remove();var a=n.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-status").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});a.each(function(e,t){e.w=40,e.h=40}),a.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Pe).on("mousedown",Ne).on("touchstart",function(e){var t=d3.select(this),i=d3.event.touches.item(0),o=[i.pageX,i.pageY];v=[i.pageX,i.pageY],g=0,b=setTimeout(function(){Me(t,o)},h),Ne.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Pe.call(this,e)}),a.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Te(e,ne,0)}).on("touchstart",function(e,t){Te(e,ne,0)}).on("mouseup",function(e,t){_e(e,ne,0)}).on("touchend",function(e,t){_e(e,ne,0)}).on("mouseover",function(e){Oe(d3.select(this),e,ne,0)}).on("mouseout",function(e){Ie(d3.select(this))}),a.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",22).attr("y",20).style("font-size","10px").text("status"),e.each(function(e,t){if(e.dirty){var i=d3.select(this);i.classed("red-ui-flow-node-selected",function(e){return e.selected}),i.selectAll(".red-ui-flow-port-index").text(function(e){return e.i+1}),i.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),($[e.id]=e).dirty=!1}}),i.each(function(e,t){if(e.dirty){var i=d3.select(this);i.classed("red-ui-flow-node-selected",function(e){return e.selected}),i.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),($[e.id]=e).dirty=!1}}),n.each(function(e,t){if(e.dirty){var i=d3.select(this);i.classed("red-ui-flow-node-selected",function(e){return e.selected}),i.selectAll(".red-ui-flow-port-index").text(function(e){return e.i+1}),i.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),($[e.id]=e).dirty=!1}})}else c.selectAll(".red-ui-flow-subflow-port-output").remove(),c.selectAll(".red-ui-flow-subflow-port-input").remove(),c.selectAll(".red-ui-flow-subflow-port-status").remove();var r=c.selectAll(".red-ui-flow-node-group").data(u,function(e){return e.id});r.exit().remove(),r.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-node-group").classed("red-ui-flow-subflow",function(e){return null!=A}).each(function(t,e){var o=d3.select(this),i="link in"===t.type||"link out"===t.type,n=t.hasOwnProperty("l")?!t.l:i;o.attr("id",t.id);var a=RED.utils.getNodeLabel(t);if(!t.resize&&void 0!==t.w||(t.w=n?O:Math.max(S,20*Math.ceil((Ee(a,"red-ui-flow-node-label",50)+(0<t._def.inputs?7:0))/20))),t.h=Math.max(O,15*(t.outputs||0)),t._def.button){var r=o.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class","red-ui-flow-node-button");r.append("rect").attr("class","red-ui-flow-node-button-background").attr("rx",5).attr("ry",5).attr("width",32).attr("height",O-4),r.append("rect").attr("class","red-ui-flow-node-button-button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",O-12).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)}).attr("cursor","pointer").on("mousedown",function(e){!W&&Ae(e)&&(qe(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!W&&Ae(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!W&&Ae(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!W&&Ae(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",ze).on("touchstart",ze)}o.append("rect").attr("class","red-ui-flow-node").classed("red-ui-flow-node-unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)}).on("mouseup",Pe).on("mousedown",Ne).on("touchstart",function(e){var t=d3.select(this),i=d3.event.touches.item(0),o=[i.pageX,i.pageY];v=[i.pageX,i.pageY],g=0,b=setTimeout(function(){Me(t,o)},h),Ne.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Pe.call(this,e)}).on("mouseover",function(i){if(0===G||G===RED.state.SELECTING_NODE)G===RED.state.SELECTING_NODE&&f&&f.filter?f.filter(i)&&o.classed("red-ui-flow-node-hovered",!0):o.classed("red-ui-flow-node-hovered",!0),clearTimeout(je),(i.hasOwnProperty("l")?i.l:"link in"!==i.type&&"link out"!==i.type)||(je=setTimeout(function(){var t;if(i._def.label){t=i._def.label;try{t=("function"==typeof t?t.call(i):t)||""}catch(e){console.log("Definition error: "+i.type+".label",e),t=i.type}}if(""!==t){var e=Le(o.node());je=null,Ce=Se(e[0]+i.w/2,e[1]-1,t,"top")}},500));else if(G===RED.state.JOINING||G===RED.state.QUICK_JOINING){var e,t;if(0<j.length)t=j[0].virtualLink&&j[0].portType===ne||j[0].portType===ae?(e=".red-ui-flow-port-input .red-ui-flow-port",ne):(e=".red-ui-flow-port-output .red-ui-flow-port",ae),Oe(d3.select(this.parentNode).selectAll(e),i,t,0)}}).on("mouseout",function(e){var t;o.classed("red-ui-flow-node-hovered",!1),clearTimeout(je),Ce&&(Ce.remove(),Ce=null),G!==RED.state.JOINING&&G!==RED.state.QUICK_JOINING||0<j.length&&(j[0].virtualLink&&j[0].portType===ne||j[0].portType===ae?t=".red-ui-flow-port-input .red-ui-flow-port":t=".red-ui-flow-port-output .red-ui-flow-port",Ie(d3.select(this.parentNode).selectAll(t)))});if(t._def.icon){var s=RED.utils.getNodeIcon(t._def,t),d=o.append("g").attr("class","red-ui-flow-node-icon-group").attr("x",0).attr("y",0);d.append("rect").attr("x",0).attr("y",0).attr("class","red-ui-flow-node-icon-shade").attr("width","30").attr("height",function(e){return Math.min(50,e.h-4)});Be(s,d,t);var l=d.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","red-ui-flow-node-icon-shade-border");"right"==t._def.align&&(d.attr("class","red-ui-flow-node-icon-group red-ui-flow-node-icon-group-"+t._def.align),l.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)})),d.style("pointer-events","none")}var c=o.append("svg:text").attr("class","red-ui-flow-node-label").attr("x",38).attr("dy",".35em").attr("text-anchor","start").classed("hide",n);t._def.align&&(c.attr("class","red-ui-flow-node-label red-ui-flow-node-label-"+t._def.align),"right"===t._def.align&&c.attr("text-anchor","end"));var p=o.append("svg:g").attr("class","red-ui-flow-node-status-group").style("display","none");p.append("rect").attr("class","red-ui-flow-node-status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),p.append("svg:text").attr("class","red-ui-flow-node-status-label").attr("x",20).attr("y",10);o.append("g").attr("class","red-ui-flow-node-changed hide").attr("transform","translate(20, -2)").append("circle").attr("r",5);var u=o.append("g").attr("class","red-ui-flow-node-error hide").attr("transform","translate(0, -2)").append("path").attr("d","M -5,4 l 10,0 -5,-8 z");u.on("mouseenter",function(){t.validationErrors&&0<t.validationErrors.length&&(clearTimeout(je),je=setTimeout(function(){var e=Le(u.node());je=null,Ce=Se(e[0],e[1],RED._("editor.errors.invalidProperties")+"\n  - "+t.validationErrors.join("\n    - "),"top")},500))}).on("mouseleave",function(){clearTimeout(je),Ce&&(Ce.remove(),Ce=null)})}),r.each(function(e,t){if(e.dirty){var i="link in"===e.type||"link out"===e.type,o=e.hasOwnProperty("l")?!e.l:i;if(($[e.id]=e).resize){var n=RED.utils.getNodeLabel(e),a=e.w;e.w=o?O:Math.max(S,20*Math.ceil((Ee(n,"red-ui-flow-node-label",50)+(0<e._def.inputs?7:0))/20)),e.h=Math.max(O,15*(e.outputs||0)),e.x+=(e.w-a)/2,e.resize=!1}var r=d3.select(this);if(r.classed("red-ui-flow-node-disabled",function(e){return!0===e.d}),r.classed("red-ui-flow-subflow",function(e){return null!=A}),r.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),G!=RED.state.MOVING_ACTIVE){r.classed("red-ui-flow-node-selected",function(e){return e.selected}),r.selectAll(".red-ui-flow-node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("red-ui-flow-node-highlighted",function(e){return e.highlighted}),!e._def.align&&0!==e.inputs&&0===e.outputs||"right"===e._def.align?(r.selectAll(".red-ui-flow-node-icon-group").classed("red-ui-flow-node-icon-group-right",!0),r.selectAll(".red-ui-flow-node-label").classed("red-ui-flow-node-label-right",!0).attr("text-anchor","end")):(r.selectAll(".red-ui-flow-node-icon-group").classed("red-ui-flow-node-icon-group-right",!1),r.selectAll(".red-ui-flow-node-label").classed("red-ui-flow-node-label-right",!1).attr("text-anchor","start")),r.selectAll(".red-ui-flow-node-icon-group").attr("transform",function(e){return"translate(0, 0)"}),r.selectAll(".red-ui-flow-node-label").attr("x",function(e){return 38}),r.selectAll(".red-ui-flow-node-icon-group-right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),r.selectAll(".red-ui-flow-node-label-right").attr("x",function(e){return e.w-38});var s=r.selectAll(".red-ui-flow-port-input");if(i&&(-1!==ie||z[e.id])||0!==e.inputs||s.empty()){if((i&&(ie===ne||z[e.id])||1===e.inputs)&&s.empty()){var d=r.append("g").attr("class","red-ui-flow-port-input");("link in"===e.type?d.append("circle").attr("cx",-1).attr("cy",5).attr("r",5).attr("class","red-ui-flow-port red-ui-flow-link-port"):d.append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10)).on("mousedown",function(e){Te(e,ne,0)}).on("touchstart",function(e){Te(e,ne,0)}).on("mouseup",function(e){_e(e,ne,0)}).on("touchend",function(e){_e(e,ne,0)}).on("mouseover",function(e){Oe(d3.select(this),e,ne,0)}).on("mouseout",function(e){Ie(d3.select(this))})}}else s.remove();var l=e.outputs;i&&"link out"===e.type&&(l=ie===ae||z[e.id]?(e.ports=[0],1):(e.ports=[],0));var c=e.h/2-(l-1)/2*13;e.ports=e.ports||d3.range(l),e._ports=r.selectAll(".red-ui-flow-port-output").data(e.ports);var p=e._ports.enter().append("g").attr("class","red-ui-flow-port-output");if(("link out"===e.type?p.append("circle").attr("cx",11).attr("cy",5).attr("r",5).attr("class","red-ui-flow-port red-ui-flow-link-port"):p.append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10)).on("mousedown",(R=e,function(e,t){Te(R,ae,t)})).on("touchstart",(E=e,function(e,t){Te(E,ae,t)})).on("mouseup",(D=e,function(e,t){_e(D,ae,t)})).on("touchend",(w=e,function(e,t){_e(w,ae,t)})).on("mouseover",(y=e,function(e,t){Oe(d3.select(this),y,ae,t)})).on("mouseout",function(e,t){Ie(d3.select(this))}),e._ports.exit().remove(),e._ports){l=e.outputs||1,c=e.h/2-(l-1)/2*13;var u=e.w-5;e._ports.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+u+","+(c+13*t-5)+")"})})}if(r.selectAll("text.red-ui-flow-node-label").text(function(t,e){var i="";if(t._def.label){i=t._def.label;try{i=("function"==typeof i?i.call(t):i)||"",i=RED.text.bidi.enforceTextDirectionWithUCC(i)}catch(e){console.log("Definition error: "+t.type+".label",e),i=t.type}}return i}).attr("y",function(e){return e.h/2-1}).attr("class",function(t){var i="";if(t._def.labelStyle){i=t._def.labelStyle;try{i=("function"==typeof i?i.call(t):i)||""}catch(e){console.log("Definition error: "+t.type+".labelStyle",e),i=""}i=" "+i}return"red-ui-flow-node-label"+(t._def.align?" red-ui-flow-node-label-"+t._def.align:"")+i}).classed("hide",o),e._def.icon){var f,h=r.select(".red-ui-flow-node-icon"),g=r.select(".fa-lg");f=h.empty()?g.attr("xlink:href"):h.attr("xlink:href");var v=RED.utils.getNodeIcon(e._def,e);if(v!==f)h.empty()?g.remove():h.remove(),Be(v,r.select(".red-ui-flow-node-icon-group"),e)}r.selectAll(".red-ui-flow-node-changed").attr("transform",function(e){return"translate("+(e.w-10)+", -2)"}).classed("hide",function(e){return!(e.changed||e.moved)}),r.selectAll(".red-ui-flow-node-error").attr("transform",function(e){return"translate("+(e.w-10-(e.changed||e.moved?14:0))+", -2)"}).classed("hide",function(e){return e.valid}),r.selectAll(".red-ui-flow-port-input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),r.selectAll(".red-ui-flow-node-icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),r.selectAll(".red-ui-flow-node-icon-shade").attr("height",function(e){return e.h}),r.selectAll(".red-ui-flow-node-icon-shade-border").attr("d",function(e){return"M "+(!e._def.align&&0!==e.inputs&&0===e.outputs||"right"===e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),r.selectAll(".fa-lg").attr("y",function(e){return(e.h+13)/2}),r.selectAll(".red-ui-flow-node-button").attr("opacity",function(e){return Ae(e)?1:.4}),r.selectAll(".red-ui-flow-node-button-button").attr("cursor",function(e){return Ae(e)?"pointer":""}),r.selectAll(".red-ui-flow-node-button").attr("transform",function(e){var t="right"==e._def.align?e.w-6:-25;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-="right"==e._def.align?8:-8),"translate("+t+",2)"}),r.selectAll(".red-ui-flow-node-button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),e._def.button&&"function"==typeof e._def.button.visible&&(!1===e._def.button.visible.call(e)?r.selectAll(".red-ui-flow-node-button").style("display","none"):r.selectAll(".red-ui-flow-node-button").style("display","inherit"))}if(e.dirtyStatus){if(H&&e.status){r.selectAll(".red-ui-flow-node-status-group").style("display","inline");var b=oe[e.status.fill];if(null==e.status.shape&&null==b)r.selectAll(".red-ui-flow-node-status").style("display","none"),r.selectAll(".red-ui-flow-node-status-group").attr("transform","translate(-14,"+(e.h+3)+")");else{r.selectAll(".red-ui-flow-node-status-group").attr("transform","translate(3,"+(e.h+3)+")");var m="red-ui-flow-node-status-"+(e.status.shape||"dot")+"-"+e.status.fill;r.selectAll(".red-ui-flow-node-status").style("display","inline").attr("class","red-ui-flow-node-status "+m)}e.status.hasOwnProperty("text")?r.selectAll(".red-ui-flow-node-status-label").text(e.status.text):r.selectAll(".red-ui-flow-node-status-label").text("")}else r.selectAll(".red-ui-flow-node-status-group").style("display","none");delete e.dirtyStatus}e.dirty=!1}var y,w,D,E,R});var s=l.selectAll(".red-ui-flow-link").data(m,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i});s.enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link").each(function(e,t){var i=d3.select(this);e.added=!0,i.append("svg:path").attr("class","red-ui-flow-link-background red-ui-flow-link-path").classed("red-ui-flow-link-link",function(e){return e.link}).on("mousedown",function(e){G!==RED.state.SELECTING_NODE?(D=e,ve(),M=D,me(),Ue(),qe(),d3.event.stopPropagation(),(d3.event.metaKey||d3.event.ctrlKey)&&(i.classed("red-ui-flow-link-splice",!0),pe(d3.mouse(this),M))):d3.event.stopPropagation()}).on("touchstart",function(e){if(G!==RED.state.SELECTING_NODE){D=e,ve(),M=D,me(),Ue(),qe(),d3.event.stopPropagation();var t=d3.select(document.body),i=d3.event.touches.item(0),o=[i.pageX,i.pageY];b=setTimeout(function(){b=null,Me(t,o)},h)}else d3.event.stopPropagation()}),i.append("svg:path").attr("class","red-ui-flow-link-outline red-ui-flow-link-path"),i.append("svg:path").attr("class","red-ui-flow-link-line red-ui-flow-link-path").classed("red-ui-flow-link-link",function(e){return e.link}).classed("red-ui-flow-subflow-link",function(e){return!e.link&&A})}),s.exit().remove(),l.selectAll(".red-ui-flow-link-path").each(function(e){var t=d3.select(this);(e.added||e===M||e.selected||$[e.source.id]||$[e.target.id])&&(/red-ui-flow-link-line/.test(t.attr("class"))&&t.classed("red-ui-flow-subflow-link",function(e){return!e.link&&A}),t.attr("d",function(e){var t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0);e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y;var i=le(e.x1,e.y1,e.x2,e.y2,1);return/NaN/.test(i)?"":i}),t.classed("red-ui-flow-node-disabled",function(e){return e.source.d||e.target.d}))}),s.classed("red-ui-flow-link-selected",function(e){return e===M||e.selected}),s.classed("red-ui-flow-link-unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var d=l.selectAll(".red-ui-flow-link-off-flow").data(y,function(e){return e.node.id+":"+e.refresh});d.enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link-off-flow").each(function(i,e){var t=d3.select(this),n=1,a="start";"link in"===i.node.type&&(n=-1,a="end");var r=30*n,s=20*n,o=(t.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M 0 0 h "+r),i.links),d=Object.keys(o),l=RED.nodes.getWorkspaceOrder();d.sort(function(e,t){return l.indexOf(e)-l.indexOf(t)});var c=O,p=-(d.length-1)*c/2,u=t.selectAll(".red-ui-flow-link-group").data(d);u.enter().append("g").attr("class","red-ui-flow-link-group").on("mouseover",function(){0===G&&d3.select(this).classed("red-ui-flow-link-group-active",!0)}).on("mouseout",function(){0===G&&d3.select(this).classed("red-ui-flow-link-group-active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(e){if(0===G){d3.event.stopPropagation();var t=i.links[e];RED.workspaces.show(e),t.forEach(function(e){e.selected=!0,e.dirty=!0,V.push({n:e})}),me(),Ue()}}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M "+r+" 0 C "+(r+1.7*s)+" 0 "+(r+.1*s)+" "+p+" "+(r+1.5*s)+" "+p+" "),t.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(r+1.5*s+17*n)+" "+(p-12)+" h "+10*-n+" a 3 3 45 0 "+(1===n?"0":"1")+" "+-3*n+" 3 v 18 a 3 3 45 0 "+(1===n?"0":"1")+" "+3*n+" 3 h "+10*n),t.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(r+1.5*s+20*n)+" "+(p-12)+" h "+30*n+" M "+(r+1.5*s+20*n)+" "+(p+12)+" h "+30*n).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","red-ui-flow-port red-ui-flow-link-port").attr("x",r+1.5*s-4+4*n).attr("y",p-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",r+1.5*s-(-1===n?S:0)).attr("y",p-12).attr("width",S).attr("height",24).style("stroke","none").style("fill","transparent");var i,o=RED.nodes.workspace(e);o&&(i=o.label||o.id),t.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",r+1.5*s+15*n).attr("y",p+1).style("font-size","10px").style("text-anchor",a).text(i),p+=c}),u.exit().remove()}),d.exit().remove(),(d=l.selectAll(".red-ui-flow-link-off-flow")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else l.selectAll(".red-ui-flow-link-selected").data(m,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("red-ui-flow-link-selected",!1);RED.view.navigator.refresh(),d3.event&&d3.event.preventDefault()}function qe(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;T.trigger("focus"),window.parent.window.scrollTo(e,t)}catch(e){T.trigger("focus")}}function Fe(e,t,i){if(G!==RED.state.SELECTING_NODE)try{var o;A&&(o=A.changed);var n=RED.nodes.import(e,!0,t);if(n){var a=n[0],r=n[1],s=n[2],d=n[3],l=n[4];t&&l&&RED.workspaces.show(l.id);var c=a.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),p=a.map(function(e){return e.changed=!0,e.id});if(0<c.length){var u=c[0].n,f=u.x,h=u.y;null==J&&(J=[0,0]);var g,v,b=0,m=0;for(g=0;g<c.length;g++)(v=c[g]).n.selected=!0,v.n.changed=!0,v.n.moved=!0,v.n.x-=f-J[0],v.n.y-=h-J[1],v.dx=v.n.x-J[0],v.dy=v.n.y-J[1],b=Math.min(v.n.x-S/2-5,b),m=Math.min(v.n.y-O/2-5,m);for(g=0;g<c.length;g++)if((v=c[g]).n.x-=b,v.n.y-=m,v.dx-=b,v.dy-=m,v.n._def.onadd)try{v.n._def.onadd.call(v.n)}catch(e){console.log("Definition error: "+v.n.type+".onadd:",e)}i||(G=RED.state.IMPORT_DRAGGING,N=!1,1===c.length&&(v=c[0],N=v.n.hasOwnProperty("_def")&&0<v.n._def.inputs&&0<v.n._def.outputs)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),ve(),RED.history.pop(),G=0}),ve(),V=c}var y={t:"add",nodes:p,links:r,workspaces:s,subflows:d,dirty:RED.nodes.dirty()};if(0===c.length&&RED.nodes.dirty(!0),A){var w=RED.subflow.refresh(!0);w&&(y.subflow={id:A.id,changed:o,instances:w.instances})}RED.history.push(y),de(),Ue();var D=[],E=0,R=0;if(a.forEach(function(e){e.hasOwnProperty("x")&&e.hasOwnProperty("y")?E++:R++}),0<s.length&&D.push(RED._("clipboard.flow",{count:s.length})),0<E&&D.push(RED._("clipboard.node",{count:E})),0<R&&D.push(RED._("clipboard.configNode",{count:E})),0<d.length&&D.push(RED._("clipboard.subflow",{count:d.length})),0<D.length){var $="<ul><li>"+D.join("</li><li>")+"</li></ul>";RED.notify("<p>"+RED._("clipboard.nodesImported")+"</p>"+$,{id:"clipboard"})}}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}function Je(e){if(G!==RED.state.SELECTING_NODE){if(0<RED.workspaces.selection().length);else if(0<V.length){for(var t=[],i=0;i<V.length;i++){var o=V[i].n;e!=o.d&&(t.push({t:"edit",node:o,changed:o.changed,changes:{d:o.d}}),e?o.d=!0:delete o.d,o.dirty=!0,o.changed=!0)}0<t.length&&(RED.history.push({t:"multi",events:t,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}RED.view.redraw()}}return{init:function(){T=$("#red-ui-workspace-chart"),_=d3.select("#red-ui-workspace-chart").append("svg:svg").attr("width",C).attr("height",L).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){qe()}).on("contextmenu",function(){d3.event.preventDefault()}),(E=_.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","red-ui-workspace-chart-event-layer").on("mousemove",ue).on("mousedown",e).on("mouseup",o).on("mouseenter",function(){W?1!==d3.event.buttons&&(W.remove(),W=null):G===RED.state.PANNING&&4!==d3.event.buttons&&xe()}).on("touchend",function(){clearTimeout(b),b=null,RED.touch.radialMenu.active()||o.call(this)}).on("touchcancel",o).on("touchstart",function(){var e;if(1<d3.event.touches.length){clearTimeout(b),b=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),i=e.pageY-t.pageY,o=e.pageX-t.pageX,n=T.offset(),a=[T.scrollLeft(),T.scrollTop()];v=[(t.pageX+o/2-n.left+a[0])/p,(t.pageY+i/2-n.top+a[1])/p],[t.pageX+o/2,t.pageY+i/2],g=Math.sqrt(i*i+o*o)}else{var r=d3.select(document.body),s=[(e=d3.event.touches.item(0)).pageX,e.pageY];v=[e.pageX,e.pageY],g=0;d3.touches(this)[0];b=setTimeout(function(){b=null,Me(r,s)},h)}}).on("touchmove",function(){var e;if(RED.touch.radialMenu.active())d3.event.preventDefault();else if(d3.event.touches.length<2){if(b){var t=(e=d3.event.touches.item(0)).pageX-v[0],i=e.pageY-v[1];64<Math.abs(t*t+i*i)&&(clearTimeout(b),b=null)}else W&&d3.event.preventDefault();ue.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),n=e.pageY-o.pageY,a=e.pageX-o.pageX,r=(T.offset(),[T.scrollLeft(),T.scrollTop()]),s=Math.sqrt(n*n+a*a),d=[o.pageX+a/2,o.pageY+n/2];if(!isNaN(s)){oldScaleFactor=p,p=Math.min(2,Math.max(.3,p+Math.floor(100*s-100*g)/1e4));var l=[v[0]*(p-oldScaleFactor),v[1]*(p-oldScaleFactor)];g=s,d,T.scrollLeft(r[0]+l[0]),T.scrollTop(r[1]+l[1]),Ue()}}})).append("svg:rect").attr("class","red-ui-workspace-chart-background").attr("width",C).attr("height",L),i=E.append("g").attr("class","red-ui-workspace-chart-grid"),t(),l=E.append("g"),n=E.append("g"),c=E.append("g"),j=[],RED.events.on("workspace:change",function(e){0!==e.old&&(a[e.old]={left:T.scrollLeft(),top:T.scrollTop()});var t=T.scrollLeft(),i=T.scrollTop();A=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",A),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||A),a[e.workspace]?(T.scrollLeft(a[e.workspace].left),T.scrollTop(a[e.workspace].top)):(T.scrollLeft(0),T.scrollTop(0));var o=T.scrollLeft()-t,n=T.scrollTop()-i;null!=J&&(J[0]+=o,J[1]+=n),0===RED.workspaces.selection().length&&ve(),RED.nodes.eachNode(function(e){e.dirty=!0,e.dirtyStatus=!0}),me(),de(),Ue()}),RED.statusBar.add({id:"view-zoom-controls",align:"right",element:$('<span class="button-group"><button class="red-ui-footer-button" id="red-ui-view-zoom-out"><i class="fa fa-minus"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-zero"><i class="fa fa-circle-o"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-in"><i class="fa fa-plus"></i></button></span>')}),$("#red-ui-view-zoom-out").on("click",d),RED.popover.tooltip($("#red-ui-view-zoom-out"),RED._("actions.zoom-out"),"core:zoom-out"),$("#red-ui-view-zoom-zero").on("click",fe),RED.popover.tooltip($("#red-ui-view-zoom-zero"),RED._("actions.zoom-reset"),"core:zoom-reset"),$("#red-ui-view-zoom-in").on("click",r),RED.popover.tooltip($("#red-ui-view-zoom-in"),RED._("actions.zoom-in"),"core:zoom-in"),T.on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?d():r())}),T.droppable({accept:".red-ui-palette-node",drop:function(e,t){d3.event=e;var i=ce($(t.draggable[0]).attr("data-palette-type"));if(i){var o=i.historyEvent,n=i.node,a=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");void 0===a||/^link (in|out)$/.test(n._def.type)||n._def.defaults.hasOwnProperty("l")||(n.l=a);var r=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),s=d3.touches(this)[0]||d3.mouse(this);s[1]+=this.scrollTop+(n.h/2-r[1]),s[0]+=this.scrollLeft+(n.w/2-r[0]),s[1]/=p,s[0]/=p,P&&(s[0]=I*Math.ceil(s[0]/I),s[1]=I*Math.ceil(s[1]/I)),n.x=s[0],n.y=s[1];var d=$(t.helper).data("splice");if(d){RED.nodes.removeLink(d);var l={source:d.source,sourcePort:d.sourcePort,target:n},c={source:n,sourcePort:0,target:d.target};RED.nodes.addLink(l),RED.nodes.addLink(c),o.links=[l,c],o.removedLinks=[d]}RED.history.push(o),RED.nodes.add(n),RED.editor.validateNode(n),RED.nodes.dirty(!0),ve(),n.selected=!0,V.push({n:n}),de(),me(),Ue(),n._def.autoedit&&RED.editor.edit(n)}}}),T.on("focus",function(){$("#red-ui-workspace-tabs").addClass("red-ui-workspace-focussed")}),T.on("blur",function(){$("#red-ui-workspace-tabs").removeClass("red-ui-workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",De),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){De(),we()}),RED.actions.add("core:paste-from-internal-clipboard",function(){Fe(s)}),RED.actions.add("core:delete-selection",we),RED.actions.add("core:edit-selected-node",ye),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:redo",RED.history.redo),RED.actions.add("core:select-all-nodes",ge),RED.actions.add("core:zoom-in",r),RED.actions.add("core:zoom-out",d),RED.actions.add("core:zoom-reset",fe),RED.actions.add("core:enable-selected-nodes",function(){Je(!1)}),RED.actions.add("core:disable-selected-nodes",function(){Je(!0)}),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):function(e){e?i.style("visibility","visible"):i.style("visibility","hidden")}(e)}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):function(e){P=e,Ue()}(e)}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):function(e){H=e,RED.nodes.eachNode(function(e){e.dirtyStatus=!0,e.dirty=!0}),Ue()}(e)}),RED.view.navigator.init(),RED.view.tools.init()},state:function(e){if(null==e)return G;G=e},redraw:function(e){e&&(de(),me()),Ue()},focus:qe,importNodes:Fe,calculateTextWidth:Ee,select:function(e){if(void 0!==e&&(ve(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,V=[{n:t}])}me(),Ue()},selection:function(){var e={};return 0<V.length&&(e.nodes=V.map(function(e){return e.n})),null!=M&&(e.link=M),e},scale:function(){return p},getLinksAtPoint:function(e,t){for(var i=[],o=_.selectAll(".red-ui-flow-link-background")[0],n=0;n<o.length;n++){var a=o[n].getBBox();e>=a.x&&t>=a.y&&e<=a.x+a.width&&t<=a.y+a.height&&i.push(o[n])}return i},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z);var i=[T.width()/p,T.height()/p],o=[T.scrollLeft()/p,T.scrollTop()/p];if(t.x<o[0]||t.y<o[1]||t.x>i[0]+o[0]||t.y>i[1]+o[1]){var n="-="+(o[0]-t.x+i[0]/2)*p,a="-="+(o[1]-t.y+i[1]/2)*p;T.animate({scrollLeft:n,scrollTop:a},200)}if(!t._flashing){t._flashing=!0;var r=22,s=function(){r--,t.dirty=!0,0<=r?(t.highlighted=!t.highlighted,setTimeout(s,100)):(t.highlighted=!1,delete t._flashing),RED.view.redraw()};s()}}else"config"===t._def.category&&RED.sidebar.config.show(e)}},gridSize:function(e){if(void 0===e)return I;I=Math.max(5,e),t()},getActiveNodes:function(){return u},selectNodes:function(e){$("#red-ui-workspace-tabs-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-header-shade").show(),$("#red-ui-workspace").addClass("red-ui-workspace-select-mode"),G=RED.state.SELECTING_NODE,ve(),e.selected&&(console.log(e.selected),e.selected.forEach(function(e){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,V.push({n:t}))})),Ue();function t(){ve(),$("#red-ui-workspace-tabs-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-workspace").removeClass("red-ui-workspace-select-mode"),xe(),o.close()}(f=e||{}).done=function(e){t(),f.onselect&&f.onselect(e)};var i=[{text:RED._("common.label.cancel"),click:function(e){t(),f.oncancel&&f.oncancel()}}];f.single||i.push({text:RED._("common.label.done"),class:"primary",click:function(e){var t=V.map(function(e){return e.n});f.done(t)}});var o=RED.notify(f.prompt||RED._("workspace.selectNodes"),{modal:!1,fixed:!0,type:"compact",buttons:i})}}}(),RED.view.navigator=function(){var e,t,i,o,n,a,r,s,d,l=25,c=5e3/l,p=5e3/l,u=!1;function f(){if(u){var e=o.selectAll(".red-ui-navigator-node").data(RED.view.getActiveNodes(),function(e){return e.id});e.exit().remove(),e.enter().insert("rect").attr("class","red-ui-navigator-node").attr("pointer-events","none"),e.each(function(e){d3.select(this).attr("x",function(e){return(e.x-e.w/2)/l}).attr("y",function(e){return(e.y-e.h/2)/l}).attr("width",function(e){return Math.max(9,e.w/l)}).attr("height",function(e){return Math.max(3,e.h/l)}).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)})})}}function h(){d||g()}function g(){i&&(a=RED.view.scale(),r=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],n=[$("#red-ui-workspace-chart").scrollLeft(),$("#red-ui-workspace-chart").scrollTop()],i.attr("x",n[0]/l).attr("y",n[1]/l).attr("width",r[0]/l/a).attr("height",r[1]/l/a))}function v(){u?(u=!1,e.fadeOut(100),$("#red-ui-workspace-chart").off("scroll",h),$("#red-ui-view-navigate").removeClass("selected")):(u=!0,$("#red-ui-view-navigate").addClass("selected"),g(),f(),$("#red-ui-workspace-chart").on("scroll",h),e.fadeIn(200))}return{init:function(){$(window).on("resize",g),RED.events.on("sidebar:resize",g),RED.actions.add("core:toggle-navigator",v),e=$("<div>").css({position:"absolute",bottom:$("#red-ui-workspace-footer").height(),right:0,zIndex:1}).appendTo("#red-ui-workspace").hide(),(t=d3.select(e[0]).append("svg:svg").attr("width",c).attr("height",p).attr("pointer-events","all").attr("id","red-ui-navigator-canvas")).append("rect").attr("x",0).attr("y",0).attr("width",c).attr("height",p).style({fill:"none",stroke:"none",pointerEvents:"all"}).on("mousedown",function(){a=RED.view.scale(),r=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],s=[r[0]/l/a,r[1]/l/a];var e=Math.max(0,Math.min(d3.event.offsetX+s[0]/2,c)-s[0]),t=Math.max(0,Math.min(d3.event.offsetY+s[1]/2,p)-s[1]);i.attr("x",e).attr("y",t),d=!0,$("#red-ui-workspace-chart").scrollLeft(e*l*a),$("#red-ui-workspace-chart").scrollTop(t*l*a)}).on("mousemove",function(){if(d)if(0!==d3.event.buttons){var e=Math.max(0,Math.min(d3.event.offsetX+s[0]/2,c)-s[0]),t=Math.max(0,Math.min(d3.event.offsetY+s[1]/2,p)-s[1]);i.attr("x",e).attr("y",t),$("#red-ui-workspace-chart").scrollLeft(e*l*a),$("#red-ui-workspace-chart").scrollTop(t*l*a)}else d=!1}).on("mouseup",function(){d=!1}),i=t.append("rect").attr("class","red-ui-navigator-border"),o=t.append("svg:g"),RED.statusBar.add({id:"view-navigator",align:"right",element:$('<button class="red-ui-footer-button-toggle single" id="red-ui-view-navigate"><i class="fa fa-map-o"></i></button>')}),$("#red-ui-view-navigate").on("click",function(e){e.preventDefault(),v()}),RED.popover.tooltip($("#red-ui-view-navigate"),RED._("actions.toggle-navigator"),"core:toggle-navigator")},refresh:f,resize:g,toggle:v}}(),RED.view.tools=function(){function e(){var e=RED.view.selection();if(e.nodes){var o=[];e.nodes.forEach(function(e){var t=e.w/2+Math.round((e.x-e.w/2)/RED.view.gridSize())*RED.view.gridSize(),i=Math.round(e.y/RED.view.gridSize())*RED.view.gridSize();e.x===t&&e.y===i||(o.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=t,e.y=i,e.dirty=!0,e.moved=!0)}),0<o.length&&(RED.history.push({t:"move",nodes:o,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}var d=null,l=!1;function c(){if(l=!1,0<d.length){for(var e=[],t=0;t<d.length;t++)e.push({n:d[t].n,ox:d[t].ox,oy:d[t].oy,moved:d[t].moved}),d[t].n.moved=!0,d[t].n.dirty=!0,delete d[t].ox,delete d[t].oy;RED.view.redraw(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),d=null}}function t(e,t){if(null===d){var i=RED.view.selection();i.nodes&&(d=i.nodes.map(function(e){return{n:e}}))}if(d&&0<d.length){l||($(document).one("keyup",c),l=!0);for(var o,n=0,a=0,r=0;r<d.length;r++)null==(o=d[r]).ox&&null==o.oy&&(o.ox=o.n.x,o.oy=o.n.y,o.moved=o.n.moved),o.n.moved=!0,o.n.dirty=!0,o.n.x+=e,o.n.y+=t,o.n.dirty=!0,n=Math.min(o.n.x-o.n.w/2-5,n),a=Math.min(o.n.y-o.n.h/2-5,a);if(0!==n||0!==a)for(var s=0;s<d.length;s++)(o=d[s]).n.x-=n,o.n.y-=a;RED.view.redraw()}}return{init:function(){RED.actions.add("core:align-selection-to-grid",e),RED.actions.add("core:move-selection-up",function(){t(0,-1)}),RED.actions.add("core:move-selection-right",function(){t(1,0)}),RED.actions.add("core:move-selection-down",function(){t(0,1)}),RED.actions.add("core:move-selection-left",function(){t(-1,0)}),RED.actions.add("core:step-selection-up",function(){t(0,-RED.view.gridSize())}),RED.actions.add("core:step-selection-right",function(){t(RED.view.gridSize(),0)}),RED.actions.add("core:step-selection-down",function(){t(0,RED.view.gridSize())}),RED.actions.add("core:step-selection-left",function(){t(-RED.view.gridSize(),0)})},alignSelectionToGrid:e,moveSelection:t}}(),RED.sidebar=function(){var a,r={};var s={};function t(e){e?($("#red-ui-main-container").removeClass("red-ui-sidebar-closed"),a.resize()):$("#red-ui-main-container").addClass("red-ui-sidebar-closed"),RED.events.emit("sidebar:resize")}function d(e){e&&(i(e)||a.addTab(r[e]),a.activateTab(e),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function i(e){return a.contains(e)}return s.dragging=!1,{init:function(){!function(){$("#red-ui-sidebar-separator").draggable({axis:"x",start:function(e,t){s.closing=!1,s.opening=!1;var i=$("#red-ui-editor").width();if(s.start=t.position.left,s.chartWidth=$("#red-ui-workspace").width(),s.chartRight=i-$("#red-ui-workspace").width()-$("#red-ui-workspace").offset().left-2,s.dragging=!0,!RED.menu.isSelected("menu-item-sidebar")){s.opening=!0;$("#red-ui-sidebar").addClass("closing"),$("#red-ui-workspace").css("right",7),$("#red-ui-editor-stack").css("right",8),$("#red-ui-sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}s.width=$("#red-ui-sidebar").width()},drag:function(e,t){var i=t.position.left-s.start,o=s.width-i;s.opening&&(o-=3),150<o&&s.chartWidth+i<200&&(t.position.left=200+s.start-s.chartWidth,i=t.position.left-s.start,o=s.width-i),o<150?(s.closing||($("#red-ui-sidebar").addClass("closing"),s.closing=!0),s.opening||(o=150,t.position.left=s.width-(150-s.start),i=t.position.left-s.start)):150<o&&(s.closing||s.opening)&&(s.closing=!1,$("#red-ui-sidebar").removeClass("closing"));var n=s.chartRight-i;$("#red-ui-workspace").css("right",n),$("#red-ui-editor-stack").css("right",1+n),$("#red-ui-sidebar").width(o),a.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){s.dragging=!1,s.closing&&($("#red-ui-sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#red-ui-sidebar").width()<180&&($("#red-ui-sidebar").width(180),$("#red-ui-workspace").css("right",187),$("#red-ui-editor-stack").css("right",188))),$("#red-ui-sidebar-separator").css("left","auto"),$("#red-ui-sidebar-separator").css("right",$("#red-ui-sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}});var e=$('<div class="red-ui-sidebar-control-right"><i class="fa fa-chevron-right"</div>').appendTo($("#red-ui-sidebar-separator"));e.on("click",function(){e.hide(),RED.menu.toggleSelected("menu-item-sidebar")}),$("#red-ui-sidebar-separator").on("mouseenter",function(){s.dragging||(RED.menu.isSelected("menu-item-sidebar")?e.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"):e.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left"),e.toggle("slide",{direction:"right"},200))}),$("#red-ui-sidebar-separator").on("mouseleave",function(){s.dragging||(e.stop(!1,!0),e.hide())})}(),a=RED.tabs.create({element:$('<ul id="red-ui-sidebar-tabs"></ul>').appendTo("#red-ui-sidebar"),onchange:function(e){$("#red-ui-sidebar-content").children().hide(),$("#red-ui-sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},collapsible:!0}),$('<div id="red-ui-sidebar-content"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-shade" class="hide"></div>').appendTo("#red-ui-sidebar"),RED.actions.add("core:toggle-sidebar",function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):t(e)}),RED.popover.tooltip($("#red-ui-sidebar-separator").find(".red-ui-sidebar-control-right"),RED._("keyboard.toggleSidebar"),"core:toggle-sidebar"),d(),RED.sidebar.info.init(),RED.sidebar.config.init(),RED.sidebar.context.init(),$("#red-ui-editor").width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(e,t,i,o){var n;"string"==typeof e?n={id:t.id,label:e,name:e,content:t,closeable:i,visible:o}:"object"==typeof e&&(n=e),delete n.closeable,n.wrapper=$("<div>",{style:"height:100%"}).appendTo("#red-ui-sidebar-content"),n.wrapper.append(n.content),n.wrapper.hide(),n.enableOnEdit||(n.shade=$("<div>",{class:"red-ui-sidebar-shade hide"}).appendTo(n.wrapper)),n.toolbar&&($("#red-ui-sidebar-footer").append(n.toolbar),$(n.toolbar).hide()),n.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+n.id,label:n.name,onselect:function(){d(n.id)},group:"sidebar-tabs"}),n.iconClass=n.iconClass||"fa fa-square-o",!1!==(r[n.id]=n).visible&&a.addTab(r[n.id])},removeTab:function(e){a.removeTab(e),$(r[e].wrapper).remove(),r[e].footer&&r[e].footer.remove(),delete r[e],RED.menu.removeItem("menu-item-view-menu-"+e)},show:d,containsTab:i,toggleSidebar:t}}(),RED.palette=function(){var a,D=["config","unknown","deprecated"],E=["subflows","common","function","network","input","output","sequence","parser","storage","analysis","social","advanced"],R={};function x(e,t,i,o){0===$("#red-ui-palette-base-category-"+t).length&&r(e,t,o+":palette.label."+t),$("#red-ui-palette-container-"+t).show(),0===$("#red-ui-palette-"+i).length&&$("#red-ui-palette-base-category-"+t).append('<div id="red-ui-palette-'+i+'"></div>')}function r(e,t,i){var o=RED._(i,{defaultValue:t});o=(o||t).replace(/_/g," ");var n=$('<div id="red-ui-palette-container-'+t+'" class="red-ui-palette-category hide"><div id="red-ui-palette-header-'+t+'" class="red-ui-palette-header"><i class="expanded fa fa-angle-down"></i><span>'+o+'</span></div><div class="red-ui-palette-content" id="red-ui-palette-base-category-'+t+'"><div id="red-ui-palette-'+t+'"></div><div id="red-ui-palette-'+t+'-input"></div><div id="red-ui-palette-'+t+'-output"></div><div id="red-ui-palette-'+t+'-function"></div></div></div>').appendTo("#red-ui-palette-container");n.data("category",e),n.data("label",o),R[t]={container:n,close:function(){n.removeClass("red-ui-palette-open"),n.addClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideUp(),$("#red-ui-palette-header-"+t+" i").removeClass("expanded")},open:function(){n.addClass("red-ui-palette-open"),n.removeClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideDown(),$("#red-ui-palette-header-"+t+" i").addClass("expanded")},toggle:function(){n.hasClass("red-ui-palette-open")?R[t].close():R[t].open()}},$("#red-ui-palette-header-"+t).on("click",function(e){R[t].toggle()})}function k(t,e,i,o){for(var n=(i=RED.utils.sanitize(i)).split(/[ -]/),a=[],r="",s=0;s<n.length;s++){var d=n[s],l=0==s?"":" ";if(RED.view.calculateTextWidth(r+l+d,"red-ui-palette-label",0)<82)r+=l+d;else for(0<s&&a.push(r);;){if(!(82<=RED.view.calculateTextWidth(d,"red-ui-palette-label",0))){r=d;break}for(var c=d.length;0<c;c--){var p=d.substring(0,c);if(RED.view.calculateTextWidth(p,"red-ui-palette-label",0)<82){a.push(p),d=d.substring(c);break}}}}a.push(r);var u,f=a.join("<br/>"),h=8+20*a.length;e.css({height:h+"px"}),e.find(".red-ui-palette-label").html(f).attr("dir",RED.text.bidi.resolveBaseTextDir(f)),e.find(".red-ui-palette-port").css({top:h/2-5+"px"});try{var g="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(i)+"</b></p>";(u=$("<div></div>").append($(g+(o||($("script[data-help-name='"+t+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&0<this.textContent.trim().length}).slice(0,2))).find("a").each(function(){var e=$(this).text();$(this).before(e),$(this).remove()});var v=RED.nodes.getType(t);if(v){var b="";v&&!/^subflow:/.test(t)&&(b=v.set.module+" : "),b+=t,$("<p>",{style:"font-size: 0.8em"}).text(b).appendTo(u)}}catch(e){console.log("Error generating pop-over label for ",t),console.log(e.toString()),u="<p><b>"+i+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}e.data("popover").setContent(u)}function T(e){return $(".red-ui-palette-node[data-palette-type='"+e+"']")}function _(e){return e.replace(/[ /.]/g,"_")}function s(i,o){if(!T(i).length){var e=o.category;if(-1===D.indexOf(e)){var t=_(e),n=t.split("-")[0],a=$("<div>",{class:"red-ui-palette-node"}).attr("data-palette-type",i).data("category",n),r=i;if(void 0!==o.paletteLabel)try{r=("function"==typeof o.paletteLabel?o.paletteLabel.call(o):o.paletteLabel)||""}catch(e){console.log("Definition error: "+i+".paletteLabel",e)}if($("<div/>",{class:"red-ui-palette-label"+(!o.align&&0!==o.inputs&&0===o.outputs||"right"===o.align?" red-ui-palette-label-right":"")}).appendTo(a),o.icon){var s=RED.utils.getNodeIcon(o),d=$("<div/>",{class:"red-ui-palette-icon-container"+(!o.align&&0!==o.inputs&&0===o.outputs||"right"===o.align?" red-ui-palette-icon-container-right":"")}).appendTo(a);RED.utils.createIconElement(s,d,!0)}if(a.css("backgroundColor",RED.utils.getNodeColor(i,o)),0<o.outputs){var l=document.createElement("div");l.className="red-ui-palette-port red-ui-palette-port-output",a.append(l)}if(0<o.inputs){var c=document.createElement("div");c.className="red-ui-palette-port red-ui-palette-port-input",a.append(c)}x(e,n,t,-1!==E.indexOf(n)?"node-red":o.set.id),$("#red-ui-palette-"+t).append(a),a.on("mousedown",function(e){e.preventDefault()});var p=RED.popover.create({target:a,trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});a.data("popover",p),a.on("click",function(){var e;RED.view.focus(),e=0===i.indexOf("subflow:")?marked(RED.nodes.subflow(i.substring(8)).info||"")||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>":$("script[data-help-name='"+a.attr("data-palette-type")+"']").html()||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>",RED.sidebar.info.set(e,RED._("sidebar.info.nodeHelp"))});var u,f,h,g,v,b,m=$("#red-ui-workspace-chart"),y=$("#red-ui-workspace-chart>svg").get(0);$(a).draggable({helper:"clone",appendTo:"#red-ui-editor",revert:"invalid",revertDuration:200,containment:"#red-ui-main-container",start:function(){v=$("#red-ui-palette").width(),b=$("#red-ui-palette").parent().position().top+$("#red-ui-palette-container").position().top,RED.view.focus()},stop:function(){d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),g&&(clearTimeout(g),g=null)},drag:function(e,c){var t=T(i);c.originalPosition.left=t.offset().left,0<o.inputs&&0<o.outputs&&(f=c.position.left-v+c.helper.width()/2+m.scrollLeft(),h=c.position.top-b+c.helper.height()/2+m.scrollTop(),g=g||setTimeout(function(){var e=[],t=1/0,i=null;if(y.getIntersectionList){var o=y.createSVGRect();o.x=f,o.y=h,o.width=1,o.height=1,e=y.getIntersectionList(o,y),f/=RED.view.scale(),h/=RED.view.scale()}else f/=RED.view.scale(),h/=RED.view.scale(),e=RED.view.getLinksAtPoint(f,h);for(var n=0;n<e.length;n++){var a=d3.select(e[n]);if(a.classed("red-ui-flow-link-background")&&!a.classed("red-ui-flow-link-link"))for(var r=e[n].getTotalLength(),s=0;s<r;s+=10){var d=e[n].getPointAtLength(s),l=(d.x-f)*(d.x-f)+(d.y-h)*(d.y-h);l<200&&l<t&&(t=l,i=e[n])}}u&&u!==i&&d3.select(u.parentNode).classed("red-ui-flow-link-splice",!1),i?d3.select(i.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),u!==i&&(i?$(c.helper).data("splice",d3.select(i).data()[0]):$(c.helper).removeData("splice")),u=i,g=null},200))}});var w=null;0===i.indexOf("subflow:")&&(a.on("dblclick",function(e){RED.workspaces.show(i.substring(8)),e.preventDefault()}),w=marked(o.info||"")),k(i,a,r,w),1===$("#red-ui-palette-container-"+n).find(".red-ui-palette-node").length&&R[n].open()}}}function d(e){var t=T(e),i=t.closest(".red-ui-palette-category");t.remove(),0===i.find(".red-ui-palette-node").length&&i.find("i").hasClass("expanded")&&(i.find(".red-ui-palette-content").slideToggle(),i.find("i").toggleClass("expanded"))}function l(e){var t=T(e);t.hide();for(var i=t.closest(".red-ui-palette-category"),o=i.find(".red-ui-palette-node"),n=0,a=0;a<o.length;a++)"none"===$(o[a]).css("display")&&(n+=1);n===o.length&&i.hide()}function c(e){var t=T(e);t.closest(".red-ui-palette-category").show(),t.show()}return{init:function(){$('<img src="red/images/spin.svg" class="red-ui-palette-spinner hide"/>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-search" class="red-ui-palette-search hide"><input type="text" data-i18n="[placeholder]palette.filter"></input></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-container" class="red-ui-palette-scroll hide"></div>').appendTo("#red-ui-palette"),$('<div class="red-ui-component-footer"></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-shade" class="hide"></div>').appendTo("#red-ui-palette"),RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);s(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){d(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){c(e.types[t]);var i=RED.nodes.getType(e.types[t]);i&&i.onpaletteadd&&"function"==typeof i.onpaletteadd&&i.onpaletteadd.call(i)}}),RED.events.on("registry:node-set-disabled",function(e){for(var t=0;t<e.types.length;t++){l(e.types[t]);var i=RED.nodes.getType(e.types[t]);i&&i.onpaletteremove&&"function"==typeof i.onpaletteremove&&i.onpaletteremove.call(i)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){d(e.types[t]);var i=RED.nodes.getType(e.types[t]);i&&i.onpaletteremove&&"function"==typeof i.onpaletteremove&&i.onpaletteremove.call(i)}}),$("#red-ui-palette > .red-ui-palette-spinner").show(),$("#red-ui-palette-search input").searchBox({delay:100,change:function(){!function(n){var a=new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(var e in $("#red-ui-palette-container .red-ui-palette-node").each(function(e,t){var i=$(t).find(".red-ui-palette-label").text(),o=$(t).attr("data-palette-type");""===n||a.test(o)||a.test(i)?$(this).show():$(this).hide()}),R)R.hasOwnProperty(e)&&(0===R[e].container.find(".red-ui-palette-node").filter(function(){return"none"!==$(this).css("display")}).length?(R[e].close(),R[e].container.slideUp()):(R[e].open(),R[e].container.show()))}($(this).val())}}),a=$('<div class="red-ui-sidebar-control-left"><i class="fa fa-chevron-left"></i></div>').appendTo($("#red-ui-palette")),RED.popover.tooltip(a,RED._("keyboard.togglePalette"),"core:toggle-palette"),a.on("click",function(){RED.menu.toggleSelected("menu-item-palette")}),$("#red-ui-palette").on("mouseenter",function(){a.toggle("slide",{direction:"left"},200)}),$("#red-ui-palette").on("mouseleave",function(){a.stop(!1,!0),a.hide()});var e=[];RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=[]);var t={};e.forEach(function(e){t[e]=!0,r(e,_(e),"palette.label."+_(e))}),E.forEach(function(e){t[e]||r(e,_(e),"palette.label."+_(e))});var i=$('<span class="button-group"></span>').appendTo("#red-ui-palette .red-ui-component-footer"),o=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-up"></i></button>').appendTo(i);o.on("click",function(e){for(var t in e.preventDefault(),R)R.hasOwnProperty(t)&&R[t].close()}),RED.popover.tooltip(o,RED._("palette.actions.collapse-all"));var n=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-down"></i></button>').appendTo(i);n.on("click",function(e){for(var t in e.preventDefault(),R)R.hasOwnProperty(t)&&R[t].open()}),RED.popover.tooltip(n,RED._("palette.actions.expand-all")),RED.actions.add("core:toggle-palette",function(e){void 0===e?RED.menu.toggleSelected("menu-item-palette"):function(e){e?($("#red-ui-main-container").removeClass("red-ui-palette-closed"),a.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left")):($("#red-ui-main-container").addClass("red-ui-palette-closed"),a.hide(),a.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"));setTimeout(function(){$(window).trigger("resize")},200)}(e)})},add:s,remove:d,hide:l,show:c,refresh:function(){RED.nodes.eachSubflow(function(e){var t=T("subflow:"+e.id),i=t.find(".red-ui-palette-port-input"),o=t.find(".red-ui-palette-port-output");if(t.find(".red-ui-palette-label").attr("class","red-ui-palette-label"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-label-right":"")),t.find(".red-ui-palette-icon-container").attr("class","red-ui-palette-icon-container"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-icon-container-right":"")),0===i.length&&0<e.in.length){var n=document.createElement("div");n.className="red-ui-palette-port red-ui-palette-port-input",t.append(n)}else 0!==i.length&&0===e.in.length&&i.remove();if(0===o.length&&0<e.out.length){var a=document.createElement("div");a.className="red-ui-palette-port red-ui-palette-port-output",t.append(a)}else 0!==o.length&&0===e.out.length&&o.remove();k(e.type+":"+e.id,t,e.name,marked(e.info||"")),function(e,t){var i=RED.utils.getNodeIcon(t._def),o=e.find(".red-ui-palette-icon-container");RED.utils.createIconElement(i,o,!0)}(t,e);var r=t.data("category"),s=e.category||"subflows";if(r!==s){var d=_(s);x(s,d,d,"node-red");var l=t.closest(".red-ui-palette-category"),c=$("#red-ui-palette-"+d);c.append(t),1===c.find(".red-ui-palette-node").length&&R[d].open(),t.data("category",s),0===l.find(".red-ui-palette-node").length&&l.find("i").hasClass("expanded")&&(l.find(".red-ui-palette-content").slideToggle(),l.find("i").toggleClass("expanded"))}t.css("backgroundColor",e.color)})},getCategories:function(){var i=[];return $("#red-ui-palette-container .red-ui-palette-category").each(function(e,t){i.push({id:$(t).data("category"),label:$(t).data("label")})}),i}}}(),RED.sidebar.info=function(){var o,j,C,L,S,n;marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var O={property:!1};function a(){RED.sidebar.show("info")}function r(e){if(void 0!==e){var t;j.show(),$(C.content).empty(),$(L.content).empty(),$(S.content).empty(),L.title.text(RED._("sidebar.info.desc"));var i,o,n=$('<table class="red-ui-info-table"></table>').appendTo(C.content),a=$("<tbody>").appendTo(n),r=RED.projects.getActiveProject();if(r){t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.project.name")+"</td><td></td></tr>").appendTo(a),$(t.children()[1]).text(r.name||""),$('<tr class="red-ui-help-property-expand blank"><td colspan="2"></td></tr>').appendTo(a);var s=$('<button class="red-ui-button red-ui-button-small" style="position:absolute;right:2px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(t.children()[1]).on("click",function(e){e.preventDefault(),RED.projects.editProject()});RED.popover.tooltip(s,RED._("sidebar.project.showProjectSettings"))}if(C.container.show(),L.container.show(),S.container.show(),null!==e)if(Array.isArray(e)){var d={nodes:0,flows:0,subflows:0};e.forEach(function(e){"tab"===e.type?(d.flows++,d.nodes+=RED.nodes.filterNodes({z:e.id}).length):"subflow"===e.type?d.subflows++:d.nodes++}),S.container.hide(),L.container.hide(),t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(a);var l=$("<div>").appendTo($(t.children()[1]));0<d.flows&&$("<div>").text(RED._("clipboard.flow",{count:d.flows})).appendTo(l),0<d.subflows&&$("<div>").text(RED._("clipboard.subflow",{count:d.subflows})).appendTo(l),0<d.nodes&&$("<div>").text(RED._("clipboard.node",{count:d.nodes})).appendTo(l)}else{var c=/^subflow(:(.+))?$/.exec(e.type);if(c){i=c[2]?RED.nodes.subflow(c[2]):e,o=0;var p="subflow:"+i.id;RED.nodes.eachNode(function(e){e.type===p&&o++})}if("tab"===e.type||"subflow"===e.type)t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info."+("tab"===e.type?"flow":"subflow"))+"</td><td></td></tr>").appendTo(a),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.tabName")+"</td><td></td></tr>").appendTo(a),$(t.children()[1]).text(e.label||e.name||""),"tab"===e.type&&(t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.status")+"</td><td></td></tr>").appendTo(a),$(t.children()[1]).text(e.disabled?RED._("sidebar.info.disabled"):RED._("sidebar.info.enabled")));else{t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.node")+"</td><td></td></tr>").appendTo(a),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),"subflow"!==e.type&&"unknown"!==e.type&&e.name&&(t=$('<tr class="red-ui-help-info-row"><td>'+RED._("common.label.name")+"</td><td></td></tr>").appendTo(a),$('<span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'"></span>').text(e.name).appendTo(t.children()[1])),c||(t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.type")+"</td><td></td></tr>").appendTo(a),$(t.children()[1]).text("unknown"===e.type?e._orig.type:e.type),"unknown"===e.type&&$('<span style="float: right; font-size: 0.8em"><i class="fa fa-warning"></i></span>').prependTo($(t.children()[1])));var u=0;if(!c&&"subflow"!=e.type){var f;if("unknown"===e.type?(f={},Object.keys(e._orig).forEach(function(e){"type"!==e&&(f[e]={})})):e._def&&(f=e._def.defaults,t=$('<tr class="red-ui-help-info-property-row'+(O.property?"":" hide")+'"><td>'+RED._("sidebar.info.module")+"</td><td></td></tr>").appendTo(a),$(t.children()[1]).text(RED.nodes.getType(e.type).set.module),u++),$('<tr class="red-ui-help-property-expand red-ui-help-info-property-row blank'+(O.property?"":" hide")+'"><td colspan="2"></td></tr>').appendTo(a),f)for(var h in f)if("name"!=h&&"info"!=h&&f.hasOwnProperty(h)){var g=e[h];if(u++,t=$('<tr class="red-ui-help-info-property-row'+(O.property?"":" hide")+'"><td>'+h+"</td><td></td></tr>").appendTo(a),f[h].type){var v=RED.nodes.node(g);if(v){var b=RED.utils.getNodeLabel(v,g),m=t.children()[1],y=$("<span>",{class:""}).appendTo(m),w=$("<div>",{class:"red-ui-palette-node red-ui-palette-node-small"}).appendTo(y),D=RED.utils.getNodeColor(v.type,v._def),E=RED.utils.getNodeIcon(v._def);w.css({backgroundColor:D,cursor:"pointer"});var R=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(w);$("<div/>",{class:"red-ui-palette-icon",style:"background-image: url("+E+")"}).appendTo(R);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).text(b).appendTo(m);w.on("dblclick",function(){RED.editor.editConfig("",v.type,v.id)})}else RED.utils.createObjectElement(void 0).appendTo(t.children()[1])}else RED.utils.createObjectElement(g).appendTo(t.children()[1])}0<u&&$('<tr class="red-ui-help-property-expand blank"><td colspan="2"><a href="#" class="node-info-property-header'+(O.property?" expanded":"")+'"><span class="red-ui-help-property-more">'+RED._("sidebar.info.showMore")+'</span><span class="red-ui-help-property-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(a)}"tab"!==e.type&&c&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(a),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(i.name)+'">'+RED.utils.sanitize(i.name)+"</span></td></tr>").appendTo(a))}if(c){t=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.category")+"</td><td></td></tr>").appendTo(a);var x=i.category||"subflows";$(t.children()[1]).text(RED._("palette.label."+x,{defaultValue:x})),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+o+"</td></tr>").appendTo(a)}"tab"===e.type||"subflow"===e.type?$(S.container).hide():($(S.container).show(),I(i&&"subflow"!==e.type?marked(i.info||"")||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>":$("script[data-help-name='"+e.type+"']").html()||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>",S.content));var k="";if(e._def&&e._def.info){var T=e._def.info,_="function"==typeof T?T.call(e):T;k+=marked(_)}e.info&&(k+=marked(e.info||"")),I(k,L.content),$(".red-ui-sidebar-info-stack").scrollTop(0),$(".node-info-property-header").on("click",function(e){e.preventDefault(),O.property=!O.property,$(this).toggleClass("expanded",O.property),$(".red-ui-help-info-property-row").toggle(O.property)})}}else P()}function I(e,t){var i=function(e){return $(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),e}($('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>")).appendTo(t);i.find(".red-ui-text-bidi-aware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");i.find("H3").wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),i=$(this).parent().next();1===i.length&&"H3"!==i[0].nodeName;)i.toggle(!t),i=i.next();$(this).toggleClass("expanded",!t)})}var s,d,t,l,c,p=(t=!0,l=15e3,c=-1,RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(t=e)?i():f()}),{start:i,stop:f,next:function(){clearInterval(d),s=!0,e()},enabled:function(){return t}});function e(){for(var e,t=Math.floor(Math.random()*c),i=RED._("infotips:info.tip"+t);e=/({{(.*?)}})/.exec(i);){var o=RED.keyboard.getShortcut(e[2]);if(!o)return;i=i.replace(e[1],RED.keyboard.formatKey(o.key))}for(;e=/(\[(.*?)\])/.exec(i);)i=i.replace(e[1],RED.keyboard.formatKey(e[2]));n.html(i).fadeIn(200),s&&(s=null,d=setInterval(u,l))}function u(){n.fadeOut(300,function(){e()})}function i(){if($(".red-ui-sidebar-info").addClass("show-tips"),t&&!s&&!d){if(-1===c)for(;c++,RED._("infotips:info.tip"+c)!=="infotips:info.tip"+c;);s=setTimeout(e,1e3)}}function f(){$(".red-ui-sidebar-info").removeClass("show-tips"),clearInterval(d),clearTimeout(s),s=d=null}function P(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?r(RED.nodes.subflow(t.z)):r(t)}else r(e.nodes);else if(e.flows||e.subflows)r(e.flows);else{var i=RED.workspaces.active(),o=RED.nodes.workspace(i)||RED.nodes.subflow(i);if(o)r(o);else{var n=RED.nodes.workspace(RED.workspaces.active());n&&n.info?r(n):r(null)}}}return RED.events.on("view:selection-changed",P),{init:function(){(o=document.createElement("div")).className="red-ui-sidebar-info",RED.actions.add("core:show-info-tab",a);var e=$("<div>",{class:"red-ui-sidebar-info-stack"}).appendTo(o);j=RED.stack.create({container:e}).hide(),(C=j.add({title:RED._("sidebar.info.info"),collapsible:!0})).expand(),(L=j.add({title:RED._("sidebar.info.desc"),collapsible:!0})).expand(),L.content.css("padding","6px"),(S=j.add({title:RED._("sidebar.info.nodeHelp"),collapsible:!0})).expand(),S.content.css("padding","6px");var t=$('<div class="red-ui-help-tips"></div>').appendTo(o);n=$('<div class="red-ui-help-tip"></div>').appendTo(t);var i=$('<div class="red-ui-help-tips-buttons"></div>').appendTo(t);$('<a href="#" class="red-ui-footer-button"><i class="fa fa-refresh"></a>').appendTo(i).on("click",function(e){e.preventDefault(),p.next()}),$('<a href="#" class="red-ui-footer-button"><i class="fa fa-times"></a>').appendTo(i).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),iconClass:"fa fa-info",action:"core:show-info-tab",content:o,pinned:!0,enableOnEdit:!0}),p.enabled()?p.start():p.stop()},show:a,refresh:r,clear:function(){r(null)},set:function(e,t){r(null),C.container.hide(),S.container.hide(),L.container.show(),L.title.text(t||RED._("sidebar.info.desc")),I(e,L.content),$(".red-ui-sidebar-info-stack").scrollTop(0)}}}(),RED.sidebar.config=function(){var d=document.createElement("div");d.className="red-ui-sidebar-node-config",d.id="red-ui-sidebar-node-config",d.tabIndex=0,$('<div class="red-ui-sidebar-header"><span class="button-group"><a class="red-ui-sidebar-header-button-toggle selected" id="red-ui-sidebar-config-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="red-ui-sidebar-header-button-toggle" id="red-ui-sidebar-config-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </span></div>').appendTo(d);var e=$('<div><a class="red-ui-footer-button" id="red-ui-sidebar-config-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="red-ui-footer-button" id="red-ui-sidebar-config-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),n=$("<div>").appendTo(d),a=$("<div>").appendTo(d),r=$("<div>").appendTo(d),l=!1,s={};function c(e,t,i){if(e=e.replace(/\./i,"-"),s[e])s[e].label!==i&&(s[e].list.parent().find(".red-ui-palette-node-config-label").text(i),s[e].label=i);else{var o=$('<div class="red-ui-palette-category red-ui-sidebar-config-category" id="red-ui-sidebar-config-category-'+e+'"></div>').appendTo(t),n=$('<div class="red-ui-sidebar-config-tray-header red-ui-palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(o);i?$('<span class="red-ui-palette-node-config-label"/>').text(i).appendTo(n):$('<span class="red-ui-palette-node-config-label" data-i18n="sidebar.config.'+e+'">').appendTo(n),$('<span class="red-ui-sidebar-node-config-filter-info"></span>').appendTo(n),category=$('<ul class="red-ui-palette-content red-ui-sidebar-node-config-list"></ul>').appendTo(o),category.on("click",function(e){$(d).find(".red-ui-palette-node").removeClass("selected")}),o.i18n();var a=n.find("i"),r={label:i,list:category,size:function(){return r.list.find("li:not(.red-ui-palette-node-config-none)").length},open:function(e){a.hasClass("expanded")||(a.addClass("expanded"),e?r.list.show():r.list.slideDown())},close:function(e){a.hasClass("expanded")&&(a.removeClass("expanded"),e?r.list.hide():r.list.slideUp())},isOpen:function(){return a.hasClass("expanded")}};n.on("click",function(e){r.isOpen()?r.close():r.open()}),s[e]=r}return s[e]}function p(e,t){var i=c(e.replace(/\./i,"-")),r=i.list;if(t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),l){var o=t.length;0<(o-=(t=t.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)?r.parent().find(".red-ui-sidebar-node-config-filter-info").text(RED._("sidebar.config.filtered",{count:o})).show():r.parent().find(".red-ui-sidebar-node-config-filter-info").hide()}else r.parent().find(".red-ui-sidebar-node-config-filter-info").hide();if(r.empty(),0===t.length)$('<li class="red-ui-palette-node-config-none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(r),i.close(!0);else{var s="";t.forEach(function(t){var e=RED.utils.getNodeLabel(t,t.id);t.type!=s&&($('<li class="red-ui-palette-node-config-type">'+t.type+"</li>").appendTo(r),s=t.type);var i=$('<li class="red-ui-palette-node_id_'+t.id.replace(/\./g,"-")+'"></li>').appendTo(r),o=$('<div class="red-ui-palette-node-config red-ui-palette-node"></div>').appendTo(i);i.data("node",t.id);e=$('<div class="red-ui-palette-label"></div>').text(e).appendTo(o);if(t.d&&(o.addClass("red-ui-palette-node-config-disabled"),$('<i class="fa fa-ban"></i>').prependTo(e)),!1!==t._def.hasUsers){var n=$("<div/>",{class:"red-ui-palette-icon-container red-ui-palette-icon-container-right"}).appendTo(o);0===t.users.length?n.text(0):$('<a href="#"/>').on("click",function(e){e.stopPropagation(),e.preventDefault(),RED.search.show(t.id)}).text(t.users.length).appendTo(n),RED.popover.tooltip(n,RED._("editor.nodesUse",{count:t.users.length})),0===t.users.length&&o.addClass("red-ui-palette-node-config-unused")}o.on("click",function(e){e.stopPropagation(),RED.view.select(!1),e.metaKey?$(this).toggleClass("selected"):($(d).find(".red-ui-palette-node").removeClass("selected"),$(this).addClass("selected")),RED.sidebar.info.refresh(t)}),o.on("dblclick",function(e){e.stopPropagation(),RED.editor.editConfig("",t.type,t.id)});var a=t.users.map(function(e){return e.id});o.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=a.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),o.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),i.open(!0)}}function t(){var t={global:!0};c("global",n),RED.nodes.eachWorkspace(function(e){t[e.id.replace(/\./g,"-")]=!0,c(e.id,a,e.label)}),RED.nodes.eachSubflow(function(e){t[e.id.replace(/\./g,"-")]=!0,c(e.id,r,e.name)}),$(".red-ui-sidebar-config-category").each(function(){var e=$(this).attr("id").substring("red-ui-sidebar-config-category-".length);t[e]||($(this).remove(),delete s[e])});var i=[],o={};for(var e in RED.nodes.eachConfig(function(e){e.z?(o[e.z.replace(/\./g,"-")]=o[e.z.replace(/\./g,"-")]||[],o[e.z.replace(/\./g,"-")].push(e)):e.z||i.push(e)}),t)t.hasOwnProperty(e)&&p(e,o[e]||[]);p("global",i)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:d,toolbar:e,iconClass:"fa fa-cog",action:"core:show-config-tab",onchange:function(){t()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),RED.actions.add("core:select-all-config-nodes",function(){$(d).find(".red-ui-palette-node").addClass("selected")}),RED.actions.add("core:delete-config-selection",function(){var e=[];if($(d).find(".red-ui-palette-node.selected").each(function(){e.push($(this).parent().data("node"))}),0<e.length){var a={t:"delete",nodes:[],changes:{},dirty:RED.nodes.dirty()};e.forEach(function(e){var t=RED.nodes.node(e);try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}a.nodes.push(t);for(var i=0;i<t.users.length;i++){var o=t.users[i];for(var n in a.changes[o.id]={changed:o.changed,valid:o.valid},o._def.defaults)o._def.defaults.hasOwnProperty(n)&&o[n]==e&&(a.changes[o.id][n]=e,o[n]="",o.changed=!0,o.dirty=!0);RED.editor.validateNode(o)}RED.nodes.remove(e)}),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a)}}),RED.events.on("view:selection-changed",function(){$(d).find(".red-ui-palette-node").removeClass("selected")}),$("#red-ui-sidebar-config-collapse-all").on("click",function(e){for(var t in e.preventDefault(),s)s.hasOwnProperty(t)&&s[t].close()}),$("#red-ui-sidebar-config-expand-all").on("click",function(e){for(var t in e.preventDefault(),s)s.hasOwnProperty(t)&&0<s[t].size()&&s[t].open()}),$("#red-ui-sidebar-config-filter-all").on("click",function(e){e.preventDefault(),l&&($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-unused").removeClass("selected"),l=!l,t())}),$("#red-ui-sidebar-config-filter-unused").on("click",function(e){e.preventDefault(),l||($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-all").removeClass("selected"),l=!l,t())}),RED.popover.tooltip($("#red-ui-sidebar-config-filter-all"),RED._("sidebar.config.showAllUnusedConfigNodes")),RED.popover.tooltip($("#red-ui-sidebar-config-filter-unused"),RED._("sidebar.config.showAllUnusedConfigNodes"))},show:function(s){"boolean"==typeof s&&(s?$("#red-ui-sidebar-config-filter-unused").trigger("click"):$("#red-ui-sidebar-config-filter-all").trigger("click")),t(),"string"==typeof s&&($("#red-ui-sidebar-config-filter-all").trigger("click"),s=s.replace(/\./g,"-"),setTimeout(function(){var e=$(".red-ui-palette-node_id_"+s),t=e.position().top,i=e.height(),o=$(".red-ui-sidebar-node-config"),n=o.height();n<t+i?o.animate({scrollTop:"-="+(n-(t+i)-30)},150):t<0&&o.animate({scrollTop:"+="+(t-10)},150);var a=21,r=function(){a%2==0?e.removeClass("node_highlighted"):e.addClass("node_highlighted"),0<=--a&&setTimeout(r,100)};r()},100)),RED.sidebar.show("config")},refresh:t}}(),RED.sidebar.context=function(){var d,l,c,p,u,f,h,g,v;function b(e,t){g=e,t||p.prop("checked")?e?y(u,"context/node/"+e.id,e.id):y(u):($(u.table).empty(),e?$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(u.table).i18n():$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(u.table).i18n(),u.timestamp.html("&nbsp;"))}function m(e,t){v=e,t||c.prop("checked")?e?y(f,"context/flow/"+e.id,e.id):y(f):($(f.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(f.table).i18n(),f.timestamp.html("&nbsp;"))}function y(e,t,i){var o=e.table;i?function(a,u,f){var h=RED.settings.context.stores,g=a.table;$.getJSON(u,function(e){$(g).empty();var i={};for(var t in e)if(e.hasOwnProperty(t))for(var o in e[t])e[t].hasOwnProperty(o)&&(i.hasOwnProperty(o)||(i[o]=[]),e[t][o].store=t,i[o].push(e[t][o]));var c=Object.keys(i);c.sort();for(var n=c.length,p=0;p<n;p++)i[c[p]].forEach(function(n){var a=c[p],r=(i[a].length,$('<tr class="red-ui-help-info-row"><td class="red-ui-sidebar-context-property"></td><td></td></tr>').appendTo(g));$(r.children()[0]).text(a);var s=$('<span class="button-group"></span>'),e=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(s).on("click",function(e){e.preventDefault(),e.stopPropagation(),$.getJSON(u+"/"+a+"?store="+n.store,function(e){e.msg===d&&e.format===l||(d=e.msg,l=e.format,s.detach(),$(r.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(d,l),{typeHint:e.format,sourceId:f+"."+a,tools:s}).appendTo(r.children()[1]))})});RED.popover.tooltip(e,RED._("sidebar.context.refrsh"));var t=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(s).on("click",function(e){e.preventDefault(),e.stopPropagation();var o=RED.popover.create({trigger:"modal",target:r,direction:"left",content:function(){var e=$("<div>");$('<p data-i18n="sidebar.context.deleteConfirm"></p>').appendTo(e);var t=$("<p>").appendTo(e),i=$('<span class="button-group"></span>').appendTo(t);return $('<button class="red-ui-button" data-i18n="common.label.cancel"></button>').appendTo(i).on("click",function(e){e.preventDefault(),o.close()}),i=$('<span class="button-group"></span>').appendTo(t),$('<button class="red-ui-button primary" data-i18n="common.label.delete"></button>').appendTo(i).on("click",function(e){e.preventDefault(),o.close(),$.ajax({url:u+"/"+a+"?store="+n.store,type:"DELETE"}).done(function(e,t,i){$.getJSON(u+"/"+a+"?store="+n.store,function(e){"undefined"===e.format?(r.remove(),0===g.children().length&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(g).i18n()):(d=e.msg,l=e.format,s.detach(),$(r.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(d,l),{typeHint:e.format,sourceId:f+"."+a,tools:s}).appendTo(r.children()[1]))})}).fail(function(e,t,i){})}),e.i18n()}});o.open()});RED.popover.tooltip(t,RED._("sidebar.context.delete"));var d=n.msg,l=n.format;RED.utils.createObjectElement(RED.utils.decodeObject(d,l),{typeHint:n.format,sourceId:f+"."+a,tools:s}).appendTo(r.children()[1]),1<h.length&&$("<span>",{class:"red-ui-sidebar-context-property-storename"}).text(n.store).appendTo($(r.children()[0]))});0===n&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(g).i18n(),$(a.timestamp).text((new Date).toLocaleString())})}(e,t,i):($(o).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(o).i18n())}function w(){RED.sidebar.show("context")}return{init:function(){(d=$("<div>").css({position:"relative",height:"100%"})).className="red-ui-sidebar-context";var e=$("<div></div>"),t=$("<div>",{class:"red-ui-sidebar-context-stack"}).appendTo(d);l=RED.stack.create({container:t}),(u=l.add({title:RED._("sidebar.context.node"),collapsible:!0})).expand(),u.content.css({height:"100%"}),u.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(u.content);var i=$('<table class="red-ui-info-table"></table>').appendTo(u.content);u.table=$("<tbody>").appendTo(i);var o=$('<div style="float: right"></div>').appendTo(u.header),n=RED.settings.get("editor.context.nodeRefresh",!1);p=$('<input type="checkbox">').prop("checked",n).appendTo(o).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)}),RED.popover.tooltip(p.next(),RED._("sidebar.context.autoRefresh"));var a=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(o).on("click",function(e){e.stopPropagation(),e.preventDefault(),b(g,!0)});RED.popover.tooltip(a,RED._("sidebar.context.refrsh")),(f=l.add({title:RED._("sidebar.context.flow"),collapsible:!0})).expand(),f.content.css({height:"100%"}),f.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(f.content),i=$('<table class="red-ui-info-table"></table>').appendTo(f.content),f.table=$("<tbody>").appendTo(i),o=$('<div style="float: right"></div>').appendTo(f.header);var r=RED.settings.get("editor.context.flowRefresh",!1);c=$('<input type="checkbox">').prop("checked",r).appendTo(o).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)}),RED.popover.tooltip(c.next(),RED._("sidebar.context.autoRefresh"));var s=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(o).on("click",function(e){e.stopPropagation(),e.preventDefault(),m(v,!0)});RED.popover.tooltip(s,RED._("sidebar.context.refrsh")),(h=l.add({title:RED._("sidebar.context.global"),collapsible:!0})).expand(),h.content.css({height:"100%"}),h.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(h.content),i=$('<table class="red-ui-info-table"></table>').appendTo(h.content),h.table=$("<tbody>").appendTo(i),o=$('<div style="float: right"></div>').appendTo(h.header),$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(o).on("click",function(e){e.stopPropagation(),e.preventDefault(),y(h,"context/global","global")}),RED.popover.tooltip(o,RED._("sidebar.context.refrsh")),RED.actions.add("core:show-context-tab",w),RED.sidebar.addTab({id:"context",label:RED._("sidebar.context.label"),name:RED._("sidebar.context.name"),iconClass:"fa fa-database",content:d,toolbar:e,enableOnEdit:!0,action:"core:show-context-tab"}),RED.events.on("view:selection-changed",function(e){b(e.nodes&&1===e.nodes.length&&e.nodes[0])}),RED.events.on("workspace:change",function(e){m(RED.nodes.workspace(e.workspace))}),$(h.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(h.table).i18n(),h.timestamp.html("&nbsp;")}}}(),RED.palette.editor=function(){var p,u,f,b,h,a,g=[],v=[],w={},m={},y={},t={},D="";function r(e,t){var i=Date.now()-e;i=i<300?300:0,setTimeout(function(){t()},i)}function E(e,t,o,n){o.show();var a=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,i){r(a,function(){o.hide(),n()})}).fail(function(e,t,i){r(a,function(){o.hide(),n(e)})})}function R(e,t,o){var i={module:e};t&&(i.version=t),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(i),contentType:"application/json; charset=utf-8"}).done(function(e,t,i){o()}).fail(function(e,t,i){o(e)})}function x(e){t.hasOwnProperty(e)||(t[e]=setTimeout(function(){delete t[e],i(e)},100))}function k(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var i=parseInt(t[1]),o=parseInt(t[2]),n=parseInt(t[3]);if(160<(299*i+587*o+114*n)/1e3)return"rgb("+(i=Math.floor(.8*i))+","+(o=Math.floor(.8*o))+","+(n=Math.floor(.8*n))+")"}return e}function i(e){if(y.hasOwnProperty(e)){var t=y[e].info,i=y[e].elements;if(i){var o=0,n=0,a=0;for(var r in i.errorList.empty(),y[e].totalUseCount=0,y[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(r)){var s=0,d=t.sets[r],l=i.sets[r];d.err&&(a++,$("<li>").text(d.err).appendTo(i.errorList)),d.enabled&&(o+=d.types.length),n+=d.types.length;for(var c=0;c<t.sets[r].types.length;c++){var p=t.sets[r].types[c];s+=m[p]||0;var u=l.swatches[p];if(d.enabled){var f=RED.nodes.getType(p);f&&f.color&&(u.css({background:RED.utils.getNodeColor(p,f)}),u.css({border:"1px solid "+k(u.css("backgroundColor"))}))}}y[e].setUseCount[r]=s,y[e].totalUseCount+=s,0<s?(l.enableButton.text(RED._("palette.editor.inuse")),l.enableButton.addClass("disabled")):(l.enableButton.removeClass("disabled"),d.enabled?l.enableButton.text(RED._("palette.editor.disable")):l.enableButton.text(RED._("palette.editor.enable"))),l.setRow.toggleClass("red-ui-palette-module-set-disabled",!d.enabled)}0===a?i.errorRow.hide():i.errorRow.show();var h=o===n?n:o+" / "+n;i.setCount.text(RED._("palette.editor.nodeCount",{count:n,label:h})),0<y[e].totalUseCount?(i.enableButton.text(RED._("palette.editor.inuse")),i.enableButton.addClass("disabled"),i.removeButton.hide()):(i.enableButton.removeClass("disabled"),t.local&&i.removeButton.css("display","inline-block"),0===o?i.enableButton.text(RED._("palette.editor.enableall")):i.enableButton.text(RED._("palette.editor.disableall")),i.container.toggleClass("disabled",0===o))}t.pending_version?(i.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(i.metaRow),i.updateButton.text(RED._("palette.editor.updated")).addClass("disabled").css("display","inline-block")):w.hasOwnProperty(e)&&1===function(e,t){for(var i=e.split(".").map(function(e){return parseInt(e)}),o=t.split(".").map(function(e){return parseInt(e)}),n=0;n<3;n++){var a=i[n]-o[n];if(a<0)return-1;if(0<a)return 1}return 0}(w[e].version,t.version)?(i.updateButton.show(),i.updateButton.text(RED._("palette.editor.update",{version:w[e].version}))):i.updateButton.hide()}else{y[e]={info:RED.nodes.registry.getModule(e)};var g=[e];for(var v in y[e].info.sets)y[e].info.sets.hasOwnProperty(v)&&(g.push(v),g=g.concat(y[e].info.sets[v].types));y[e].index=g.join(",").toLowerCase(),b.editableList("addItem",y[e])}}var s,T,d=[],l=!1,_=L;function n(e,t,i,o){if(d.push(e||o),e?l=!0:(o.modules&&(o.modules.forEach(function(e){(w[e.id]=e).index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.types&&(e.index=e.index.concat(e.types)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),g=g.concat(o.modules)),f.searchBox("count",g.length)),1<a&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+d.length+"/"+a),d.length===a){l&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var n=250-(Date.now()-s);setTimeout(function(){$("#red-ui-palette-module-install-shade").hide()},Math.max(n,0))}}function j(){if(0===g.length){g=[],w={},h.editableList("empty"),$(".red-ui-palette-module-shade-status").text(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];l=!(d=[]),a=e.length,1<e.length&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#red-ui-palette-module-install-shade").show(),s=Date.now();var t=0;e.forEach(function(o,e){$.getJSON(o,{_:(new Date).getTime()},function(e){n(null,o,0,e),function(){for(var e in y)y.hasOwnProperty(e)&&i(e)}()}).fail(function(e,t,i){n(e,o)}).always(function(){++t===a&&f.searchBox("change")})})}}function C(){if(h.editableList("empty"),""!==f.searchBox("value").trim()){v.sort(_);for(var e=0;e<Math.min(10,v.length);e++)h.editableList("addItem",v[e]);0===v.length&&h.editableList("addItem",{}),10<v.length&&h.editableList("addItem",{start:10,more:v.length-10})}else h.editableList("addItem",{count:g.length})}function L(e,t){var i=f.searchBox("value").trim();if(""===i)return S(e,t);var o=e.info.index.indexOf(i)-t.info.index.indexOf(i);return 0==o?S(e,t):o}function S(e,t){return e.info.id.localeCompare(t.info.id)}function O(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function e(){return j(),p.activateTab("nodes"),T}function I(o,t,n){if(!1!==RED.settings.theme("palette.editable")){var e=[{text:RED._("common.label.cancel"),click:function(){a.close()}}];o.url&&e.push({text:RED._("palette.editor.confirm.button.review"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var e=o.url||"";window.open(e)}}),e.push({text:RED._("palette.editor.confirm.button.install"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var i=RED.utils.addSpinnerOverlay(t,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(i);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+o.id+" "+o.version),R(o.id,o.version,function(e){if(i.remove(),e&&e.responseJSON)var t=RED.notify(RED._("palette.editor.errors.installFailed",{module:o.id,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]});n(e)}),a.close()}});var a=RED.notify(RED._("palette.editor.confirm.install.body",{module:o.id}),{modal:!0,fixed:!0,buttons:e})}else n(new Error("Palette not editable"))}return{init:function(){!1!==RED.settings.theme("palette.editable")&&(function(){T=$('<div id="red-ui-settings-tab-palette"></div>');var t=$('<div id="red-ui-palette-editor"><ul id="red-ui-palette-editor-tabs"></ul></div>').appendTo(T);p=RED.tabs.create({element:T.find("#red-ui-palette-editor-tabs"),onchange:function(e){t.find(".red-ui-palette-editor-tab").hide(),e.content.show(),u&&u.searchBox("value",""),f&&f.searchBox("value",""),"install"===e.id?f&&f.trigger("focus"):u&&u.trigger("focus")},minimumActiveTabWidth:110});var e=$("<div>",{class:"red-ui-palette-editor-tab"}).appendTo(t);p.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:e});var i=$("<div>",{class:"red-ui-palette-search"}).appendTo(e);u=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(i).searchBox({delay:200,change:function(){!function(e){D=e.toLowerCase();var t=b.editableList("filter"),i=b.editableList("length");""===e?u.searchBox("count"):u.searchBox("count",t+" / "+i)}($(this).val())}}),b=$("<ol>",{id:"red-ui-palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===D||(""===D||-1<e.index.indexOf(D))},addItem:function(t,e,r){var s=r.info;if(s){var i=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(t),o=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(i);$("<span>").text(s.name).appendTo(o);var n=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(i),a=$("<span>").text(s.version).appendTo(n),d=$('<div class="red-ui-palette-module-meta red-ui-palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(i),l=$('<ul class="red-ui-palette-module-error-list"></ul>').appendTo(d),c=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(i),p=$('<a href="#" class="red-ui-button red-ui-button-small red-ui-palette-module-set-button"><i class="fa fa-angle-right red-ui-palette-module-node-chevron"></i> </a>').appendTo(c),u=$("<span>").appendTo(p),f=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(c),h=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.update")).appendTo(f);h.attr("id","up_"+Math.floor(1e9*Math.random())),h.on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||function(o,t,n,a){if(!1===RED.settings.theme("palette.editable"))return a(new Error("Palette not editable"));var r=RED.notify(RED._("palette.editor.confirm.update.body",{module:o.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){r.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary red-ui-palette-module-install-confirm-button-update",click:function(){var i=RED.utils.addSpinnerOverlay(n,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(i);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+o.name+" "+t),R(o.name,t,function(e){if(i.remove(),e&&e.responseJSON)var t=RED.notify(RED._("palette.editor.errors.updateFailed",{module:o.name,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]});a(e)}),r.close()}}]})}(s,w[s.name].version,t,function(e){})});var g=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.remove")).appendTo(f);g.attr("id","up_"+Math.floor(1e9*Math.random())),g.on("click",function(e){e.preventDefault(),function(o,t,e){if(!1===RED.settings.theme("palette.editable"))return e(new Error("Palette not editable"));var n=RED.notify(RED._("palette.editor.confirm.remove.body",{module:o.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary red-ui-palette-module-install-confirm-button-remove",click:function(){var i=RED.utils.addSpinnerOverlay(t,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(i);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.remove")+" : "+o.name),function(e,o){$.ajax({url:"nodes/"+e,type:"DELETE"}).done(function(e,t,i){o()}).fail(function(e,t,i){o(e)})}(o.name,function(e){if(i.remove(),e&&e.responseJSON)var t=RED.notify(RED._("palette.editor.errors.removeFailed",{module:o.name,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]})}),n.close()}}]})}(s,t,function(e){})}),s.local||g.hide();var v=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.disableall")).appendTo(f),b=$("<div>",{class:"red-ui-palette-module-content"}).appendTo(t),m=$('<div class="red-ui-palette-module-shade hide"><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(t);r.elements={updateButton:h,removeButton:g,enableButton:v,errorRow:d,errorList:l,setCount:u,container:t,shade:m,versionSpan:a,sets:{}},p.on("click",function(e){e.preventDefault(),t.hasClass("expanded")?(t.removeClass("expanded"),b.slideUp()):(t.addClass("expanded"),b.slideDown())});var y=Object.keys(s.sets);y.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),y.forEach(function(o){var n=s.sets[o],i=$("<div>",{class:"red-ui-palette-module-set"}).appendTo(b),e=$("<div>",{class:"red-ui-palette-module-set-button-group"}).appendTo(i),a={};n.types.forEach(function(e){var t=$("<div>",{class:"red-ui-palette-module-type"}).appendTo(i);a[e]=$("<span>",{class:"red-ui-palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"red-ui-palette-module-type-node"}).text(e).appendTo(t)});var t=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').appendTo(e);t.on("click",function(e){if(e.preventDefault(),0===r.setUseCount[o]){var t=RED.nodes.registry.getNodeSet(n.id);m.show();var i=!t.enabled;E(n.id,i,m,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(i?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))})}}),r.elements.sets[n.name]={setRow:i,enableButton:t,swatches:a}}),v.on("click",function(e){e.preventDefault(),0===r.totalUseCount&&E(s.name,t.hasClass("disabled"),m,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))})}),x(s.name)}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(t)}});var o=$("<div>",{class:"red-ui-palette-editor-tab hide"}).appendTo(t);p.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:o});var n=$("<div>",{class:"red-ui-palette-editor-toolbar"}).appendTo(o),a=$("<div>",{class:"red-ui-palette-search"}).appendTo(o);f=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(a).searchBox({delay:300,change:function(){var t=$(this).val().trim().toLowerCase();0<t.length?(v=g.filter(function(e){return-1<e.index.indexOf(t)}).map(function(e){return{info:e}}),C(),f.searchBox("count",v.length+" / "+g.length)):(f.searchBox("count",g.length),h.editableList("empty"),h.editableList("addItem",{count:g.length}))}}),$("<span>").text(RED._("palette.editor.sort")+" ").appendTo(n);var r=$('<span class="button-group"></span>').appendTo(n),s=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle selected"><i class="fa fa-sort-amount-desc"></i></a>').appendTo(r),d=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortAZ"></a>').appendTo(r),l=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(r);[{button:s,func:L},{button:d,func:S},{button:l,func:O}].forEach(function(t){t.button.on("click",function(e){e.preventDefault(),$(this).hasClass("selected")||($(".red-ui-palette-editor-install-sort-option").removeClass("selected"),$(this).addClass("selected"),_=t.func,C())})});var c=$("<span>").appendTo(n);$('<a href="#" class="red-ui-sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(c).on("click",function(e){e.preventDefault(),g=[],w={},j()}),h=$("<ol>",{style:"position: absolute;top: 79px;bottom: 0;left: 0;right: 0px;"}).appendTo(o).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,i){if(i.count)$("<div>",{class:"red-ui-search-empty"}).text(RED._("palette.editor.moduleCount",{count:i.count})).appendTo(t);else if(i.more){t.addClass("red-ui-palette-module-more");var o=$("<div>",{class:"red-ui-palette-module-header palette-module"}).appendTo(t);$('<a href="#"></a>').text(RED._("palette.editor.more",{count:i.more})).appendTo(o).on("click",function(e){e.preventDefault(),h.editableList("removeItem",i);for(var t=i.start;t<Math.min(i.start+10,i.start+i.more);t++)h.editableList("addItem",v[t]);10<i.more&&h.editableList("addItem",{start:i.start+10,more:i.more-10})})}else if(i.info){var n=i.info,a=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(t),r=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(a);$("<span>").text(n.name||n.id).appendTo(r),$('<a target="_blank" class="red-ui-palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",n.url).appendTo(r);var s=$('<div class="red-ui-palette-module-meta"></div>').appendTo(a);$("<div>",{class:"red-ui-palette-module-description"}).text(n.description).appendTo(s);var d=$('<div class="red-ui-palette-module-meta"></div>').appendTo(a);$('<span class="red-ui-palette-module-version"><i class="fa fa-tag"></i> '+n.version+"</span>").appendTo(d),$('<span class="red-ui-palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var i=Math.floor(t/7);if(i<4)return RED._("palette.editor.times.weeksV",{count:i});var o=Math.floor(i/4);if(i%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var n=Math.floor(o/12);return 0===(o%=12)?RED._("palette.editor.times.yearsV",{count:n}):RED._("palette.editor.times.year"+(1<n?"s":"")+"MonthsV",{y:n,count:o})}(n.updated_at)+"</span>").appendTo(d);var l=!1;if(n.types&&0<n.types.length)for(e=0;e<n.types.length;e++){var c=RED.nodes.registry.getNodeSetForType(n.types[e]);if(c){l=c.module;break}}var p=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(a),u=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(p),f=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.install")).appendTo(u);f.on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||I(n,t,function(e){})}),y.hasOwnProperty(n.id)?(f.addClass("disabled"),f.text(RED._("palette.editor.installed"))):l&&(f.addClass("disabled"),f.text(RED._("palette.editor.conflict")),RED.popover.create({target:f,content:RED._("palette.editor.conflictTip",{module:l}),trigger:"hover",direction:"bottom",delay:{show:750,hide:50}})),i.elements={installButton:f}}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(t)}}),$('<div id="red-ui-palette-module-install-shade" class="red-ui-palette-module-shade hide"><div class="red-ui-palette-module-shade-status"></div><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(o)}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:e,close:function(){T.detach()},focus:function(){p.resize(),setTimeout(function(){u.trigger("focus")},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){x(e.module)}),RED.events.on("registry:node-set-enabled",function(e){x(e.module)}),RED.events.on("registry:node-set-disabled",function(e){x(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||x(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||x(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){x(e.module);for(var t=0;t<v.length;t++)if(v[t].info.id===e.module){var i=v[t].elements.installButton;i.addClass("disabled"),i.text(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=y[e.module];if(t){b.editableList("removeItem",t),delete y[e.module];for(var i=0;i<v.length;i++)if(v[i].info.id===e.module){var o=v[i].elements.installButton;o.removeClass("disabled"),o.text(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(m[e.type]=(m[e.type]||0)+1,1===m[e.type]&&x(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){m.hasOwnProperty(e.type)&&(m[e.type]--,0===m[e.type]&&(delete m[e.type],x(RED.nodes.registry.getNodeSetForType(e.type).module)))}))},install:I}}(),RED.editor=function(){var a=[],s={},i={};function O(e){var t,i,o,n,a=e.valid,r=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))i=(t=RED.nodes.subflow(e.type.substring(8))).valid,n=t.changed,void 0===i&&(i=O(t),n=t.changed),o=p(e,e._def.defaults,e),e.valid=i&&0===o.length,e.changed=e.changed||n,e.validationErrors=o;else if(e._def)o=p(e,e._def.defaults,e),e._def._creds&&(o=o.concat(p(e,e._def.credentials,e._def._creds))),e.valid=0===o.length,e.validationErrors=o;else if("subflow"==e.type){for(var s=RED.nodes.filterNodes({z:e.id}),d=0;d<s.length;d++)i=s[d].valid,n=s[d].changed,void 0===i&&(i=O(s[d]),n=s[d].changed),e.valid=e.valid&&i,e.changed=e.changed||n;var l=RED.nodes.filterNodes({type:"subflow:"+e.id}),c={};for(d=0;d<l.length;d++)l[d].valid=e.valid,l[d].changed=l[d].changed||e.changed,l[d].dirty=!0,c[l[d].z]=!0;Object.keys(c).forEach(function(e){var t=RED.nodes.subflow(e);t&&O(t)})}return a===e.valid&&r===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&O(t)),e.valid}function p(e,t,i){var o=[];for(var n in t)t.hasOwnProperty(n)&&(r(e,t,n,i[n])||o.push(n));return o}function r(t,e,i,o){var n=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if(/^\$\{[a-zA-Z_][a-zA-Z0-9_]*\}$/.test(o))return!0;if("required"in e[i]&&e[i].required&&(n=""!==o),n&&"validate"in e[i])try{n=e[i].validate.call(t,o)}catch(e){console.log("Validation error:",t.type,t.id,"property: "+i,"value:",o,e)}if(n&&e[i].type&&RED.nodes.getType(e[i].type)&&!("validate"in e[i]))if(o&&"_ADD_"!=o){var a=RED.nodes.node(o);n=null!==a&&(null==a.valid||a.valid)}else n=e[i].hasOwnProperty("required")&&!e[i].required;return n}function d(e,t){for(var i in e._def.defaults)e._def.defaults.hasOwnProperty(i)&&o(e,e._def.defaults,i,t);if(e._def.credentials)for(i in e._def.credentials)e._def.credentials.hasOwnProperty(i)&&o(e,e._def.credentials,i,t)}function o(e,t,i,o){var n=$("#"+o+"-"+i);if(0<n.length){var a=n.val();t[i].hasOwnProperty("format")&&""!==t[i].format&&"DIV"===n[0].nodeName&&(a=n.text()),r(e,t,i,a)?n.removeClass("input-error"):n.addClass("input-error")}}function I(t,i){t.resize=!0,t.dirty=!0,t.dirtyStatus=!0;var o=[];if(t.ports)if(i&&RED.nodes.eachLink(function(e){e.source===t&&i.hasOwnProperty(e.sourcePort)&&("-1"===i[e.sourcePort]?o.push(e):e.sourcePort=i[e.sourcePort])}),t.outputs<t.ports.length){for(;t.outputs<t.ports.length;)t.ports.pop();RED.nodes.eachLink(function(e){e.source===t&&e.sourcePort>=t.outputs&&-1===o.indexOf(e)&&o.push(e)})}else if(t.outputs>t.ports.length)for(;t.outputs>t.ports.length;)t.ports.push(t.ports.length);t.inputs=Math.min(1,Math.max(0,parseInt(t.inputs))),isNaN(t.inputs)&&(t.inputs=0),0===t.inputs&&(o=o.concat(RED.nodes.filterLinks({target:t})));for(var e=0;e<o.length;e++)RED.nodes.removeLink(o[e]);return o}function l(e,t,i,o){var n=$("#"+o+"-"+t);if(0!==n.length){var a,r=n.width(),s=n.attr("style");r=null!==(a=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(s))?a[1]:"70%";var d=$("<div></div>").css({display:"inline-block",position:"relative"}),l=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(d),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(l);d.width(r).height(n.height()),0===d.width()&&d.width("70%"),n.replaceWith(d),c.attr("style","width:100%"),_(t,i,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="red-ui-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(d),$("#"+o+"-lookup-"+t).on("click",function(e){g(t,i,c.find(":selected").val(),o),e.preventDefault()});var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(i);u&&(p=RED.utils.getNodeLabel(u,u.id)),n.val(p)}}function c(e,t,i,o){var n=$("#"+o+"-"+t);n.val(e[t]),n.attr("type","hidden");var a=$("<a>",{id:o+"-edit-"+t,class:"red-ui-button"});n.after(a),e[t]?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),a.on("click",function(e){g(t,i,n.val()||"_ADD_",o),e.preventDefault()})}function u(e,t,i,o){var n=$("#"+i+"-"+t);if(0!==n.length)if("checkbox"===n.attr("type"))n.prop("checked",e[t]);else{var a=e[t];null==a&&(a=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===n[0].nodeName?(n.html(RED.text.format.getHtml(a,o[t].format,{},!1,"en")),RED.text.format.attach(n[0],o[t].format,{},!1,"en")):(n.val(a),"INPUT"!==n[0].nodeName&&"TEXTAREA"!==n[0].nodeName||RED.text.bidi.prepareInput(n))}}function f(i,e,t,o){var n=$("#"+o+"-"+t);void 0!==e&&"format"in e[t]&&""!==e[t].format&&"DIV"===n[0].nodeName?$("#"+o+"-"+t).on("change keyup",function(e,t){t||d(i,o)}):$("#"+o+"-"+t).on("change",function(e,t){t||d(i,o)})}function h(e,t,i,o){var n;for(n in t)t.hasOwnProperty(n)&&("password"==t[n].type?i[n]?$("#"+o+"-"+n).val(i[n]):i["has_"+n]?$("#"+o+"-"+n).val("__PWRD__"):$("#"+o+"-"+n).val(""):u(i,n,o,t),f(e,t,n,o))}function P(e,t,i){var o=!1;for(var n in e.credentials||(e.credentials={_:{}}),t)if(t.hasOwnProperty(n)){var a=$("#"+i+"-"+n).val();if("password"==t[n].type){if(e.credentials["has_"+n]=""!==a,"__PWRD__"==a)continue;o=!0}(e.credentials[n]=a)!=e.credentials._[n]&&(o=!0)}return o}function D(t,i,o,n){for(var e in i.defaults)if(i.defaults.hasOwnProperty(e)){if(i.defaults[e].type){var a=RED.nodes.getType(i.defaults[e].type);a?a.exclusive?c(t,e,i.defaults[e].type,o):l(t,e,i.defaults[e].type,o):(console.log("Unknown type:",i.defaults[e].type),u(t,e,o,i.defaults))}else u(t,e,o,i.defaults);f(t,i.defaults,e,o)}function r(){if(i.oneditprepare)try{i.oneditprepare.call(t)}catch(e){console.log("oneditprepare",t.id,t.type,e.toString())}for(var e in i.defaults)i.defaults.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);if(i.credentials)for(e in i.credentials)i.credentials.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);d(t,o),n&&n()}i.credentials?t.credentials?(h(t,i.credentials,t.credentials,o),r()):$.getJSON(function(e,t){return"credentials/"+e.replace(/\s+/g,"-")+"/"+t}(t.type,t.id),function(e){t.credentials=e,t.credentials._=$.extend(!0,{},e),h(t,i.credentials,t.credentials,o),r()}):r()}function E(){for(var e,t=a.length-1;t<a.length;t++){var i=a[t];if(e=i.type,"_expression"===i.type)e=RED._("expressionEditor.title");else if("_js"===i.type)e=RED._("jsEditor.title");else if("_text"===i.type)e=RED._("textEditor.title");else if("_json"===i.type)e=RED._("jsonEditor.title");else if("_markdown"===i.type)e=RED._("markdownEditor.title");else if("_buffer"===i.type)e=RED._("bufferEditor.title");else if("subflow"===i.type)e=RED._("subflow.editSubflow",{name:RED.utils.sanitize(i.name)});else if(0===i.type.indexOf("subflow:")){var o=RED.nodes.subflow(i.type.substring(8));e=RED._("subflow.editSubflowInstance",{name:RED.utils.sanitize(o.name)})}else if(void 0!==i._def){if(void 0!==i._def.paletteLabel)try{e=RED.utils.sanitize(("function"==typeof i._def.paletteLabel?i._def.paletteLabel.call(i._def):i._def.paletteLabel)||"")}catch(e){console.log("Definition error: "+i.type+".paletteLabel",e)}t===a.length-1&&(e=RED.nodes.node(i.id)?RED._("editor.editNode",{type:RED.utils.sanitize(e)}):RED._("editor.addNewConfig",{type:RED.utils.sanitize(e)}))}}return e}function N(e,t){return JSON.stringify(e)===JSON.stringify(t)}function R(e,t,i,a,o){var n=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return n.html($("script[data-template-name='"+i+"']").html()),a=a||"node-red",n.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var i=e[t];if(-1===i.indexOf(":")){var o="";if(0===i.indexOf("[")){var n=i.split("]");o=n[0]+"]",i=n[1]}e[t]=o+a+":"+i}}$(this).attr("data-i18n",e.join(";"))}),"subflow-template"!==i&&"subflow"!==i||RED.subflow.buildEditForm(n,i,o),$('<input type="password" style="display: none;" />').prependTo(n),$('<input type="text" style="display: none;" />').prependTo(n),n.on("submit",function(e){e.preventDefault()}),n.find("input").attr("autocomplete","disable"),n}function v(e,t){var i,o=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),n=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),a=$("#red-ui-editor-node-label-form-inputs"),r=$("#red-ui-editor-node-label-form-outputs"),s=$("#node-input-inputs").val();void 0===s?i="subflow"===t.type?t.in.length:t.inputs||t._def.inputs||0:(i=Math.min(1,Math.max(0,parseInt(s))),isNaN(i)&&(i=0));var d,l,c=a.children(),p=c.length;if(1===p&&$(c[0]).hasClass("red-ui-editor-node-label-form-none")&&p--,p<i)for(0===p&&$(c[0]).remove(),l=p;l<i;l++)k("input",l,"",o).appendTo(a);else if(i<p){for(l=i;l<p;l++)$(c[l]).remove();0===i&&k().appendTo(a)}var u=$("#node-input-outputs").val();if(void 0===u)"subflow"===t.type?d=t.out.length:i=t.outputs||t._def.outputs||0;else if(isNaN(u)){var f=JSON.parse(u),h=Object.keys(f);c=r.children(),1===(p=c.length)&&$(c[0]).hasClass("red-ui-editor-node-label-form-none")&&p--,d=0;var g=[];h.forEach(function(e){var t=$("#red-ui-editor-node-label-form-output-"+e).parent();0===t.length&&-1!==f[e]?(0===p&&($(c[0]).remove(),p=-1),t=k("output",e,"",n)):t.detach(),-1!==f[e]&&(d++,g.push({i:parseInt(f[e]),r:t}))}),g.sort(function(e,t){return e.i-t.i}),g.forEach(function(e,t){e.r.find("label").text(t+1+"."),e.r.appendTo(r)}),0===g.length&&k("output",l,"").appendTo(r)}else d=Math.max(0,parseInt(u));if(c=r.children(),1===(p=c.length)&&$(c[0]).hasClass("red-ui-editor-node-label-form-none")&&p--,p<d)for(0===p&&$(c[0]).remove(),l=p;l<d;l++)k("output",l,"").appendTo(r);else if(d<p){for(l=d;l<p;l++)$(c[l]).remove();0===d&&k().appendTo(r)}}function k(e,t,i,o){var n=$("<div>",{class:"red-ui-editor-node-label-form-row"});if(void 0===e)$("<span>").text(RED._("editor.noDefaultLabel")).appendTo(n),n.addClass("red-ui-editor-node-label-form-none");else{n.addClass("");var a="red-ui-editor-node-label-form-"+e+"-"+t;$("<label>",{for:a}).text(t+1+".").appendTo(n);var r=$("<input>",{type:"text",id:a,placeholder:o}).val(i).appendTo(n);$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-times"></i></button>').appendTo(n).on("click",function(e){e.preventDefault(),r.val("")})}return n}function T(e,r,s,o,d){var t=$('<div class="red-ui-icon-picker">'),i=$("<div>",{class:"red-ui-search-container"}).appendTo(t);searchInput=$('<input type="text">').attr("placeholder",RED._("editor.searchIcons")).appendTo(i).searchBox({delay:50,change:function(){var i=$(this).val().trim();""===i?(l.find(".red-ui-icon-list-module").show(),l.find(".red-ui-icon-list-icon").show()):(l.find(".red-ui-icon-list-module").hide(),l.find(".red-ui-icon-list-icon").each(function(e,t){-1===$(t).data("icon").indexOf(i)?$(t).hide():$(t).show()}))}});$("<div>").appendTo(t);var l=$('<div class="red-ui-icon-list">').appendTo(t),n=$('<div class="red-ui-icon-meta"></div>').appendTo(t),c=$("<span>").appendTo(n);$('<button type="button" class="red-ui-button red-ui-button-small">'+RED._("editor.useDefault")+"</button>").appendTo(n).on("click",function(e){e.preventDefault(),p.hide(),d(null)});!r&&o&&l.addClass("red-ui-icon-list-dark"),setTimeout(function(){var i=RED.nodes.getIconSets();Object.keys(i).forEach(function(a){if(!o||"font-awesome"===a){var e=i[a];if(0<e.length){var t=$('<div class="red-ui-icon-list-module"></div>').text(a).appendTo(l);$('<i class="fa fa-cube"></i>').prependTo(t),e.forEach(function(e){var t=$("<div>",{class:"red-ui-icon-list-icon"}).appendTo(l),i=$("<div>",{class:"red-ui-search-result-node"}).appendTo(t),o=RED.settings.apiRootUrl+"icons/"+a+"/"+e;t.data("icon",o),r&&i.css({backgroundColor:r});var n=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(i);RED.utils.createIconElement(o,n,!0),s.module===a&&s.file===e&&t.addClass("selected"),t.on("mouseover",function(){c.text(e)}),t.on("mouseout",function(){c.html("&nbsp;")}),t.on("click",function(){p.hide(),d(a+"/"+e)})})}}}),setTimeout(function(){a.remove()},50)},300);var a=RED.utils.addSpinnerOverlay(l,!0),p=RED.popover.panel(t);p.show({target:e}),t.slideDown(100),searchInput.trigger("focus")}function b(e,n){var t,i=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e);if("subflow"===n.type){var o=$("<div/>",{class:"form-row"}).appendTo(i);$("<label/>",{for:"subflow-appearance-input-category","data-i18n":"editor:subflow.category"}).appendTo(o);var a=$("<select/>",{id:"subflow-appearance-input-category"}).css({width:"250px"}).appendTo(o);$("<input/>",{type:"text",id:"subflow-appearance-input-custom-category"}).css({display:"none","margin-left":"10px",width:"calc(100% - 250px)"}).appendTo(o);var r=RED.palette.getCategories();r.sort(function(e,t){return e.label.localeCompare(t.label)}),r.forEach(function(e){a.append($("<option/>").val(e.id).text(e.label))}),a.append($("<option/>").attr("disabled",!0).text("---")),a.append($("<option/>").val("_custom_").text(RED._("palette.addCategory"))),$("#subflow-appearance-input-category").on("change",function(){"_custom_"===$(this).val()?($("#subflow-appearance-input-category").width(120),$("#subflow-appearance-input-custom-category").show()):($("#subflow-appearance-input-category").width(250),$("#subflow-appearance-input-custom-category").hide())}),$("#subflow-appearance-input-category").val(n.category||"subflows");var s=0,d="subflow:"+n.id;RED.nodes.eachNode(function(e){e.type===d&&s++}),$("#red-ui-editor-subflow-user-count").text(RED._("subflow.subflowInstances",{count:s})).show()}if($('<div class="form-row"><label for="node-input-show-label-btn" data-i18n="editor.label"></label><span style="margin-right: 2px;"/><input type="checkbox" id="node-input-show-label"/></div>').appendTo(i),$("#node-input-show-label").toggleButton({enabledLabel:RED._("editor.show"),disabledLabel:RED._("editor.hide")}),n.hasOwnProperty("l")||(n.l=!/^link (in|out)$/.test(n._def.type)),$("#node-input-show-label").prop("checked",n.l).trigger("change"),"subflow"===n.type){var l=n.color?n.color:"#DDAA99",c=$("<div/>",{class:"form-row"}).appendTo(i);$("<label/>").text(RED._("editor.color")).appendTo(c),function(e,t){var s=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(e);$('<i class="fa fa-caret-down"></i>').appendTo(s),$("<div>",{class:"red-ui-search-result-node"}).appendTo(s);var d=$("<input/>",{id:"red-ui-editor-node-color",type:"text",value:t}).css({marginLeft:"10px",width:"150px"}).appendTo(e);d.on("change",function(e){var t=d.val();$(".red-ui-editor-node-appearance-button .red-ui-search-result-node").css({"background-color":t})}),d.trigger("change"),s.on("click",function(e){var t=["#DDAA99","#3FADB5","#87A980","#A6BBCF","#AAAA66","#C0C0C0","#C0DEED","#C7E9C0","#D7D7A0","#D8BFD8","#DAC4B4","#DEB887","#DEBD5C","#E2D96E","#E6E0F8","#E7E7AE","#E9967A","#F3B567","#FDD0A2","#FDF0C2","#FFAAAA","#FFCC66","#FFF0F0","#FFFFFF"].map(function(e){var t=parseInt(e.substring(1,3),16)/255,i=parseInt(e.substring(3,5),16)/255,o=parseInt(e.substring(5,7),16)/255;return{hex:e,r:t,g:i,b:o,l:.3*t+.59*i+.11*o}});t.sort(function(e,t){return e.l-t.l});var i=t.length,o=$("<div/>",{class:"red-ui-color-picker"}).css({width:"204px",height:34*Math.ceil(i/6)+"+px"}),n=0,a=null;t.forEach(function(t){n%6==0&&(a=$("<div/>").appendTo(o)),$("<button/>",{}).css({width:"30px",height:"30px",margin:"2px",backgroundColor:t.hex,"border-style":"solid","border-width":"1px","border-color":t.luma<.92?t.hex:"#ccc"}).appendTo(a).on("click",function(e){e.preventDefault(),r.hide(),d.val(t.hex),d.trigger("change")}),n++});var r=RED.popover.panel(o);r.show({target:s})})}(c,l)}if(!n._def.defaults||!n._def.defaults.hasOwnProperty("icon")){var p=$('<div class="form-row"></div>').appendTo(i);$('<label data-i18n="editor.settingIcon">').appendTo(p);var u=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(p);$('<i class="fa fa-caret-down"></i>').appendTo(u);var f=$("<div>",{class:"red-ui-search-result-node"}).appendTo(u),h=RED.utils.getNodeColor(n.type,n._def),g=RED.utils.getNodeIcon(n._def,n);f.css("backgroundColor",h);var v=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(f);RED.utils.createIconElement(g,v,!0),u.on("click",function(e){var t;e.preventDefault();var i=$("#red-ui-editor-node-icon").val()||"";t=i?RED.utils.separateIconPath(i):RED.utils.getDefaultNodeIcon(n._def,n);var o=RED.utils.getNodeColor(n.type,n._def);"subflow"===n.type&&(o=$("#red-ui-editor-node-color").val()),T(u,o,t,!1,function(e){$("#red-ui-editor-node-icon").val(e||"");var t=RED.utils.getNodeIcon(n._def,{type:n.type,icon:e});RED.utils.createIconElement(t,v,!0)})}),RED.popover.tooltip(u,function(){return $("#red-ui-editor-node-icon").val()||RED._("editor.default")}),$('<input type="hidden" id="red-ui-editor-node-icon">').val(n.icon).appendTo(p)}$('<div class="form-row"><span data-i18n="editor.portLabels"></span></div>').appendTo(i);var b=n.inputs||n._def.inputs||0,m=n.outputs||n._def.outputs||0;"subflow"===n.type&&(b=n.in.length,m=n.out.length);var y=n.inputLabels||[],w=n.outputLabels||[],D=n._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),E=n._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelInputs"></span><div id="red-ui-editor-node-label-form-inputs"></div></div>').appendTo(i);var R=$("#red-ui-editor-node-label-form-inputs");if(0<b)for(t=0;t<b;t++)k("input",t,y[t],D).appendTo(R);else k().appendTo(R);$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelOutputs"></span><div id="red-ui-editor-node-label-form-outputs"></div></div>').appendTo(i);var x=$("#red-ui-editor-node-label-form-outputs");if(0<m)for(t=0;t<m;t++)k("output",t,w[t],E).appendTo(x);else k().appendTo(x)}function A(e,t,i){var o=$("#red-ui-editor-node-label-form-inputs").children().find("input"),n=$("#red-ui-editor-node-label-form-outputs").children().find("input"),a=!1,r=!1,s=o.map(function(){var e=$(this).val();return a=a||""!==e,e}).toArray().slice(0,e.inputs);return(void 0===e.inputLabels&&a||void 0!==e.inputLabels&&JSON.stringify(s)!==JSON.stringify(e.inputLabels))&&(t.inputLabels=e.inputLabels,e.inputLabels=s,r=!0),a=!1,s=new Array(e.outputs),n.each(function(){var e=$(this).attr("id").substring("red-ui-editor-node-label-form-output-".length);if(!i||!i.hasOwnProperty(e)||-1!==(e=parseInt(i[e]))){var t=$(this).val();a=a||""!==t,s[e]=t}}),(void 0===e.outputLabels&&a||void 0!==e.outputLabels&&JSON.stringify(s)!==JSON.stringify(e.outputLabels))&&(t.outputLabels=e.outputLabels,e.outputLabels=s,r=!0),r}function x(e,t){var i=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),o=($("<div></div>").appendTo(i),$('<div class="form-row node-text-editor-row" style="position:relative; padding-top: 4px; height: 100%"></div>').appendTo(i));$('<div style="height: 100%" class="node-text-editor" id="node-info-input-info-editor" ></div>').appendTo(o);var n=RED.editor.createEditor({id:"node-info-input-info-editor",mode:"ace/mode/markdown",value:""});return t.info&&n.getSession().setValue(t.info,-1),n}function g(g,v,e,b){var m,c,y="_ADD_"==e,p=RED.nodes.getType(v),w=RED.nodes.node(e),u=!1;c="node-red"===p.set.module?"node-red":p.set.id;var t="",i=RED.nodes.subflow(RED.workspaces.active());if(i&&(t=i.id),null==w){for(var o in w={id:RED.nodes.id(),_def:p,type:v,z:t,users:[]},p.defaults)p.defaults[o].value&&(w[o]=JSON.parse(JSON.stringify(p.defaults[o].value)));w._=p._}a.push(w),RED.view.state(RED.state.EDITING);var n={title:E(),resize:function(e){if($(".red-ui-tray-content").height(e.height-50),w&&w._def.oneditresize){var t=$("#node-config-dialog-edit-form");try{w._def.oneditresize.call(w,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",w.id,w.type,e.toString())}}},open:function(e,n){e.find(".red-ui-tray-header");var a=e.find(".red-ui-tray-body"),r=e.find(".red-ui-tray-footer"),t=$('<div class="red-ui-tray-footer-left"></div>').appendTo(r);$('<input id="node-config-input-node-disabled" type="checkbox">').prop("checked",!!w.d).appendTo(t).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0}),!1!==p.hasUsers&&$('<span><i class="fa fa-info-circle"></i> <span id="red-ui-editor-config-user-count"></span></span>').css("margin-left","10px").appendTo(t),r.append('<span class="red-ui-tray-footer-right"><span id="red-ui-editor-config-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="red-ui-editor-config-scope"></select></span>');var i=$("<ul></ul>").appendTo(a),o=$("<div></div>").appendTo(a),s=RED.tabs.create({element:i,onchange:function(e){o.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),u&&RED.tray.resize()},collapsible:!0,menu:!1}),d={id:"editor-tab-cproperties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(o).hide(),iconClass:"fa fa-cog"};if(s.addTab(d),R(d.content,"node-config-dialog-edit-form",v,c),!p.defaults||!p.defaults.hasOwnProperty("info")){var l={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(o).hide(),iconClass:"fa fa-file-text-o",onchange:function(){m.focus()}};s.addTab(l),m=x(l.content,w)}D(w,p,"node-config-input",function(){w._def.exclusive?$("#red-ui-editor-config-scope").hide():$("#red-ui-editor-config-scope").show(),$("#red-ui-editor-config-scope-warning").hide();var i={};w.users.forEach(function(e){i[e.z]=!0});var t=Object.keys(i).length,o=$("#red-ui-editor-config-scope").empty();o.off("change"),o.append('<option value=""'+(w.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),o.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(e){var t=e.label;i[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==w.z?" selected":"")+"></option>").text(t).appendTo(o)}),o.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(e){var t=e.name;i[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==w.z?" selected":"")+"></option>").text(t).appendTo(o)}),0<t&&o.on("change",function(){var e=$(this).val();""===e?$("#red-ui-editor-config-scope-warning").hide():!i[e]||1<t?$("#red-ui-editor-config-scope-warning").show():$("#red-ui-editor-config-scope-warning").hide()}),!1!==p.hasUsers&&$("#red-ui-editor-config-user-count").text(RED._("editor.nodesUse",{count:w.users.length})).parent().show(),a.i18n(),r.i18n(),u=!0,n()})},close:function(){RED.workspaces.refresh(),m&&(m.destroy(),m=null),a.pop()},show:function(){w&&RED.sidebar.info.refresh(w)}};n.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var t=v,i=w.id,e=RED.nodes.getType(t);if(e.oneditcancel&&e.oneditcancel){var o=RED.nodes.node(i);if(o)try{e.oneditcancel.call(o,!1)}catch(e){console.log("oneditcancel",o.id,o.type,e.toString())}else try{e.oneditcancel.call({id:i},!0)}catch(e){console.log("oneditcancel",i,t,e.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:y?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,t,i=g,o=(w.id,v),n=y,a=RED.nodes.getType(o),r=$("#red-ui-editor-config-scope").val();if(a.oneditsave)try{a.oneditsave.call(w)}catch(e){console.log("oneditsave",w.id,w.type,e.toString())}for(e in a.defaults){var s;if(a.defaults.hasOwnProperty(e))if(null!=(s="checkbox"===(t=$("#node-config-input-"+e)).attr("type")?t.prop("checked"):"format"in a.defaults[e]&&""!==a.defaults[e].format&&"DIV"===t[0].nodeName?t.text():t.val())&&s!==w[e]){if(w._def.defaults[e].type){"_ADD_"==s&&(s="");var d=RED.nodes.node(w[e]);if(d){var l=d.users;l.splice(l.indexOf(w),1)}(d=RED.nodes.node(s))&&d.users.push(w)}w[e]=s}}if(m){w.info=m.getValue();var c=w.info;if(m){var p=m.getValue();c?""===p.trim()?delete w.info:p!==c&&(w.info=p):""!==p.trim()&&(w.info=p)}}w.label=a.label,w.z=r,$("#node-config-input-node-disabled").prop("checked")?!0!==w.d&&(w.d=!0):!0===w.d&&delete w.d,r&&(w.users=w.users.filter(function(e){var t=!0;for(var i in e._def.defaults)e._def.defaults.hasOwnProperty(i)&&e._def.defaults[i].type===w.type&&e[i]===w.id&&e.z!==r&&(t=!1,e[i]=null,e.dirty=!0,e.changed=!0,O(e));return t})),n&&RED.nodes.add(w),a.credentials&&P(w,a.credentials,"node-config-input"),O(w);var u={};u[w.id]=!0;for(var f=w.users.slice();0<f.length;){var h=f.pop();u[h.id]||(u[h.id]=!0,h.users&&(f=f.concat(h.users)),O(h))}RED.nodes.dirty(!0),RED.view.redraw(!0),n||RED.events.emit("editor:save",w),RED.tray.close(function(){_(i,o,w.id,b)})}}],y||n.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=g,t=w.id,i=v,o=RED.nodes.getType(i);try{o.ondelete&&(console.log("Deprecated API warning: config node type ",i," has an ondelete function - should be oneditdelete"),o.ondelete.call(w)),o.oneditdelete&&o.oneditdelete.call(w)}catch(e){console.log("oneditdelete",w.id,w.type,e.toString())}for(var n={t:"delete",nodes:[w],changes:{},dirty:RED.nodes.dirty()},a=0;a<w.users.length;a++){var r=w.users[a];for(var s in n.changes[r.id]={changed:r.changed,valid:r.valid},r._def.defaults)r._def.defaults.hasOwnProperty(s)&&r[s]==t&&(n.changes[r.id][s]=t,r[s]="",r.changed=!0,r.dirty=!0);O(r)}RED.nodes.remove(t),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(n),RED.tray.close(function(){_(e,i,"",b)})}}),RED.tray.show(n)}function m(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function _(e,i,t,o){if(o){var n=$("#"+o+"-edit-"+e);if(n.length)t?n.text(RED._("editor.configEdit")):n.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(t);else{var a=$("#"+o+"-"+e),r=RED.nodes.getType(i);a.children().remove();var s=RED.nodes.workspace(RED.workspaces.active());s=s||RED.nodes.subflow(RED.workspaces.active());var d=[];RED.nodes.eachConfig(function(e){if(e.type==i&&(!e.z||e.z===s.id)){var t=RED.utils.getNodeLabel(e,e.id);e.__label__=t+(e.d?" ["+RED._("workspace.disabled")+"]":""),d.push(e)}});var l=m;"function"==typeof r.sort&&(l=r.sort);try{d.sort(l)}catch(e){console.log("Definition error: "+r.type+".sort",e)}d.forEach(function(e){$('<option value="'+e.id+'"'+(t==e.id?" selected":"")+"></option>").text(RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)).appendTo(a),delete e.__label__}),a.append('<option value="_ADD_"'+(""===t?" selected":"")+">"+RED._("editor.addNewType",{type:i})+"</option>"),window.setTimeout(function(){a.trigger("change")},50)}}}function t(e,t){s.hasOwnProperty(e)?(0<a.length&&(t.parent=a[a.length-1].id),a.push({type:e}),t.title=t.title||E(),t.onclose=function(){a.pop()},s[e].show(t)):console.log("Unknown type editor:",e)}return{init:function(){ace.config.set("basePath","vendor/ace"),RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$(document.activeElement).blur(),$("#node-dialog-ok").trigger("click"),$("#node-config-dialog-ok").trigger("click")}),RED.actions.add("core:cancel-edit-tray",function(){$(document.activeElement).blur(),$("#node-dialog-cancel").trigger("click"),$("#node-config-dialog-cancel").trigger("click")})},edit:function(T){var _,j,C,L=T,h=!1;a.push(T),RED.view.state(RED.state.EDITING);var S=T.type;"subflow:"==T.type.substring(0,8)&&(S="subflow");var e={title:E(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],i=[],o=RED.nodes.remove(L.id);t.push(L);var n={t:"delete",nodes:t=t.concat(o.nodes),links:i=i.concat(o.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(n),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(L._def){if(L._def.oneditcancel)try{L._def.oneditcancel.call(L)}catch(e){console.log("oneditcancel",L.id,L.type,e.toString())}for(var e in L._def.defaults)if(L._def.defaults.hasOwnProperty(e)){var t=L._def.defaults[e];if(t.type){var i=RED.nodes.getType(t.type);if(i&&i.exclusive){var o=$("#node-input-"+e).val()||"";""===o||L[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t,i,o={},n=!1,a=RED.nodes.dirty();if(L._def.oneditsave){var r={};for(e in L._def.defaults)L._def.defaults.hasOwnProperty(e)&&("string"==typeof L[e]||"number"==typeof L[e]?r[e]=L[e]:r[e]=$.extend(!0,{},{v:L[e]}).v);try{!0===L._def.oneditsave.call(L)&&(n=!0)}catch(e){console.log("oneditsave",L.id,L.type,e.toString())}for(e in L._def.defaults)L._def.defaults.hasOwnProperty(e)&&(null===r[e]||"string"==typeof r[e]||"number"==typeof r[e]?r[e]!==L[e]&&(o[e]=r[e],n=!0):JSON.stringify(r[e])!==JSON.stringify(L[e])&&(o[e]=r[e],n=!0))}if(L._def.defaults)for(e in L._def.defaults)if(L._def.defaults.hasOwnProperty(e)){var s=$("#node-input-"+e);if("checkbox"===s.attr("type")?i=s.prop("checked"):"select"===s.prop("nodeName")&&"multiple"===s.attr("multiple")?null==(i=s.val())&&(i=[]):i="format"in L._def.defaults[e]&&""!==L._def.defaults[e].format&&"DIV"===s[0].nodeName?s.text():s.val(),null!=i){if("outputs"===e){if(""===i.trim())continue;if(isNaN(i)){t=JSON.parse(i);var d=0,l=!1;Object.keys(t).forEach(function(e){isNaN(e)?(d++,delete t[e]):(t[e]=t[e]+"","-1"!==t[e]?(d++,t[e]!==e?l=!0:delete t[e]):l=!0)}),i=d,l&&(n=!0)}else i=parseInt(i)}if(L[e]!=i){if(L._def.defaults[e].type){"_ADD_"==i&&(i="");var c=RED.nodes.node(L[e]);if(c){var p=c.users;p.splice(p.indexOf(L),1)}(c=RED.nodes.node(i))&&c.users.push(L)}o[e]=L[e],L[e]=i,n=!0}}}if(L._def.credentials){var u=L._def.credentials,f=P(L,u,"node-input");n=n||f}var h=I(L,t);if(A(L,o,t)&&(n=!0),!L._def.defaults||!L._def.defaults.hasOwnProperty("icon")){var g=$("#red-ui-editor-node-icon").val()||"";if(_)if(""!==g&&g!==j)o.icon=L.icon,L.icon=g,n=!0;else{var v=RED.utils.getDefaultNodeIcon(L._def,L),b=v.module+"/"+v.file;j!==b&&(o.icon=L.icon,L.icon=b,n=!0)}else g!==L.icon&&(o.icon=L.icon,L.icon=g,n=!0)}$("#node-input-show-label").prop("checked")?/^link (in|out)$/.test(T.type)?(T.l||(o.l=T.l,n=!0),T.l=!0):(T.hasOwnProperty("l")&&!T.l&&(o.l=T.l,n=!0),delete T.l):/^link (in|out)$/.test(T.type)?(T.hasOwnProperty("l")&&T.l&&(o.l=T.l,n=!0),delete T.l):(!1!==T.l&&(o.l=T.l,n=!0),T.l=!1),$("#node-input-node-disabled").prop("checked")?!0!==T.d&&(o.d=T.d,n=!0,T.d=!0):!0===T.d&&(o.d=T.d,n=!0,delete T.d),T.resize=!0;var m=T.info;if(C){var y=C.getValue();m?""===y.trim()?(n=!0,o.info=m,delete T.info):y!==m&&(n=!0,o.info=m,T.info=y):""!==y.trim()&&(n=!0,o.info=void 0,T.info=y)}if("subflow"===S){var w=L.env,D=RED.subflow.exportSubflowInstanceEnv(L);N(w,D)||(L.env=D,o.env=L.env,n=!0)}if(n){var E=L.changed;L.changed=!0,RED.nodes.dirty(!0);var R=RED.nodes.subflow(RED.workspaces.active()),x=null;R&&(x=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(x.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,I(e))}));var k={t:"edit",node:L,changes:o,links:h,dirty:a,changed:E};t&&(k.outputMap=t),x&&(k.subflow={instances:x}),RED.history.push(k)}L.dirty=!0,O(L),RED.events.emit("editor:save",L),RED.tray.close()}}],resize:function(e){i[S]=e.width,$(".red-ui-tray-content").height(e.height-50);var t=$(".red-ui-tray-content form").height(e.height-50-40);if(L&&L._def.oneditresize)try{L._def.oneditresize.call(L,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",L.id,L.type,e.toString())}},open:function(e,t){var i=e.find(".red-ui-tray-footer"),o=e.find(".red-ui-tray-body");o.parent().css("overflow","hidden");var n=$('<div class="red-ui-tray-footer-left"></div>').appendTo(i);$('<input id="node-input-node-disabled" type="checkbox">').prop("checked",!!T.d).appendTo(n).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0});var a,r=$("<ul></ul>").appendTo(o),s=$("<div></div>").appendTo(o),d=RED.tabs.create({element:r,onchange:function(e){s.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),h&&RED.tray.resize()},collapsible:!0,menu:!1});L&&RED.sidebar.info.refresh(L),a="node-red"===T._def.set.module?"node-red":T._def.set.id;var l=RED.utils.getDefaultNodeIcon(T._def,T);j=l.module+"/"+l.file,_=!T.icon||T.icon===j;var c={id:"editor-tab-properties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(s).hide(),iconClass:"fa fa-cog"};if(R(c.content,"dialog-form",S,a,T),d.addTab(c),/^subflow:/.test(T.type)){var p={id:"editor-subflow-envProperties",label:RED._("editor-tab.envProperties"),name:RED._("editor-tab.envProperties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(s).hide(),iconClass:"fa fa-list"};RED.subflow.buildPropertiesForm(p.content,T),d.addTab(p)}if(!T._def.defaults||!T._def.defaults.hasOwnProperty("info")){var u={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(s).hide(),iconClass:"fa fa-file-text-o",onchange:function(){C.focus()}};d.addTab(u),C=x(u.content,T)}var f={id:"editor-tab-appearance",label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(s).hide(),iconClass:"fa fa-object-group",onchange:function(){v(this.content,T)}};b(f.content,T),d.addTab(f),D(T,T._def,"node-input",function(){o.i18n(),h=!0,t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),L&&RED.sidebar.info.refresh(L),RED.workspaces.refresh(),C&&(C.destroy(),C=null),RED.view.redraw(!0),a.pop()},show:function(){L&&RED.sidebar.info.refresh(L)}};if(i.hasOwnProperty(S)&&(e.width=i[S]),"subflow"===S){var t=L.type.substring(8);e.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(t),$("#node-dialog-ok").trigger("click")}})}RED.tray.show(e)},editConfig:g,editSubflow:function(p){var h,g=p;a.push(p),RED.view.state(RED.state.EDITING);var u=!1,e={title:E(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,i=RED.nodes.dirty(),o=$("#subflow-input-name").val();o!=g.name&&(e.name=g.name,g.name=o,t=!0);var n=h.getValue();n!=g.info&&(e.info=g.info,g.info=n,t=!0),A(g,e,null)&&(t=!0);var a=$("#red-ui-editor-node-icon").val()||"";(void 0===g.icon&&"node-red/subflow.svg"!==a||void 0!==g.icon&&g.icon!==a)&&(e.icon=g.icon,g.icon=a,t=!0);var r=$("#subflow-appearance-input-category").val().trim();"_custom_"===r&&""===(r=$("#subflow-appearance-input-custom-category").val().trim())&&(r=g.category),"subflows"===r&&(r=""),r!=g.category&&(e.category=g.category,g.category=r,t=!0);var s=g.color,d=$("#red-ui-editor-node-color").val();s!==d&&(g.color=d,e.color=d,t=!0,RED.utils.clearNodeColorCache(),"subflow"===g.type&&(RED.nodes.getType("subflow:"+g.id).color=d));var l=g.env,c=RED.subflow.exportSubflowTemplateEnv($("#node-input-env-container").editableList("items"));if(N(l,c)||(g.env=c,e.env=g.env,t=!0),RED.palette.refresh(),t){var p=g.changed;g.changed=!0,O(g);var u=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+g.id&&(u.push({id:e.id,changed:e.changed}),e._def.color=g.color,e.changed=!0,e.dirty=!0,I(e),O(e))}),RED.nodes.dirty(!0);var f={t:"edit",node:g,changes:e,dirty:i,changed:p,subflow:{instances:u}};RED.history.push(f)}g.dirty=!0,RED.tray.close()}}],resize:function(e){if($(".red-ui-tray-content").height(e.height-50),$("#node-input-env-container").length){for(var t=$("#dialog-form>div:not(#subflow-env-tabs-content)"),i=e.height,o=0;o<t.size();o++)i-=$(t[o]).outerHeight(!0);$("#node-input-env-container").editableList("height",i-95)}},open:function(e){var t=e.find(".red-ui-tray-footer"),i=$("<div/>",{class:"red-ui-tray-footer-left"}).appendTo(t),o=e.find(".red-ui-tray-body");if(o.parent().css("overflow","hidden"),"subflow"===g.type){var n=$("<span/>").css({"margin-left":"10px"}).appendTo(i);$("<i/>",{class:"fa fa-info-circle"}).appendTo(n),$("<span/>").text(" ").appendTo(n),$("<i/>",{id:"red-ui-editor-subflow-user-count"}).appendTo(n)}g&&RED.sidebar.info.refresh(g);var a=$("<ul></ul>").appendTo(o),r=$("<div></div>").appendTo(o),s=RED.tabs.create({element:a,onchange:function(e){r.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),u&&RED.tray.resize()},collapsible:!0,menu:!1}),d={id:"editor-tab-properties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(r).hide(),iconClass:"fa fa-cog"};R(d.content,"dialog-form","subflow-template",void 0,g),s.addTab(d);var l={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(r).hide(),iconClass:"fa fa-file-text-o",onchange:function(){h.focus()}};s.addTab(l),h=x(l.content,g);var c={id:"editor-tab-appearance",label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(r).hide(),iconClass:"fa fa-object-group",onchange:function(){v(this.content,g)}};b(c.content,g),s.addTab(c),$("#subflow-input-name").val(p.name),RED.text.bidi.prepareInput($("#subflow-input-name")),o.i18n(),u=!0},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(g),RED.workspaces.refresh(),h.destroy(),h=null,a.pop(),g=null},show:function(){}};RED.tray.show(e)},editJavaScript:function(e){t("_js",e)},editExpression:function(e){t("_expression",e)},editJSON:function(e){t("_json",e)},editMarkdown:function(e){t("_markdown",e)},editText:function(e){t("_text",e)},editBuffer:function(e){t("_buffer",e)},buildEditForm:R,validateNode:O,updateNodeProperties:I,showIconPicker:T,showTypeEditor:t,registerTypeEditor:function(e,t){s[e]=t},createEditor:function(e){var t=e.element||$("#"+e.id)[0],i=$("<div>").appendTo(t);t=$("<div>").appendTo(t).addClass("red-ui-editor-text-container")[0];var o=ace.edit(t);o.setTheme("ace/theme/tomorrow");var n=o.getSession();if(n.on("changeAnnotation",function(){for(var e=n.getAnnotations()||[],t=e.length,i=e.length;t--;)/doctype first\. Expected/.test(e[t].text)?e.splice(t,1):/Unexpected End of file\. Expected/.test(e[t].text)&&e.splice(t,1);i>e.length&&n.setAnnotations(e)}),e.mode&&n.setMode(e.mode),e.foldStyle?n.setFoldStyle(e.foldStyle):n.setFoldStyle("markbeginend"),e.options?o.setOptions(e.options):o.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,tooltipFollowsMouse:!1}),e.readOnly&&(o.setOption("readOnly",e.readOnly),o.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&o.renderer.setOption("showGutter",e.lineNumbers),o.$blockScrolling=1/0,e.value&&n.setValue(e.value,-1),e.globals&&setTimeout(function(){n.$worker&&n.$worker.send("setOptions",[{globals:e.globals,esversion:6,sub:!0,asi:!0,maxerr:1e3}])},100),"ace/mode/markdown"===e.mode){if($(t).addClass("red-ui-editor-text-container-toolbar"),o.toolbar=s._markdown.buildToolbar(i,o),!1!==e.expandable){var a=$('<button type="button" class="red-ui-button" style="float: right;"><i class="fa fa-expand"></i></button>').appendTo(o.toolbar);RED.popover.tooltip(a,RED._("markdownEditor.expand")),a.on("click",function(e){e.preventDefault();var t=o.getValue();RED.editor.editMarkdown({value:t,width:"Infinity",cursor:o.getCursorPosition(),complete:function(e,t){o.setValue(e,-1),o.gotoLine(t.row+1,t.column,!1),setTimeout(function(){o.focus()},300)}})})}var r=$('<button type="button" class="red-ui-editor-text-help red-ui-button red-ui-button-small"><i class="fa fa-question"></i></button>').appendTo($(t).parent());RED.popover.create({target:r,trigger:"click",size:"small",direction:"left",content:RED._("markdownEditor.format"),autoClose:50}),n.setUseWrapMode(!0)}return o}}}(),function(){var e={show:function(e){var a=e.value,t=e.complete;0===$("script[data-template-name='_buffer']").length&&$('<script type="text/x-red" data-template-name="_buffer"><div id="red-ui-editor-type-buffer-panels"><div id="red-ui-editor-type-buffer-panel-str" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-buffer-type red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span id="red-ui-editor-type-buffer-type-string" data-i18n="bufferEditor.modeString"></span><span id="red-ui-editor-type-buffer-type-array" data-i18n="bufferEditor.modeArray"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-buffer-str"></div></div></div><div id="red-ui-editor-type-buffer-panel-bin" class="red-ui-panel"><div class="form-row node-text-editor-row" style="margin-top: 10px"><div class="node-text-editor" id="red-ui-editor-type-buffer-bin"></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var s,r,d=[],i={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){t(JSON.stringify(s)),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();r&&r.resize(t)},open:function(e){e.find(".red-ui-tray-body");var t,i=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_buffer","editor");(d=RED.editor.createEditor({id:"red-ui-editor-type-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(a||"",-1),bufferBinEditor=RED.editor.createEditor({id:"red-ui-editor-type-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});function o(e){var t=!0,i="string"==typeof e,o=[],n=0,a=(s=i?function(e){var t=[],i=0,o=e.length;for(i=0;i<o;i++){var n=e.charCodeAt(i);n<128?t.push(n):(n<2048?t.push(192|n>>6):(n<55296||57344<=n?t.push(224|n>>12):(i++,n=65536+((1023&n)<<10|1023&e.charAt(i)),t.push(240|n>>18),t.push(128|n>>12&63)),t.push(128|n>>6&63)),t.push(128|63&n))}return t}(e):e).length;for(n=0;n<a;n++){var r=parseInt(s[n]);if(!i&&(isNaN(r)||r<0||255<r)){t=!1;break}0<n&&(n%8==0?n%16==0?o.push("\n"):o.push("  "):o.push(" ")),o.push((r<16?"0":"")+r.toString(16).toUpperCase())}return t&&($("#red-ui-editor-type-buffer-type-string").toggle(i),$("#red-ui-editor-type-buffer-type-array").toggle(!i),bufferBinEditor.setValue(o.join(""),1)),t}function n(){var e=d.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var i=JSON.parse(e);t=o(i)}catch(e){t=!1}}t||o(e)}d.getSession().on("change",function(){clearTimeout(t),t=setTimeout(n,200)}),n(),i.i18n(),r=RED.panels.create({id:"red-ui-editor-type-buffer-panels",resize:function(e,t){var i=$("#red-ui-editor-type-buffer-panel-str");e-=$(i.children()[0]).outerHeight(!0);var o=$(i.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-buffer-str").css("height",e-5+"px"),d.resize();var n=$("#red-ui-editor-type-buffer-panel-bin");o=$(n.children()[0]),t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".red-ui-editor-type-buffer-type").on("click",function(e){e.preventDefault(),RED.sidebar.info.set(RED._("bufferEditor.modeDesc")),RED.sidebar.info.show()})},close:function(){e.onclose&&e.onclose(),d.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(i)}};RED.editor.registerTypeEditor("_buffer",e)}(),function(){var g={},e={show:function(e){var u,d,f,a,r=e.parent||"_",s=e.value,t=e.complete;0===$("script[data-template-name='_expression']").length&&$('<script type="text/x-red" data-template-name="_expression"><div id="red-ui-editor-type-expression-panels"><div id="red-ui-editor-type-expression-panel-expr" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-expression-legacy red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span data-i18n="expressionEditor.compatMode"></span></button><button id="red-ui-editor-type-expression-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="expressionEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-expression"></div></div></div><div id="red-ui-editor-type-expression-panel-info" class="red-ui-panel"><div class="form-row"><ul id="red-ui-editor-type-expression-tabs"></ul><div id="red-ui-editor-type-expression-tab-help" class="red-ui-editor-type-expression-tab-content hide"><div><select id="red-ui-editor-type-expression-func"></select><button id="red-ui-editor-type-expression-func-insert" class="red-ui-button" data-i18n="expressionEditor.insert"></button></div><div id="red-ui-editor-type-expression-help"></div></div><div id="red-ui-editor-type-expression-tab-test" class="red-ui-editor-type-expression-tab-content hide"><div><span style="display: inline-block; width: calc(50% - 5px);"><span data-i18n="expressionEditor.data"></span><button style="float: right; margin-right: 5px;" id="node-input-example-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button></span><span style="display: inline-block; margin-left: 10px; width: calc(50% - 5px);" data-i18n="expressionEditor.result"></span></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-data"></div><div style="display: inline-block; margin-left: 10px;  width:calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-result"></div></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var h={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#red-ui-editor-type-expression-help").text(""),t(u.getValue()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();a&&a.resize(t)},open:function(e){e.find(".red-ui-tray-body").addClass("red-ui-editor-type-expression");var t=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_expression","editor"),l=$("#red-ui-editor-type-expression-func");Object.keys(jsonata.functions).forEach(function(e){l.append($("<option></option>").val(e).text(e))}),l.on("change",function(e){var t=$(this).val(),i="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",o=marked(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#red-ui-editor-type-expression-help").html(i+"<p>"+o+"</p>")}),u=RED.editor.createEditor({id:"red-ui-editor-type-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}});var c=null,p=-1;u.getSession().setValue(s||"",-1),u.on("changeSelection",function(){var e=u.getCursorPosition(),t=u.getSession().getTokenAt(e.row,e.column);if(t!==c||t&&/paren/.test(t.type)&&e.column!==p){var i,o,n=null;if((c=t)&&"keyword"===t.type)i=e.row,n=t;else{var a=0,r=!1;for(o=t?("paren.rparen"===t.type&&(p=e.column,a=e.column-(t.start+t.value.length)),i=e.row,t.index):(i=e.row-1,-1);null===n&&-1<i;){var s=u.getSession().getTokens(i);for(-1===o&&(o=s.length-1);-1<o;){var d=s[o].type;if(r){if("keyword"===d){n=s[o];break}r=!1}"paren.lparen"===d?a-=s[o].value.length:"paren.rparen"===d&&(a+=s[o].value.length),a<0&&(r=!0,a=0),o--}n||i--}}u.session.removeMarker(null),n&&l.val(n.value).trigger("change")}}),t.i18n(),$("#red-ui-editor-type-expression-func-insert").on("click",function(e){e.preventDefault();u.getCursorPosition();var t=l.val(),i=jsonata.getFunctionSnippet(t);u.insertSnippet(i),u.focus()}),$("#red-ui-editor-type-expression-reformat").on("click",function(e){e.preventDefault();var t=u.getValue()||"";try{t=jsonata.format(t)}catch(e){}u.getSession().setValue(t||"",-1)}),l.change();var i,o=RED.tabs.create({element:$("#red-ui-editor-type-expression-tabs"),onchange:function(e){$(".red-ui-editor-type-expression-tab-content").hide(),e.content.show(),h.resize()}});o.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#red-ui-editor-type-expression-tab-help")}),o.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#red-ui-editor-type-expression-tab-test")}),d=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-data",value:g[r]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".red-ui-editor-type-expression-legacy").on("click",function(e){e.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});function n(){var e,t,i=d.getValue(),o=u.getValue(),n=!1,a=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(o);$(".red-ui-editor-type-expression-legacy").toggle(a);try{(t=jsonata(o)).assign("flowContext",function(e){return n=!0,null}),t.assign("globalContext",function(e){return n=!0,null})}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(i)}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var r,s=t.evaluate(a?{msg:e}:e);if(n)return void f.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);r=void 0!==s?JSON.stringify(s,null,4):RED._("expressionEditor.noMatch"),f.setValue(r,-1)}catch(e){f.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}}d.getSession().on("change",function(){clearTimeout(i),i=setTimeout(n,200),g[r]=d.getValue()}),u.getSession().on("change",function(){clearTimeout(i),i=setTimeout(n,200)}),f=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),a=RED.panels.create({id:"red-ui-editor-type-expression-panels",resize:function(e,t){var i=$("#red-ui-editor-type-expression-panel-expr");e-=$(i.children()[0]).outerHeight(!0);var o=$(i.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-expression").css("height",e-5+"px"),u.resize(),t-=$("#red-ui-editor-type-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".red-ui-editor-type-expression-tab-content").height(t),$("#red-ui-editor-type-expression-test-data").css("height",t-5+"px"),d.resize(),$("#red-ui-editor-type-expression-test-result").css("height",t-5+"px"),f.resize()}}),$("#node-input-example-reformat").on("click",function(e){e.preventDefault();var t=d.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}d.getSession().setValue(t||"",-1)}),n()},close:function(){e.onclose&&e.onclose(),u.destroy(),d.destroy()},show:function(){}};RED.tray.show(h)}};RED.editor.registerTypeEditor("_expression",e)}(),function(){var e={show:function(i){var n,o=i.value,e=i.complete;0===$("script[data-template-name='_js']").length&&$('<script type="text/x-red" data-template-name="_js"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-js"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var t={title:i.title,width:i.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(n.getValue(),n.getCursorPosition()),RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),i=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)i-=$(t[o]).outerHeight(!0);$(".node-text-editor").css("height",i+"px"),n.resize()},open:function(e){e.find(".red-ui-tray-body");var t=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_js","editor");n=RED.editor.createEditor({id:"node-input-js",mode:i.mode||"ace/mode/javascript",value:o,globals:{msg:!0,context:!0,RED:!0,util:!0,flow:!0,global:!0,console:!0,Buffer:!0,setTimeout:!0,clearTimeout:!0,setInterval:!0,clearInterval:!0}}),i.cursor&&n.gotoLine(i.cursor.row+1,i.cursor.column,!1),t.i18n()},close:function(){n.destroy(),i.onclose&&i.onclose()},show:function(){}};RED.tray.show(t)}};RED.editor.registerTypeEditor("_js",e)}(),function(){var f;function h(e,t,i){var o,n="";if(0<e.children.length)switch(e.children[Math.max(0,Math.min(e.children.length-1,i))].type){case"string":n="";break;case"number":n=0;break;case"boolean":n=!0;break;case"null":n=null;break;case"object":n={};break;case"array":n=[]}if("array"===e.type)o=e.children.length;else{var a={};e.children.forEach(function(e){a[e.key]=!0});var r=2;for(o="item";a[o];)o="item-"+r++}var s=g(o,n,e.depth+1,e);e.treeList.insertChildAt(s,t,!0),e.treeList.expand()}function g(e,t,i,o){var a,r={depth:i,type:typeof t},n=$('<span class="red-ui-editor-type-json-editor-label">');if(null!=e){var s;s="string"==typeof(r.key=e)?'"'+e+'"':e;var d=$('<span class="red-ui-debug-msg-object-key red-ui-editor-type-json-editor-label-key">').text(s).appendTo(n);d.addClass("red-ui-debug-msg-type-"+typeof e),o&&"array"===o.type&&d.addClass("red-ui-editor-type-json-editor-label-array-key"),d.on("click",function(e){if("array"!==r.parent.type){e.preventDefault(),e.stopPropagation();var t=Math.max(150,d.width()),a=$('<input type="text" class="red-ui-editor-type-json-editor-key">').css({width:t+"px"}).val(""+r.key).insertAfter(d).typedInput({types:["str"]});$(document).on("mousedown.nr-ui-json-editor",function(e){for(var t=a.next(".red-ui-typedInput-container")[0],i=e.target;"BODY"!==i.nodeName&&i!==t&&!$(i).hasClass("red-ui-typedInput-options");)i=i.parentElement;if("BODY"===i.nodeName){var o,n=a.typedInput("value");o="string"==typeof(r.key=n)?'"'+n+'"':n,d.text(o),a.remove(),d.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor")}}),$(document).on("keydown.nr-ui-json-editor",function(e){27===e.keyCode&&(a.remove(),d.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))}),d.hide()}}),$("<span>").text(" : ").appendTo(n)}Array.isArray(t)?(r.expanded=i<2,r.type="array",r.deferBuild=2<=i,r.children=function(e,t,i){for(var o=[],n=e.length,a=0;a<n;a++)o.push(g(a,e[a],t,i));return o}(t,i+1,r)):null!==t&&"object"===r.type?(r.expanded=i<2,r.children=function(e,t,i){var o=[];for(var n in e)e.hasOwnProperty(n)&&o.push(g(n,e[n],t,i));return o}(t,i+1,r),r.deferBuild=2<=i):null===(r.value=t)&&(r.type="null");var l,c,p="";switch(r.type){case"string":a="str",p='"'+r.value+'"',l="red-ui-debug-msg-type-string";break;case"number":a="num",p=r.value,l="red-ui-debug-msg-type-number";break;case"boolean":a="bool",p=r.value,l="red-ui-debug-msg-type-other";break;case"null":a=r.type,p=r.type,l="red-ui-debug-msg-type-null";break;case"object":a=r.type,p=r.type,l="red-ui-debug-msg-type-meta";break;case"array":a=r.type,p=r.type+"["+r.children.length+"]",l="red-ui-debug-msg-type-meta"}var u=$('<span class="red-ui-editor-type-json-editor-label-value">').addClass(l).text(p).appendTo(n);return u.on("click",function(e){e.preventDefault(),e.stopPropagation(),"str"===a?p=p.substring(1,p.length-1):"array"===a?p="":"object"===a&&(p="");var t=Math.max(150,u.width()),n=$('<input type="text" class="red-ui-editor-type-json-editor-value">').css({width:t+"px"}).val(""+p).insertAfter(u).typedInput({types:["str","num","bool",{value:"null",label:"null",hasValue:!1},{value:"array",label:"array",hasValue:!1},{value:"object",label:"object",hasValue:!1}],default:a});$(document).on("mousedown.nr-ui-json-editor",function(e){for(var t=n.next(".red-ui-typedInput-container")[0],i=e.target;"BODY"!==i.nodeName&&i!==t&&!$(i).hasClass("red-ui-typedInput-options");)i=i.parentElement;if("BODY"===i.nodeName){var o;switch(a=n.typedInput("type"),p=n.typedInput("value"),"num"===a&&(p=p.trim(),isNaN(p)?a="str":""===p&&(p=0)),r.value=p,a){case"str":r.children&&(c=r.children),r.treeList.makeLeaf(!0),r.type="string",o="red-ui-debug-msg-type-string",p='"'+p+'"';break;case"num":r.children&&(c=r.children),r.treeList.makeLeaf(!0),r.type="number",o="red-ui-debug-msg-type-number";break;case"bool":r.children&&(c=r.children),r.treeList.makeLeaf(!0),r.type="boolean",o="red-ui-debug-msg-type-other",r.value="true"===p;break;case"null":r.children&&(c=r.children),r.treeList.makeLeaf(!0),r.type="null",o="red-ui-debug-msg-type-null",r.value=p="null";break;case"object":r.treeList.makeParent(c),r.type="object",o="red-ui-debug-msg-type-meta",r.value=p="object",r.children.forEach(function(e,t){if(e.hasOwnProperty("_key")){var i;e.key=e._key,delete e._key;var o=e.element.find(".red-ui-editor-type-json-editor-label-key");o.removeClass("red-ui-editor-type-json-editor-label-array-key"),"string"==typeof e.key?(i='"'+e.key+'"',o.addClass("red-ui-debug-msg-type-string"),o.removeClass("red-ui-debug-msg-type-number")):(i=e.key,o.removeClass("red-ui-debug-msg-type-string"),o.addClass("red-ui-debug-msg-type-number")),o.text(i)}});break;case"array":r.treeList.makeParent(c),r.type="array",o="red-ui-debug-msg-type-meta",r.value=p="array["+r.children.length+"]",r.children.forEach(function(e,t){e._key=e.key,e.key=t,e.element.find(".red-ui-editor-type-json-editor-label-key").addClass("red-ui-editor-type-json-editor-label-array-key").text(""+e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")})}u.text(p).removeClass().addClass("red-ui-editor-type-json-editor-label-value "+o),n.remove(),u.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor")}}),$(document).on("keydown.nr-ui-json-editor",function(e){27===e.keyCode&&(n.remove(),u.show(),"str"===a&&(p='"'+p+'"'),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))}),u.hide()}),r.gutter=$('<span class="red-ui-editor-type-json-editor-item-gutter"></span>'),o?$('<span class="red-ui-editor-type-json-editor-item-handle"><i class="fa fa-bars"></span>').appendTo(r.gutter):$("<span></span>").appendTo(r.gutter),$('<button type="button" class="editor-button editor-button-small"><i class="fa fa-caret-down"></button>').appendTo(r.gutter).on("click",function(e){e.preventDefault(),e.stopPropagation(),function(e,s){var t=e.offset(),i=[];s.parent&&(i.push({id:"red-ui-editor-type-json-menu-insert-above",icon:"fa fa-toggle-up",label:RED._("jsonEditor.insertAbove"),onselect:function(){var e=s.parent.children.indexOf(s);h(s.parent,e,e)}}),i.push({id:"red-ui-editor-type-json-menu-insert-below",icon:"fa fa-toggle-down",label:RED._("jsonEditor.insertBelow"),onselect:function(){var e=s.parent.children.indexOf(s)+1;h(s.parent,e,e-1)}})),"array"!==s.type&&"object"!==s.type||i.push({id:"red-ui-editor-type-json-menu-add-child",icon:"fa fa-plus",label:RED._("jsonEditor.addItem"),onselect:function(){h(s,s.children.length,s.children.length-1)}}),s.parent&&(i.push({id:"red-ui-editor-type-json-menu-copy-path",icon:"fa fa-terminal",label:RED._("jsonEditor.copyPath"),onselect:function(){for(var e=s,t="";e.parent;)t=("array"===e.parent.type?"["+e.key+"]":/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(e.key)?e.key:'["'+e.key.replace(/"/,'\\"')+'"]')+(0<t.length&&"["!==t[0]?".":"")+t,e=e.parent;RED.clipboard.copyText(t,s.element,"clipboard.copyMessagePath")}}),i.push({id:"red-ui-editor-type-json-menu-duplicate",icon:"fa fa-copy",label:RED._("jsonEditor.duplicate"),onselect:function(){var e=s.key;if("array"===s.parent.type)e=parent.children.length;else{var t=/^(.*?)(-(\d+))?$/.exec(e),i={};s.parent.children.forEach(function(e){i[e.key]=!0});var o=t[1],n=2;for(void 0!==t[3]&&(n=parseInt(t[3])),e=o;i[e];)e=o+"-"+n++}var a=g(e,v(s),s.parent.depth+1,s.parent),r=s.parent.children.indexOf(s)+1;s.parent.treeList.insertChildAt(a,r,!0),s.parent.treeList.expand()}}),i.push({id:"red-ui-editor-type-json-menu-delete",icon:"fa fa-times",label:RED._("common.label.delete"),onselect:function(){s.treeList.remove()}})),"array"!==s.type&&"object"!==s.type||(i.push(null),i.push({id:"red-ui-editor-type-json-menu-expand-children",icon:"fa fa-angle-double-down",label:RED._("jsonEditor.expandItems"),onselect:function(){s.treeList.expand(),s.children.forEach(function(e){e.treeList.expand()})}}),i.push({id:"red-ui-editor-type-json-menu-collapse-children",icon:"fa fa-angle-double-up",label:RED._("jsonEditor.collapseItems"),onselect:function(){s.treeList.collapse(),s.children.forEach(function(e){e.treeList.collapse()})}}));var o=RED.menu.init({id:"red-ui-editor-type-json-menu",options:i});o.css({position:"absolute"}),o.on("mouseleave",function(){$(this).hide()}),o.on("mouseup",function(){$(this).hide()}),o.appendTo("body");var n=t.top,a=o.height(),r=$(window).height();r<n+a&&(n-=n+a-r+20),o.css({top:n+"px",left:t.left+"px"}),o.show()}($(this),r)}),r.element=n,r}function v(e){var t;switch(e.type){case"string":t=e.value;break;case"number":t=Number(e.value);break;case"boolean":t=e.value;break;case"null":t=null;break;case"object":t={},e.children.forEach(function(e){t[e.key]=v(e)});break;case"array":t=e.children.map(function(e){return v(e)})}return t}var e={show:function(r){var s,d,l=r.value,t=r.complete;0===$("script[data-template-name='_json']").length&&$('<script type="text/x-red" data-template-name="_json"><ul id="red-ui-editor-type-json-tabs"></ul><div id="red-ui-editor-type-json-tab-raw" class="red-ui-editor-type-json-tab-content hide"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button id="node-input-json-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-json"></div></div></div><div id="red-ui-editor-type-json-tab-ui" class="red-ui-editor-type-json-tab-content hide"><div id="red-ui-editor-type-json-tab-ui-container"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);function c(){var e=s.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}}var p,u={title:r.title,width:r.width||700,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e;r.requireValid&&!c()||("json-ui"===f?e=p?JSON.stringify(v(p),null,4):s.getValue():"json-raw"===f&&(e=s.getValue()),t&&t(e),RED.tray.close())}}],resize:function(e){var t=$(".red-ui-editor-type-json-tab-content").height();$(".node-text-editor").css("height",t-45+"px"),s.resize()},open:function(e){e.find(".red-ui-tray-body");var t=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_json","editor"),i=$("#red-ui-editor-type-json-tab-ui-container").css({height:"100%"}),n=$('<div class="red-ui-debug-msg-payload red-ui-editor-type-json-editor">').appendTo(i).treeList({rootSortable:!1,sortable:".red-ui-editor-type-json-editor-item-handle"}).on("treelistchangeparent",function(e,t){"array"===t.old.type&&t.old.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.old.children.length+"]"),"array"===t.item.parent.type&&t.item.parent.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.item.parent.children.length+"]")}).on("treelistsort",function(e,i){i.children.forEach(function(e,t){"array"===i.type?(e.key=t,e.element.find(".red-ui-editor-type-json-editor-label-key").text(e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")):e.element.find(".red-ui-editor-type-json-editor-label-key").text('"'+e.key+'"').removeClass("red-ui-debug-msg-type-number").addClass("red-ui-debug-msg-type-string")})});(s=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(l||"",-1),r.requireValid&&(s.getSession().on("change",function(){clearTimeout(d),d=setTimeout(c,200)}),c()),$("#node-input-json-reformat").on("click",function(e){e.preventDefault();var t=s.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}s.getSession().setValue(t||"",-1)}),t.i18n();var a=!1,o=RED.tabs.create({element:$("#red-ui-editor-type-json-tabs"),onchange:function(e){if(f=e.id,$(".red-ui-editor-type-json-tab-content").hide(),a)if("json-raw"===e.id){if(p){var t=JSON.stringify(v(p),null,4);s.getSession().setValue(t||"",-1)}}else if("json-ui"===e.id){var i=s.getValue().trim()||"{}";try{var o=JSON.parse(i);(p=g(null,o,0,null)).class="red-ui-editor-type-json-root-node",n.treeList("data",[p])}catch(e){p=null,n.treeList("data",[{label:"Invalid JSON: "+e.toString()}])}}e.content.show(),u.resize()}});o.addTab({id:"json-raw",label:RED._("jsonEditor.rawMode"),content:$("#red-ui-editor-type-json-tab-raw")}),o.addTab({id:"json-ui",label:RED._("jsonEditor.uiMode"),content:$("#red-ui-editor-type-json-tab-ui")}),a=!0},close:function(){r.onclose&&r.onclose()},show:function(){}};RED.tray.show(u)}};RED.editor.registerTypeEditor("_json",e)}(),function(){var r,e={show:function(o){var n,a=o.value,e=o.complete;0===$("script[data-template-name='_markdown']").length&&$('<script type="text/x-red" data-template-name="_markdown"><div id="red-ui-editor-type-markdown-panels"><div id="red-ui-editor-type-markdown-panel-editor" class="red-ui-panel"><div style="height: 100%; margin: auto;"><div id="red-ui-editor-type-markdown-toolbar"></div><div class="node-text-editor" style="height: 100%" id="red-ui-editor-type-markdown"></div></div></div><div class="red-ui-panel"><div class="red-ui-editor-type-markdown-panel-preview red-ui-help"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var t={title:o.title,width:o.width||1/0,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(n.getValue(),n.getCursorPosition()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").width();r&&r.resize(t)},open:function(e){e.find(".red-ui-tray-body").addClass("red-ui-editor-type-markdown-editor");var t,i=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_markdown","editor");(n=RED.editor.createEditor({id:"red-ui-editor-type-markdown",value:a,mode:"ace/mode/markdown",expandable:!1})).getSession().on("change",function(){clearTimeout(t),t=setTimeout(function(){var e=$(".red-ui-editor-type-markdown-panel-preview").scrollTop();$(".red-ui-editor-type-markdown-panel-preview").html(marked(n.getValue())),$(".red-ui-editor-type-markdown-panel-preview").scrollTop(e)},200)}),o.header&&o.header.appendTo(e.find("#red-ui-editor-type-markdown-title")),a&&$(".red-ui-editor-type-markdown-panel-preview").html(marked(n.getValue())),(r=RED.panels.create({id:"red-ui-editor-type-markdown-panels",dir:"horizontal",resize:function(e,t){n.resize()}})).ratio(1),$('<span class="button-group" style="float:right"><button type="button" id="node-btn-markdown-preview" class="red-ui-button toggle single"><i class="fa fa-eye"></i></button></span>').appendTo(n.toolbar),$("#node-btn-markdown-preview").on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),r.ratio(1)):($(this).addClass("selected"),r.ratio(.5))}),RED.popover.tooltip($("#node-btn-markdown-preview"),RED._("markdownEditor.toggle-preview")),o.cursor&&n.gotoLine(o.cursor.row+1,o.cursor.column,!1),i.i18n()},close:function(){n.destroy(),o.onclose&&o.onclose()},show:function(){}};RED.tray.show(t)},buildToolbar:function(e,d){var t={h1:{newline:!0,before:"# ",tooltip:RED._("markdownEditor.heading1")},h2:{newline:!0,before:"## ",tooltip:RED._("markdownEditor.heading2")},h3:{newline:!0,before:"### ",tooltip:RED._("markdownEditor.heading3")},b:{before:"**",after:"**",tooltip:RED._("markdownEditor.bold")},i:{before:"_",after:"_",tooltip:RED._("markdownEditor.italic")},code:{before:"`",after:"`",tooltip:RED._("markdownEditor.code")},ol:{before:" * ",newline:!0,tooltip:RED._("markdownEditor.ordered-list")},ul:{before:" - ",newline:!0,tooltip:RED._("markdownEditor.unordered-list")},bq:{before:"> ",newline:!0,tooltip:RED._("markdownEditor.quote")},link:{before:"[",after:"]()",tooltip:RED._("markdownEditor.link")},hr:{before:"\n---\n\n",tooltip:RED._("markdownEditor.horizontal-rule")}},i=$('<div style="margin-bottom: 5px"><span class="button-group"><button type="button" class="red-ui-button" data-style="h1" style="font-size:1.1em; font-weight: bold">h1</button><button type="button" class="red-ui-button" data-style="h2" style="font-size:1.0em; font-weight: bold">h2</button><button type="button" class="red-ui-button" data-style="h3" style="font-size:0.9em; font-weight: bold">h3</button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="b"><i class="fa fa-bold"></i></button><button type="button" class="red-ui-button" data-style="i"><i class="fa fa-italic"></i></button><button type="button" class="red-ui-button" data-style="code"><i class="fa fa-code"></i></button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="ol"><i class="fa fa-list-ol"></i></button><button type="button" class="red-ui-button" data-style="ul"><i class="fa fa-list-ul"></i></button><button type="button" class="red-ui-button" data-style="bq"><i class="fa fa-quote-left"></i></button><button type="button" class="red-ui-button" data-style="hr"><i class="fa fa-minus"></i></button><button type="button" class="red-ui-button" data-style="link"><i class="fa fa-link"></i></button></span>').appendTo(e);return i.find("button[data-style]").each(function(e){var s=t[$(this).data("style")];$(this).on("click",function(e){e.preventDefault();var t=d.getSelectedText(),i=d.selection.getRange();if(s.newline)for(var o=0,n=((s.before||"").match(/\n/g)||[]).length,a=((s.after||"").match(/\n/g)||[]).length,r=i.start.row;r<=i.end.row+o;r++)s.before&&(d.session.insert({row:r,column:0},s.before),o+=n,r+=n),s.after&&(d.session.insert({row:r,column:1/0},s.after),o+=a,r+=a);else d.session.replace(d.selection.getRange(),(s.before||"")+t+(s.after||"")),""===t&&d.gotoLine(i.start.row+1,i.start.column+(s.before||"").length,!1);d.focus()}),s.tooltip&&RED.popover.tooltip($(this),s.tooltip)}),i}};RED.editor.registerTypeEditor("_markdown",e)}(),function(){var e={show:function(t){var i,o=t.value,e=t.complete;0===$("script[data-template-name='_text']").length&&$('<script type="text/x-red" data-template-name="_text"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-text"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var n={title:t.title,width:t.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(i.getValue(),i.getCursorPosition()),RED.tray.close()}}],resize:function(e){$("#dialog-form>div:not(.node-text-editor-row)"),$("#dialog-form>div.node-text-editor-row");var t=$("#dialog-form").height();$(".node-text-editor").css("height",t+"px"),i.resize()},open:function(e){e.find(".red-ui-tray-body"),RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_text","editor");(i=RED.editor.createEditor({id:"node-input-text",value:"",mode:"ace/mode/"+(t.mode||"text")})).getSession().setValue(o||"",-1),t.cursor&&i.gotoLine(t.cursor.row+1,t.cursor.column,!1)},close:function(){i.destroy(),t.onclose&&t.onclose()},show:function(){}};RED.tray.show(n)}};RED.editor.registerTypeEditor("_text",e)}(),RED.eventLog=function(){var n,a=[],t=!1;return{init:function(){$('<script type="text/x-red" data-template-name="_eventLog"><div class="form-row node-text-editor-row"><div style="height: 100%;min-height: 150px;" class="node-text-editor" id="red-ui-event-log-editor"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.actions.add("core:show-event-log",RED.eventLog.show)},show:function(){if(!t){t=!0;var e={title:RED._("eventLog.title"),width:1/0,buttons:[{id:"node-dialog-close",text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),i=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)i-=$(t[o]).outerHeight(!0);i-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",i+"px"),n.resize()},open:function(e){e.find(".red-ui-tray-body");var t=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_eventLog","editor");n=RED.editor.createEditor({id:"red-ui-event-log-editor",value:a.join("\n"),lineNumbers:!1,readOnly:!0,options:{showPrintMargin:!1}}),setTimeout(function(){n.scrollToLine(n.getSession().getLength())},200),t.i18n()},close:function(){n.destroy(),n=null,t=!1},show:function(){}};RED.tray.show(e)}},log:function(e,t){var i=new Date(t.ts).toISOString()+" ";if(t.type&&(i+="["+t.type+"] "),t.data){var o=t.data;o.endsWith("\n")&&(o=o.substring(0,o.length-1)),o.split(/\n/).forEach(function(e){!function(e){a.push(e),500<a.length&&(a=a.slice(-500)),n&&(n.getSession().insert({row:n.getSession().getLength(),column:0},"\n"+e),n.scrollToLine(n.getSession().getLength()))}(i+e)})}},startEvent:function(e){a.push(""),a.push("-----------------------------------------------------------"),a.push((new Date).toISOString()+" "+e),a.push("")}}}(),RED.tray=function(){var v,b=[],m=!1,i=!1;function o(e){var i=$('<div class="red-ui-tray"></div>'),t=$('<div class="red-ui-tray-header editor-tray-header"></div>').appendTo(i),o=$('<div class="red-ui-tray-body-wrapper"></div>').appendTo(i),n=$('<div class="red-ui-tray-body editor-tray-body"></div>').appendTo(o),a=$('<div class="red-ui-tray-footer"></div>').appendTo(i),r=$('<div class="red-ui-tray-resize-handle"></div>').appendTo(i);if(e.title){var s=b.map(function(e){return e.options.title});s.push(e.title);var d='<ul class="red-ui-tray-breadcrumbs"><li>'+s.join("</li><li>")+"</li></ul>";$('<div class="red-ui-tray-titlebar">'+d+"</div>").appendTo(t)}e.width===1/0&&(e.maximized=!0,r.addClass("red-ui-tray-resize-maximised"));var l,c=$('<div class="red-ui-tray-toolbar"></div>').appendTo(t);if(e.buttons)for(var p=0;p<e.buttons.length;p++){var u=e.buttons[p],f=$("<button>").button().appendTo(c);u.id&&f.attr("id",u.id),u.text&&f.text(u.text),u.click&&f.on("click",function(t){return function(e){$(this).hasClass("disabled")||t(e)}}(u.click)),u.class&&(f.addClass(u.class),"primary"===u.class&&(l=u))}i.appendTo(v);var h={tray:i,header:t,body:n,footer:a,options:e,primaryButton:l};function g(){$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),h.preferredWidth=Math.max(i.width(),500),e.maximized||n.css({minWidth:h.preferredWidth-40}),e.width?(e.width>$("#red-ui-editor-stack").position().left-8&&(e.width=$("#red-ui-editor-stack").position().left-8),i.width(e.width)):i.width(h.preferredWidth),h.width=i.width(),h.width>$("#red-ui-editor-stack").position().left-8&&(h.width=Math.max(0,$("#red-ui-editor-stack").position().left-8),i.width(h.width)),$("#red-ui-main-container").scrollLeft(0),i.css({right:-(i.width()+10)+"px",transition:"right 0.25s ease"}),y(),m=!0,setTimeout(function(){setTimeout(function(){e.width||i.width(Math.min(h.preferredWidth,$("#red-ui-editor-stack").position().left-8)),e.resize&&e.resize({width:i.width()}),e.show&&e.show(),setTimeout(function(){m=!1},200),n.find(":focusable:first").trigger("focus")},150),i.css({right:0})},0)}b.push(h),e.maximized||i.draggable({handle:r,axis:"x",start:function(e,t){i.width("auto")},drag:function(e,t){var i=v.position().left+t.position.left;i<7?t.position.left+=7-i:t.position.left>-h.preferredWidth-1&&(t.position.left=-Math.min(v.position().left-7,h.preferredWidth-1)),h.options.resize&&setTimeout(function(){h.options.resize({width:-t.position.left})},0),h.width=-t.position.left},stop:function(e,t){i.width(-t.position.left),i.css({left:""}),h.options.resize&&h.options.resize({width:-t.position.left}),h.width=-t.position.left}}),e.open?1===e.open.length?(e.open(i),g()):e.open(i,g):g()}function y(){if(0<b.length){var e=b[b.length-1];e.options.maximized||e.width>$("#red-ui-editor-stack").position().left-8?(e.width=$("#red-ui-editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#red-ui-editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width));var t=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight();e.body.height(t),e.options.resize&&e.options.resize({width:e.width,height:t})}}return{init:function(){v=$("#red-ui-editor-stack"),$(window).on("resize",y),RED.events.on("sidebar:resize",y),$("#red-ui-editor-shade").on("click",function(){if(!m){var e=b[b.length-1];e&&e.primaryButton&&e.primaryButton.click()}})},show:function(e){if(e){if(i)throw new Error("Cannot add to stack whilst hidden");if(0<b.length&&!e.overlay){var t=b[b.length-1];"inherit"===e.width&&(e.width=t.tray.width()),t.tray.css({right:-(t.tray.width()+10)+"px"}),setTimeout(function(){t.tray.detach(),o(e)},250)}else RED.events.emit("editor:open"),o(e)}else{if(0<b.length)b[b.length-1].tray.css({right:0}),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),i=!1}},hide:function(){if(0<b.length){var e=b[b.length-1];e.tray.css({right:-(e.tray.width()+10)+"px"}),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),i=!0}},resize:y,close:function(t){if(0<b.length){var i=b.pop();i.tray.css({right:-(i.tray.width()+10)+"px"}),setTimeout(function(){if(i.options.close&&i.options.close(),i.tray.remove(),0<b.length){var e=b[b.length-1];e.options.overlay?(y(),e.options.show&&e.options.show()):(e.tray.appendTo("#red-ui-editor-stack"),setTimeout(function(){y(),e.tray.css({right:0}),e.options.show&&e.options.show()},0))}t&&t(),0===b.length&&($("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){var r,o,n,i,f,h,d,l,a,e,t,c=!1;function p(){e&&clearTimeout(e),e=setTimeout(function(){var e=$("#red-ui-clipboard-dialog-tab-library-name"),t=e.val().trim();0<t.length&&!/[\/\\]/.test(t)?(e.removeClass("input-error"),$("#red-ui-clipboard-dialog-export").button("enable")):(e.addClass("input-error"),$("#red-ui-clipboard-dialog-export").button("disable"))},100)}function s(){if("red-ui-clipboard-dialog-import-tab-clipboard"===d)t&&clearTimeout(t),t=setTimeout(function(){var t=$("#red-ui-clipboard-dialog-import-text"),i=t.val().trim();if(""===i)return f.close(!0),h=null,t.removeClass("input-error"),void $("#red-ui-clipboard-dialog-ok").button("disable");try{if(!/^\[[\s\S]*\]$/m.test(i))throw new Error(RED._("clipboard.import.errors.notArray"));for(var e=JSON.parse(i),o=0;o<e.length;o++){if("object"!=typeof e[o])throw new Error(RED._("clipboard.import.errors.itemNotObject",{index:o}));if(!e[o].hasOwnProperty("id"))throw new Error(RED._("clipboard.import.errors.missingId",{index:o}));if(!e[o].hasOwnProperty("type"))throw new Error(RED._("clipboard.import.errors.missingType",{index:o}))}h=null,f.close(!0),t.removeClass("input-error"),t.val(i),$("#red-ui-clipboard-dialog-ok").button("enable")}catch(e){if(""!==i){t.addClass("input-error");var n=e.toString();if(n!==h){var a,r=$('<div class="red-ui-clipboard-import-error"></div>').text(n),s=/at position (\d+)/i.exec(n);if(s)a=parseInt(s[1]);else if(s=/at line (\d+) column (\d+)/i.exec(n)){var d=parseInt(s[1])-1,l=parseInt(s[2])-1,c=i.split("\n");for(o=a=0;o<d;o++)a+=c[o].length+1;a+=l}if(void 0!==a){i=i.replace(/\n/g,"↵");parseInt(s[1]);var p=$("<div>").appendTo(r),u=$("<pre>").appendTo(p);$("<span>").text(i.substring(a-12,a)).appendTo(u),$('<span class="error">').text(i.charAt(a)).appendTo(u),$("<span>").text(i.substring(a+1,a+12)).appendTo(u)}f.close(!0).setContent(r).open(),h=n}}else h=null;$("#red-ui-clipboard-dialog-ok").button("disable")}},100);else{var e=l.getSelected();e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")}}function u(e){if(!c){e=e||"clipboard",o.empty(),o.append($(i));var t=RED.tabs.create({id:"red-ui-clipboard-dialog-import-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-import-tabs-content").children().hide(),$("#"+e.id).show(),d=e.id,f&&(f.close(!0),h=null),"red-ui-clipboard-dialog-import-tab-clipboard"===e.id?$("#red-ui-clipboard-dialog-import-text").trigger("focus"):l.focus(),s()}});t.addTab({id:"red-ui-clipboard-dialog-import-tab-clipboard",label:RED._("clipboard.clipboard")}),t.addTab({id:"red-ui-clipboard-dialog-import-tab-library",label:RED._("library.library")}),t.addTab({id:"red-ui-clipboard-dialog-import-tab-examples",label:RED._("library.types.examples")}),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",p),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",function(){setTimeout(p,10)}),$("#red-ui-clipboard-dialog-export").button("enable"),v(l=RED.library.createBrowser({container:$("#red-ui-clipboard-dialog-import-tab-library"),onselect:function(e){e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")},onconfirm:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-ok").trigger("click")}}),"local",RED._("library.types.local")),v(a=RED.library.createBrowser({container:$("#red-ui-clipboard-dialog-import-tab-examples"),onselect:function(e){e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")},onconfirm:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-ok").trigger("click")}}),"_examples_",RED._("library.types.examples")),o.i18n(),$("#red-ui-clipboard-dialog-ok").show(),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-ok").button("disable"),$("#red-ui-clipboard-dialog-import-text").on("keyup",s),$("#red-ui-clipboard-dialog-import-text").on("paste",function(){setTimeout(s,10)}),$("#red-ui-clipboard-dialog-import-opt > a").on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),$("#red-ui-clipboard-dialog-import-file-upload").on("change",function(){var e=new FileReader;e.onload=function(){$("#red-ui-clipboard-dialog-import-text").val(e.result),s()},e.readAsText($(this).prop("files")[0])}),$("#red-ui-clipboard-dialog-import-file-upload-btn").on("click",function(e){e.preventDefault(),$("#red-ui-clipboard-dialog-import-file-upload").trigger("click")}),t.activateTab("red-ui-clipboard-dialog-import-tab-"+e),"clipboard"===e&&setTimeout(function(){$("#red-ui-clipboard-dialog-import-text").trigger("focus")},100),r.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"),f=RED.popover.create({target:$("#red-ui-clipboard-dialog-import-text"),trigger:"manual",direction:"bottom",content:""})}}function g(e){if(!c){e=e||"clipboard",o.empty(),o.append($(n));var t=RED.tabs.create({id:"red-ui-clipboard-dialog-export-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-export-tabs-content").children().hide(),$("#"+e.id).show(),d=e.id,"red-ui-clipboard-dialog-export-tab-clipboard"===e.id?($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.copy")),$("#red-ui-clipboard-dialog-download").show()):($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.export")),$("#red-ui-clipboard-dialog-download").hide(),l.focus())}});t.addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard",label:RED._("clipboard.clipboard")}),t.addTab({id:"red-ui-clipboard-dialog-export-tab-library",label:RED._("library.library")}),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",p),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",function(){setTimeout(p,10)}),$("#red-ui-clipboard-dialog-export").button("enable"),v(l=RED.library.createBrowser({container:$("#red-ui-clipboard-dialog-export-tab-library-browser"),folderTools:!0,onselect:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-tab-library-name").val(e.label)}}),"local",RED._("library.types.local")),$("#red-ui-clipboard-dialog-tab-library-name").val("flows.json").select(),o.i18n();var s=RED.settings.flowFilePretty?"red-ui-clipboard-dialog-export-fmt-full":"red-ui-clipboard-dialog-export-fmt-mini";$("#red-ui-clipboard-dialog-export-fmt-group > a").on("click",function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#red-ui-clipboard-dialog-export-text").trigger("focus");else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#red-ui-clipboard-dialog-export-text").val();if(0<t.length){var i=JSON.parse(t);t="red-ui-clipboard-dialog-export-fmt-full"===(s=$(this).attr("id"))?JSON.stringify(i,null,4):JSON.stringify(i),$("#red-ui-clipboard-dialog-export-text").val(t),setTimeout(function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0)},50),$("#red-ui-clipboard-dialog-export-text").trigger("focus")}}}),$("#red-ui-clipboard-dialog-export-rng-group > a").on("click",function(e){if(e.preventDefault(),!$(this).hasClass("disabled")&&!$(this).hasClass("selected")){$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),i="",o=null;if("red-ui-clipboard-dialog-export-rng-selected"===t){var n=RED.workspaces.selection();0<n.length?(o=[],n.forEach(function(e){o.push(e),o=o.concat(RED.nodes.filterNodes({z:e.id}))})):o=RED.view.selection().nodes||[],o=RED.nodes.createExportableNodeSet(o.filter(function(e){return"subflow"!==e.type}))}else if("red-ui-clipboard-dialog-export-rng-flow"===t){var a=RED.workspaces.active();o=RED.nodes.filterNodes({z:a});var r=RED.nodes.workspace(a)||RED.nodes.subflow(a);o.unshift(r),o=RED.nodes.createExportableNodeSet(o)}else"red-ui-clipboard-dialog-export-rng-full"===t&&(o=RED.nodes.createCompleteNodeSet(!1));null!==o&&(i="red-ui-clipboard-dialog-export-fmt-full"===s?JSON.stringify(o,null,4):JSON.stringify(o)),0<i.length?$("#red-ui-clipboard-dialog-export").removeClass("disabled"):$("#red-ui-clipboard-dialog-export").addClass("disabled"),$("#red-ui-clipboard-dialog-export-text").val(i),setTimeout(function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0)},50),$("#red-ui-clipboard-dialog-export-text").trigger("focus")}}),$("#red-ui-clipboard-dialog-ok").hide(),$("#red-ui-clipboard-dialog-cancel").hide(),$("#red-ui-clipboard-dialog-export").hide();var i=RED.workspaces.selection();0<i.length?$("#red-ui-clipboard-dialog-export-rng-selected").trigger("click"):(i=RED.view.selection()).nodes?$("#red-ui-clipboard-dialog-export-rng-selected").trigger("click"):($("#red-ui-clipboard-dialog-export-rng-selected").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-flow").trigger("click")),"red-ui-clipboard-dialog-export-fmt-full"===s?$("#red-ui-clipboard-dialog-export-fmt-full").trigger("click"):$("#red-ui-clipboard-dialog-export-fmt-mini").trigger("click"),t.activateTab("red-ui-clipboard-dialog-export-tab-"+e),r.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#red-ui-clipboard-dialog-export-text").trigger("focus"),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").show(),$("#red-ui-clipboard-dialog-download").show()}}function v(e,o,t){e.data([{library:o,type:"flows",icon:"fa fa-hdd-o",label:t,path:"",expanded:!0,children:function(t,i){RED.library.loadLibraryFolder(o,"flows","",function(e){i.children=e,t(e)})}}],!0)}function b(){$("#red-ui-drop-target").hide(),RED.keyboard.remove("escape")}return{init:function(){r=$('<div id="red-ui-clipboard-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:700,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{id:"red-ui-clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-clipboard-dialog-download",class:"primary",text:RED._("clipboard.download"),click:function(){var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent($("#red-ui-clipboard-dialog-export-text").val())),e.setAttribute("download","flows.json"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),$(this).dialog("close")}},{id:"red-ui-clipboard-dialog-export",class:"primary",text:RED._("clipboard.export.copy"),click:function(){if("red-ui-clipboard-dialog-export-tab-clipboard"===d)$("#red-ui-clipboard-dialog-export-text").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported"),{id:"clipboard"}),$(this).dialog("close");else{var e=$("#red-ui-clipboard-dialog-export-text").val(),t=l.getSelected();function i(){$.ajax({url:"library/"+t.library+"/"+t.type+"/"+t.path+o,type:"POST",data:e,contentType:"application/json; charset=utf-8"}).done(function(){$(r).dialog("close"),RED.notify(RED._("library.exportedToLibrary"),"success")}).fail(function(e,t,i){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}t.children||(t=t.parent);var o=$("#red-ui-clipboard-dialog-tab-library-name").val().trim();if(t.children){var n=!1;if(t.children.forEach(function(e){e.label===o&&(n=!0)}),n){r.dialog("close");var a=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(o)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.hideNotification(),r.dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){a.hideNotification(),i()}}]})}else i()}else i()}}},{id:"red-ui-clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){var e,t="red-ui-clipboard-dialog-import-opt-new"===$("#red-ui-clipboard-dialog-import-opt > a.selected").attr("id");"red-ui-clipboard-dialog-import-tab-clipboard"===d?RED.view.importNodes($("#red-ui-clipboard-dialog-import-text").val(),t):(e="red-ui-clipboard-dialog-import-tab-library"===d?l.getSelected():a.getSelected()).path&&$.get("library/"+e.library+"/"+e.type+"/"+e.path,function(e){RED.view.importNodes(e,t)}),$(this).dialog("close")}}],close:function(e){f&&(f.close(!0),h=null)}}),o=r.children(".dialog-form"),n='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="common.label.export"></label><span id="red-ui-clipboard-dialog-export-rng-group" class="button-group"><a id="red-ui-clipboard-dialog-export-rng-selected" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="red-ui-clipboard-dialog-export-rng-flow" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-export-rng-full" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="red-ui-clipboard-dialog-box"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-export-tabs"></ul></div><div id="red-ui-clipboard-dialog-export-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-export-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div class="form-row"><textarea readonly id="red-ui-clipboard-dialog-export-text"></textarea></div><div class="form-row" style="text-align: right;"><span id="red-ui-clipboard-dialog-export-fmt-group" class="button-group"><a id="red-ui-clipboard-dialog-export-fmt-mini" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="red-ui-clipboard-dialog-export-fmt-full" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div></div><div id="red-ui-clipboard-dialog-export-tab-library" class="red-ui-clipboard-dialog-tab-library"><div id="red-ui-clipboard-dialog-export-tab-library-browser"></div><div class="form-row"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-clipboard-dialog-tab-library-name" type="text"></div></div></div></div>',i='<div class="red-ui-clipboard-dialog-box" style="margin-bottom: 12px"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-import-tabs"></ul></div><div id="red-ui-clipboard-dialog-import-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-import-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div class="form-row"><span data-i18n="clipboard.pasteNodes"></span> <a class="red-ui-button" id="red-ui-clipboard-dialog-import-file-upload-btn"><i class="fa fa-upload"></i> <span data-i18n="clipboard.selectFile"></span></a><input type="file" id="red-ui-clipboard-dialog-import-file-upload" accept=".json" style="display:none"></div><div class="form-row"><textarea id="red-ui-clipboard-dialog-import-text"></textarea></div></div><div id="red-ui-clipboard-dialog-import-tab-library" class="red-ui-clipboard-dialog-tab-library"></div><div id="red-ui-clipboard-dialog-import-tab-examples" class="red-ui-clipboard-dialog-tab-library"></div></div></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="red-ui-clipboard-dialog-import-opt" class="button-group"><a id="red-ui-clipboard-dialog-import-opt-current" class="red-ui-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-import-opt-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',$('<input type="text" id="red-ui-clipboard-hidden" tabIndex="-1">').appendTo("#red-ui-editor"),RED.actions.add("core:show-export-dialog",g),RED.actions.add("core:show-import-dialog",u),RED.actions.add("core:show-library-export-dialog",function(){g("library")}),RED.actions.add("core:show-library-import-dialog",function(){u("library")}),RED.events.on("editor:open",function(){c=!0}),RED.events.on("editor:close",function(){c=!1}),RED.events.on("search:open",function(){c=!0}),RED.events.on("search:close",function(){c=!1}),RED.events.on("actionList:open",function(){c=!0}),RED.events.on("actionList:close",function(){c=!1}),RED.events.on("type-search:open",function(){c=!0}),RED.events.on("type-search:close",function(){c=!1}),$('<div id="red-ui-drop-target"><div data-i18n="[append]workspace.dropFlowHere"><i class="fa fa-download"></i><br></div></div>').appendTo("#red-ui-editor"),$("#red-ui-workspace-chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#red-ui-drop-target").css({display:"table"}),RED.keyboard.add("*","escape",b))}),$("#red-ui-drop-target").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){b()}).on("drop",function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t)}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var i=e.originalEvent.dataTransfer.files;if(1===i.length){var o=i[0],n=new FileReader;n.onload=function(e){RED.view.importNodes(e.target.result)},n.readAsText(o)}}b(),e.preventDefault()})},import:u,export:g,copyText:function(e,t,i){var o=!1;"string"!=typeof e&&(e=JSON.stringify(e,function(e,t){if(null!==t&&"object"==typeof t&&t.__enc__){if(t.hasOwnProperty("data")&&t.hasOwnProperty("length"))return o=t.data.length!==t.length,t.data;if("function"===t.type||"internal"===t.type)return;if("number"===t.type)return null}return t})),o&&(i+="_truncated"),$("#red-ui-clipboard-hidden").val(e).select();var n=document.execCommand("copy");if(n&&t){var a=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(i)});setTimeout(function(){a.close()},1e3),a.open()}return n}}}(),RED.library=function(){var o,c,a,p,e;function r(o,n,a,i){$.getJSON("library/"+o+"/"+n+"/"+a,function(e){var t=e.map(function(e){return"string"==typeof e?{library:o,type:n,icon:"fa fa-folder",label:e,path:a+e+"/",children:function(t,i){r(o,n,a+e+"/",function(e){i.children=e,t(e)})}}:{library:o,type:n,icon:"fa fa-file-o",label:e.fn,path:a+e.fn,props:e}});t.sort(function(e,t){return e.children&&!t.children?-1:!e.children&&t.children?1:e.label.localeCompare(t.label)}),i(t)})}function t(t){e&&clearTimeout(e),e=setTimeout(function(){var e=t.val().trim();0<e.length&&!/[\/\\]/.test(e)?(t.removeClass("input-error"),$("#red-ui-library-dialog-save-button").button("enable")):(t.addClass("input-error"),$("#red-ui-library-dialog-save-button").button("disable"))},100)}return{init:function(){$('<div id="red-ui-library-dialog-save" class="hide"><form class="form-horizontal"><div style="height: 400px; position:relative; "><div id="red-ui-library-dialog-save-browser"></div><div class="form-row"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-library-dialog-save-filename" type="text"></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$('<div id="red-ui-library-dialog-load" class="hide"><form class="form-horizontal"><div style="height: 400px; position:relative; "><div id="red-ui-library-dialog-load-panes"><div class="red-ui-panel" id="red-ui-library-dialog-load-browser"></div><div class="red-ui-panel"><div id="red-ui-library-dialog-load-preview"><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-text"></div><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-details"><table id="red-ui-library-dialog-load-preview-details-table" class="red-ui-info-table"></table></div></div></div></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$("#red-ui-library-dialog-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:800,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-library-dialog-save-button",text:RED._("common.label.save"),class:"primary",click:function(){!function(){var e=p.elementPrefix||"node-input-",t=$("#"+e+"name").val().trim();""===t&&(t=RED._("library.unnamedType",{type:p.type}));var i=$("#red-ui-library-dialog-save-filename").val().trim(),o=c.getSelected();o.children||(o=o.parent);for(var n={},a=0;a<p.fields.length;a++){var r=p.fields[a];"name"==r?n.name=t:n[r]=$("#"+e+r).val()}function s(){$.ajax({url:"library/"+o.library+"/"+o.type+"/"+o.path+i,type:"POST",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"}).done(function(e,t,i){RED.notify(RED._("library.savedType",{type:p.type}),"success")}).fail(function(e,t,i){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}if(n.text=p.editor.getValue(),o.children){var d=!1;if(o.children.forEach(function(e){e.label===i&&(d=!0)}),d){$("#red-ui-library-dialog-save").dialog("close");var l=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(i)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){l.hideNotification(),$("#red-ui-library-dialog-save").dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){l.hideNotification(),s()}}]})}else s()}else s()}(),$(this).dialog("close")}}]}),c=RED.library.createBrowser({container:$("#red-ui-library-dialog-save-browser"),folderTools:!0,onselect:function(e){e.label&&(e.children||($("#red-ui-library-dialog-save-filename").val(e.label),e=e.parent),!1===e.writable?$("#red-ui-library-dialog-save-button").button("disable"):$("#red-ui-library-dialog-save-button").button("enable"))}}),$("#red-ui-library-dialog-save-filename").on("keyup",function(){t($(this))}),$("#red-ui-library-dialog-save-filename").on("paste",function(){var e=$(this);setTimeout(function(){t(e)},10)}),$("#red-ui-library-dialog-load").dialog({modal:!0,autoOpen:!1,width:800,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(selectedLibraryItem){for(var e=p.elementPrefix||"node-input-",t=0;t<p.fields.length;t++){var i=p.fields[t];$("#"+e+i).val(selectedLibraryItem[i])}p.editor.setValue(a.getValue(),-1)}$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){a&&(a.destroy(),a=null)}}),o=RED.library.createBrowser({container:$("#red-ui-library-dialog-load-browser"),onselect:function(o){var n=$("#red-ui-library-dialog-load-preview-details-table").empty();selectedLibraryItem=o.props,o&&o.label&&!o.children?$.get("library/"+o.library+"/"+o.type+"/"+o.path,function(e){var t=$('<tr class="red-ui-help-info-row"><td>Type</td><td></td></tr>').appendTo(n);for(var i in $(t.children()[1]).text(p.type),o.props.hasOwnProperty("name")&&(t=$('<tr class="red-ui-help-info-row"><td>Name</td><td>'+o.props.name+"</td></tr>").appendTo(n),$(t.children()[1]).text(o.props.name)),o.props)o.props.hasOwnProperty(i)&&"name"!==i&&"fn"!==i&&(t=$('<tr class="red-ui-help-info-row"><td></td><td></td></tr>').appendTo(n),$(t.children()[0]).text(i),RED.utils.createObjectElement(o.props[i]).appendTo(t.children()[1]));a.setValue(e,-1)}):a.setValue("",-1)}}),RED.panels.create({container:$("#red-ui-library-dialog-load-panes"),dir:"horizontal",resize:function(){a.resize()}}),RED.panels.create({container:$("#red-ui-library-dialog-load-preview"),dir:"vertical",resize:function(){a.resize()}})},create:function(i){var t=i.elementPrefix||"node-input-";i.editor.setText&&(i.editor.setValue=function(e,t){i.editor.setText.call(i.editor,e)}),i.editor.getText&&(i.editor.getValue=i.editor.getText),$("#"+t+"name").css("width","calc(100% - 52px)").after('<div style="margin-left:5px; display: inline-block;position: relative;"><a id="node-input-'+i.type+'-lookup" class="red-ui-button"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a></div>'),RED.menu.init({id:"node-input-"+i.type+"-lookup",options:[{id:"node-input-"+i.type+"-menu-open-library",label:RED._("library.openLibrary"),onselect:function(){r("local",(p=i).url,"",function(e){var t=[{library:"local",type:i.url,icon:"fa fa-hdd-o",label:RED._("library.types.local"),path:"",expanded:!0,writable:!1,children:[{library:"local",type:i.url,icon:"fa fa-cube",label:i.type,path:"",expanded:!0,children:e}]}];o.data(t),setTimeout(function(){o.select(t[0].children[0])},200)}),(a=ace.edit("red-ui-library-dialog-load-preview-text",{useWorker:!1})).setTheme("ace/theme/tomorrow"),i.mode&&a.getSession().setMode(i.mode),a.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),a.renderer.$cursorLayer.element.style.opacity=0,a.$blockScrolling=1/0,$("#red-ui-library-dialog-load").dialog("option","title",RED._("library.typeLibrary",{type:i.type})).dialog("open")}},{id:"node-input-"+i.type+"-menu-save-library",label:RED._("library.saveToLibrary"),onselect:function(){p=i;var e=$("#"+t+"name").val().replace(/(^\s*)|(\s*$)/g,"").replace(/[^\w-]/g,"-");""===e&&(e="unnamed-"+i.type),$("#red-ui-library-dialog-save-filename").attr("value",e+"."+(i.ext||"txt")),r("local",i.url,"",function(e){var t=[{library:"local",type:i.url,icon:"fa fa-hdd-o",label:RED._("library.types.local"),path:"",expanded:!0,writable:!1,children:[{library:"local",type:i.url,icon:"fa fa-cube",label:i.type,path:"",expanded:!0,children:e}]}];c.data(t),setTimeout(function(){c.select(t[0].children[0])},200)}),$("#red-ui-library-dialog-save").dialog("open")}}]})},createBrowser:function(i){var e=$('<div class="red-ui-library-browser"></div>').appendTo(i.container),o=$("<div>").css({width:"100%",height:"100%"}).appendTo(e).treeList({}).on("treelistselect",function(e,t){i.onselect&&i.onselect(t)}).on("treelistconfirm",function(e,t){i.onconfirm&&i.onconfirm(t)}),n=$("<div>").css({position:"absolute",bottom:"6px",right:"8px"}),a=$('<button class="red-ui-button red-ui-button-small" type="button"><i class="fa fa-ellipsis-h"></i></button>').on("click",function(e){e.preventDefault(),e.stopPropagation();var t=a.offset(),i=RED.menu.init({id:"red-ui-library-browser-menu",options:[{id:"red-ui-library-browser-menu-addFolder",label:RED._("library.newFolder"),onselect:function(){var i="new-folder",r={},s=o.treeList("selected");s.children||(s=s.parent);s.treeList.expand(function(){s.children.forEach(function(e){/^new-folder/.test(e.label)&&(r[e.label]=!0)});for(var e=2;r[i];)i="new-folder-"+e++;s.treeList.expand();function t(){var e=o.val().trim();if(""!==e){for(var t=0;t<s.children.length;t++)if(s.children[t].label===e)return void a();n.treeList.remove();var i={library:s.library,type:s.type,icon:"fa fa-folder",children:[],label:e,path:n.path+e+"/"};s.treeList.addChild(i,!0)}else a()}var o=$('<input type="text" class="red-ui-treeList-input">').val(i),n={icon:"fa fa-folder-o",children:[],path:s.path,element:o},a=function(){n.treeList.remove()};o.on("keydown",function(e){e.stopPropagation(),13===e.keyCode?t():27===e.keyCode&&a()}),o.on("blur",function(){t()}),s.treeList.addChild(n),setTimeout(function(){o.trigger("focus"),o.select()},400)})}}]}).on("mouseleave",function(){$(this).remove(),o.focus()}).on("mouseup",function(){var e=$(this);e.hide(),o.focus(),setTimeout(function(){e.remove()},100)}).appendTo("body");i.css({position:"absolute",top:t.top+"px",left:t.left-i.width()+20+"px"}).show()}).appendTo(n);return i.folderTools&&o.on("treelistselect",function(e,t){!1!==t.writable&&t.treeList&&n.appendTo(t.treeList.label)}),{select:function(e){o.treeList("select",e)},getSelected:function(){return o.treeList("selected")},focus:function(){o.focus()},data:function(e,t){o.treeList("data",e),t&&setTimeout(function(){o.treeList("select",e[0])},100)}}},export:function(){console.warn("Deprecated call to RED.library.export")},loadLibraryFolder:r}}(),RED.notifications=function(){var b,m={},y=[],w=0;function e(e,t,i,o){var n={};if(null!==t&&"object"==typeof t&&(i=(n=t).fixed,o=n.timeout,t=n.type),n.id&&m.hasOwnProperty(n.id))return m[n.id].update(e,n),m[n.id];if(n.modal&&$("#red-ui-full-shade").show(),4<y.length)for(var a=y.length,r=0;4<a&&r<y.length;r+=1){var s=y[r];s.fixed||(window.clearTimeout(s.timeoutid),s.close(),a-=1)}var d,l,c,p,u,f=document.createElement("div");if(f.id="red-ui-notification-"+w,f.className="red-ui-notification",f.fixed=i,t&&(f.className="red-ui-notification red-ui-notification-"+t),n.width){var h=$("#red-ui-notifications").width();if(n.width>h){var g=-(n.width-h)/2;$(f).css({width:n.width+"px",marginLeft:g+"px"})}}if(f.style.display="none","string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),f.innerHTML=e):$(f).append(e),n.buttons){var v=$('<div class="ui-dialog-buttonset"></div>').appendTo(f);n.buttons.forEach(function(e){var t=$("<button>").html(e.text).on("click",e.click).appendTo(v);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}return $("#red-ui-notifications").append(f),RED.notifications.hide||$(f).slideDown(300),f.close=(d=f,function(){d.closed||(d.closed=!0,y.splice(y.indexOf(d),1),n.id&&(delete m[n.id],0===Object.keys(m).length&&b.hide()),RED.notifications.hide?d.parentNode.removeChild(d):$(d).slideUp(300,function(){d.parentNode.removeChild(d)}),n.modal&&$("#red-ui-full-shade").hide())}),f.hideNotification=(l=f,function(){l.closed||(l.hidden=!0,RED.notifications.hide||$(l).slideUp(300))}),f.showNotification=(c=f,function(){!c.closed&&c.hidden&&(c.hidden=!1,RED.notifications.hide||$(c).slideDown(300))}),f.update=(p=f,function(e,t){var i;if("string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),p.innerHTML=e):$(p).empty().append(e),"number"==typeof t)i=t;else if(void 0!==t&&(t.fixed||(i=t.timeout||5e3),t.buttons)){var o=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(p);t.buttons.forEach(function(e){var t=$("<button>").text(e.text).on("click",e.click).appendTo(o);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}void 0!==i&&0<i?(window.clearTimeout(p.timeoutid),p.timeoutid=window.setTimeout(p.close,i)):window.clearTimeout(p.timeoutid),p.hidden?p.showNotification():t&&t.silent||($(p).addClass("red-ui-notification-shake-horizontal"),setTimeout(function(){$(p).removeClass("red-ui-notification-shake-horizontal")},300))}),i||($(f).on("click",(u=f,function(){u.close(),window.clearTimeout(u.timeoutid)})),f.timeoutid=window.setTimeout(f.close,o||5e3)),y.push(f),n.id&&(m[n.id]=f,n.fixed&&b.show()),w+=1,f}return{init:function(){$('<div id="red-ui-notifications"></div>').appendTo("#red-ui-editor"),b=$("<li></li>").prependTo(".red-ui-header-toolbar").hide(),$('<a class="button" href="#"><i class="fa fa-warning"></i></a>').appendTo(b).on("click",function(){!function(){for(var e in m)m.hasOwnProperty(e)&&m[e].showNotification()}()})},notify:RED.notify=e}}(),RED.search=function(){var o,u,t,n=!1,a=null,c=-1,r=!1,p={},f=[],h=[];function s(t,i,e){if("string"==typeof e||"number"==typeof e)e=(""+e).toLowerCase(),p[e]=p[e]||{},p[e][t.id]={node:t,label:i};else if(Array.isArray(e))e.forEach(function(e){s(t,i,e)});else if("object"==typeof e)for(var o in e)e.hasOwnProperty(o)&&s(t,i,e[o])}function d(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),p[t]=p[t]||{},p[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var i=["id","type","name","label","info"];e._def&&e._def.defaults&&(i=i.concat(Object.keys(e._def.defaults)));for(var o=0;o<i.length;o++)e.hasOwnProperty(i[o])&&s(e,t,e[i[o]])}function l(){var e=u.find("li.selected");if(1===e.length){var t=u.parent(),i=t.height(),o=(t.scrollTop(),e.position().top),n=e.height();i<o+n?t.animate({scrollTop:"-="+(i-(o+n)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function g(){a=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#red-ui-main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(a);(o=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(e).searchBox({delay:200,change:function(){!function(e){var t;u.editableList("empty");var i=/(?:^| )type:([^ ]+)/.exec(e);if(i&&(e=e.replace(/(?:^| )type:[^ ]+/,""),t=i[1]),e=e.trim(),c=-1,h=[],0<e.length||t){var o,n;e=e.toLowerCase();var a=[],r={};for(o=0;o<f.length;o++){var s=f[o],d=f[o].indexOf(e);if(-1<d)for(n=0;n<p[s].length;n++){var l=p[s][n];t&&l.node.type!==t||(r[l.node.id]=r[l.node.id]=l,r[l.node.id].index=Math.min(r[l.node.id].index||1/0,d))}}for((a=Object.keys(r)).sort(function(e,t){return r[e].index-r[t].index}),o=0;o<a.length;o++)h.push(r[a[o]]);if(0<h.length){for(o=0;o<Math.min(h.length,25);o++)u.editableList("addItem",h[o]);25<h.length&&u.editableList("addItem",{more:{results:h,start:25}})}else u.editableList("addItem",{})}}($(this).val())}})).on("keydown",function(e){var t;if(0<h.length)if(40===e.keyCode)t=u.children(),c<t.length-1&&(-1<c&&$(t[c]).removeClass("selected"),c++),$(t[c]).addClass("selected"),l(),e.preventDefault();else if(38===e.keyCode)t=u.children(),0<c&&(c<t.length&&$(t[c]).removeClass("selected"),c--),$(t[c]).addClass("selected"),l(),e.preventDefault();else if(13===e.keyCode)if(t=u.children(),$(t[c]).hasClass("red-ui-search-more")){var o=$(t[c]).find(".red-ui-editableList-item-content").data("data");if(o){for(u.editableList("removeItem",o),i=o.more.start;i<Math.min(h.length,o.more.start+25);i++)u.editableList("addItem",h[i]);h.length>o.more.start+25&&u.editableList("addItem",{more:{results:h,start:o.more.start+25}})}}else 0<h.length&&v(h[Math.max(0,c)].node)}),o.i18n();var t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(a);u=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,i){var o,n=i.node;if(i.more)e.parent().addClass("red-ui-search-more"),(o=$("<a>",{href:"#",class:"red-ui-search-result red-ui-search-empty"}).appendTo(e)).text(RED._("palette.editor.more",{count:i.more.results.length-i.more.start})),o.on("click",function(e){for(e.preventDefault(),u.editableList("removeItem",i),t=i.more.start;t<Math.min(h.length,i.more.start+25);t++)u.editableList("addItem",h[t]);h.length>i.more.start+25&&u.editableList("addItem",{more:{results:h,start:i.more.start+25}})});else if(void 0===n)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{var a=n._def;o=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e);var r=$("<div>",{class:"red-ui-search-result-node"}).appendTo(o),s=RED.utils.getNodeColor(n.type,a),d=RED.utils.getNodeIcon(a,n);"tab"===n.type&&(s="#C0DEED"),r.css("backgroundColor",s);var l=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(r);RED.utils.createIconElement(d,l,!0);var c=$("<div>",{class:"red-ui-search-result-node-description"}).appendTo(o);if(n.z){var p=RED.nodes.workspace(n.z);p=p?"flow:"+p.label:"subflow:"+(p=RED.nodes.subflow(n.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).text(p).appendTo(c)}$("<div>",{class:"red-ui-search-result-node-label"}).text(i.label||n.id).appendTo(c),$("<div>",{class:"red-ui-search-result-node-type"}).text(n.type).appendTo(c),$("<div>",{class:"red-ui-search-result-node-id"}).text(n.id).appendTo(c),o.on("click",function(e){e.preventDefault(),v(n)})}},scrollOnAdd:!1})}function v(e){b(),RED.view.reveal(e.id)}function e(e){n||(r||(t=document.activeElement,RED.keyboard.add("*","escape",function(){b()}),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),p={},RED.nodes.eachWorkspace(d),RED.nodes.eachSubflow(d),RED.nodes.eachConfig(d),RED.nodes.eachNode(d),(f=Object.keys(p)).sort(),f.forEach(function(t){p[t]=Object.keys(p[t]).map(function(e){return p[t][e]})}),null===a&&g(),a.slideDown(300),o.searchBox("value",e),RED.events.emit("search:open"),r=!0),o.trigger("focus"))}function b(){r&&(RED.keyboard.remove("escape"),r=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==a&&a.slideUp(200,function(){o.searchBox("value","")}),RED.events.emit("search:close"),t&&($(t).trigger("focus"),t=null))}return{init:function(){RED.actions.add("core:search",e),RED.events.on("editor:open",function(){n=!0}),RED.events.on("editor:close",function(){n=!1}),RED.events.on("type-search:open",function(){n=!0}),RED.events.on("type-search:close",function(){n=!1}),RED.events.on("actionList:open",function(){n=!0}),RED.events.on("actionList:close",function(){n=!1}),$("#red-ui-header-shade").on("mousedown",b),$("#red-ui-editor-shade").on("mousedown",b),$("#red-ui-palette-shade").on("mousedown",b),$("#red-ui-sidebar-shade").on("mousedown",b)},show:e,hide:b}}(),RED.actionList=function(){var o,a,n,r=!1,s=null,d=!1,l="",c=[];function p(){var e=a.find("li.selected");if(1===e.length){var t=a.parent(),i=t.height(),o=(t.scrollTop(),e.position().top),n=e.height();i<o+n?t.animate({scrollTop:"-="+(i-(o+n)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function u(e){f(),e&&RED.actions.invoke(e.id)}function e(e){if(!r){if(!d){n=document.activeElement,RED.keyboard.add("*","escape",function(){f()}),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),null===s&&function(){s=$("<div>",{id:"red-ui-actionList",class:"red-ui-search"}).appendTo("#red-ui-main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(s);(o=$('<input type="text" data-i18n="[placeholder]keyboard.filterActions">').appendTo(e).searchBox({change:function(){l=$(this).val().trim(),c=l.split(" "),a.editableList("filter"),a.find("li.selected").removeClass("selected");var e=a.children(":visible");e.length&&$(e[0]).addClass("selected")}})).on("keydown",function(e){var t;if(40===e.keyCode){if((t=a.find("li.selected")).length){(o=t.nextAll(":visible").first()).length&&(t.removeClass("selected"),o.addClass("selected"))}else{var i=a.children(":visible");i.length&&$(i[0]).addClass("selected")}p(),e.preventDefault()}else if(38===e.keyCode){var o;(o=(t=a.find("li.selected")).prevAll(":visible").first()).length&&(t.removeClass("selected"),o.addClass("selected")),p(),e.preventDefault()}else 13===e.keyCode&&(t=a.find("li.selected"),u(a.editableList("getItem",t)))}),o.i18n();var t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(s);a=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,i){if(void 0===i.id)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{var o=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),n=$("<div>",{class:"red-ui-search-result-action"}).appendTo(o);$("<div>").text(i.label).appendTo(n),i.key&&$("<div>",{class:"red-ui-search-result-action-key"}).html(RED.keyboard.formatKey(i.key)).appendTo(n),o.on("click",function(e){e.preventDefault(),u(i)})}},scrollOnAdd:!1,filter:function(e){if(""===l)return!0;for(var t=0,i=0;i<c.length;i++){var o=e._label.indexOf(c[i],t);if(!(-1<o))return!1;t=o}return!0}})}(),s.slideDown(300),o.searchBox("value",e),a.editableList("empty"),results=[];var t=RED.actions.list();t.sort(function(e,t){return e.id.localeCompare(t.id)}),t.forEach(function(e){e.label=e.id.replace(/:/,": ").replace(/-/g," ").replace(/(^| )./g,function(){return arguments[0].toUpperCase()}),e._label=e.label.toLowerCase(),a.editableList("addItem",e)}),RED.events.emit("actionList:open"),d=!0}o.trigger("focus");var i=a.children(":visible");i.length&&$(i[0]).addClass("selected")}}function f(){d&&(RED.keyboard.remove("escape"),d=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==s&&s.slideUp(200,function(){o.searchBox("value","")}),RED.events.emit("actionList:close"),n&&($(n).trigger("focus"),n=null))}return{init:function(){RED.actions.add("core:show-action-list",e),RED.events.on("editor:open",function(){r=!0}),RED.events.on("editor:close",function(){r=!1}),RED.events.on("search:open",function(){r=!0}),RED.events.on("search:close",function(){r=!1}),RED.events.on("type-search:open",function(){r=!0}),RED.events.on("type-search:close",function(){r=!1}),$("#red-ui-header-shade").on("mousedown",f),$("#red-ui-editor-shade").on("mousedown",f),$("#red-ui-palette-shade").on("mousedown",f),$("#red-ui-sidebar-shade").on("mousedown",f)},show:e,hide:f}}(),RED.typeSearch=function(){var d,l,t,n,i,o,a=null,c=-1,r=!1,s="",p={};function u(){var e=l.find("li.selected");if(1===e.length){var t=l.parent(),i=t.height(),o=(t.scrollTop(),e.position().top),n=e.height();i<o+n?t.animate({scrollTop:"-="+(i-(o+n)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function f(e,t){var i=a.position();i.top=i.top+t+"px",i.left=i.left+e+"px",a.css(i),o(e,t)}function h(){a=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#red-ui-main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(a);(d=$('<input type="text" id="red-ui-type-search-input">').attr("placeholder",RED._("search.addNode")).appendTo(e).searchBox({delay:50,change:function(){!function(e){s=e.toLowerCase(),l.editableList("filter"),l.editableList("sort"),setTimeout(function(){c=0,l.children().removeClass("selected"),l.children(":visible:first").addClass("selected")},100)}($(this).val())}})).on("keydown",function(e){var t=l.children(":visible");if(40===e.keyCode&&e.shiftKey)e.preventDefault(),f(0,10);else if(38===e.keyCode&&e.shiftKey)e.preventDefault(),f(0,-10);else if(39===e.keyCode&&e.shiftKey)e.preventDefault(),f(10,0);else if(37===e.keyCode&&e.shiftKey)e.preventDefault(),f(-10,0);else if(0<t.length){if(40===e.keyCode)c<t.length-1&&(-1<c&&$(t[c]).removeClass("selected"),c++),$(t[c]).addClass("selected"),u(),e.preventDefault();else if(38===e.keyCode)0<c&&(c<t.length&&$(t[c]).removeClass("selected"),c--),$(t[c]).addClass("selected"),u(),e.preventDefault();else if((e.metaKey||e.ctrlKey)&&13===e.keyCode){if(e.preventDefault(),(o=Math.max(0,c))<t.length){var i=$(t[o]).find(".red-ui-editableList-item-content").data("data");p[i.type]=Date.now(),0===i.def.outputs?g(i):n(i.type,!0),$("#red-ui-type-search-input").val("").trigger("keyup"),setTimeout(function(){$("#red-ui-type-search-input").focus()},100)}}else if(13===e.keyCode){var o;e.preventDefault(),(o=Math.max(0,c))<t.length&&g($(t[o]).find(".red-ui-editableList-item-content").data("data"))}}else 13===e.keyCode&&(e.stopPropagation(),e.preventDefault())}),t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(a),l=$("<ol>",{style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(t).editableList({addButton:!1,filter:function(e){return""===s||!e.recent&&!e.common&&(""===s||-1<e.index.indexOf(s))},sort:function(e,t){if(""===s)return e.i-t.i;var i=e.index.indexOf(s),o=t.index.indexOf(s);return-1===i?1:-1===o?-1:i===o?y(e,t):i-o},addItem:function(e,t,i){var o=i.def;i.index=i.type.toLowerCase(),i.separator&&e.addClass("red-ui-search-result-separator");var n=$("<div>",{class:"red-ui-search-result"}).appendTo(e),a=$("<div>",{class:"red-ui-search-result-node"}).appendTo(n),r=RED.utils.getNodeColor(i.type,o),s=RED.utils.getNodeIcon(o);a.css("backgroundColor",r);var d=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(a);RED.utils.createIconElement(s,d,!1),0<o.inputs&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(a),0<o.outputs&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(a);var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(n),c=i.label;i.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).text(c).appendTo(l),n.on("click",function(e){e.preventDefault(),g(i)})},scrollOnAdd:!1})}function g(e){b(),p[e.type]=Date.now(),n(e.type)}function v(e){if(r){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}b(!0),i&&i()}}function b(e){r&&(RED.keyboard.remove("escape"),r=!1,null!==a&&t.slideUp(e?50:200,function(){a.hide(),d.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"))}function m(t,e){var i=t;if(void 0!==e.paletteLabel)try{i=("function"==typeof e.paletteLabel?e.paletteLabel.call(e):e.paletteLabel)||"",i+=" ("+t+")"}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}return i}function y(e,t){var i=e.label.toLowerCase(),o=t.label.toLowerCase();return i<o?-1:i===o?0:1}function w(e,t,i){return!e||(!e.type||t===e.type)&&(!e.input||0<i.inputs)&&(!e.output||0<i.outputs)}function D(t){var e;l.editableList("empty"),d.searchBox("value","").focus(),c=-1;var i=["inject","debug","function","change","switch"].filter(function(e){return w(t.filter,e,RED.nodes.getType(e))}),o=Object.keys(p);o.sort(function(e,t){return p[t]-p[e]}),o=o.filter(function(e){return w(t.filter,e,RED.nodes.getType(e))&&-1===i.indexOf(e)});var n=[];RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&n.push({type:e,def:t,label:m(e,t)})}),n.sort(y);var a,r=0;for(e=0;e<i.length;e++){var s=RED.nodes.getType(i[e]);s&&((a={type:i[e],common:!0,def:s,i:r++}).label=m(a.type,a.def),e===i.length-1&&(a.separator=!0),l.editableList("addItem",a))}for(e=0;e<Math.min(5,o.length);e++)(a={type:o[e],def:RED.nodes.getType(o[e]),recent:!0,i:r++}).label=m(a.type,a.def),e===o.length-1&&(a.separator=!0),l.editableList("addItem",a);for(e=0;e<n.length;e++)w(t.filter,n[e].type,n[e].def)&&(n[e].i=r++,l.editableList("addItem",n[e]));setTimeout(function(){c=0,l.children(":first").addClass("selected")},100)}return{show:function(e){r?(a.hide(),t.hide()):(RED.keyboard.add("*","escape",function(){b(),i&&i()}),null===a&&h(),r=!0),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"),setTimeout(function(){$(document).on("mousedown.red-ui-type-search",v),$(document).on("mouseup.red-ui-type-search",v),$(document).on("click.red-ui-type-search",v)},200),D(e),n=e.add,i=e.cancel,o=e.move,RED.events.emit("type-search:open"),$("#red-ui-main-container").height()-e.y-150<0&&(e.y=e.y-235),a.css({left:e.x+"px",top:e.y+"px"}).show(),t.slideDown(300),setTimeout(function(){t.find(".red-ui-editableList-container").scrollTop(0),d.trigger("focus")},100)},refresh:D,hide:b}}(),RED.subflow=function(){var m="en-US";function s(e,t){var i={x:50,y:30};t||(i.x+=110);var o=[].concat(e.out).concat(e.in);e.status&&o.push(e.status),o.sort(function(e,t){return e.x-t.x});for(var n=0;n<o.length;n++){var a=o[n];a.x==i.x&&a.y==i.y&&(i.x+=55)}return i}function r(){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.in.length){var i=t.in[0],o=[];return RED.nodes.eachLink(function(e){"subflow"==e.source.type&&e.source.z==t.id&&e.source.i==i.i?o.push(e):e.target.type=="subflow:"+t.id&&o.push(e)}),o.forEach(function(e){RED.nodes.removeLink(e)}),t.in=[],$("#red-ui-subflow-input-add").removeClass("active"),$("#red-ui-subflow-input-remove").addClass("active"),t.changed=!0,RED.palette.refresh(),{subflowInputs:[i],links:o}}}function d(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var o=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var n=e[i];t.out.splice(n.i,1);var a=[],r=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==n.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==n.i?a.push(e):e.sourcePort>n.i&&r.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),r.forEach(function(e){e.sourcePort--}),o=o.concat(a);for(var s=n.i;s<t.out.length;s++)t.out[s].i--,t.out[s].dirty=!0}return t.changed=!0,RED.palette.refresh(),{subflowOutputs:e,links:o}}}function l(){var t=RED.nodes.subflow(RED.workspaces.active());if(t.status){var i=[];return RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&"status"==e.target.direction&&i.push(e)}),i.forEach(function(e){RED.nodes.removeLink(e)}),delete t.status,$("#red-ui-subflow-status").prop("checked",!!t.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!t.status),{links:i}}}function c(t){var i=RED.nodes.subflow(RED.workspaces.active());n(i);var o=[];if(i)return RED.nodes.filterNodes({type:"subflow:"+i.id}).forEach(function(e){for(o.push({id:e.id,changed:e.changed}),t&&(e.changed=!0),e.inputs=i.in.length,e.outputs=i.out.length;e.outputs<e.ports.length;)e.ports.pop();e.resize=!0,e.dirty=!0,RED.editor.updateNodeProperties(e)}),RED.editor.validateNode(i),{instances:o}}function n(e){e&&($("#red-ui-subflow-input-add").toggleClass("active",0!==e.in.length),$("#red-ui-subflow-input-remove").toggleClass("active",0===e.in.length),$("#red-ui-subflow-output .spinner-value").text(e.out.length),$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status))}function o(a){var e=$("#red-ui-workspace-toolbar");e.empty(),$('<a class="button" id="red-ui-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="red-ui-subflow-input-remove" class="button active" href="#">0</a><a id="red-ui-subflow-input-add" class="button" href="#">1</a></div>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="red-ui-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="red-ui-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="red-ui-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(e),$('<span class="button-group"><span class="button" style="padding:0"><label for="red-ui-subflow-status"><input id="red-ui-subflow-status" type="checkbox"> <span data-i18n="subflow.status"></span></label></span></span>').appendTo(e),$('<a class="button" id="red-ui-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(e),e.i18n(),$("#red-ui-subflow-output-remove").on("click",function(e){e.preventDefault();var t=RED.nodes.dirty(),i=a.changed,o=d();if(o){var n=c(!0);RED.history.push({t:"delete",links:o.links,subflowOutputs:o.subflowOutputs,changed:i,dirty:t,subflow:{instances:n.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#red-ui-subflow-output-add").on("click",function(e){e.preventDefault(),function(){var e=RED.nodes.subflow(RED.workspaces.active()),t=s(e,!1),i={type:"subflow",direction:"out",z:e.id,i:e.out.length,x:t.x,y:t.y,id:RED.nodes.id()},o=e.out.length;e.out.push(i),e.dirty=!0;var n=RED.nodes.dirty(),a=e.changed;e.changed=!0;var r={t:"edit",node:e,dirty:n,changed:a,subflow:{outputCount:o,instances:c(!0).instances}};RED.history.push(r),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-output .spinner-value").text(e.out.length),RED.palette.refresh()}()}),$("#red-ui-subflow-input-add").on("click",function(e){e.preventDefault(),function(){var e=RED.nodes.subflow(RED.workspaces.active());if(1!==e.in.length){var t=s(e,!0),i={type:"subflow",direction:"in",z:e.id,i:e.in.length,x:t.x,y:t.y,id:RED.nodes.id()},o=e.in.length;e.in.push(i),e.dirty=!0;var n=RED.nodes.dirty(),a=e.changed;e.changed=!0;var r={t:"edit",node:e,dirty:n,changed:a,subflow:{inputCount:o,instances:c(!0).instances}};RED.history.push(r),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-input-add").addClass("active"),$("#red-ui-subflow-input-remove").removeClass("active"),RED.palette.refresh()}}()}),$("#red-ui-subflow-input-remove").on("click",function(e){e.preventDefault();var t=RED.nodes.dirty(),i=a.changed;a.changed=!0;var o=r();if(o){var n=c(!0);RED.history.push({t:"delete",links:o.links,changed:i,subflowInputs:o.subflowInputs,dirty:t,subflow:{instances:n.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#red-ui-subflow-status").on("change",function(e){if(this.checked)!function(){var e=RED.nodes.subflow(RED.workspaces.active());if(!e.status){var t=s(e,!1),i={type:"subflow",direction:"status",z:e.id,x:t.x,y:t.y,id:RED.nodes.id()};e.status=i,e.dirty=!0;var o=RED.nodes.dirty(),n=e.changed,a=(c(e.changed=!0),{t:"edit",node:e,dirty:o,changed:n,subflow:{status:!0}});RED.history.push(a),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status)}}();else{var t=a.status,i=a.changed,o=l();if(o){a.changed=!0;var n=RED.nodes.dirty();RED.history.push({t:"delete",links:o.links,changed:i,dirty:n,subflow:{id:a.id,status:t}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw()}}}),$("#red-ui-subflow-edit").on("click",function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#red-ui-subflow-delete").on("click",function(e){e.preventDefault();var t=RED.nodes.dirty(),i=p(RED.workspaces.active());i.t="delete",i.dirty=t,RED.history.push(i)}),n(a),$("#red-ui-workspace-chart").css({"margin-top":"40px"}),$("#red-ui-workspace-toolbar").show()}function p(e){var t=[],i=[],o=RED.nodes.subflow(e);RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&t.push(e),e.z==o.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==o.id&&t.push(e)});for(var n=[],a=0;a<t.length;a++){var r=RED.nodes.remove(t[a].id);i=i.concat(r.links),n=n.concat(r.nodes)}return t=t.concat(n),RED.nodes.removeSubflow(o),RED.workspaces.remove(o),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:t,links:i,subflows:[o]}}function e(){var i=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(i=Math.max(i,t[1]))});var e="Subflow "+(i+1),t=RED.nodes.id(),o={type:"subflow",id:t,name:e,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(t),RED.nodes.dirty(!0)}function y(e){return RED.settings.get("editor").view["view-snap-grid"]&&(e=Math.round(e/RED.view.gridSize())*RED.view.gridSize()),e}function t(){var e=RED.view.selection();if(e.nodes){var t,n,a={},o=[],i=[],r=[],s=[],d={},l=[e.nodes[0].x,e.nodes[0].y,e.nodes[0].x,e.nodes[0].y];for(t=0;t<e.nodes.length;t++)n=e.nodes[t],a[n.id]={n:n,outputs:{}},l=[Math.min(l[0],n.x),Math.min(l[1],n.y),Math.max(l[2],n.x),Math.max(l[3],n.y)];var c=y(l[0]-200),p=y(l[1]-80),u=[y((l[2]+l[0])/2),y((l[3]+l[1])/2)];RED.nodes.eachLink(function(e){a[e.source.id]&&a[e.target.id],a[e.source.id]&&!a[e.target.id]&&(s.push(e),i.push(e)),!a[e.source.id]&&a[e.target.id]&&(r.push(e),d[e.target.id]=e.target,i.push(e))});var f={};if((s=s.filter(function(e){return f[e.source.id+":"+e.sourcePort]?(f[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),f[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),1<Object.keys(d).length)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var h=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(h=Math.max(h,t[1]))});var g="Subflow "+(h+1),v=RED.nodes.id(),b={type:"subflow",id:v,name:g,info:"",in:Object.keys(d).map(function(e,t){var i=t;return{type:"subflow",direction:"in",x:y(d[e].x-d[e].w/2-80-c),y:y(d[e].y-p),z:v,i:i,id:RED.nodes.id(),wires:[{id:d[e].id}]}}),out:s.map(function(e,t){var i=t;return{type:"subflow",direction:"out",x:y(e.source.x+e.source.w/2+80-c),y:y(e.source.y-p),z:v,i:i,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})};RED.nodes.addSubflow(b);var m={id:RED.nodes.id(),type:"subflow:"+b.id,x:u[0],y:u[1],z:RED.workspaces.active(),inputs:b.in.length,outputs:b.out.length,h:Math.max(30,15*(b.out.length||0)),changed:!0};for(m._def=RED.nodes.getType(m.type),RED.editor.validateNode(m),RED.nodes.add(m),r.forEach(function(e){var t={source:e.source,sourcePort:e.sourcePort,target:m};o.push(t),RED.nodes.addLink(t)}),s.forEach(function(e,i){e.targets.forEach(function(e){var t={source:m,sourcePort:i,target:e};o.push(t),RED.nodes.addLink(t)})}),b.in.forEach(function(i){i.wires.forEach(function(e){var t={source:i,sourcePort:0,target:RED.nodes.node(e.id)};o.push(t),RED.nodes.addLink(t)})}),b.out.forEach(function(i,e){i.wires.forEach(function(e){var t={source:RED.nodes.node(e.id),sourcePort:e.port,target:i};o.push(t),RED.nodes.addLink(t)})}),t=0;t<i.length;t++)RED.nodes.removeLink(i[t]);for(t=0;t<e.nodes.length;t++)n=e.nodes[t],/^link /.test(n.type)&&(n.links=n.links.filter(function(e){var t=a.hasOwnProperty(e);if(!t){var i=RED.nodes.node(e);if(i&&i.links){var o=i.links.indexOf(n.id);-1<o&&i.links.splice(o,1)}}return t})),n.x-=c,n.y-=p,RED.nodes.moveNodeToTab(n,b.id);RED.history.push({t:"createSubflow",nodes:[m.id],links:o,subflow:{subflow:b,offsetX:c,offsetY:p},activeWorkspace:RED.workspaces.active(),removedLinks:i,dirty:RED.nodes.dirty()}),RED.view.select(null),RED.editor.validateNode(b),RED.nodes.dirty(!0),RED.view.redraw(!0)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}function a(l,e){var c="subflow"===e.type;c&&function(t){var e=RED.tabs.create({id:"subflow-env-tabs",onchange:function(e){"subflow-env-tab-preview"===e.id&&f($("#subflow-input-ui"),h(t.editableList("items"),!0));$("#subflow-env-tabs-content").children().hide(),$("#"+e.id).show()}});e.addTab({id:"subflow-env-tab-edit",label:RED._("editor-tab.envProperties")}),e.addTab({id:"subflow-env-tab-preview",label:RED._("editor-tab.preview")});var i=RED.settings.theme("languages").map(function(e){var t=RED._("languages."+e);return{text:t||e,val:e}}).sort(function(e,t){return e.text.localeCompare(t.text)});RED.popover.tooltip($(".node-input-env-locales-row i"),RED._("editor.locale"));var o=$("#subflow-input-env-locale");i.forEach(function(e){var t={value:e.val};"en-US"===e.val&&(t.selected=""),$("<option/>",t).text(e.text).appendTo(o)});var n=RED.i18n.lang();o.val(n),o.on("change",function(){m=$(this).val(),$("#node-input-env-container").editableList("items").each(function(e,t){var i=$(this).data("data"),o=i.ui.labelField;o.val(w(i.ui.label,"",m)),o.timeout&&(clearTimeout(o.timeout),delete o.timeout),o.addClass("input-updated"),o.timeout=setTimeout(function(){delete o.timeout,o.removeClass("input-updated")},3e3)})})}(l),l.css({"min-height":"150px","min-width":"450px"}).editableList({header:c?$('<div><div><div></div><div data-i18n="common.label.name"></div><div data-i18n="editor-tab.defaultValue"></div><div></div></div></div>'):void 0,addItem:function(t,e,i){c&&t.addClass("red-ui-editor-subflow-env-editable");var o=$("<div/>").appendTo(t),n=null,a=null;if(n=$("<input/>",{class:"node-input-env-name",type:"text",placeholder:RED._("common.label.name")}).attr("autocomplete","disable").appendTo(o).val(i.name),(a=$("<input/>",{style:"width:100%",class:"node-input-env-value",type:"text"}).attr("autocomplete","disable").appendTo(o)).typedInput({default:"str",types:["str","num","bool","json","bin","env"]}),a.typedInput("type",i.parent?i.type||i.parent.type:i.type),a.typedInput("value",i.parent?void 0!==i.value?i.value:i.parent.value:i.value),i.nameField=n,i.valueField=a,!i.parent){var r=$("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(o);$("<i/>",{class:"fa "+(i.parent?"fa-reply":"fa-remove")}).appendTo(r);var s=RED.popover.tooltip(r,RED._("subflow.env.remove"));r.on("click",function(e){e.preventDefault(),s.close(),t.parent().addClass("red-ui-editableList-item-deleting"),t.fadeOut(300,function(){l.editableList("removeItem",i)})})}if(c){i.ui=i.ui||{icon:"",label:{},type:"input",opts:{types:["str","num","bool","json","bin","env"]}},i.ui.label=i.ui.label||{},i.ui.type=i.ui.type||"input";var d=$("<div/>").appendTo(t).hide();$('<a href="#"><i class="fa fa-angle-right"></a>').prependTo(o).on("click",function(e){e.preventDefault(),$(this).hasClass("expanded")?(d.slideUp(),$(this).removeClass("expanded")):(d.slideDown(),$(this).addClass("expanded"))}),function(e,d,t,i){e.addClass("red-ui-editor-subflow-env-ui-row");var o=$("<div></div>").appendTo(e);$("<div></div>").appendTo(o),$("<div>").text(RED._("editor.icon")).appendTo(o),$("<div>").text(RED._("editor.label")).appendTo(o),$("<div>").text(RED._("editor.inputType")).appendTo(o);var n=$("<div></div>").appendTo(e);$('<div><i class="red-ui-editableList-item-handle fa fa-bars"></i></div>').appendTo(n);var a={input:{types:["str","num","bool","json","bin","env"]},select:{opts:[]},spinner:{}};d.opts?a[d.type]=d.opts:d.opts=a[d.type];var r=$("<div></div>").appendTo(n),s=$('<a href="#"></a>').appendTo(r);if(s.on("click",function(e){e.preventDefault();var t=d.icon||"",i=t?RED.utils.separateIconPath(t):{};RED.editor.showIconPicker(s,null,i,!0,function(e){s.empty();var t=e||"",i=RED.utils.separateIconPath(t);i&&$('<i class="fa"></i>').addClass(i.file).appendTo(s),d.icon=t})}),d.icon){var l=RED.utils.separateIconPath(d.icon);$('<i class="fa '+l.file+'"></i>').appendTo(s)}var c=$("<div></div>").appendTo(n),p=d.label&&d.label[m]||"",u=$('<input type="text">').val(p).appendTo(c);(d.labelField=u).on("change",function(e){d.label=d.label||{};var t=$(this).val().trim();""===t?delete d.label[m]:d.label[m]=t});var f=$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(c);RED.popover.tooltip(f,function(){var e=Object.keys(d.label),i=$("<div>");return-1===e.indexOf(m)&&(e.push(m),e.sort()),e.forEach(function(e){var t=$("<div>").appendTo(i);$("<span>").css({display:"inline-block",width:"120px"}).text(RED._("languages."+e)+(e===m?"*":"")).appendTo(t),$("<span>").text(d.label[e]||"").appendTo(t)}),i}),t.on("change",function(e){u.attr("placeholder",$(this).val())});var h,g,v=$("<div></div>").appendTo(n),b=$('<input type="text">').css("width","100%").appendTo(v);"input"===d.type&&b.val(d.opts.types.join(","));b.typedInput({types:[{value:"input",label:RED._("editor.inputs.input"),icon:"fa fa-i-cursor",showLabel:!1,multiple:!0,options:[{value:"str",label:RED._("editor.types.str"),icon:"red/images/typedInput/az.svg"},{value:"num",label:RED._("editor.types.num"),icon:"red/images/typedInput/09.svg"},{value:"bool",label:RED._("editor.types.bool"),icon:"red/images/typedInput/bool.svg"},{value:"json",label:RED._("editor.types.json"),icon:"red/images/typedInput/json.svg"},{value:"bin",label:RED._("editor.types.bin"),icon:"red/images/typedInput/bin.svg"},{value:"env",label:RED._("editor.types.env"),icon:"red/images/typedInput/env.svg"}],default:["str","num","bool","json","bin","env"],valueLabel:function(e,t){e.css("padding",0);var i=$("<div>").css({background:"white",height:"100%","box-sizing":"border-box"}).appendTo(e),o=$('<div class="placeholder-input">').appendTo(i);$('<span><i class="fa fa-i-cursor"></i></span>').appendTo(o),t.length?t.forEach(function(e){$("<img>",{src:e.icon,style:"max-width:14px; padding: 0 3px; margin-top:-4px; margin-left: 3px"}).appendTo(o)}):$("<span>").css({color:"#aaa","padding-left":"4px"}).text("select types...").appendTo(o)}},{value:"select",label:RED._("editor.inputs.select"),icon:"fa fa-tasks",showLabel:!1,valueLabel:function(e,t){e.css("padding","0"),g=$("<select></select>").appendTo(e),d.opts&&Array.isArray(d.opts.opts)&&d.opts.opts.forEach(function(e){var t=w(e.l,e.l["en-US"]||e.v,m);$("<option>").val(e.v).text(t).appendTo(g)}),g.on("change",function(e){var t=g.val();i.typedInput("value",t)}),g.val(i.typedInput("value"))},expand:{icon:"fa-caret-down",minWidth:400,content:function(e){var t=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(e),s=$("<ol>").appendTo(t).editableList({header:$("<div><div>"+RED._("editor.select.label")+"</div><div>"+RED._("editor.select.value")+"</div></div>"),addItem:function(e,t,n){var i=$("<div>").appendTo(e),o=w(n.l,"",m);n.label=$('<input type="text">').val(o).appendTo(i),n.label.on("keydown",function(e){13===e.keyCode&&(n.input.focus(),e.preventDefault())});var a=$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(i);RED.popover.tooltip(a,function(){return m}),n.input=$('<input type="text">').val(n.v).appendTo(e),n.input.on("keydown",function(e){if(13===e.keyCode){var t=s.editableList("indexOf",n);if(t+1===s.editableList("length")){var i={};s.editableList("addItem",i),setTimeout(function(){i.label&&i.label.focus()},100)}else{var o=s.editableList("getItemAt",t+1);o.label&&o.label.focus()}e.preventDefault()}})},sortable:!0,removable:!0,height:160});return 0<d.opts.opts.length?d.opts.opts.forEach(function(e){s.editableList("addItem",$.extend(!0,{},e))}):s.editableList("addItem",{}),{onclose:function(){var e=s.editableList("items"),r=[];e.each(function(e,t){var i=t.data("data"),o=i.label.val().trim(),n=i.input.val();if(0<o.length&&(i.l=i.l||{},i.l[m]=o),i.v=n,0<o.length||0<n.length){var a={l:i.l,v:i.v};r.push(a)}}),d.opts.opts=r,b.typedInput("value",Date.now())}}}}},{value:"checkbox",label:RED._("editor.inputs.checkbox"),icon:"fa fa-check-square-o",showLabel:!1,valueLabel:function(e,t){e.css("padding",0),(h=$('<input type="checkbox">').appendTo(e)).on("change",function(e){i.typedInput("value",$(this).prop("checked")?"true":"false")}),h.prop("checked","true"===i.typedInput("value"))}},{value:"spinner",label:RED._("editor.inputs.spinner"),icon:"fa fa-sort-numeric-asc",showLabel:!1,valueLabel:function(e,t){e.css("padding",0);var i=$("<div>").css({background:"white",height:"100%","box-sizing":"border-box"}).appendTo(e),o=$('<div class="placeholder-input">').appendTo(i);$('<span><i class="fa fa-sort-numeric-asc"></i></span>').appendTo(o);var n=d.opts&&d.opts.min,a=d.opts&&d.opts.max,r="";void 0!==n&&void 0!==a?r=Math.min(n,a)+" - "+Math.max(n,a):void 0!==n?r="> "+n:void 0!==a&&(r="< "+a),$("<span>").css("margin-left","15px").text(r).appendTo(o)},expand:{icon:"fa-caret-down",content:function(e){var t=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(e);t.css("padding","8px 5px");var i=d.opts.min,o=d.opts.max,n=$('<input type="number" style="margin-bottom:0; width:60px">');n.val(i);var a=$('<input type="number" style="margin-bottom:0; width:60px">');return a.val(o),$('<div class="form-row" style="margin-bottom:3px"><label>'+RED._("editor.spinner.min")+"</label></div>").append(n).appendTo(t),$('<div class="form-row" style="margin-bottom:0"><label>'+RED._("editor.spinner.max")+"</label></div>").append(a).appendTo(t),{onclose:function(){var e=n.val().trim(),t=a.val().trim();""!==e?d.opts.min=parseInt(e):delete d.opts.min,""!==t?d.opts.max=parseInt(t):delete d.opts.max,b.typedInput("value",Date.now())}}}}},{value:"none",label:RED._("editor.inputs.none"),icon:"fa fa-times",hasValue:!1},{value:"hide",label:RED._("editor.inputs.hidden"),icon:"fa fa-ban",hasValue:!1}],default:"none"}).on("typedinputtypechange",function(e,t){switch(d.type=$(this).typedInput("type"),d.opts=a[d.type],"input"===d.type?b.typedInput("value",d.opts.types.join(",")):b.typedInput("value",Date.now()),d.type){case"input":i.typedInput("types",d.opts.types);break;case"select":i.typedInput("types",["str"]);break;case"checkbox":i.typedInput("types",["bool"]);break;case"spinner":i.typedInput("types",["num"]);break;default:i.typedInput("types",["str","num","bool","json","bin","env"])}"checkbox"===d.type?i.typedInput("type","bool"):"spinner"===d.type&&i.typedInput("type","num"),"checkbox"!==d.type&&(h=null)}).on("change",function(e,t){"input"===d.type&&(d.opts.types=b.typedInput("value").split(","),i.typedInput("types",d.opts.types))}),i.on("change",function(e){h&&h.prop("checked","true"===$(this).typedInput("value"))}),b.typedInput("type",d.type)}(d,i.ui,n,a),n.trigger("change")}},sortable:".red-ui-editableList-item-handle",removable:!1});var i={},o=[];if(/^subflow:/.test(e.type)){var t=RED.nodes.subflow(e.type.substring(8));t.env&&t.env.forEach(function(e){var t={name:e.name,parent:{type:e.type,value:e.value,ui:e.ui}};o.push(t),i[e.name]=t})}if(e.env)for(var n=0;n<e.env.length;n++){var a=e.env[n];i.hasOwnProperty(a.name)?(i[a.name].type=a.type,i[a.name].value=a.value):o.push({name:a.name,type:a.type,value:a.value,ui:a.ui})}o.forEach(function(e){e.parent&&e.parent.ui&&"hide"===e.parent.ui.type||!c&&e.parent||l.editableList("addItem",JSON.parse(JSON.stringify(e)))})}function u(e,t,i){i.label=i.label||{},i.type?i.opts||(i.opts="select"===i.type?{opts:[]}:{}):(i.type="input",i.opts={types:["str","num","bool","json","bin","env"]});var o,n=i.label||{},a=RED.i18n.lang(),r=w(n,n["en-US"]||t.name,a),s=$("<label>").appendTo(e),d=$("<span></span>").appendTo(s);if(i.icon){var l=RED.utils.separateIconPath(i.icon);l&&$("<i class='fa "+l.file+"'/>").appendTo(d)}if("checkbox"!==i.type){var c=i.icon?{"padding-left":"5px"}:{};$("<span>").css(c).text(r).appendTo(s),"none"===i.type&&s.width("100%")}var p={value:"",type:"str"};switch(t.parent&&(p.value=t.parent.value,p.type=t.parent.type),t.hasOwnProperty("value")&&(p.value=t.value),t.hasOwnProperty("type")&&(p.type=t.type),i.type){case"input":if(o=$('<input type="text">').css("width","70%").appendTo(e),i.opts.types&&0<i.opts.types.length){var u=p.type;-1===i.opts.types.indexOf(u)&&(u=i.opts.types[0]),o.typedInput({types:i.opts.types,default:u}),o.typedInput("value",p.value)}else o.val(p.value);break;case"select":o=$("<select>").css("width","70%").appendTo(e),i.opts.opts&&i.opts.opts.forEach(function(e){$("<option>").val(e.v).text(w(e.l,e.l["en-US"]||e.v,a)).appendTo(o)}),o.val(p.value);break;case"checkbox":s.css("cursor","default");var f=$("<label>").css("width","70%").appendTo(e);o=$('<input type="checkbox">').css({marginTop:0,width:"auto",height:"34px"}).appendTo(f),d.css({"padding-left":"5px"}).appendTo(f),$("<span>").css({"padding-left":"5px"}).text(r).appendTo(f);var h=!1;h="bool"===p.type?"true"===p.value:"num"===p.type?"0"!==p.value:""!==p.value,o.prop("checked",h);break;case"spinner":o=$("<input>").css("width","70%").appendTo(e);var g={};i.opts.hasOwnProperty("min")&&(g.min=i.opts.min),i.opts.hasOwnProperty("max")&&(g.max=i.opts.max),o.spinner(g).parent().width("70%"),o.val(p.value)}o&&o.attr("id",v(t.name))}function f(e,t){e.empty();for(var i=0;i<t.length;i++){var o=t[i];if(!o.ui||"hide"!==o.ui.type)u($("<div/>",{class:"form-row"}).appendTo(e),o,o.ui||{})}}function h(e,d){if(e){var l=[];return e.each(function(e){var t=$(this).data("data"),i=(t.parent?t.name:t.nameField.val()).trim();if(""!==i||t.ui&&"none"===t.ui.type){var o=t.valueField,n=o.typedInput("value"),a=o.typedInput("type");if(d||!t.parent||t.parent.value!==n||t.parent.type!==a){var r={name:i,type:a,value:n};if(t.ui){var s={icon:t.ui.icon,label:$.extend(!0,{},t.ui.label),type:t.ui.type,opts:$.extend(!0,{},t.ui.opts)};switch(s.icon||delete s.icon,$.isEmptyObject(s.label)&&delete s.label,s.type){case"input":JSON.stringify(s.opts)===JSON.stringify({types:["str","num","bool","json","bin","env"]})&&(delete s.type,delete s.opts);break;case"select":s.opts&&$.isEmptyObject(s.opts.opts)&&delete s.opts;break;case"spinner":$.isEmptyObject(s.opts)&&delete s.opts;break;default:delete s.opts}$.isEmptyObject(s)||(r.ui=s)}l.push(r)}}}),l}return null}function g(e){var i={},o=[];if(/^subflow:/.test(e.type)){var t=RED.nodes.subflow(e.type.substring(8));t.env&&t.env.forEach(function(e){var t={name:e.name,parent:{type:e.type,value:e.value},ui:e.ui};o.push(t),i[e.name]=t})}if(e.env)for(var n=0;n<e.env.length;n++){var a=e.env[n];i.hasOwnProperty(a.name)&&(i[a.name].type=a.type,i[a.name].value=a.value)}return o}function v(e){return"node-input-subflow-env-"+e.replace(/[^a-z0-9-_]/gi,"_")}function w(e,t,i){if(e){if(e[i])return e[i];if(i){var o=i.substring(0,2);if(e[o])return e[o]}}return t}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?o(t):($("#red-ui-workspace-toolbar").hide().empty(),$("#red-ui-workspace-chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)}),RED.actions.add("core:create-subflow",e),RED.actions.add("core:convert-to-subflow",t),$('<script type="text/x-red" data-template-name="subflow"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div><div id="subflow-input-ui"></div><\/script>').appendTo("#red-ui-editor-node-configs"),$('<script type="text/x-red" data-template-name="subflow-template"><div class="form-row"><label for="subflow-input-name" data-i18n="[append]common.label.name"><i class="fa fa-tag"></i>  </label><input type="text" id="subflow-input-name" data-i18n="[placeholder]common.label.name"></div><div class="form-row"><ul style="margin-bottom: 20px;" id="subflow-env-tabs"></ul></div><div id="subflow-env-tabs-content"><div id="subflow-env-tab-edit"><div class="form-row node-input-env-container-row" id="subflow-input-edit-ui"><ol class="red-ui-editor-subflow-env-list" id="node-input-env-container"></ol><div class="node-input-env-locales-row"><i class="fa fa-language"></i> <select id="subflow-input-env-locale"></select></div></div></div><div id="subflow-env-tab-preview"><div id="subflow-input-ui"/></div></div><\/script>').appendTo("#red-ui-editor-node-configs")},createSubflow:e,convertToSubflow:t,removeSubflow:p,refresh:c,removeInput:r,removeOutput:d,removeStatus:l,buildEditForm:function(e,t,i){"subflow-template"===t?a($("#node-input-env-container"),i):"subflow"===t&&f($("#subflow-input-ui"),g(i))},buildPropertiesForm:function(e,t){var i=$('<form class="dialog-form form-horizontal"></form>').appendTo(e),o=$('<div class="form-row node-input-env-container-row"></div>').appendTo(i);a($('<ol id="red-ui-editor-subflow-env-list" class="red-ui-editor-subflow-env-list"></ol>').appendTo(o),t)},exportSubflowTemplateEnv:h,exportSubflowInstanceEnv:function(e){var n=[];return g(e).forEach(function(e){var t,i=e.ui||{};i.type?i.opts=i.opts||{}:(i.type="input",i.opts={types:["str","num","bool","json","bin","env"]});var o=$("#"+v(e.name));if(o.length){switch(t={name:e.name},i.type){case"input":i.opts.types&&0<i.opts.types.length?(t.value=o.typedInput("value"),t.type=o.typedInput("type")):(t.value=o.val(),t.type="str");break;case"spinner":t.value=o.val(),t.type="num";break;case"select":t.value=o.val(),t.type="str";break;case"checkbox":t.type="bool",t.value=""+o.prop("checked")}t.type===e.parent.type&&t.value===e.parent.value||n.push(t)}}),$("#red-ui-editor-subflow-env-list").editableList("items").each(function(e,t){var i,o=t.data("data");o.nameField&&o.valueField&&""!==(i={name:o.nameField.val(),value:o.valueField.typedInput("value"),type:o.valueField.typedInput("type")}).name.trim()&&n.push(i)}),n}}}(),RED.userSettings=function(){var t=700,i=!1,s=[];function e(e){s.push(e)}function o(r){if(!i)if(RED.user.hasPermission("settings.write")){i=!0;var e={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var t=e.find(".red-ui-tray-body"),i=$("<div></div>").appendTo(t),o=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(i);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(o);var n=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){a.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),a=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(i);s.forEach(function(e){n.addTab({id:"red-ui-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(a)}),i.i18n(),n.activateTab("red-ui-settings-tab-"+(r||"view")),$("#red-ui-sidebar-shade").show()},close:function(){i=!1,s.forEach(function(e){e.close&&e.close()}),$("#red-ui-sidebar-shade").hide()},show:function(){}};null!==t&&(e.width=t),RED.tray.show(e)}else RED.notify(RED._("user.errors.settings"),"error")}function n(e){var t=RED._("languages."+e);return{text:t||e,val:e}}function a(e,t){return e.text.localeCompare(t.text)}var r=[{options:[{setting:"editor-language",local:!0,label:"menu.label.view.language",options:function(e){e([{val:"",text:RED._("menu.label.view.browserDefault")}].concat(RED.settings.theme("languages").map(n).sort(a)))}}]},{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",default:!0,toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",default:!0,toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"},{setting:"view-node-show-label",label:"menu.label.showNodeLabelDefault",default:!0,toggle:!0}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],d={};function l(){var n=$('<div id="red-ui-settings-tab-view" class="red-ui-help"></div>'),a=RED.settings.get("editor")||{};return a.view=a.view||{},r.forEach(function(e){e.title&&$("<h3></h3>").text(RED._(e.title)).appendTo(n),e.options.forEach(function(e){var t;t=e.local?localStorage.getItem(e.setting):a.view[e.setting];var i=$('<div class="red-ui-settings-row"></div>').appendTo(n);if(e.toggle)$('<label for="user-settings-'+e.setting+'"><input id="user-settings-'+e.setting+'" type="checkbox"> '+RED._(e.label)+"</label>").appendTo(i).find("input").prop("checked",t);else if(e.options){$('<label for="user-settings-'+e.setting+'">'+RED._(e.label)+"</label>").appendTo(i);var o=$('<select id="user-settings-'+e.setting+'"></select>').appendTo(i);"function"==typeof e.options&&(e.options(function(e){e.forEach(function(e){var t=e,i=e;"string"!=typeof e&&(t=e.val,i=e.text),$("<option>").val(t).text(i).appendTo(o)})}),o.val(t))}else $('<label for="user-settings-'+e.setting+'">'+RED._(e.label)+"</label>").appendTo(i),$('<input id="user-settings-'+e.setting+'" type="'+(e.type||"text")+'">').appendTo(i).val(t)})}),n}function c(e,t){var i=d[e];if(i.local)localStorage.setItem(i.setting,t);else{var o=RED.settings.get("editor")||{};o.view=o.view||{},o.view[i.setting]=t,RED.settings.set("editor",o);var n=i.onchange;"string"==typeof n&&(n=RED.actions.get(n)),n&&n.call(i,t)}}return{init:function(){RED.actions.add("core:show-user-settings",o),RED.actions.add("core:show-help",function(){o("keyboard")}),e({id:"view",title:RED._("menu.label.view.view"),get:l,close:function(){r.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?c(e.setting,t.prop("checked")):c(e.setting,t.val())})})}});var n=RED.settings.get("editor")||{};n.view=n.view||{};var a=!1;r.forEach(function(e){e.options.forEach(function(e){if(e.local)d[e.setting]=e;else{if(e.oldSetting){var t=RED.settings.get(e.oldSetting);null!=t&&(n.view[e.setting]=t,a=!0,RED.settings.remove(e.oldSetting))}d[e.setting]=e;var i=n.view[e.setting];if(null==i&&e.hasOwnProperty("default")&&(i=e.default,n.view[e.setting]=i,a=!0),e.onchange){var o=e.onchange;"string"==typeof o&&(o=RED.actions.get(o)),o&&o.call(e,i)}}})}),a&&RED.settings.set("editor",n)},toggle:function(e){var t=d[e],i=RED.settings.get("editor")||{};i.view=i.view||{},c(e,!i.view[t.setting])},show:o,add:e}}(),RED.projects=function(){var B,a,U;function u(e){var t;t="git_missing_user"===e.code?RED.notify("<p>"+RED._("projects.errors.no-username-email")+"</p>",{fixed:!0,type:"error",buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("projects.config-git"),click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),RED.notify("<p>"+RED._("projects.errors.unexpected")+":</p><p>"+e.message+"</p><small>"+RED._("projects.errors.code")+": "+e.code+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:RED._("common.label.close"),click:function(){t.close()}}]}))}var r={};function t(){var m=$('<div class="red-ui-projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(m),$("<hr>").appendTo(m);var k,T,_,j,C,L,S,O,I,P,N,A,c,d,l,y,w,D,E,R,x,z,M,f,h,s,p,g={};r={welcome:{content:function(e){var t=$('<div class="red-ui-projects-dialog-screen-start"></div>');m.appendTo(t);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.welcome.hello")).appendTo(i),$("<p>").text(RED._("projects.welcome.desc0")).appendTo(i),$("<p>").text(RED._("projects.welcome.desc1")).appendTo(i),$("<p>").text(RED._("projects.welcome.desc2")).appendTo(i);var o=$('<div style="text-align: center"></div>').appendTo(i),n=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.welcome.create")+"</button>").appendTo(o),a=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.welcome.clone")+"</button>").appendTo(o);return n.on("click",function(e){e.preventDefault(),g={action:"create"},v("git-config")}),a.on("click",function(e){e.preventDefault(),g={action:"clone"},v("git-config")}),t},buttons:[{text:RED._("projects.welcome.openExistingProject"),class:"secondary",click:function(){g={action:"open"},v("git-config")}},{text:RED._("projects.welcome.not-right-now"),click:function(){g={},$(this).dialog("close")}}]},"git-config":{content:function(e){var t=!1,i=RED.settings.get("git");function o(){var e=s.val().trim(),t=p.val().trim(),i=0<e.length&&0<t.length;$("#red-ui-projects-dialog-git-config").prop("disabled",!i).toggleClass("disabled ui-button-disabled ui-state-disabled",!i)}i&&i.user?i=i.user:RED.settings.git&&RED.settings.git.globalUser&&(t=!0,i=RED.settings.git.globalUser);var n=$('<div class="red-ui-projects-dialog-screen-start"></div>');m.appendTo(n);var a=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text(RED._("projects.git-config.setup")).appendTo(a),$("<p>").text(RED._("projects.git-config.desc0")).appendTo(a),$("<p>").text(RED._("projects.git-config.desc1")).appendTo(a),t&&$("<p>").text(RED._("projects.git-config.desc2")).appendTo(a),$("<p>").text(RED._("projects.git-config.desc3")).appendTo(a);var r=$('<div class="form-row"></div>').appendTo(a);return $('<label for="">'+RED._("projects.git-config.username")+"</label>").appendTo(r),(s=$('<input type="text">').val(i&&i.name||"").appendTo(r)).on("change keyup paste",o),r=$('<div class="form-row"></div>').appendTo(a),$('<label for="">'+RED._("projects.git-config.email")+"</label>").appendTo(r),(p=$('<input type="text">').val(i&&i.email||"").appendTo(r)).on("change keyup paste",o),setTimeout(function(){s.trigger("focus"),o()},50),n},buttons:[{text:RED._("common.label.back"),click:function(){v("welcome")}},{id:"red-ui-projects-dialog-git-config",text:RED._("common.label.next"),class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=s.val(),e.user.email=p.val(),RED.settings.set("git",e),"create"===g.action?v("project-details"):"clone"===g.action?v("clone-project"):"open"===g.action&&v("create",{screen:"open"})}}]},"project-details":{content:function(e){var i=null,o=!1;$.getJSON("projects",function(e){i={},e.projects.forEach(function(e){i[e]=!0,o&&(o=!1,a())})});var t=$('<div class="red-ui-projects-dialog-screen-start"></div>');m.appendTo(t);var n=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.project-details.create")).appendTo(n),$("<p>").text(RED._("projects.project-details.desc0")).appendTo(n),$("<p>").text(RED._("projects.project-details.desc1")).appendTo(n),$("<p>").text(RED._("projects.project-details.desc2")).appendTo(n);var a=function(){var e=f.val(),t=!0;if(p){if(null===i)return void(o=!0);c.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||i[e]?(f.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(c),t=d=!1,i[e]?projectNameSublabel.text(RED._("projects.project-details.already-exists")):projectNameSublabel.text(RED._("projects.project-details.must-contain"))):(f.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(c),projectNameSublabel.text(RED._("projects.project-details.must-contain")),d=!0),u=e}t=d,$("#red-ui-projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},r=$('<div class="form-row"></div>').appendTo(n);$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.project-details.project-name")+"</label>").appendTo(r);var s=$('<div style="position:relative;"></div>').appendTo(r);f=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').val(g.name||"").appendTo(s);var d,l,c=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(s),p=!1,u="";return f.on("change keyup paste",function(){if(p=f.val()!==u,l)clearTimeout(l);else if(p&&(c.empty(),$('<img src="red/images/spin.svg"/>').appendTo(c),""===f.val()))return void a();l=setTimeout(function(){a(),l=null},300)}),projectNameSublabel=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.must-contain")+"</small></label>").appendTo(r).find("small"),r=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(n),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.project-details.desc")+"</label>").appendTo(r),h=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').val(g.summary||"").appendTo(r),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.opt")+"</small></label>").appendTo(r),setTimeout(function(){f.trigger("focus"),f.trigger("change")},50),t},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){v("git-config")}},{id:"red-ui-projects-dialog-create-name",disabled:!0,text:RED._("common.label.next"),class:"primary disabled",click:function(){g.name=f.val(),g.summary=h.val(),v("default-files",e)}}]}},"clone-project":{content:function(e){var t=$('<div class="red-ui-projects-dialog-screen-start"></div>');m.appendTo(t);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.clone-project.clone")).appendTo(i),$("<p>").text(RED._("projects.clone-project.desc0")).appendTo(i);var n=null,a=!1;$.getJSON("projects",function(e){n={},e.projects.forEach(function(e){n[e]=!0,a&&(a=!1,r())})});var o,r=function(){var e=y.val(),t=!0;if(p){if(null===n)return void(a=!0);c.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||n[e]?(y.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(c),t=d=!1,n[e]?x.text(RED._("projects.clone-project.already-exists")):x.text(RED._("projects.clone-project.must-contain"))):(y.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(c),x.text(RED._("projects.clone-project.must-contain")),d=!0),u=e}t=d;var i=D.val(),o=0<i.length&&!/\s/.test(i);/^https?:\/\/[^/]+@/i.test(i)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.no-info-in-url")),o=!1),o?D.removeClass("input-error"):(h&&D.addClass("input-error"),t=!1),/^https?:\/\//.test(i)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(i)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()),$("#red-ui-projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};o=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.clone-project.project-name")+"</label>").appendTo(o);var s=$('<div style="position:relative;"></div>').appendTo(o);y=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(s);var d,l,c=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(s),p=!1,u="",f="";y.on("change keyup paste",function(){if(p=y.val()!==u,l)clearTimeout(l);else if(p&&(c.empty(),$('<img src="red/images/spin.svg"/>').appendTo(c),""===y.val()))return void r();l=setTimeout(function(){r(),l=null},300)}),x=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.must-contain")+"</small></label>").appendTo(o).find("small"),o=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.clone-project.git-url")+"</label>").appendTo(o),D=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(o),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.protocols")+"</small></label>").appendTo(o);var h=!1,g="";D.on("change keyup paste",function(){h=!0;var e=$(this).val();g!==e&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols"));var t=/\/([^/]+?)(?:\.git)?$/.exec(g=e);if(t){var i=y.val();""!==i&&i!==f||(f=t[1],y.val(f),y.trigger("change"))}r()});var v=$('<div class="red-ui-projects-dialog-screen-create-row"></div>').appendTo(i);o=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(v),$('<div><i class="fa fa-warning"></i> '+RED._("projects.clone-project.auth-failed")+"</div>").appendTo(o),o=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(v),s=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(o),$('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.clone-project.username")+"</label>").appendTo(s),E=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(s),s=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(o),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.clone-project.passwd")+"</label>").appendTo(s),R=$('<input id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(s),o=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(v),s=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(o),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.ssh-key")+"</label>").appendTo(s),z=$("<select>",{style:"width: 100%"}).appendTo(s),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){z.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(z.addClass("input-error"),z.attr("disabled",!0),b.show()):(z.removeClass("input-error"),z.attr("disabled",!1),b.hide())}),s=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(o),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.passphrase")+"</label>").appendTo(s),M=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(s),s=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(v);var b=$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(s);return $('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.clone-project.ssh-key-desc")+"</div>").appendTo(b),s=$('<div style="text-align: center">').appendTo(b),$('<button class="red-ui-button">'+RED._("projects.clone-project.ssh-key-add")+"</button>").appendTo(s).on("click",function(e){e.preventDefault(),B.dialog("close"),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").trigger("click")},500)}),o=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(i),$("<label>"+RED._("projects.clone-project.credential-key")+"</label>").appendTo(o),w=$('<input type="password"></input>').appendTo(o),t},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){v("git-config")}},{id:"red-ui-projects-dialog-clone-project",disabled:!0,text:RED._("common.label.clone"),class:"primary disabled",click:function(){$(".red-ui-projects-dialog-screen-create-type.selected").data("type");var e={name:y.val()};e.credentialSecret=w.val();var t=D.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(t)){var i=z.val();if(!i)return void console.log(RED._("projects.clone-project.cant-get-ssh-key"));e.git={remotes:{origin:{url:t,keyFile:i,passphrase:M.val()}}}}else e.git={remotes:{origin:{url:t,username:E.val(),password:R.val()}}};$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),E.removeClass("input-error"),R.removeClass("input-error"),z.removeClass("input-error"),M.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e.name),q({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){B.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.clone-project.already-exists2"))},git_error:function(e){console.log(RED._("projects.clone-project.git-error"),e)},git_connection_failed:function(e){D.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.connection-failed"))},git_not_a_repository:function(e){D.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.not-git-repo"))},git_repository_not_found:function(e){D.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.repo-not-found"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),E.addClass("input-error"),R.addClass("input-error"),z.addClass("input-error"),M.addClass("input-error")},missing_flow_file:function(e){B.dialog("close")},missing_package_file:function(e){B.dialog("close")},project_empty:function(e){B.dialog("close")},credentials_load_failed:function(e){B.dialog("close")},"*":function(e){u(e),$(B).dialog("close")}}}},e).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"default-files":{content:function(e){var t=$('<div class="red-ui-projects-dialog-screen-start"></div>');m.appendTo(t);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t);function o(){var e=!0,t=d.val();""!==t&&/\.json$/.test(t)?(d.hasClass("input-error")&&(d.removeClass("input-error"),d.next().empty()),l.hasClass("input-error")&&(l.removeClass("input-error"),l.next().empty()),l.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,d.hasClass("input-error")||(d.addClass("input-error"),d.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),l.text(""),l.hasClass("input-error")||(l.addClass("input-error"),l.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#red-ui-projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)}$("<p>").text(RED._("projects.default-files.create")).appendTo(i),$("<p>").text(RED._("projects.default-files.desc0")).appendTo(i),$("<p>").text(RED._("projects.default-files.desc1")).appendTo(i),!e.existingProject&&RED.settings.files&&$("<p>").text(RED._("projects.default-files.desc2")).appendTo(i);var n=$('<div class="form-row"></div>').appendTo(i);$('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.default-files.flow-file")+"</label>").appendTo(n);var a=$('<div style="position:relative;"></div>').appendTo(n),r=g.files&&g.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";d=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val(r).on("change keyup paste",o).appendTo(a),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(a),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(n);var s=g.files&&g.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return n=$('<div class="form-row"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-credfile">'+RED._("projects.default-files.credentials-file")+"</label>").appendTo(n),a=$('<div style="position:relative;"></div>').appendTo(n),l=$('<div style="width: 100%" class="uneditable-input" id="red-ui-projects-dialog-screen-create-project-credentials">').text(s).appendTo(a),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(a),setTimeout(function(){d.trigger("focus"),o()},50),t},buttons:function(e){return[{text:RED._(e.existingProject?"common.label.cancel":"common.label.back"),click:function(){e.existingProject?$(this).dialog("close"):v("project-details",e)}},{id:"red-ui-projects-dialog-create-default-files",text:RED._("common.label.next"),class:"primary",click:function(){g.files={flow:d.val(),credentials:l.text()},e.existingProject||(g.migrateFiles=!0),v("encryption-config",e)}}]}},"encryption-config":{content:function(e){var t=$('<div class="red-ui-projects-dialog-screen-start"></div>');m.appendTo(t);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t);function o(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==c.val()),$("#red-ui-projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)}$("<p>").text(RED._("projects.encryption-config.setup")).appendTo(i),e.existingProject?($("<p>").text(RED._("projects.encryption-config.desc0")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc1")).appendTo(i)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text(RED._("projects.encryption-config.desc2")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc3")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc4")).appendTo(i)):("user"===RED.settings.flowEncryptionType?$("<p>").text(RED._("projects.encryption-config.desc5")).appendTo(i):"system"===RED.settings.flowEncryptionType&&$("<p>").text(RED._("projects.encryption-config.desc6")).appendTo(i),$("<p>").text(RED._("projects.encryption-config.desc7")).appendTo(i));var n=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(i);$("<label>"+RED._("projects.encryption-config.credentials")+"</label>").appendTo(n);var a=$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(n),r=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(a),s=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(a),d=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(s);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(d);var l=$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled"></div>').appendTo(s);return $('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(l),s.find("input[name=projects-encryption-type]").on("click",function(e){var t,i;"enabled"===$(this).val()?(t=d,i=l,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&c.trigger("focus")):(i=d,t=l,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),i.addClass("disabled"),o()}),n=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(r),$('<label class="red-ui-projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?RED._("projects.encryption-config.disabled"):"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.copy")+"</span></label>").appendTo(n),n=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(r),$('<label class="red-ui-projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.use-custom")+"</span></label>").appendTo(n),n=$('<div class="projects-encryption-enabled-row"></div>').appendTo(r),(c=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(n)).on("change keyup paste",o),n=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(r),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.encryption-config.desc8")+"</div>").appendTo(n),r.find("input[name=projects-encryption-key]").on("click",function(){var e=$(this).val();c.attr("disabled","default"===e),"custom"===e&&c.trigger("focus"),o()}),setTimeout(function(){s.find("input[name=projects-encryption-type][value=enabled]").trigger("click"),"user"!==RED.settings.flowEncryptionType?r.find("input[name=projects-encryption-key][value=custom]").trigger("click"):r.find("input[name=projects-encryption-key][value=default]").trigger("click"),o()},100),t},buttons:function(o){return[{text:RED._("common.label.back"),click:function(){v("default-files",o)}},{id:"red-ui-projects-dialog-create-encryption",text:RED._(o.existingProject?"projects.encryption-config.create-project-files":"projects.encryption-config.create-project"),class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(g.credentialSecret=c.val()):g.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(g.name);var e="POST",t="projects";o.existingProject&&(g.initialise=!0,e="PUT",t="projects/"+U.name);var i=this;q({url:t,type:e,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){g={},o.existingProject?$(i).dialog("close"):(v("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log(RED._("projects.encryption-config.already-exists"))},git_error:function(e){console.log(RED._("projects.encryption-config.git-error"),e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log(RED._("projects.encryption-config.git-auth-error"),e)},"*":function(e){u(e),$(B).dialog("close")}}}},g).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"create-success":{content:function(e){var t=$('<div class="red-ui-projects-dialog-screen-start"></div>');m.appendTo(t);var i=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t);return $("<p>").text(RED._("projects.create-success.success")).appendTo(i),$("<p>").text(RED._("projects.create-success.desc0")).appendTo(i),$("<p>").text(RED._("projects.create-success.desc1")).appendTo(i),$("<p>").text(RED._("projects.create-success.desc2")).appendTo(i),t},buttons:[{text:RED._("common.label.done"),click:function(){$(this).dialog("close")}}]},create:{title:RED._("projects.create.projects"),content:function(e){var r=null;A=null;var s=!1;$.getJSON("projects",function(e){r={},e.projects.forEach(function(e){r[e]=!0,s&&(s=!1,o())})});var t,i=$('<div class="red-ui-projects-dialog-screen-create"></div>'),o=function(){var e=k.val(),t=!0;if(f){if(null===r)return void(s=!0);u.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||r[e]?(k.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(u),t=c=!1,r[e]?I.text(RED._("projects.create.already-exists")):I.text(RED._("projects.create.must-contain"))):(k.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(u),I.text(RED._("projects.create.must-contain")),c=!0),h=e}t=c;var i=$(".red-ui-projects-dialog-screen-create-type.selected").data("type");if("copy"===i)t=!1;else if("clone"===i){var o=C.val(),n=0<o.length&&!/\s/.test(o);/^https?:\/\/[^/]+@/i.test(o)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-info-in-url")),n=!1),n?C.removeClass("input-error"):(D&&C.addClass("input-error"),t=!1),/^https?:\/\//.test(o)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(o)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===i){var a=_.val();""!==a&&/\.json$/.test(a)?_.hasClass("input-error")&&(_.removeClass("input-error"),_.next().empty()):(t=!1,_.hasClass("input-error")||(_.addClass("input-error"),_.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"!==$("input[name=projects-encryption-type]:checked").val()||"custom"===$("input[name=projects-encryption-key]:checked").val()&&(t=t&&""!==L.val())}else"open"===i&&(t=!!A);$("#red-ui-projects-dialog-create").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};t=$('<div class="form-row button-group"></div>').appendTo(i);var n=$('<button data-type="open" class="red-ui-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>'+RED._("projects.create.open")+"</button>").appendTo(t),a=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.create.create")+"</button>").appendTo(t),d=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.create.clone")+"</button>").appendTo(t);t.find(".red-ui-projects-dialog-screen-create-type").on("click",function(e){switch(e.preventDefault(),i.find(".red-ui-projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),i.find(".red-ui-projects-dialog-screen-create-row").hide(),i.find(".red-ui-projects-dialog-screen-create-row-"+$(this).data("type")).show(),o(),k.trigger("focus"),$(this).data("type")){case"open":$("#red-ui-projects-dialog-create").text(RED._("projects.create.open"));break;case"empty":$("#red-ui-projects-dialog-create").text(RED._("projects.create.create"));break;case"clone":$("#red-ui-projects-dialog-create").text(RED._("projects.create.clone"))}}),t=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-open"></div>').hide().appendTo(i),function(a){a=a||{};var r,e=$("<div></div>",{class:"red-ui-projects-dialog-project-list-container"}),t="",i=$("<div>",{class:"red-ui-search-container"}).appendTo(e),s=$('<input id="red-ui-projects-dialog-project-list-search" type="text" placeholder="'+RED._("projects.create-project-list.search")+'">').appendTo(i).searchBox({delay:200,change:function(){t=$(this).val().toLowerCase(),c.editableList("filter"),r&&!r.is(":visible")&&r.children().children().removeClass("selected"),(r=c.children(":visible").first()).children().children().addClass("selected"),a.select&&a.select(r.children().data("data")),d()}});s.on("keydown",function(e){if(40===e.keyCode){e.preventDefault();var t=r;if(r){for(;0!==(t=t.next()).length&&!t.is(":visible"););if(0===t.length)return;r.children().children().removeClass("selected")}else t=c.children(":visible").first();(r=t).children().children().addClass("selected"),a.select&&a.select(r.children().data("data")),d()}else if(38===e.keyCode){e.preventDefault();var i=r;if(r){for(;0!==(i=i.prev()).length&&!i.is(":visible"););if(0===i.length)return;r.children().children().removeClass("selected")}else i=c.children(":visible").first();(r=i).children().children().addClass("selected"),a.select&&a.select(r.children().data("data")),d()}else 13===e.keyCode&&(e.preventDefault(),r&&a.dblclick&&a.dblclick(r.children().data("data")))}),s.i18n();var d=function(){var e=c.find(".red-ui-projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=l,i=t.height(),o=(t.scrollTop(),e.position().top),n=e.height();i<o+n?t.animate({scrollTop:"-="+(i-o-n)},50):o<0&&t.animate({scrollTop:"+="+o},50)}},l=$("<div></div>",{class:"red-ui-projects-dialog-project-list-inner-container"}).appendTo(e),c=$("<ol>",{class:"red-ui-projects-dialog-project-list"}).appendTo(l).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(t,e,i){var o=$("<div></div>",{class:"red-ui-projects-dialog-project-list-entry"}).appendTo(t);if($('<span class="red-ui-projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(o),$('<span class="red-ui-projects-dialog-project-list-entry-name" style=""></span>').text(i.name).appendTo(o),!U||U.name!==i.name||(o.addClass("projects-list-entry-current"),$('<span class="red-ui-projects-dialog-project-list-entry-current">'+RED._("projects.create-project-list.current")+"</span>").appendTo(o),!1!==a.canSelectActive)){o.addClass("selectable");var n=$('<div class="red-ui-projects-dialog-project-list-entry-tools"></div>').appendTo(o);$('<button class="red-ui-button red-ui-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(n).on("click",function(e){e.stopPropagation(),e.preventDefault(),function(e,t,i){var o=$("<div>").css({background:"white",position:"absolute",top:0,right:0,bottom:0,left:"100%",overflow:"hidden",padding:"5px 20px",transition:"left 0.4s",whitespace:"nowrap",width:"1000px"}).on("click",function(e){e.stopPropagation()}).appendTo(e);$("<span>").css({lineHeight:"40px"}).text(RED._("projects.delete.confirm")).appendTo(o),$('<button style="margin-left:20px" class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(o).on("click",function(e){e.stopPropagation(),o.remove(),i(!0)}),$('<button style="margin-left:20px" class="red-ui-button primary">'+RED._("common.label.delete")+"</button>").appendTo(o).on("click",function(e){e.stopPropagation(),o.remove(),q({url:"projects/"+t,type:"DELETE",responses:{200:function(e){i(!1)},400:{unexpected_error:function(e){o.remove(),i(!0)}}}})}),setTimeout(function(){o.css("left",0)},50)}(t,i.name,function(e){e||t.fadeOut(300,function(){c.editableList("removeItem",i),a.delete&&a.delete(i)})})}),t.on("click",function(e){$(".red-ui-projects-dialog-project-list-entry").removeClass("selected"),o.addClass("selected"),r=t.parent(),a.select&&a.select(i),d(),s.trigger("focus")}),a.dblclick&&t.on("dblclick",function(e){e.preventDefault(),a.dblclick(i)})}},filter:function(e){return""===t||-1!==e.name.toLowerCase().indexOf(t)}});return $.getJSON("projects",function(e){e.projects.forEach(function(e){c.editableList("addItem",{name:e})})}),e}({canSelectActive:!1,dblclick:function(e){A=e,$("#red-ui-projects-dialog-create").trigger("click")},select:function(e){A=e,o()},delete:function(e){r&&delete r[e.name],A=null,o()}}).appendTo(t),t=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.create.project-name")+"</label>").appendTo(t);var l=$('<div style="position:relative;"></div>').appendTo(t);k=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(l);var c,p,u=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(l),f=!1,h="",g="";k.on("change keyup paste",function(){if(f=k.val()!==h,p)clearTimeout(p);else if(f&&(u.empty(),$('<img src="red/images/spin.svg"/>').appendTo(u),""===k.val()))return void o();p=setTimeout(function(){o(),p=null},300)}),I=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.must-contain")+"</small></label>").appendTo(t).find("small"),t=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.create.desc")+"</label>").appendTo(t),T=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').appendTo(t),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.opt")+"</small></label>").appendTo(t),t=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.create.flow-file")+"</label>").appendTo(t),l=$('<div style="position:relative;"></div>').appendTo(t),_=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",o).appendTo(l),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(l),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(t),t=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(i),$("<label>"+RED._("projects.create.credentials")+"</label>").appendTo(t);var v=$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(t),b=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(v),m=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(v),y=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(m);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(y);var w=$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled disabled"></div>').appendTo(m);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(w),m.find("input[name=projects-encryption-type]").on("click",function(e){var t,i;"enabled"===$(this).val()?(t=y,i=w,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&L.trigger("focus")):(i=y,t=w,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),i.addClass("disabled"),o()}),t=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(b),$('<label class="red-ui-projects-edit-form-inline-label">'+RED._("projects.create.encryption-key")+"</label>").appendTo(t),(L=$('<input type="password"></input>').appendTo(t)).on("change keyup paste",o),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.desc0")+"</small></label>").appendTo(t),t=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(b),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.create.desc1")+"</div>").appendTo(t),b.find("input[name=projects-encryption-key]").on("click",function(){var e=$(this).val();L.attr("disabled","default"===e),"custom"===e&&L.trigger("focus"),o()}),t=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(i),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.create.git-url")+"</label>").appendTo(t),C=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(t),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.protocols")+"</small></label>").appendTo(t);var D=!1,E="";C.on("change keyup paste",function(){D=!0;var e=$(this).val();E!==e&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols"));var t=/\/([^/]+?)(?:\.git)?$/.exec(E=e);if(t){var i=k.val();""!==i&&i!==g||(g=t[1],k.val(g),k.trigger("change"))}o()});var R=$('<div class="hide red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').hide().appendTo(i);t=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(R),$('<div><i class="fa fa-warning"></i> '+RED._("projects.create.auth-failed")+"</div>").appendTo(t),t=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(R),l=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.create.username")+"</label>").appendTo(l),S=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(l),l=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.create.password")+"</label>").appendTo(l),O=$('<input id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(l),t=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(R),l=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.ssh-key")+"</label>").appendTo(l),P=$("<select>",{style:"width: 100%"}).appendTo(l),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){P.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(P.addClass("input-error"),P.attr("disabled",!0),x.show()):(P.removeClass("input-error"),P.attr("disabled",!1),x.hide())}),l=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.passphrase")+"</label>").appendTo(l),N=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(l),l=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(R);var x=$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(l);switch($('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.create.desc2")+"</div>").appendTo(x),l=$('<div style="text-align: center">').appendTo(x),$('<button class="red-ui-button">'+RED._("projects.create.add-ssh-key")+"</button>").appendTo(l).on("click",function(e){e.preventDefault(),$("#red-ui-projects-dialog-cancel").trigger("click"),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").trigger("click")},500)}),t=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(i),$("<label>"+RED._("projects.create.credentials-encryption-key")+"</label>").appendTo(t),j=$('<input type="password"></input>').appendTo(t),e.screen||"empty"){case"empty":a.trigger("click");break;case"open":n.trigger("click");break;case"clone":d.trigger("click")}return setTimeout(function(){"open"!==(e.screen||"empty")?k.trigger("focus"):$("#red-ui-projects-dialog-project-list-search").trigger("focus")},50),i},buttons:function(e){var t;switch(e.screen||"empty"){case"open":t=RED._("projects.create.open");break;case"empty":t=RED._("projects.create.create");break;case"clone":t=RED._("projects.create.clone")}return[{id:"red-ui-projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-projects-dialog-create",text:t,class:"primary disabled",disabled:!0,click:function(){var e=$(".red-ui-projects-dialog-screen-create-type.selected").data("type"),t={name:k.val()};if("empty"===e){t.summary=T.val(),t.files={flow:_.val()};var i=$("input[name=projects-encryption-type]:checked").val();t.credentialSecret="enabled"===i&&L.val()}else if("copy"===e)t.copy=(void 0).name;else if("clone"===e){t.credentialSecret=j.val();var o=C.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(o)){var n=P.val();if(!n)return void console.log(RED._("projects.create.cant-get-ssh-key-path"));t.git={remotes:{origin:{url:o,keyFile:n,passphrase:N.val()}}}}else t.git={remotes:{origin:{url:o,username:S.val(),password:O.val()}}}}else if("open"===e)return function(e,t){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e),q({url:"projects/"+e,type:"PUT",responses:{200:function(e){t(null,e)},400:{"*":t}}},{active:!0}).then(function(){RED.events.emit("project:change",{name:e})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}(A.name,function(e,t){B.dialog("close"),e&&"credentials_load_failed"!==e.code&&console.log(RED._("projects.create.unexpected_error"),e)});$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),S.removeClass("input-error"),O.removeClass("input-error"),P.removeClass("input-error"),N.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t.name),q({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){B.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.create.already-exists-2"))},git_error:function(e){console.log(RED._("projects.create.git-error"),e)},git_connection_failed:function(e){C.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.con-failed"))},git_not_a_repository:function(e){C.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.not-git"))},git_repository_not_found:function(e){C.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-resource"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),S.addClass("input-error"),O.addClass("input-error"),P.addClass("input-error"),N.addClass("input-error")},missing_flow_file:function(e){B.dialog("close")},missing_package_file:function(e){B.dialog("close")},project_empty:function(e){B.dialog("close")},credentials_load_failed:function(e){B.dialog("close")},"*":function(e){u(e),$(B).dialog("close")}}}},t).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}}function v(e,t){B||RED.projects.init();var i=r[e],o=i.content(t||{});a.empty();var n=i.buttons;"function"==typeof n&&(n=n(t||{})),B.dialog("option","buttons",n),a.append(o),B.dialog("option","title",i.title||""),B.dialog("open"),B.dialog({position:{my:"center top",at:"center top+20",of:window}})}function e(e){if(RED.nodes.dirty())var t=RED._("projects.require-clean.confirm"),i=RED.notify(t,{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close(),e(!0)}},{text:RED._("common.label.cont"),click:function(){i.close(),e(!1)}}]})}function q(c,p){var t,i;if(c.requireCleanWorkspace&&RED.nodes.dirty())return e(function(e){e?c.cancel&&(c.cancel(),i&&i()):(delete c.requireCleanWorkspace,q(c,p).then(function(){t&&t()}).always(function(){i&&i()}))}),{then:function(e){return t=e,{always:function(e){i=e}}},always:function(e){i=e}};var u,f,o=Date.now();return $(".red-ui-component-spinner").show(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),p&&(c.data=JSON.stringify(p),c.contentType="application/json; charset=utf-8"),$.ajax(c).done(function(e,t,i){c.responses&&c.responses[200]&&(u=c.responses[200],f=e)}).fail(function(i,e,t){if(c.responses&&c.responses[i.status]){var o=c.responses[i.status];if("function"==typeof o)return void(f={error:(u=o).statusText});if(!1!==c.handleAuthFail&&"git_auth_failed"===i.responseJSON.code){var n=U.git.remotes[i.responseJSON.remote||c.remote||"origin"].fetch,a=$('<div><div class="form-row">'+RED._("projects.send-req.auth-req")+':</div><div class="form-row"><div style="margin-left: 20px;">'+n+"</div></div></div>"),r=!1;if(/^https?:\/\//.test(n))$('<div class="form-row"><label for="projects-user-auth-username">'+RED._("projects.send-req.username")+'</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for=projects-user-auth-password">'+RED._("projects.send-req.password")+'</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(a);else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(n)){r=!0;var s=$('<div class="form-row"></div>').appendTo(a);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(s);var d=$('<select id="projects-user-auth-key">').width("70%").appendTo(s);$.getJSON("settings/user/keys",function(e){e.keys.forEach(function(e){d.append($("<option></option>").val(e.name).text(e.name)),0})}),s=$('<div class="form-row"></div>').appendTo(a),$('<label for="projects-user-auth-passphrase">'+RED._("projects.send-req.passphrase")+"</label>").appendTo(s),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(s)}var l=RED.notify(a,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){l.close()}},{text:'<span><i class="fa fa-refresh"></i> '+RED._("projects.send-req.retry")+"</span>",click:function(){p=p||{};var e={};r?(e.keyFile=$("#projects-user-auth-key").val(),e.passphrase=$("#projects-user-auth-passphrase").val()):(e.username=$("#projects-user-auth-username").val(),e.password=$("#projects-user-auth-password").val());function t(e){e?(console.log(RED._("projects.send-req.update-failed")),console.log(e)):(q(c,p),l.close())}q({url:"projects/"+U.name+"/remotes/"+(i.responseJSON.remote||c.remote||"origin"),type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null)},400:{unexpected_error:function(e){t(e)}}}},{auth:e})}}]});return}if(o[i.responseJSON.code])return u=o[i.responseJSON.code],void(f=i.responseJSON);if(o["*"])return u=o["*"],void(f=i.responseJSON)}console.log(o),console.log(RED._("projects.send-req.unhandled")+":"),console.log(i),console.log(e),console.log(t)}).always(function(){var e=Date.now()-o;e=Math.max(0,500-e),setTimeout(function(){$(".red-ui-component-spinner").hide(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),u&&u(f)},e)})}function i(n){var a,i="",o=[],r="",s=$('<div class="red-ui-projects-branch-list">').appendTo(n.container),d=$('<input type="text">').attr("placeholder",n.placeholder).appendTo(s).searchBox({delay:200,change:function(){i=$(this).val(),/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(i)?(a.hasClass("input-error")||(a.addClass("input-error"),a.find("i").addClass("fa-warning").removeClass("fa-code-fork")),a.find("span").text(RED._("projects.create-branch-list.invalid")+": "+r+i)):(a.hasClass("input-error")&&(a.removeClass("input-error"),a.find("i").removeClass("fa-warning").addClass("fa-code-fork")),a.find(".red-ui-sidebar-vc-branch-list-entry-create-name").text(r+i)),l.editableList("filter")}}),l=$("<ol>",{style:"height: 130px;"}).appendTo(s);return l.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){var o=$('<div class="red-ui-sidebar-vc-branch-list-entry">').appendTo(e);i.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(o),$("<span>").text(i.name).appendTo(o),i.current&&(o.addClass("selected"),$('<span class="current"></span>').text(n.currentLabel||RED._("projects.create-branch-list.current")).appendTo(o))):(a=o,$('<i class="fa fa-code-fork"></i>').appendTo(o),$("<span>").text(RED._("projects.create-branch-list.create")+":").appendTo(o),$('<div class="red-ui-sidebar-vc-branch-list-entry-create-name" style="margin-left: 10px;">').text(i.name).appendTo(o)),o.on("click",function(e){if(e.preventDefault(),!$(this).hasClass("input-error")){var t={};i.hasOwnProperty("commit")?($(this).hasClass("selected")&&(t.current=!0),t.name=i.name):(t.name=d.val(),t.create=!0,n.remote&&(t.name=n.remote()+"/"+t.name)),n.onselect&&n.onselect(t)}})},filter:function(e){var t=!e.hasOwnProperty("commit");return t&&""!==i&&-1===o.indexOf(r+i)||!t&&-1!==e.name.indexOf(i)}}),{refresh:function(e){d.searchBox("value",""),l.editableList("empty");var t=Date.now(),i=c(s).addClass("red-ui-component-spinner-contain");r=n.remote?n.remote()+"/":"",q({url:e,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){o=e.branches,e.branches.forEach(function(e){l.editableList("addItem",e)}),l.editableList("addItem",{}),setTimeout(function(){i.remove()},Math.max(300-(Date.now()-t),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){u(e)}}}})},filter:function(){l.editableList("filter")},focus:function(){d.trigger("focus")}}}function c(e){return $('<div class="red-ui-component-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function o(){createProjectOptions={},U?v("create",{screen:"empty"}):v("welcome")}return{init:function(){B=$('<div id="red-ui-projects-dialog" class="hide red-ui-projects-edit-form"><form class="form-horizontal"></form><div class="red-ui-component-spinner hide"><img src="red/images/spin.svg"/></div></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"}}),a=B.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var e={sendRequest:q,createBranchList:i,addSpinnerOverlay:c,reportUnexpectedError:u};RED.projects.settings.init(e),RED.projects.userSettings.init(e),RED.sidebar.versionControl.init(e),t()},showStartup:function(){RED.user.hasPermission("projects.write")?v("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?e(function(e){e||o()}):void o();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?e(function(e){e||v("create",{screen:"open"})}):void v("create",{screen:"open"});RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?(RED.projects.settings.show("settings"),setTimeout(function(){$("#project-settings-tab-settings-file-edit").trigger("click")},200)):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!U)throw new Error(RED._("projects.create-default-file-set.no-active"));if(!U.empty)throw new Error(RED._("projects.create-default-file-set.no-empty"));RED.user.hasPermission("projects.write")?(createProjectOptions={},v("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(U.name),q({url:"projects/"+U.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log(RED._("projects.create-default-file-set.git-error"),e)},missing_flow_file:function(e){$(B).dialog("close")},"*":function(e){u(e),$(B).dialog("close")}}}},{initialise:!0}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})},refresh:function(t){$.getJSON("projects",function(e){e.active?$.getJSON("projects/"+e.active,function(e){U=e,RED.sidebar.versionControl.refresh(!0),t&&t(U)}):t&&t(null)})},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return U}}}(),RED.projects.settings=function(){var J,G,t=700,i=!1,d=[];function o(e){d.push(e)}function r(e,t){var i;t.empty(),i=e.description?marked(e.description):'<span class="red-ui-help-info-none">'+RED._("sidebar.project.noDescriptionAvailable")+"</span>",function(e){return $(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),e}($('<span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(i)+'">'+i+"</span>")).appendTo(t).find(".red-ui-text-bidi-aware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>")}function c(e,t){t.empty(),e?t.text(e).removeClass("node-info-node"):t.text(RED._("sidebar.project.noSummaryAvailable")).addClass("red-ui-help-info-none")}function n(t){var e=$('<div id="red-ui-project-settings-tab-main" class="red-ui-project-settings-tab-pane red-ui-help"></div>');$("<h1>").text(t.name).appendTo(e);var i=$('<div style="position: relative">').appendTo(e),o=$("<div></div>").appendTo(i);c(t.summary,o),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editDescription")+"</button>").prependTo(i).on("click",function(e){e.preventDefault(),function n(a,r,s){var d=s.prev();d.hide(),s.empty();var e=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(s),l=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(r||"").appendTo(s);$('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(e).on("click",function(e){e.preventDefault(),c(a.summary,s),d.show()}),$('<button class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(e).on("click",function(e){e.preventDefault();var i=l.val();function t(e,t){if(e)return o.remove(),n(a,r,s);a.summary=i,o.remove(),c(a.summary,s),d.show()}c(i,s);var o=G.addSpinnerOverlay(s);G.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),t(null)},400:{"*":function(e){G.reportUnexpectedError(e),t(e)}}}},{summary:i})})}(t,t.summary,o)}),$("<hr>").appendTo(e);var n=$('<div class="red-ui-help" style="position: relative"></div>').appendTo(e),a=$("<div>",{style:"min-height: 200px"}).appendTo(n);return r(t,a),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editReadme")+"</button>").prependTo(n).on("click",function(e){e.preventDefault(),function o(n,a){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:n.description,complete:function(i){function t(e,t){if(e)return o(n,a);n.description=i,r(n,a)}a.empty();var e=G.addSpinnerOverlay(a);G.sendRequest({url:"projects/"+n.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){G.reportUnexpectedError(e),t(e)}}}},{description:i}).always(function(){e.remove()})}})}(t,a)}),e}function s(e,t){t.editableList("empty");var i=0;for(var o in h)h.hasOwnProperty(o)&&(t.editableList("addItem",{id:h[o].module,version:h[o].version,count:h[o].count,known:e.dependencies.hasOwnProperty(o),installed:!0}),i++,0===h[o].count&&0,e.dependencies.hasOwnProperty(o)||0);if(e.dependencies)for(var o in e.dependencies)if(e.dependencies.hasOwnProperty(o)&&!h.hasOwnProperty(o)){var n=!!RED.nodes.registry.getModule(o);t.editableList("addItem",{id:o,version:e.dependencies[o],count:0,known:!0,installed:n}),i++,n?0:0}0===i&&t.editableList("addItem",{index:0,label:RED._("sidebar.project.projectSettings.none")})}function p(e,t,i,o){function n(e,t){if(r.remove(),e)return o(e);a.dependencies=i,RED.sidebar.versionControl.refresh(!0),o()}var a=RED.projects.getActiveProject(),r=G.addSpinnerOverlay(t).addClass("red-ui-component-spinner-contain");G.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){n(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),n(null)},400:{"*":function(e){n(e)}}}},{dependencies:i})}function a(l){var t=$('<div id="red-ui-project-settings-tab-deps" class="red-ui-project-settings-tab-pane red-ui-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="margin-top:10px;float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(t).on("click",function(e){e.preventDefault(),function o(n,e,a,r){var t=e||JSON.stringify(n.dependencies||{},"",4);"{}"===t&&(t="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:t,requireValid:!0,complete:function(t){try{var i=JSON.parse(t);p(0,a,i,function(e){if(e)return o(n,t,a,r);n.dependencies=i,s(n,r)})}catch(e){o(n,t,a,r)}}})}(l,null,t,c)});var c=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return c.editableList({addButton:!1,addItem:function(i,e,o){var n=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(i);if(o.label)0===o.index?n.addClass("red-ui-search-empty"):i.parent().addClass("red-ui-palette-module-section"),n.text(o.label);else{n.addClass("red-ui-palette-module-header"),o.installed?0===o.count?n.addClass("red-ui-palette-module-unused"):o.known||n.addClass("red-ui-palette-module-unknown"):n.addClass("red-ui-palette-module-not-installed"),o.element=n;var t=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"></div>').appendTo(n),a="fa-cube";o.installed||(a="fa-warning");var r=$('<i class="fa '+a+'"></i>').appendTo(t);o.icon=r,$("<span>").text(o.id).appendTo(t);var s=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(n);$("<span>").text(o.version).appendTo(s);s=$('<div class="red-ui-palette-module-meta"></div>').appendTo(n);var d=$('<div class="red-ui-palette-module-button-group"></div>').appendTo(s);RED.user.hasPermission("projects.write")&&(o.installed||!1===RED.settings.theme("palette.editable")?o.known&&0===o.count?$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.removeFromProject")+"</a>").appendTo(d).on("click",function(e){e.preventDefault();var t=$.extend(!0,{},l.dependencies);delete t[o.id],p(0,i,t,function(e){e?console.log(e):i.fadeOut(200,function(){c.editableList("removeItem",o)})})}):o.known||$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.addToProject")+"</a>").appendTo(d).on("click",function(e){e.preventDefault();var t=$.extend(!0,{},l.dependencies);t[o.id]=h[o.id].version,p(0,i,t,function(e){e?console.log(e):(d.remove(),n.removeClass("red-ui-palette-module-unknown"))})}):$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.install")+"</a>").appendTo(d).on("click",function(e){e.preventDefault(),RED.palette.editor.install(o,i,function(e){if(!e){o.installed=!0;RED.utils.addSpinnerOverlay(i,!0);setTimeout(function(){c.editableList("removeItem",o),h={},RED.nodes.eachNode(f),RED.nodes.eachConfig(f),h.hasOwnProperty(o.id)?o.count=h[o.id].count:o.count=0,c.editableList("addItem",o)},500)}})}))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),s(l,c),t}function V(e,t,o,a,r){var s=$('<div class="red-ui-projects-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),d=G.addSpinnerOverlay(s);return $.getJSON("projects/"+t.name+"/files",function(t){var e=Object.keys(t);e=e.filter(function(e){return!t[e].status||!/D/.test(t[e].status)});var i={};e.sort(),e.forEach(function(e){e.split("/").reduce(function(e,t,i,o){if(t)return i<o.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]},i)});var n=function(e,t,i){var o={name:e||"/",path:i+(i?"/":"")+e};return!0===t?o.type="f":(o.type="d",o.children=[],o.path=o.path,Object.keys(t).forEach(function(e){o.children.push(n(e,t[e],o.path))}),o.children.sort(function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)})),o};i=n("",i,"");!function r(e,t,s,d,l,i){i=i||"";var o=$("<ol>",{class:"red-ui-projects-dialog-file-list",style:i}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){var o=$("<div></div>",{class:"red-ui-projects-dialog-file-list-entry"}).appendTo(e);if(i.children){if($('<span class="red-ui-projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(o),0<i.children.length){var n=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(e);0===s.indexOf(i.path+"/")?o.addClass("expanded"):n.hide(),r(n,i.children,s,d,l),o.addClass("selectable"),o.on("click",function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),n.slideUp(200)):($(this).addClass("expanded"),n.slideDown(200))})}}else{var a="fa-file-o";/\.json$/i.test(i.name)?a="fa-file-code-o":/\.md$/i.test(i.name)?a="fa-book":/^\.git/i.test(i.name)&&(a="fa-code-fork",o.addClass("red-ui-projects-dialog-file-list-entry-file-type-git")),$('<span class="red-ui-projects-dialog-file-list-entry-file"> <i class="fa '+a+'"></i></span>').appendTo(o),d(i)?(o.addClass("selectable"),i.path===s&&o.addClass("selected"),o.on("click",function(e){$(".red-ui-projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),l(i.path,!0)}),o.on("dblclick",function(e){e.preventDefault(),l(i.path,!0)})):o.addClass("unselectable")}$('<span class="red-ui-projects-dialog-file-list-entry-name" style=""></span>').text(i.name).appendTo(o)}});i||o.parent().css("overflow-y","");t.forEach(function(e){o.editableList("addItem",e)})}(s,i.children,o,a,r,"height: 175px"),d.remove()}),s}function l(r,e){$("<h3></h3>").text(RED._("sidebar.project.projectSettings.versionControl")).appendTo(e),function(d,e){var t=$('<div class="red-ui-settings-section"></div>').appendTo(e);$("<h4></h4>").text(RED._("sidebar.project.projectSettings.branches")).appendTo(t);var i=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(t),l=$("<ol>").appendTo(i).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(n,e,a){var t=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(n);if(a.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("sidebar.project.projectSettings.noBranches"));a.current&&t.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(t);var i=$("<span>").appendTo(t),o=$("<div>").appendTo(i);if($('<span class="entry-name">').text(a.name).appendTo(o),a.commit&&$('<span class="entry-detail">').text(a.commit.sha).appendTo(o),a.remote){var r=$("<div>").appendTo(i);$('<span class="entry-detail entry-remote-name">').text(a.remote||"").appendTo(r),0<a.status.ahead+a.status.behind&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+a.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+a.status.behind+"</span></span>").appendTo(r)}if(!a.current){var s=$('<span class="entry-tools">').appendTo(t);$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(s).on("click",function(e){e.preventDefault();var i=G.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),o=RED.notify(RED._("sidebar.project.projectSettings.deleteConfirm",{name:a.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.remove(),o.close()}},{text:"Delete branch",click:function(){o.close();var t={url:"projects/"+d.name+"/branches/"+a.name,type:"DELETE",responses:{200:function(e){n.fadeOut(200,function(){l.editableList("removeItem",a),i.remove()})},400:{git_delete_branch_unmerged:function(e){o=RED.notify(RED._("sidebar.project.projectSettings.unmergedConfirm",{name:a.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.remove(),o.close()}},{text:RED._("sidebar.project.projectSettings.deleteUnmergedBranch"),click:function(){t.url+="?force=true",o.close(),G.sendRequest(t)}}]})},"*":function(e){G.reportUnexpectedError(e),i.remove()}}}};G.sendRequest(t)}}]})})}}});$.getJSON("projects/"+d.name+"/branches",function(e){e.branches&&(0<e.branches.length?(e.branches.sort(function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)}),e.branches.forEach(function(e){l.editableList("addItem",e)})):l.editableList("addItem",{empty:!0}))})}(r,e);var t=$('<div class="red-ui-settings-section"></div>').appendTo(e),i=$("<h4></h4>").text(RED._("sidebar.project.projectSettings.gitRemotes")).appendTo(t),o=$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("sidebar.project.projectSettings.addRemote")+"</button>").appendTo(i).on("click",function(e){o.attr("disabled",!0),a.slideDown(200,function(){a[0].scrollIntoView(),d?(h.val("origin"),v.trigger("focus")):h.trigger("focus"),p()})}),s={empty:!0},d=!0,n=$('<div class="red-ui-settings-row"></div>').appendTo(t),a=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(n);n=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(t);var l=$("<ol>").appendTo(n);l.editableList({addButton:!1,height:"auto",addItem:function(o,e,n){var t=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(o);if(n.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("sidebar.project.projectSettings.noRemotes"));$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(t);var i=$("<span>").appendTo(t);$('<div class="entry-name">').text(n.name).appendTo(i),n.urls.fetch===n.urls.push?$('<div class="entry-detail">').text(n.urls.fetch).appendTo(i):($('<div class="entry-detail">').text("fetch: "+n.urls.fetch).appendTo(i),$('<div class="entry-detail">').text("push: "+n.urls.push).appendTo(i));var a=$('<span class="entry-tools">').appendTo(t);$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(a).on("click",function(e){e.preventDefault();var t=G.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),i=RED.notify(RED._("sidebar.project.projectSettings.deleteRemoteConfrim",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),i.close()}},{text:RED._("sidebar.project.projectSettings.deleteRemote"),click:function(){i.close(),r.git.branches.remote&&0===r.git.branches.remote.indexOf(n.name+"/")&&delete r.git.branches.remote,r.git.branches.remoteAlt&&0===r.git.branches.remoteAlt.indexOf(n.name+"/")&&delete r.git.branches.remoteAlt;var e={url:"projects/"+r.name+"/remotes/"+n.name,type:"DELETE",responses:{200:function(e){o.fadeOut(200,function(){l.editableList("removeItem",n),setTimeout(t.remove,100),0===e.remotes.length?(delete r.git.remotes,d=!0,l.editableList("addItem",s)):(r.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,r.git.remotes[t]=e})),delete r.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()})},400:{"*":function(e){G.reportUnexpectedError(e),t.remove()}}}};G.sendRequest(e)}}]})})}});var c,p=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(h.val()),t=v.val(),i=0<t.length&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(b.text(RED._("sidebar.project.projectSettings.urlRule2")),i=!1):b.text(RED._("sidebar.project.projectSettings.urlRule")),y.attr("disabled",!e||!i),h.toggleClass("input-error",u&&!e),v.toggleClass("input-error",f&&!i),c&&(c.close(),c=null)},u=!1,f=!1;$('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("sidebar.project.projectSettings.addRemote2")).appendTo(a),n=$('<div class="red-ui-settings-row"></div>').appendTo(a),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.remoteName")).appendTo(n);var h=$('<input type="text">').appendTo(n).on("change keyup paste",function(){u=!0,p()});$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.nameRule")+"</small></label>").appendTo(n).find("small"),n=$('<div class="red-ui-settings-row"></div>').appendTo(a),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.url")).appendTo(n);function g(){o.attr("disabled",!1),a.hide(),h.val(""),v.val(""),c&&(c.close(),c=null)}var v=$('<input type="text">').appendTo(n).on("change keyup paste",function(){f=!0,p()}),b=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.urlRule")+"</small></label>").appendTo(n).find("small"),m=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(a);$('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(m).on("click",function(e){e.preventDefault(),g()});var y=$('<button class="red-ui-button">'+RED._("sidebar.project.projectSettings.addRemote2")+"</button>").appendTo(m).on("click",function(e){e.preventDefault();function t(e){i.remove(),e||g()}var i=G.addSpinnerOverlay(a).addClass("red-ui-component-spinner-contain"),o={name:h.val(),url:v.val()};RED.deploy.setDeployInflight(!0),G.sendRequest({url:"projects/"+r.name+"/remotes",type:"POST",responses:{0:function(e){t(e)},200:function(e){r.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,r.git.remotes[t]=e}),w(),RED.sidebar.versionControl.refresh(),t()},400:{git_remote_already_exists:function(e){c=RED.popover.create({target:h,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),h.addClass("input-error"),t(e)},"*":function(e){G.reportUnexpectedError(e),t(e)}}}},o)}),w=function(){l.editableList("empty");var e=0;if(r.git.hasOwnProperty("remotes"))for(var t in r.git.remotes)r.git.remotes.hasOwnProperty(t)&&(e++,l.editableList("addItem",{name:t,urls:r.git.remotes[t]}));(d=0===e)&&l.editableList("addItem",s)};w()}function u(e){var t=$('<div id="red-ui-project-settings-tab-settings" class="red-ui-project-settings-tab-pane red-ui-help"></div>');return function(a,e){var t,i=$("<h3></h3>").text(RED._("sidebar.project.projectSettings.files")).appendTo(e),r=$('<div class="red-ui-settings-section"></div>').appendTo(e);if(RED.user.hasPermission("projects.write"))var o=$('<button type="button" id="red-ui-project-settings-tab-settings-file-edit" class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(i).on("click",function(e){e.preventDefault(),U.show(),o.hide(),a.files.package||(c.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.packageCreate")),c.show()),l.show(),v.hide(),m.show(),y.show(),b(),T.addClass("uneditable-input"),$(".red-ui-settings-row-credentials").show(),T.css("height","auto"),L.hide(),_.show()});t=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.package")).appendTo(t);var n=$('<div class="uneditable-input" style="padding:0">').appendTo(t),s=$('<span style="display:inline-block;  padding: 6px">').text(a.files.package||"package.json").appendTo(n),d=$('<input type="hidden">').val(a.files.package||"package.json").appendTo(n),l=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(n).on("click",function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),n.find(".red-ui-projects-file-listing-container").slideUp(200,function(){$(this).remove(),n.css("height","")}),n.css("color","");else{$(this).addClass("selected"),n.css("color","inherit");var t=V(n,a,d.val(),function(e){return e.children||/package\.json$/.test(e.path)},function(e,t){if(e){d.val(e),s.text(e);var i=e.substring(0,e.length-12);h.text(i),E.text(i),b(),c.hide()}t&&$(l).trigger("click"),k()});n.css("height","auto"),setTimeout(function(){t.slideDown(200)},50)}});RED.popover.tooltip(l,RED._("sidebar.project.projectSettings.selectFile"));var c=$('<label style="margin-left: 110px" class="red-ui-projects-edit-form-sublabel"><small><span class="form-warning"><i class="fa fa-warning"></i> <span class="red-ui-projects-edit-form-sublabel-text"></span></small></label>').appendTo(t).hide();a.files.package||(c.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),c.show());var p=a.files.package||"package.json",u=p.substring(0,p.length-12);t=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.flow")).appendTo(t);var f=$('<div class="uneditable-input" style="padding:0">').appendTo(t),h=$('<span style="display:inline-block; padding: 6px 0 6px 6px">').text(u).appendTo(f),g="flows.json";a.files.flow&&(g=0===a.files.flow.indexOf(u)?a.files.flow.substring(u.length):a.files.flow);var v=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(g).appendTo(f),b=function(){m.css({width:"calc(100% - "+(y.width()+h.width())+"px)"})},m=$('<input type="text" style="padding-left:1px; margin-top: -2px; margin-bottom: 0;border: none;">').val(g).hide().appendTo(f),y=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(f).on("click",function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),f.find(".red-ui-projects-file-listing-container").slideUp(200,function(){$(this).remove(),f.css("height","")}),f.css("color","");else{$(this).addClass("selected"),f.css("color","inherit");var t=d.val(),i=t.substring(0,t.length-12),o=new RegExp("^"+i+".*.json$"),n=V(f,a,m.val(),function(e){return!/package.json$/.test(e.path)&&o.test(e.path)&&!/_cred\.json$/.test(e.path)},function(e,t){e&&m.val(e.substring(i.length)),t&&$(y).trigger("click"),k()});f.css("height","auto"),setTimeout(function(){n.slideDown(200)},50)}});RED.popover.tooltip(y,RED._("sidebar.project.projectSettings.selectFile")),t=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.credentials")).appendTo(t);var w="flows_cred.json";a.files.credentials&&(w=0===a.files.flow.indexOf(u)?a.files.credentials.substring(u.length):a.files.credentials);var D=$('<div class="uneditable-input" style="padding:0">').appendTo(t),E=$('<span style="display:inline-block;padding: 6px 0 6px 6px">').text(u).appendTo(D),R=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(w).appendTo(D),x=$('<input type="hidden">').val(w).insertAfter(D),k=function(){var e,t=m.val(),i=/^(.+?)(\.[^.]*)?$/.exec(t);i?R.text(i[1]+"_cred"+(i[2]||".json")):""===t&&R.text(""),x.val(R.text());var o=""===t||/\.\./.test(t)||/\/$/.test(t);e=o||""===R.text(),N.is(":visible")&&(N.toggleClass("input-error",""===N.val()),e=e||""===N.val()),M.is(":visible")&&(M.toggleClass("input-error",""===M.val()),e=e||""===M.val()),m.toggleClass("input-error",o),q.toggleClass("disabled",e),q.prop("disabled",e)};m.on("change keyup paste",k),t=$('<div class="red-ui-settings-row"></div>').appendTo(r),$("<label></label>").appendTo(t);var T=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(t),_=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(t);T.css("color","#666"),_.css("vertical-align","top");var j=$('<button type="button" class="red-ui-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(_).on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),L.hide()):(M.val(""),P.hide(),A.show(),$(this).addClass("selected"),C.removeClass("selected"),I.show(),B.show(),S.hide(),O.hide(),L.show()),k()});RED.popover.tooltip(j,RED._("sidebar.project.projectSettings.resetTheEncryptionKey"));var C=$('<button type="button" class="red-ui-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(_).on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),L.hide()):(N.val(""),M.val(""),a.settings.credentialSecretInvalid||!a.settings.credentialsEncrypted?(S.show(),O.hide(),P.hide()):(P.show(),S.hide(),O.show()),A.show(),C.addClass("selected"),j.removeClass("selected"),I.hide(),B.hide(),L.show()),k()});RED.popover.tooltip(C,RED._("sidebar.project.projectSettings.changeTheEncryptionKey")),t=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').hide().appendTo(r);var L=$("<div>",{style:"margin-top:10px"}).hide().appendTo(T),S=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.setTheEncryptionKey")+"</div>").hide().appendTo(L),O=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.changeTheEncryptionKey")+"</div>").hide().appendTo(L),I=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.resetTheEncryptionKey")+"</div>").hide().appendTo(L),P=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(L);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.currentKey")).appendTo(P);var N=$('<input type="password">').appendTo(P).on("change keyup paste",function(){J&&(J.close(),J=null),k()}),A=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(L);function z(){o.show(),U.hide(),l.hide(),v.show(),m.hide(),y.hide(),T.removeClass("uneditable-input"),T.css("height",""),y.removeClass("selected"),f.find(".red-ui-projects-file-listing-container").remove(),f.css("height",""),f.css("color",""),$(".red-ui-settings-row-credentials").hide(),L.hide(),_.hide(),j.removeClass("selected"),C.removeClass("selected")}$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.newKey")).appendTo(A);var M=$('<input type="password">').appendTo(A).on("change keyup paste",k),B=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i>'+RED._("sidebar.project.projectSettings.credentialsAlert")+"</div>").hide().appendTo(L),U=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(r);$('<button type="button" class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(U).on("click",function(e){e.preventDefault();var t=a.files.package||"package.json",i=t.substring(0,t.length-12);h.text(i),E.text(i),s.text(a.files.package||"package.json"),a.files.package?c.hide():(c.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),c.show()),m.val(v.text()),R.text(w),z()});var q=$('<button type="button" class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(U).on("click",function(e){e.preventDefault();function t(e){i.remove(),e?G.reportUnexpectedError(e):(v.text(m.val()),R.text(x.val()),c.hide(),z())}var i=G.addSpinnerOverlay(r),o=d.val();o=o.substring(0,o.length-12);var n={files:{package:d.val(),flow:o+m.val(),credentials:o+x.val()}};j.hasClass("selected")&&(n.resetCredentialSecret=!0),(j.hasClass("selected")||C.hasClass("selected"))&&(n.credentialSecret=M.val(),N.is(":visible")&&(n.currentCredentialSecret=N.val())),RED.deploy.setDeployInflight(!0),G.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){a=e,RED.sidebar.versionControl.refresh(!0),F(),t()},400:{credentials_load_failed:function(e){t(e)},missing_current_credential_key:function(e){N.addClass("input-error"),J=RED.popover.create({target:N,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),t(e)},"*":function(e){t(e)}}}},n).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),F=function(){a.settings.credentialSecretInvalid?(T.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),T.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.invalidEncryptionKey"))):a.settings.credentialsEncrypted?(T.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),T.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionEnabled"))):(T.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),T.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionDisabled"))),j.toggleClass("disabled",!a.settings.credentialSecretInvalid&&!a.settings.credentialsEncrypted),j.prop("disabled",!a.settings.credentialSecretInvalid&&!a.settings.credentialsEncrypted)};k(),F()}(e,t),l(e,t),t}function f(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(h.hasOwnProperty(t)||(h[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),h[t].count++)}}var h={};return{init:function(e){G=e,o({id:"main",title:RED._("sidebar.project.name"),get:n,close:function(){}}),o({id:"deps",title:RED._("sidebar.project.dependencies"),get:a,close:function(){}}),o({id:"settings",title:RED._("sidebar.project.settings"),get:u,close:function(){J&&(J.close(),J=null)}}),RED.events.on("nodes:add",f),RED.events.on("nodes:remove",function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&h.hasOwnProperty(t)&&(h[t].count--,0===h[t].count&&(h[t].known||delete h[t]))}})},show:function(s){if(!i)if(RED.user.hasPermission("projects.write")){i=!0;var e={title:RED._("sidebar.project.projectSettings.title"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var t=RED.projects.getActiveProject(),i=e.find(".red-ui-tray-body"),o=$("<div></div>").appendTo(i),n=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(o);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(n);var a=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){r.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),r=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(o);d.forEach(function(e){a.addTab({id:"red-ui-project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(t).hide().appendTo(r)}),o.i18n(),a.activateTab("red-ui-project-settings-tab-"+(s||"main")),$("#red-ui-sidebar-shade").show()},close:function(){i=!1,d.forEach(function(e){e.close&&e.close()}),$("#red-ui-sidebar-shade").hide()},show:function(){}};null!==t&&(e.width=t),RED.tray.show(e)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){h={}}}}(),RED.projects.userSettings=function(){var n,D,E;function t(e){var t=$('<div id="red-ui-settings-tab-gitconfig" class="project-settings-tab-pane red-ui-help"></div>');return function(e){var t=RED.settings.get("git")||{};t.user=t.user||{},$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.committerDetail")).appendTo(e);var i=$('<div class="red-ui-settings-section"></div>').appendTo(e);$('<div class="red-ui-settings-section-description"></div>').appendTo(i).text(RED._("editor:sidebar.project.userSettings.committerTip"));var o=$('<div class="red-ui-settings-row"></div>').appendTo(i);$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.userName")).appendTo(o),(n=$('<input type="text">').appendTo(o)).val(t.user.name||""),o=$('<div class="red-ui-settings-row"></div>').appendTo(i),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.email")).appendTo(o),(D=$('<input type="text">').appendTo(o)).val(t.user.email||"")}(t),function(e){function t(){var e=/^[a-zA-Z0-9\-_]+$/.test(c.val());c.toggleClass("input-error",l&&!e);var t=f.val(),i=0===t.length||8<=t.length;f.toggleClass("input-error",!i),i?0===t.length?h.text(RED._("editor:sidebar.project.userSettings.optional")):h.text(""):h.text(RED._("editor:sidebar.project.userSettings.passphraseShort")),e=e&&i,v.attr("disabled",!e),o&&(o.close(),o=null)}var o,i=$('<div class="red-ui-settings-section"></div>').appendTo(e),n=($("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.sshKeys")).appendTo(i),$('<div class="red-ui-settings-section-description"></div>').appendTo(i).text(RED._("editor:sidebar.project.userSettings.sshKeysTip"))),a=$('<button id="user-settings-gitconfig-add-key" class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("editor:sidebar.project.userSettings.add")+"</button>").appendTo(n).on("click",function(e){a.attr("disabled",!0),v.attr("disabled",!0),s.slideDown(200),c.trigger("focus")}),r=$('<div class="red-ui-settings-row"></div>').appendTo(i),s=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(r);$('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("editor:sidebar.project.userSettings.addSshKey")).appendTo(s);var d=$("<div>").appendTo(s);r=$('<div class="red-ui-settings-row"></div>').appendTo(d),$('<div class="red-ui-settings-section-description"></div>').appendTo(r).text(RED._("editor:sidebar.project.userSettings.addSshKeyTip")),r=$('<div class="red-ui-settings-row"></div>').appendTo(d),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.name")).appendTo(r);var l=!1,c=$('<input type="text">').appendTo(r).on("change keyup paste",function(){l=!0,t()});$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.nameRule")+"</small></label>").appendTo(r).find("small");var p=$("<div>").appendTo(d);function u(){a.attr("disabled",!1),s.hide(),c.val(""),l=!1,f.val(""),o&&(o.close(),o=null)}r=$('<div class="red-ui-settings-row"></div>').appendTo(p),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.passphrase")).appendTo(r);var f=$('<input type="password">').appendTo(r).on("change keyup paste",t),h=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.optional")+"</small></label>").appendTo(r).find("small"),g=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(s);$('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.cancel")+"</button>").appendTo(g).on("click",function(e){e.preventDefault(),u()});var v=$('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.generate")+"</button>").appendTo(g).on("click",function(e){e.preventDefault();var t=E.addSpinnerOverlay(s).addClass("red-ui-component-spinner-contain"),i={name:c.val(),type:"generate"};i.comment=D.val(),i.password=f.val(),i.size=4096;function o(e){t.remove(),e||u()}RED.deploy.setDeployInflight(!0),E.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){o(e)},200:function(e){w(i.name),o()},400:{unexpected_error:function(e){console.log(e),o(e)}}}},i)});function b(e,t){var i=$('<div class="red-ui-projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),o=$("<pre>",{style:"min-height: 80px"}).appendTo(i),n=E.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),a={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){o.text(e.publickey),n.remove()},400:{unexpected_error:function(e){console.log(e),n.remove()}}}};E.sendRequest(a);var r=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(i);return $('<button class="red-ui-button red-ui-button-small">'+RED._("editor:sidebar.project.userSettings.copyPublicKey")+"</button>").appendTo(r).on("click",function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(o[0]);document.execCommand("copy");document.getSelection().empty()}catch(e){}}),i}r=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(i);var m={empty:!0},y=$('<ol class="red-ui-projects-dialog-ssh-key-list">').appendTo(r).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(o,e,n){var t=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(o);if(n.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("editor:sidebar.project.userSettings.noSshKeys"));var i=$('<div class="red-ui-projects-dialog-ssh-key-header">').appendTo(t);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(i),$('<span class="entry-name">').text(n.name).appendTo(i);var a,r=$('<span class="button-row entry-tools">').appendTo(i);i.on("click",function(e){a?a.slideUp(200,function(){a.remove(),a=null}):a=b(t,n)}),n.system||$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).on("click",function(e){e.stopPropagation();var t=E.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),i=RED.notify(RED._("editor:sidebar.project.userSettings.deleteConfirm",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),i.close()}},{text:RED._("editor:sidebar.project.userSettings.delete"),click:function(){i.close();var e={url:"settings/user/keys/"+n.name,type:"DELETE",responses:{200:function(e){o.fadeOut(200,function(){y.editableList("removeItem",n),setTimeout(t.remove,100),0===y.editableList("length")&&y.editableList("addItem",m)})},400:{unexpected_error:function(e){console.log(e),t.remove()}}}};E.sendRequest(e)}}]})}),n.expand&&(a=b(t,n))}}),w=function(t){$.getJSON("settings/user/keys",function(e){e.keys&&(e.keys.sort(function(e,t){return e.name.localeCompare(t.name)}),y.editableList("empty"),e.keys.forEach(function(e){e.name===t&&(e.expand=!0),y.editableList("addItem",e)}),0===y.editableList("length")&&y.editableList("addItem",m))})};w()}(t),t}return{init:function(e){E=e,RED.userSettings.add({id:"gitconfig",title:RED._("editor:sidebar.project.userSettings.gitConfig"),get:t,close:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=n.val(),e.user.email=D.val(),RED.settings.set("git",e)}})}}}(),RED.sidebar.versionControl=function(){var S,O,I,P,N,A,s,z,M,B,U,q,F,d,J,G,V,W={};function K(i,o,e,n){i.addClass("red-ui-sidebar-vc-change-entry");var a=$("<div>").appendTo(i);if(o.label){if(i.addClass("red-ui-help-info-none"),a.text(o.label),o.button){a.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var t=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(a);$('<button class="red-ui-button red-ui-button-small"></button>').text(o.button.label).appendTo(t).on("click",o.button.click)}}else{var r,s,d=$('<i class=""></i>').appendTo(a),l=$('<a href="#">').appendTo(a).on("click",function(e){e.preventDefault(),function(o,n){var a=RED.projects.getActiveProject(),e="staged"===n?"index":"tree";J.sendRequest({url:"projects/"+a.name+"/diff/"+e+"/"+encodeURIComponent(o.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t;t="unstaged"===n?RED._("sidebar.project.versionControl.unstagedChanges")+" : "+o.file:"staged"===n?RED._("sidebar.project.versionControl.stagedChanges")+" : "+o.file:RED._("sidebar.project.versionControl.resolveConflicts")+" : "+o.file;var i={diff:e.diff,title:t,unmerged:"unmerged"===n,project:a};"unstaged"==n?(i.oldRevTitle=" "===o.indexStatus?RED._("sidebar.project.versionControl.head"):RED._("sidebar.project.versionControl.staged"),i.newRevTitle=RED._("sidebar.project.versionControl.unstaged"),i.oldRev=" "===o.indexStatus?"@":":0",i.newRev="_"):"staged"===n?(i.oldRevTitle=RED._("sidebar.project.versionControl.head"),i.newRevTitle=RED._("sidebar.project.versionControl.staged"),i.oldRev="@",i.newRev=":0"):(i.oldRevTitle=RED._("sidebar.project.versionControl.local"),i.newRevTitle=RED._("sidebar.project.versionControl.remote"),i.commonRev=":1",i.oldRev=":2",i.newRev=":3",i.onresolve=function(e){J.sendRequest({url:"projects/"+a.name+"/resolve/"+encodeURIComponent(o.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){Z(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:e.resolutions[o.file]})}),RED.diff.showUnifiedDiff(i)},400:{unexpected_error:function(e){console.log(e)}}}})}(o,n)}),c=$("<span>").appendTo(l),p=$('<div class="red-ui-sidebar-vc-change-entry-tools">').appendTo(i);if("unstaged"===n&&(r=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(p),s=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(r).on("click",function(e){e.preventDefault();var t=J.addSpinnerOverlay(a).addClass("red-ui-component-spinner-contain"),i=RED.notify(RED._("sidebar.project.versionControl.revert",{file:o.file}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),i.close()}},{text:RED._("sidebar.project.versionControl.revertChanges"),click:function(){i.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+o.file,type:"DELETE",responses:{200:function(e){t.remove()},400:{unexpected_error:function(e){t.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),J.sendRequest(e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]})}),RED.popover.tooltip(s,RED._("sidebar.project.versionControl.revertChanges"))),r=$('<span class="button-group"></span>').appendTo(p),"unmerged"!==n){var u=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-'+("unstaged"===n?"plus":"minus")+'"></i></button>').appendTo(r).on("click",function(e){e.preventDefault();var t=RED.projects.getActiveProject();o.spinner=J.addSpinnerOverlay(i).addClass("projects-version-control-spinner-sidebar"),J.sendRequest({url:"projects/"+t.name+"/stage/"+encodeURIComponent(o.file),type:"unstaged"===n?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){Q(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})});RED.popover.tooltip(u,RED._("sidebar.project.versionControl."+("unstaged"===n?"stage":"unstage")+"Change"))}o["update"+("unstaged"===n?"Unstaged":"Staged")]=function(e,t){a.removeClass();var i="";i="A"===t?(a.addClass("red-ui-diff-state-added"),"fa-plus-square"):"?"===t?(a.addClass("red-ui-diff-state-unchanged"),"fa-question-circle-o"):"D"===t?(a.addClass("red-ui-diff-state-deleted"),"fa-minus-square"):"M"===t?(a.addClass("red-ui-diff-state-changed"),"fa-square"):"R"===t?(a.addClass("red-ui-diff-state-changed"),"fa-toggle-right"):("U"===t&&a.addClass("red-ui-diff-state-conflicted"),"fa-exclamation-triangle"),c.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(c),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(c),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(c)),d.removeClass(),d.addClass("fa "+i),e.spinner&&(e.spinner.remove(),delete e.spinner),s&&s.toggle("?"!==t),l.toggleClass("disabled","D"===t||"?"===t)},o["update"+("unstaged"===n?"Unstaged":"Staged")](o,e)}}function H(e){var t=Date.now()/1e3-e,i=Math.floor(t/86400);if(30<i)return new Date(1e3*e).toLocaleDateString();if(0<i)return RED._("sidebar.project.versionControl.daysAgo",{count:i});var o=Math.floor(t/3600);if(0<o)return RED._("sidebar.project.versionControl.hoursAgo",{count:o});var n=Math.floor(t/60);return 0<n?RED._("sidebar.project.versionControl.minsAgo",{count:n}):RED._("sidebar.project.versionControl.secondsAgo")}function Y(e,t){var i=RED.projects.getActiveProject();(s=t?J.addSpinnerOverlay(I.parent()):J.addSpinnerOverlay(N.parent())).addClass("red-ui-component-spinner-sidebar");var o=t?{files:e}:void 0;J.sendRequest({url:"projects/"+i.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){Q(e)},400:{unexpected_error:function(e){console.log(e)}}}},o)}var n=!1;function X(o,n,e,a,t){var r=J.addSpinnerOverlay(e),i=o+"?limit="+(a||20);t&&(i+="&before="+t),J.sendRequest({url:i,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t;e.commits.forEach(function(e){n.editableList("addItem",e),t=e.sha}),n.loadMoreItem&&(n.editableList("removeItem",n.loadMoreItem),delete n.loadMoreItem);var i=n.editableList("length");i<e.total&&(n.loadMoreItem={totalKnown:i,total:e.total,url:o,before:t+"~1",limit:a},n.editableList("addItem",n.loadMoreItem)),r.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function Q(e){var o=e.files;s&&(s.remove(),s=null),(d=!!e.merging)?(S.addClass("red-ui-sidebar-vc-merging"),z.show()):(S.removeClass("red-ui-sidebar-vc-merging"),z.hide()),I.editableList("removeItem",G),N.editableList("removeItem",G),M.editableList("removeItem",V);var t=Object.keys(o).filter(function(e){return"f"===o[e].type});t.sort();var n=Date.now()+Math.floor(100*Math.random());t.forEach(function(e){var t=o[e],i=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),W[e]?(W[e].unmerged&&!t.unmerged?(M.editableList("removeItem",W[e]),i=!0):!W[e].unmerged&&t.unmerged&&(I.editableList("removeItem",W[e]),N.editableList("removeItem",W[e])),W[e].status!==t.status&&(" "!==W[e].treeStatus?" "===t.treeStatus?I.editableList("removeItem",W[e]):t.treeStatus!==W[e].treeStatus&&W[e].updateUnstaged(t,t.treeStatus):i=!0," "!==W[e].indexStatus&&"?"!==W[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?N.editableList("removeItem",W[e]):t.indexStatus!==W[e].indexStatus&&W[e].updateStaged(t,t.indexStatus):i=!0),W[e].status=t.status,W[e].indexStatus=t.indexStatus,W[e].treeStatus=t.treeStatus,W[e].oldName=t.oldName,W[e].unmerged=t.unmerged):(i=!0,W[e]=t),W[e].updateIndex=n,i&&(t.unmerged?M.editableList("addItem",W[e]):(" "!==t.treeStatus&&I.editableList("addItem",W[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&N.editableList("addItem",W[e]))))}),Object.keys(W).forEach(function(e){W[e].updateIndex!==n&&(I.editableList("removeItem",W[e]),N.editableList("removeItem",W[e]),delete W[e])});var i=N.editableList("length"),a=I.editableList("length"),r=M.editableList("length");B.prop("disabled",d&&0<r||!d&&0===i),P.prop("disabled",0===a),A.prop("disabled",0===i),0===i&&N.editableList("addItem",G),0===a&&I.editableList("addItem",G),0===r&&M.editableList("addItem",V)}function Z(e,t){if(!n&&(e&&(W={},I.editableList("empty"),N.editableList("empty"),M.editableList("empty")),RED.user.hasPermission("projects.write"))){n=!0,function(){q.editableList("empty");var e=RED.projects.getActiveProject();e&&X("projects/"+e.name+"/commits",q,q.parent())}();var o=RED.projects.getActiveProject();if(o){var i="projects/"+o.name+"/status";t&&(i+="?remote=true"),$.getJSON(i,function(e){Q(e),$("#red-ui-sidebar-vc-local-branch").text(e.branches.local),$("#red-ui-sidebar-vc-remote-branch").text(e.branches.remote||RED._("sidebar.project.versionControl.none"));var t=e.commits.ahead||0,i=e.commits.behind||0;o.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#red-ui-sidebar-vc-repo-status-auth-issue").show(),$("#red-ui-sidebar-vc-repo-status-stats").hide(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-toolbar-message").hide(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").show()):($("#red-ui-sidebar-vc-repo-toolbar-message").show(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").hide(),$("#red-ui-sidebar-vc-repo-status-auth-issue").hide(),$("#red-ui-sidebar-vc-repo-status-stats").show(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-status-button").show(),e.branches.hasOwnProperty("remote")?ee(t,i):($("#red-ui-sidebar-vc-commits-ahead").text(""),$("#red-ui-sidebar-vc-commits-behind").text(""),$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.notTracking")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))):$("#red-ui-sidebar-vc-repo-status-button").hide(),n=!1,$(".red-ui-sidebar-vc-shade").hide()}).fail(function(){n=!1})}else $(".red-ui-sidebar-vc-shade").show(),I.editableList("empty"),N.editableList("empty"),M.editableList("empty")}}function ee(e,t){$("#red-ui-sidebar-vc-commits-ahead").text(e),$("#red-ui-sidebar-vc-commits-behind").text(t),d?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.statusUnmergedChanged")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0<e&&0===t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAhead",{count:e})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1)):0===e&&0<t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsBehind",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0<e&&0<t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAheadAndBehind1",{count:t})+RED._("sidebar.project.versionControl.commitsAheadAndBehind2",{count:e})+RED._("sidebar.project.versionControl.commitsAheadAndBehind3",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0===e&&0===t&&($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.repositoryUpToDate")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))}function te(){Z(),RED.sidebar.show("version-control")}return{init:function(e){J=e,RED.actions.add("core:show-version-control-tab",te),RED.events.on("deploy",function(){var e=RED.projects.getActiveProject();e&&(W={},I.editableList("empty"),N.editableList("empty"),M.editableList("empty"),$.getJSON("projects/"+e.name+"/status",function(e){Q(e)}))}),RED.events.on("login",function(){Z(!0)}),S=$("<div>",{class:"red-ui-sidebar-vc"});var t=$("<div>",{class:"red-ui-sidebar-vc-stack"}).appendTo(S);O=RED.stack.create({container:t,fill:!0,singleExpanded:!0}),(U=O.add({title:RED._("sidebar.project.versionControl.localChanges"),collapsible:!0})).expand(),U.content.css({height:"100%"});var i=$('<div style="float: right"></div>').appendTo(U.header),o=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),Z(!0)});RED.popover.tooltip(o,RED._("sidebar.project.versionControl.refreshChanges")),G={label:RED._("sidebar.project.versionControl.none")},V={label:RED._("sidebar.project.versionControl.conflictResolve")};var n=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(U.content),a=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.localFiles")+"</div>").appendTo(n);P=$('<button class="red-ui-button red-ui-button-small" style="float: right"><i class="fa fa-plus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(a).on("click",function(e){e.preventDefault(),e.stopPropagation(),Y(Object.keys(W).filter(function(e){return" "!==W[e].treeStatus}),!0)}),RED.popover.tooltip(P,RED._("sidebar.project.versionControl.stageAllChange")),(I=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(n)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){K(e,i,i.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),z=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(U.content),a=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.unmergedChanges")+"</div>").appendTo(z),i=$('<div style="float: right"></div>').appendTo(a);var r=$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.abortMerge")+"</button>").appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation();var t=J.addSpinnerOverlay(z),i=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),J.sendRequest({url:"projects/"+i.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),Z(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})});(M=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(z)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){i===V&&(i.button={label:RED._("sidebar.project.versionControl.commit"),click:function(e){e.preventDefault(),e.stopPropagation(),d()}}),K(e,i,i.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var s=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(U.content);a=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.changeToCommit")+"</div>").appendTo(s),i=$('<div style="float: right"></div>').appendTo(a);var d=function(){l.val(""),u.prop("disabled",!0),n.css("height","30px"),z.is(":visible")?(z.css("height","30px"),s.css("height","calc(100% - 60px - 175px)")):s.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout(function(){commitBox.css("height","175px")},10),P.prop("disabled",!0),A.prop("disabled",!0),B.prop("disabled",!0),r.prop("disabled",!0),l.trigger("focus")};B=$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.commit")+"</button>").appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),d()}),RED.popover.tooltip(B,RED._("sidebar.project.versionControl.commitChanges")),A=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-minus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),Y(Object.keys(W).filter(function(e){return" "!==W[e].indexStatus&&"?"!==W[e].indexStatus}),!1)}),RED.popover.tooltip(A,RED._("sidebar.project.versionControl.unstageAllChange")),(N=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(s)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){K(e,i,i.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-bottom"></div>').hide().appendTo(U.content);var l=$("<textarea></textarea>").attr("placeholder",RED._("sidebar.project.versionControl.commitPlaceholder")).appendTo(commitBox).on("change keyup paste",function(){u.prop("disabled",""===$(this).val().trim())}),c=$('<div class="red-ui-sidebar-vc-slide-box-toolbar button-group">').appendTo(commitBox),p=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.cancelCapital")+"</button>").appendTo(c).on("click",function(e){e.preventDefault(),l.val(""),n.css("height",""),z.css("height",""),s.css("height",""),commitBox.css("height",0),setTimeout(function(){commitBox.hide()},200),P.prop("disabled",!1),A.prop("disabled",!1),B.prop("disabled",!1),r.prop("disabled",!1)}),u=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.commitCapital")+"</button>").appendTo(c).on("click",function(e){e.preventDefault();var t=J.addSpinnerOverlay(u).addClass("red-ui-component-spinner-sidebar"),i=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),J.sendRequest({url:"projects/"+i.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),p.trigger("click"),Z(!0)},400:{"*":function(e){J.reportUnexpectedError(e)}}}},{message:l.val()}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),f=O.add({title:RED._("sidebar.project.versionControl.commitHistory"),collapsible:!0});i=$('<div style="float: right"></div>').appendTo(f.header),o=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),Z(!0,!0)}),RED.popover.tooltip(o,RED._("sidebar.project.versionControl.refreshCommitHistory"));var h=$('<div class="red-ui-sidebar-vc-change-header" style="text-align: right;"></div>').appendTo(f.content),g=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.branch")+' <span id="red-ui-sidebar-vc-local-branch"></span></button>').appendTo(h).on("click",function(e){if(e.preventDefault(),$(this).hasClass("selected"))b();else{D(),F.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();y.refresh("projects/"+t.name+"/branches"),m.show(),setTimeout(function(){m.css("height","215px"),y.focus()},100)}});RED.popover.tooltip(g,RED._("sidebar.project.versionControl.changeLocalBranch"));var v=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 10px;" id="red-ui-sidebar-vc-repo-status-button"><span id="red-ui-sidebar-vc-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="red-ui-sidebar-vc-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="red-ui-sidebar-vc-commits-behind"></span></span><span id="red-ui-sidebar-vc-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(h).on("click",function(e){if(e.preventDefault(),$(this).hasClass("selected"))D();else{b(),F.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),w.show(),setTimeout(function(){w.css("height","265px")},100)}});RED.popover.tooltip(v,RED._("sidebar.project.versionControl.manageRemoteBranch")),q=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(f.content),F=$('<div class="red-ui-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(f.content),q.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,i){if(t.addClass("red-ui-sidebar-vc-commit-entry"),i.url)t.addClass("red-ui-sidebar-vc-commit-more"),t.text("+ "+(i.total-i.totalKnown)+RED._("sidebar.project.versionControl.moreCommits")),t.on("click",function(e){e.preventDefault(),X(i.url,q,t,i.limit,i.before)});else{t.on("click",function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+i.sha,function(e){e.project=t,e.parents=i.parents,e.oldRev=i.sha+"~1",e.newRev=i.sha,e.oldRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+i.sha.substring(0,7)+"~1",e.newRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+i.sha.substring(0,7),e.date=H(parseInt(i.date)),RED.diff.showCommitDiff(e)})});var o=$("<div>").appendTo(t);if($('<div class="red-ui-sidebar-vc-commit-subject">').text(i.subject).appendTo(o),i.refs){var n=$('<div class="red-ui-sidebar-vc-commit-refs">').appendTo(o);i.refs.forEach(function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="red-ui-sidebar-vc-commit-ref">').text(t).appendTo(n)}),t.addClass("red-ui-sidebar-vc-commit-head")}$('<div class="red-ui-sidebar-vc-commit-sha">').text(i.sha.substring(0,7)).appendTo(o),$('<div class="red-ui-sidebar-vc-commit-date">').text(H(parseInt(i.date))).appendTo(o)}}});var b=function(e){g.removeClass("selected"),m.css("height","0"),F.hide(),setTimeout(function(){m.hide(),e&&e()},200)},m=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px;"></div>').hide().appendTo(f.content);$('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.changeLocalBranch")).appendTo(m);var y=J.createBranchList({placeholder:RED._("sidebar.project.versionControl.createBranchPlaceholder"),container:m,onselect:function(e){if(e.current)return b();var t=J.addSpinnerOverlay(m),i=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),J.sendRequest({url:"projects/"+i.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){b(function(){t.remove()})},400:{git_local_overwrite:function(e){t.remove(),RED.notify(RED._("sidebar.project.versionControl.localOverwrite"),{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}),w=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px"></div>').hide().appendTo(f.content),D=function(){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),v.removeClass("selected"),w.css("height","0"),F.hide(),setTimeout(function(){w.hide(),E()},200)},E=function(e){x.hasClass("selected")&&(x.removeClass("selected"),_.height(0),w.css("height","265px"),setTimeout(function(){_.hide(),e&&e()},200))};$('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.manageRemoteBranch")).appendTo(w);var R=$('<div style="margin-bottom: 5px;"></div>').appendTo(w),x=$('<button id="red-ui-sidebar-vc-repo-branch" class="red-ui-sidebar-vc-repo-action red-ui-button"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.remote")+': <span id="red-ui-sidebar-vc-remote-branch"></span></button>').appendTo(R).on("click",function(e){if(e.preventDefault(),$(this).hasClass("selected"))E();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();j.refresh("projects/"+t.name+"/branches/remote"),_.show(),setTimeout(function(){_.height(180),w.css("height","445px"),j.focus()},100)}});$('<div id="red-ui-sidebar-vc-repo-toolbar-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').appendTo(w);var k=$('<div id="red-ui-sidebar-vc-repo-toolbar-error-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(w);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> '+RED._("sidebar.project.versionControl.unableToAccess")+"</div>").appendTo(k);var T=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(k);$('<button class="red-ui-button" style="width: 80%;"><i class="fa fa-refresh"></i> '+RED._("sidebar.project.versionControl.retry")+"</button>").appendTo(T).on("click",function(e){e.preventDefault();var t=RED.projects.getActiveProject(),i=J.addSpinnerOverlay(w).addClass("red-ui-component-spinner-contain");J.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){Z(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always(function(){i.remove()})}),$('<div class="red-ui-sidebar-vc-slide-box-header" style="height: 20px;"><label id="red-ui-sidebar-vc-repo-toolbar-set-upstream-row" for="red-ui-sidebar-vc-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="red-ui-sidebar-vc-repo-toolbar-set-upstream"> '+RED._("sidebar.project.versionControl.setUpstreamBranch")+"</label></div>").appendTo(w);var _=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(R),j=J.createBranchList({placeholder:RED._("sidebar.project.versionControl.createRemoteBranchPlaceholder"),currentLabel:RED._("sidebar.project.versionControl.upstream"),remote:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)[0]},container:_,onselect:function(e){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!1),$("#red-ui-sidebar-vc-remote-branch").text(e.name+(e.create?" *":""));var o=RED.projects.getActiveProject();o.git.branches.remote===e.name?delete o.git.branches.remoteAlt:o.git.branches.remoteAlt=e.name,$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!o.git.branches.remoteAlt),E(function(){if(e.create)o.git.branches.remote?$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.selectUpstreamBranch")):($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.trackedUpstreamBranch")),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!0),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!0)),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1);else{var t=Date.now(),i=J.addSpinnerOverlay($("#red-ui-sidebar-vc-repo-toolbar-message")).addClass("red-ui-component-spinner-contain");$.getJSON("projects/"+o.name+"/branches/remote/"+e.name+"/status",function(e){setTimeout(function(){ee(e.commits.ahead,e.commits.behind),i.remove()},Math.max(400-(Date.now()-t),0))})}})}}),C=$('<div style="margin-bottom: 5px;"></div>').appendTo(w);$('<button id="red-ui-sidebar-vc-repo-push" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-up"></i> <span data-i18n="sidebar.project.versionControl.push"></span></button>').appendTo(C).on("click",function(e){e.preventDefault();var t=J.addSpinnerOverlay(w).addClass("red-ui-component-spinner-contain"),i=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(t);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(i).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")});var o=RED.projects.getActiveProject();RED.eventLog.startEvent("Push changes"+(o.git.branches.remoteAlt?" : "+o.git.branches.remoteAlt:""));var n="projects/"+o.name+"/push";o.git.branches.remoteAlt&&(n+="/"+o.git.branches.remoteAlt);var a=$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked");a&&(n+="?u=true"),J.sendRequest({url:n,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){a&&o.git.branches.remoteAlt&&(o.git.branches.remote=o.git.branches.remoteAlt,delete o.git.branches.remoteAlt),Z(!0),D()},400:{git_push_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.pushFailed"),"error")},unexpected_error:function(e){console.log(e)}}}},{}).always(function(){t.remove()})});var L=function(i){i=i||{};var e=J.addSpinnerOverlay(w).addClass("red-ui-component-spinner-contain"),t=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(e);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(t).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")});var o=RED.projects.getActiveProject();RED.eventLog.startEvent("Pull changes"+(o.git.branches.remoteAlt?" : "+o.git.branches.remoteAlt:""));var n="projects/"+o.name+"/pull";o.git.branches.remoteAlt&&(n+="/"+o.git.branches.remoteAlt),(i.setUpstream||i.allowUnrelatedHistories)&&(n+="?"),i.setUpstream&&(n+="setUpstream=true",i.allowUnrelatedHistories&&(n+="&")),i.allowUnrelatedHistories&&(n+="allowUnrelatedHistories=true"),J.sendRequest({url:n,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){i.setUpstream&&o.git.branches.remoteAlt&&(o.git.branches.remote=o.git.branches.remoteAlt,delete o.git.branches.remoteAlt),Z(!0),D()},400:{git_local_overwrite:function(e){RED.notify(RED._("sidebar.project.versionControl.unablePull")+'<p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">'+RED._("sidebar.project.versionControl.showUnstagedChanges")+"</a></p>","error",!1,1e7)},git_pull_merge_conflict:function(e){Z(!0),D()},git_connection_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.connectionFailed")+e.toString(),"warning")},git_pull_unrelated_history:function(e){var t=RED.notify(RED._("sidebar.project.versionControl.pullUnrelatedHistory"),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("sidebar.project.versionControl.pullChanges"),click:function(){t.close(),i.allowUnrelatedHistories=!0,L(i)}}]})},"*":function(e){J.reportUnexpectedError(e)}}}},{}).always(function(){e.remove()})};$('<button id="red-ui-sidebar-vc-repo-pull" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-down"></i> <span data-i18n="sidebar.project.versionControl.pull"></span></button>').appendTo(C).on("click",function(e){e.preventDefault(),L({setUpstream:$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked")})}),$('<div class="red-ui-shade red-ui-sidebar-vc-shade">').appendTo(S),RED.sidebar.addTab({id:"version-control",label:RED._("sidebar.project.versionControl.history"),name:RED._("sidebar.project.versionControl.projectHistory"),content:S,enableOnEdit:!1,pinned:!0,iconClass:"fa fa-code-fork",action:"core:show-version-control-tab",onchange:function(){setTimeout(function(){O.resize()},10)}})},show:te,refresh:Z,showLocalChanges:function(){RED.sidebar.show("version-control"),U.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var f=null,h=!1,g=!1,v=null;return{show:function(e,a,t){h=!0;try{function i(e,t,i){i.el=o.append("div").classed("red-ui-editor-radial-menu-opt",!0).style({top:t+80-25+"px",left:e+80-25+"px"}).classed("red-ui-editor-radial-menu-opt-disabled",!!i.disabled),i.el.html(i.name),i.x=e,i.y=t,r.push(i),i.el.on("touchstart",function(){i.el.classed("red-ui-editor-radial-menu-opt-active",!0),d3.event.preventDefault(),d3.event.stopPropagation()}),i.el.on("touchend",function(){u(),i.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})}for(var o=(f=d3.select("body").append("div").classed("red-ui-editor-radial-menu",!0).on("touchstart",function(){u(),d3.event.preventDefault()})).append("div").style({top:a[1]-80+"px",left:a[0]-80+"px"}),r=[],n=t.length,s=Math.max(Math.PI/(n-1),Math.PI/4),d=Math.PI,l=0;l<n;l++){var c=Math.floor(80*Math.cos(d)),p=Math.floor(80*Math.sin(d));t[l].name&&i(c,p,t[l]),d+=s}var u=function(){h=!1,v=null,f.remove(),f=null};e.on("touchend.radial",function(){if(e.on("touchend.radial",null),e.on("touchmenu.radial",null),v){try{v.onselect()}catch(e){RED._debug(e)}u()}else g&&u()}),e.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-a[0],e.pageY-a[1]],i=0;i<r.length;i++){var o=r[i];o.disabled||(t[0]>o.x-30&&t[0]<o.x+30&&t[1]>o.y-30&&t[1]<o.y+30?o!==v&&(o.el.style("background","#999"),v=o):o===v?(o.el.style("background","#fff"),v=null):o.el.style("background","#fff"))}if(!v){var n=Math.abs(t[0]*t[0]+t[1]*t[1]);g=6400<n}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return h}}}();