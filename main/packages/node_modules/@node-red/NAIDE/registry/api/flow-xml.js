const runtime = require('../../../runtime');
const convert = require('xml-js');
const fs = require('fs');

function init() {
    runtime.httpAdmin.post("/naide/flow/xml2json", function(req, res) {
        var xml = req.body.data;
        console.log(xml);
        var json = convert.xml2json(xml, {compact: true, spaces: 4});
        console.log(json);
        res.send(json);
        //res.sendFile(req.params[0], options);
    });
    runtime.httpAdmin.post("/naide/flow/json2xml", function(req, res) {
        var json = req.body;
        var xml = json2xml(json);
        console.log(xml);
        var json = convert.xml2json(xml, {compact: false, spaces: 4});
        console.log(json);
        res.send(xml);
        /*
        console.log(__dirname+'\\flow-xml\\flow.xml');
        fs.writeFileSync(__dirname + '\\flow-xml\\flow.xml', xml, 'utf8');
        res.download(__dirname + "\\flow-xml\\flow.xml", "flow.xml");
        console.log(xml);
        */
        //res.sendFile(req.params[0], options);
    });
}
function json2xml(data) {
    let xml = json2xml_process(data);
    return xml;
}

function json2xml_process(data, depth = 0) {
    let xml = "";
    let tab = "";
    for(let i = 0; i < depth; i++) {
        tab += "    ";
    }
    if (Array.isArray(data)) {
        let len = data.length;
        for(let i = 0; i < len; i++) {
            xml += tab + `<arr_${i}>\n`;
            xml += json2xml_process(data[i], depth+1) + "\n";
            xml += tab + `</arr_${i}>`;
            if (i < len - 1) {
                xml += "\n";
            }
        }
    }
    else if (typeof(data) === "number") {
        xml += tab + data;
    }
    else if (typeof(data) === "boolean") {
        xml += tab + data;
    }
    else if (typeof(data) === "string") {
        xml += tab + `${data}`;
    }
    else if (typeof(data) === "object") {
        for(key in data) {
            let value = data[key];
            if (Array.isArray(value)) {
                xml += tab + `<${key}>\n`;
                xml += json2xml_process(value, depth+1) + "\n";;
                xml += tab + `</${key}>`;
            }
            else if (typeof(value) === "object") {
                xml += json2xml_process(value, depth+1) + "\n";
            }
            else if (typeof(value) === "number") {
                xml += tab + `<${key}>`;
                xml += value;
                xml += `</${key}>\n`;
            }
            else if (typeof(value) === "boolean") {
                xml += tab + `<${key}>`;
                xml += value;
                xml += `</${key}>\n`;
            }
            else if (typeof(value) === "string") {
                xml += tab + `<${key}>`;
                xml += `${value}`;
                xml += `</${key}>\n`;
            }
        }
    }
    return xml;
}

module.exports = {
    init: init
};