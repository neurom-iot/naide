<script type="text/x-red" data-template-name="pulse-generator">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 이름</label>
        <input type="text" id="node-input-name" placeholder="이름 입력">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-signal"></i> 파형설정</label>
        <span class = "button-group">
            <button type = "button"class = "red-ui-button toggle selected pulse-button-group">교차</button>
            <button type = "button"class = "red-ui-button toggle pulse-button-group ">무작위</button>
        </span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-repeat"></i> 주기설정</label>
        <span class = "button-group">
            <button type = "button"class = "red-ui-button toggle selected hz-button-group">1Hz</button>
            <button type = "button"class = "red-ui-button toggle hz-button-group ">10Hz</button>
            <button type = "button"class = "red-ui-button toggle hz-button-group ">100Hz</button>
            <button type = "button"class = "red-ui-button toggle hz-button-group ">1KHz</button>
        </span>
    </div>
</script>

<script type="text/x-red" data-help-name="pulse-generator">
    <p>수동, 혹은 일정간격으로 메세지를 플로우에 주입합니다. 메세지의 페이로드는 1 또는 0의 신호(High, Low)를 갖습니다.</p>

    <h3>상세</h3>
    <p>PulseGenerator 컴포넌트를 사용하여 지정한 시간간격으로 TimeStamp를 플로우에 주입할 수 있습니다.</p>
    <p>옵션에서 Hz 단위의 시간간격을 지정하라 수 있습니다.</p>
    <p>TimeStamp는 일정하거나 무작위하게 보낼수 있으며 사용자에 의해 조정될 수 있습니다.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType("pulse-generator",{
        category: 'NAIDE',
        color: '#66F8F0',
        defaults: {
            name: {value: "pulse-generator"},
            payload: {value: ""},
            payloadType: {value: ""},
            pulse: {value: 0},
            hz: {value: 1000}
        },
        codeEditable: true,
        inputs:0,
        outputs:1,
        icon: "file.png",
        label: function() {
            return this.name|| "pulse-generator";
        },
        oneditprepare: function() {
            var pluseIdx = this.pulse;
            var hzIdx = 3 - Math.log10(this.hz);
            $(".pulse-button-group").removeClass("selected");
            $(".hz-button-group").removeClass("selected");
            $(".pulse-button-group:eq("+ pluseIdx + ")").addClass("selected");
            $(".hz-button-group:eq("+ hzIdx + ")").addClass("selected");
            $(".pulse-button-group").on("click", function() {
                $(".pulse-button-group").removeClass("selected");
                $(this).addClass("selected");
            })
            $(".hz-button-group").on("click", function() {
                $(".hz-button-group").removeClass("selected");
                $(this).addClass("selected");
            })
        },
        oneditsave: function() {
            var pluseValue = $(".pulse-button-group.selected").text();
            var hzValue = $(".hz-button-group.selected").text();
            this.payloadType = pluseValue;
            this.pulse = pluseValue == "교차" ? 0 : 1;
            this.hz = hzValue == "1Hz" ? 1000 : hzValue == "10Hz" ? 100 : hzValue == "100Hz" ? 10 : 1;
        },
        button: {
            enabled: function() {
                return !this.changed
            },
            onclick: function() {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", {message:RED._("notification.warnings.undeployedChanges")}),"warning");
                }
                var node = this;
                $.ajax({
                    url: "inject/"+this.id,
                    type:"POST",
                    success: function(resp) {
                        RED.notify(node._("pulse-generator.success",{label:label}),{type:"success",id:"pulse-generator"});
                    },
                    error: function(jqXHR,textStatus,errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.not-deployed")}),"error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error",{message:node._("pulse-generator.errors.failed")}),"error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.no-response")}),"error");
                        } else {
                            RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:jqXHR.status,message:textStatus})}),"error");
                        }
                    }
                });
            }
        }
    });
</script>